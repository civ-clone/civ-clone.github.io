"use strict";(()=>{var Yr=Object.create;var oi=Object.defineProperty;var Vr=Object.getOwnPropertyDescriptor;var Xr=Object.getOwnPropertyNames;var Qr=Object.getPrototypeOf,Jr=Object.prototype.hasOwnProperty;var l=(i,t)=>oi(i,"name",{value:t,configurable:!0});var Si=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var Zr=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Xr(t))!Jr.call(i,n)&&n!==e&&oi(i,n,{get:()=>t[n],enumerable:!(s=Vr(t,n))||s.enumerable});return i};var y=(i,t,e)=>(e=i!=null?Yr(Qr(i)):{},Zr(t||!i||!i.__esModule?oi(e,"default",{value:i,enumerable:!0}):e,i));var Di=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var r=(i,t,e)=>(Di(i,t,"read from private field"),e?e.call(i):t.get(i)),c=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},u=(i,t,e,s)=>(Di(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var w=Si(x=>{"use strict";var Es,ea=x&&x.__classPrivateFieldSet||function(i,t,e,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(i,e):n?n.value=e:t.set(i,e),e},ta=x&&x.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(x,"__esModule",{value:!0}),x.Element=x.toggleClass=x.t=x.s=x.removeClass=x.once=x.onEach=x.on=x.off=x.hasClass=x.empty=x.emitCustom=x.emit=x.addClass=void 0;x.addClass=(i,...t)=>i.classList.add(...t);x.emit=(i,t)=>i.dispatchEvent(t);x.emitCustom=(i,t,...e)=>(0,x.emit)(i,new CustomEvent(t,{detail:e}));x.empty=i=>{for(var t;i.hasChildNodes();)(t=i.firstChild)===null||t===void 0||t.remove()};x.hasClass=(i,t)=>i.classList.contains(t);x.off=(i,t,e,s={})=>i.removeEventListener(t,e,s);x.on=(i,t,e,s={})=>i.addEventListener(t,e,s);x.onEach=(i,t,e,s={})=>t.forEach(n=>(0,x.on)(i,n,e,s));x.once=(i,t,e,s={})=>(0,x.on)(i,t,e,Object.assign(Object.assign({},typeof s=="boolean"?{capture:s}:s),{once:!0}));x.removeClass=(i,...t)=>i.classList.remove(...t);x.s=(i,...t)=>{let e=document.createElement("div");e.innerHTML=i;let s=e.firstElementChild;return t.forEach(n=>{n instanceof pe?s.append(n.element()):n instanceof Node?s.append(n):s.append((0,x.t)(n))}),s};x.t=i=>document.createTextNode(i);x.toggleClass=(i,...t)=>t.forEach(e=>i.classList.toggle(e));var pe=class{constructor(t){Es.set(this,void 0),ea(this,Es,t,"f")}static fromString(t){return new pe((0,x.s)(t))}addClass(...t){(0,x.addClass)(this.element(),...t)}append(...t){t.forEach(e=>{e instanceof pe&&(e=e.element()),this.element().append(e)})}element(){return ta(this,Es,"f")}emit(t){return(0,x.emit)(this.element(),t)}emitCustom(t,...e){return(0,x.emitCustom)(this.element(),t,...e)}empty(){(0,x.empty)(this.element())}hasClass(t){return(0,x.hasClass)(this.element(),t)}off(t,e,s={}){(0,x.off)(this.element(),t,e,s)}on(t,e,s={}){(0,x.on)(this.element(),t,e,s)}onEach(t,e,s={}){(0,x.onEach)(this.element(),t,e,s)}once(t,e,s={}){(0,x.once)(this.element(),t,e,s)}query(t){return this.element().querySelector(t)}queryAll(t){return this.element().querySelectorAll(t)}remove(){this.element().remove()}removeClass(...t){(0,x.removeClass)(this.element(),...t)}toggleClass(...t){(0,x.toggleClass)(this.element(),...t)}};l(pe,"o");x.Element=pe,Es=new WeakMap,x.default=pe});var sr=Si(ze=>{"use strict";var ne,Ce=ze&&ze.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(ze,"__esModule",{value:!0}),ze.EventEmitter=void 0;var Zt=class{constructor(){ne.set(this,{})}on(t,e){t in Ce(this,ne,"f")||(Ce(this,ne,"f")[t]=[]),Ce(this,ne,"f")[t].push(e)}once(t,e){let s=l((...n)=>{e(...n),this.off(t,s)},"i");this.on(t,s)}off(t,e){if(!(t in Ce(this,ne,"f")))return;let s=Ce(this,ne,"f")[t].indexOf(e);s!==-1&&Ce(this,ne,"f")[t].splice(s,1)}emit(t,...e){t in Ce(this,ne,"f")&&Ce(this,ne,"f")[t].forEach(s=>s(...e))}};l(Zt,"i");ze.EventEmitter=Zt,ne=new WeakMap,ze.default=Zt});var Qe=y(w());var Ts=l(({hierarchy:i,objects:t},e=null)=>{let s=new Map;e&&Object.keys(t).forEach(a=>e.push(a));let n=l(a=>{if(s.has(a))return s.get(a);if(Array.isArray(a)){let o=[];return s.set(a,o),a.forEach(m=>o.push(n(m))),o}if(a&&a["#ref"]){if(e&&e.splice(e.indexOf(a["#ref"]),1),!(a["#ref"]in t))throw new TypeError(`missing ${a["#ref"]}`);let o=n(t[a["#ref"]]);return s.set(a,o),o}if(a instanceof Object){let o={};return s.set(a,o),Object.entries(a).forEach(([m,p])=>{o[m]=n(p)}),o}return a},"getReferences");return n(i)},"reconstituteData");var Cn=y(w());var Ms=y(w());var kt,Ht,Cs=class extends Ms.Element{constructor(e,s){super((0,Ms.s)('<div class="action"></div>'));c(this,kt,void 0);c(this,Ht,void 0);u(this,kt,e),u(this,Ht,s),this.on("keydown",n=>{n.key!=="Escape"&&n.stopPropagation()}),this.build()}activate(){}build(){}complete(){this.emit(new CustomEvent("actioned",{bubbles:!0,detail:this}))}transport(){return r(this,Ht)}value(){return r(this,kt).value}};l(Cs,"Action"),kt=new WeakMap,Ht=new WeakMap;var q=Cs;var Is=y(w());var sa=l((i,t)=>(0,Is.s)(`<fieldset><legend>${i}</legend><input type="range" max="100" min="0" step="1" value="${t}"><input type="number"><label><input type="checkbox">Lock</label></fieldset>`),"template"),At,Y,Z,Ze,$t,Ls=class extends Is.Element{constructor(e,s){super(sa(e,s));c(this,At,void 0);c(this,Y,void 0);c(this,Z,void 0);c(this,Ze,void 0);c(this,$t,[]);u(this,At,e),u(this,Y,this.element().querySelector('input[type="range"]')),u(this,Z,this.element().querySelector('input[type="number"]')),u(this,Ze,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(r(this,Y).value),r(this,Y).addEventListener("input",()=>this.set(r(this,Y).value)),r(this,Z).addEventListener("input",()=>this.set(r(this,Z).value)),r(this,Ze).addEventListener("input",()=>this.lock()),this.lock()}label(){return r(this,At)}lock(){if(this.isLocked()){r(this,Y).setAttribute("disabled",""),r(this,Z).setAttribute("disabled","");return}r(this,Y).removeAttribute("disabled"),r(this,Z).removeAttribute("disabled")}onInput(e){r(this,$t).push(e)}isLocked(){return r(this,Ze).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),r(this,Y).value!==e&&(r(this,Y).value=e),r(this,Z).value!==e&&(r(this,Z).value=e),r(this,$t).forEach(s=>s())}value(){return parseInt(r(this,Y).value,10)}};l(Ls,"LockedSlider"),At=new WeakMap,Y=new WeakMap,Z=new WeakMap,Ze=new WeakMap,$t=new WeakMap;var ki=Ls;var fe,Ps=class{constructor(...t){c(this,fe,void 0);u(this,fe,t),r(this,fe).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let s=r(this,fe).filter(a=>a!==e),n=s.filter(a=>!a.isLocked());if(this.total()!==100&&n.length===0){e.set((100-this.total(s)).toString());return}if(this.total()>100){let a=this.total()-100,o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()-Math.min(o,a)).toString()),a-=o}),this.total()>100&&e.set((100-this.total(s)).toString())}if(this.total()<100){let a=100-this.total(),o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()+Math.min(o,a)).toString()),a-=o}),this.total()<100&&e.set((100-this.total(s)).toString())}}))}sliders(){return r(this,fe)}total(t=r(this,fe)){return t.reduce((e,s)=>e+s.value(),0)}};l(Ps,"LockedSliderGroup"),fe=new WeakMap;var Hi=Ps;var Ss=y(w());var et,Rt=class extends Ss.Element{constructor(e,s=(0,Ss.s)("<div></div>")){super(s);c(this,et,void 0);this.on("keydown",n=>{n.stopPropagation()}),this.element().setAttribute("tabindex","0"),u(this,et,e)}build(){}display(){this.build(),r(this,et).append(this.element())}parent(){return r(this,et)}};l(Rt,"TransientElement"),et=new WeakMap;var G=y(w());var b=l((i,t)=>(Object.entries(t).forEach(([e,s])=>i.addEventListener(e,s)),i),"h");var Ai={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},$e,Ot,tt=class extends Rt{constructor(e,s,n={}){var a;super((a=n.parent)!=null?a:Ai.parent,(0,G.s)('<div class="window"></div>'));c(this,$e,void 0);c(this,Ot,void 0);if(this.options={...Ai,...n},u(this,$e,s),u(this,Ot,e),this.options.size==="auto"&&this.addClass("size-auto"),this.options.size==="maximised"&&this.addClass("maximised"),this.options.size!=="auto"&&["height","width"].forEach(o=>{let m=this.options.size[o];if(typeof m=="number"){this.element().style[o]=m+"px";return}this.element().style[o]=m}),this.options.position==="auto"&&this.addClass("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([o,m])=>{this.element().style[m]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[o]))+"px"}),this.options.autoDisplay){this.display();return}this.build()}build(){this.empty();let e=[[this.options.canMaximise,b((0,G.s)('<button class="maximise" aria-label="Maximise">Maximise</button>'),{click:()=>this.maximise()})],[this.options.canClose,b((0,G.s)('<button class="close" aria-label="Close">Maximise</button>'),{click:()=>this.close()})]].filter(([n])=>n).map(([,n])=>n),s=!1;this.append(b((0,G.s)(`<header><h3>${r(this,Ot)}</h3></header>`,...e),{dblclick:()=>this.maximise(),mousedown:n=>{if(n.target.matches("button, button img"))return;s=!0;let a=l(o=>{!s||this.move({x:o.movementX,y:o.movementY})},"moveHandler");(0,G.on)(document,"mousemove",a),(0,G.on)(document,"mouseup",()=>{(0,G.off)(document,"mousemove",a),s=!1},{once:!0})}}),(0,G.s)('<div class="body"></div>',r(this,$e)instanceof Node?r(this,$e):(0,G.s)(`<p>${r(this,$e)}</p>`))),this.on("keydown",n=>{n.key==="Escape"&&this.options.canClose&&this.close(),n.stopPropagation()})}close(){this.remove(),this.emit(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||(this.element().classList.toggle("maximised"),this.emit(new CustomEvent("resize",{bubbles:!1})))}move({x:e,y:s}){if(this.hasClass("position-auto")){e+=this.element().offsetLeft,s+=this.element().offsetTop,this.removeClass("position-auto"),this.element().style.setProperty("top",s+"px"),this.element().style.setProperty("left",e+"px");return}let n=getComputedStyle(this.element()),a=parseInt(n.getPropertyValue("top"),10),o=parseInt(n.getPropertyValue("left"),10);this.element().style.setProperty("top",a+s+"px"),this.element().style.setProperty("left",o+e+"px")}update(e){this.element().lastElementChild.remove(),this.append(e instanceof Node?e:(0,G.s)(`<p>${e}</p>`))}};l(tt,"Window"),$e=new WeakMap,Ot=new WeakMap;var z=tt;var na=l((i,t)=>t.some(e=>i instanceof e),"instanceOfAny"),$i,Ri;function ia(){return $i||($i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}l(ia,"getIdbProxyableTypes");function ra(){return Ri||(Ri=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}l(ra,"getCursorAdvanceMethods");var Oi=new WeakMap,mi=new WeakMap,Ui=new WeakMap,li=new WeakMap,di=new WeakMap;function aa(i){let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("success",a),i.removeEventListener("error",o)},"unlisten"),a=l(()=>{e(ee(i.result)),n()},"success"),o=l(()=>{s(i.error),n()},"error");i.addEventListener("success",a),i.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Oi.set(e,i)}).catch(()=>{}),di.set(t,i),t}l(aa,"promisifyRequest");function oa(i){if(mi.has(i))return;let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("complete",a),i.removeEventListener("error",o),i.removeEventListener("abort",o)},"unlisten"),a=l(()=>{e(),n()},"complete"),o=l(()=>{s(i.error||new DOMException("AbortError","AbortError")),n()},"error");i.addEventListener("complete",a),i.addEventListener("error",o),i.addEventListener("abort",o)});mi.set(i,t)}l(oa,"cacheDonePromiseForTransaction");var pi={get(i,t,e){if(i instanceof IDBTransaction){if(t==="done")return mi.get(i);if(t==="objectStoreNames")return i.objectStoreNames||Ui.get(i);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return ee(i[t])},set(i,t,e){return i[t]=e,!0},has(i,t){return i instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in i}};function zi(i){pi=i(pi)}l(zi,"replaceTraps");function la(i){return i===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){let s=i.call(Ds(this),t,...e);return Ui.set(s,t.sort?t.sort():[t]),ee(s)}:ra().includes(i)?function(...t){return i.apply(Ds(this),t),ee(Oi.get(this))}:function(...t){return ee(i.apply(Ds(this),t))}}l(la,"wrapFunction");function ma(i){return typeof i=="function"?la(i):(i instanceof IDBTransaction&&oa(i),na(i,ia())?new Proxy(i,pi):i)}l(ma,"transformCachableValue");function ee(i){if(i instanceof IDBRequest)return aa(i);if(li.has(i))return li.get(i);let t=ma(i);return t!==i&&(li.set(i,t),di.set(t,i)),t}l(ee,"wrap");var Ds=l(i=>di.get(i),"unwrap");function Ni(i,t,{blocked:e,upgrade:s,blocking:n,terminated:a}={}){let o=indexedDB.open(i,t),m=ee(o);return s&&o.addEventListener("upgradeneeded",p=>{s(ee(o.result),p.oldVersion,p.newVersion,ee(o.transaction),p)}),e&&o.addEventListener("blocked",p=>e(p.oldVersion,p.newVersion,p)),m.then(p=>{a&&p.addEventListener("close",()=>a()),n&&p.addEventListener("versionchange",d=>n(d.oldVersion,d.newVersion,d))}).catch(()=>{}),m}l(Ni,"openDB");var pa=["get","getKey","getAll","getAllKeys","count"],da=["put","add","delete","clear"],ci=new Map;function Wi(i,t){if(!(i instanceof IDBDatabase&&!(t in i)&&typeof t=="string"))return;if(ci.get(t))return ci.get(t);let e=t.replace(/FromIndex$/,""),s=t!==e,n=da.includes(e);if(!(e in(s?IDBIndex:IDBObjectStore).prototype)||!(n||pa.includes(e)))return;let a=l(async function(o,...m){let p=this.transaction(o,n?"readwrite":"readonly"),d=p.store;return s&&(d=d.index(m.shift())),(await Promise.all([d[e](...m),n&&p.done]))[0]},"method");return ci.set(t,a),a}l(Wi,"getMethod");zi(i=>({...i,get:(t,e,s)=>Wi(t,e)||i.get(t,e,s),has:(t,e)=>!!Wi(t,e)||i.has(t,e)}));var de,te,Ut=class{constructor(t,e,s){c(this,de,void 0);c(this,te,void 0);u(this,te,e),u(this,de,Ni(t,1,{upgrade:n=>n.createObjectStore(r(this,te),s)}))}async get(t){return(await r(this,de)).get(r(this,te),t)}async getAll(t,e){return(await r(this,de)).getAll(r(this,te),t,e)}async set(t,e){return(await r(this,de)).put(r(this,te),t,e)}async clear(){return(await r(this,de)).clear(r(this,te))}async keys(){return(await r(this,de)).getAllKeys(r(this,te))}};l(Ut,"Store"),de=new WeakMap,te=new WeakMap;var ca=l((i,t,e)=>{let s=document.createElement("canvas"),n=s.getContext("2d");return s.width=i.width*t,s.height=i.height*t,e!=null&&e.smoothing||(n.imageSmoothingEnabled=!1),n.drawImage(i,0,0,s.width,s.height),s},"scaleImage"),ji=ca;var st,nt,it,Hs,ks=class extends Ut{constructor(){super("civ-clone-assets","assets",{keyPath:"name"});c(this,st,new Map);c(this,nt,new Map);c(this,it,new Map);c(this,Hs,["./assets/city/bulb.png","./assets/city/food.png","./assets/city/gold.png","./assets/city/luxury.png","./assets/city/people_content_f.png","./assets/city/people_content_m.png","./assets/city/people_happy_f.png","./assets/city/people_happy_m.png","./assets/city/people_luxury.png","./assets/city/people_science.png","./assets/city/people_tax.png","./assets/city/people_unhappy_f.png","./assets/city/people_unhappy_m.png","./assets/city/pollution.png","./assets/city/sad.png","./assets/city/production.png","./assets/city/trade.png","./assets/cursor/go.png","./assets/cursor/torch.png","./assets/general/texture_1.png","./assets/general/texture_2.png","./assets/improvements/irrigation.png","./assets/improvements/mine.png","./assets/improvements/pollution.png","./assets/improvements/railroad_e.png","./assets/improvements/railroad_se.png","./assets/improvements/railroad_n.png","./assets/improvements/railroad_ne.png","./assets/improvements/railroad_nw.png","./assets/improvements/railroad_s.png","./assets/improvements/railroad_sw.png","./assets/improvements/railroad_w.png","./assets/improvements/road_e.png","./assets/improvements/road_n.png","./assets/improvements/road_ne.png","./assets/improvements/road_nw.png","./assets/improvements/road_s.png","./assets/improvements/road_se.png","./assets/improvements/road_sw.png","./assets/improvements/road_w.png","./assets/map/city.png","./assets/map/fog_e.png","./assets/map/fog_n.png","./assets/map/fog_s.png","./assets/map/fog_w.png","./assets/map/fort.png","./assets/map/fortify.png","./assets/map/hut.png","./assets/status/pollution_0.png","./assets/status/pollution_25.png","./assets/status/pollution_50.png","./assets/status/pollution_75.png","./assets/status/science_0.png","./assets/status/science_25.png","./assets/status/science_50.png","./assets/status/science_75.png","./assets/terrain/arctic.png","./assets/terrain/arctic_e.png","./assets/terrain/arctic_es.png","./assets/terrain/arctic_esw.png","./assets/terrain/arctic_ew.png","./assets/terrain/arctic_n.png","./assets/terrain/arctic_ne.png","./assets/terrain/arctic_nes.png","./assets/terrain/arctic_nesw.png","./assets/terrain/arctic_new.png","./assets/terrain/arctic_ns.png","./assets/terrain/arctic_nsw.png","./assets/terrain/arctic_nw.png","./assets/terrain/arctic_s.png","./assets/terrain/arctic_sw.png","./assets/terrain/arctic_w.png","./assets/terrain/coal.png","./assets/terrain/coast_sprite.png","./assets/terrain/desert.png","./assets/terrain/desert_e.png","./assets/terrain/desert_es.png","./assets/terrain/desert_esw.png","./assets/terrain/desert_ew.png","./assets/terrain/desert_n.png","./assets/terrain/desert_ne.png","./assets/terrain/desert_nes.png","./assets/terrain/desert_nesw.png","./assets/terrain/desert_new.png","./assets/terrain/desert_ns.png","./assets/terrain/desert_nsw.png","./assets/terrain/desert_nw.png","./assets/terrain/desert_s.png","./assets/terrain/desert_sw.png","./assets/terrain/desert_w.png","./assets/terrain/doe.png","./assets/terrain/fish.png","./assets/terrain/forest.png","./assets/terrain/forest_e.png","./assets/terrain/forest_es.png","./assets/terrain/forest_esw.png","./assets/terrain/forest_ew.png","./assets/terrain/forest_n.png","./assets/terrain/forest_ne.png","./assets/terrain/forest_nes.png","./assets/terrain/forest_nesw.png","./assets/terrain/forest_new.png","./assets/terrain/forest_ns.png","./assets/terrain/forest_nsw.png","./assets/terrain/forest_nw.png","./assets/terrain/forest_s.png","./assets/terrain/forest_sw.png","./assets/terrain/forest_w.png","./assets/terrain/gems.png","./assets/terrain/gold.png","./assets/terrain/grassland.png","./assets/terrain/grassland_e.png","./assets/terrain/grassland_es.png","./assets/terrain/grassland_esw.png","./assets/terrain/grassland_ew.png","./assets/terrain/grassland_n.png","./assets/terrain/grassland_ne.png","./assets/terrain/grassland_nes.png","./assets/terrain/grassland_nesw.png","./assets/terrain/grassland_new.png","./assets/terrain/grassland_ns.png","./assets/terrain/grassland_nsw.png","./assets/terrain/grassland_nw.png","./assets/terrain/grassland_s.png","./assets/terrain/grassland_sw.png","./assets/terrain/grassland_w.png","./assets/terrain/hills.png","./assets/terrain/hills_e.png","./assets/terrain/hills_es.png","./assets/terrain/hills_esw.png","./assets/terrain/hills_ew.png","./assets/terrain/hills_n.png","./assets/terrain/hills_ne.png","./assets/terrain/hills_nes.png","./assets/terrain/hills_nesw.png","./assets/terrain/hills_new.png","./assets/terrain/hills_ns.png","./assets/terrain/hills_nsw.png","./assets/terrain/hills_nw.png","./assets/terrain/hills_s.png","./assets/terrain/hills_sw.png","./assets/terrain/hills_w.png","./assets/terrain/horse.png","./assets/terrain/jungle.png","./assets/terrain/jungle_e.png","./assets/terrain/jungle_es.png","./assets/terrain/jungle_esw.png","./assets/terrain/jungle_ew.png","./assets/terrain/jungle_n.png","./assets/terrain/jungle_ne.png","./assets/terrain/jungle_nes.png","./assets/terrain/jungle_nesw.png","./assets/terrain/jungle_new.png","./assets/terrain/jungle_ns.png","./assets/terrain/jungle_nsw.png","./assets/terrain/jungle_nw.png","./assets/terrain/jungle_s.png","./assets/terrain/jungle_sw.png","./assets/terrain/jungle_w.png","./assets/terrain/land.png","./assets/terrain/mountains.png","./assets/terrain/mountains_e.png","./assets/terrain/mountains_es.png","./assets/terrain/mountains_esw.png","./assets/terrain/mountains_ew.png","./assets/terrain/mountains_n.png","./assets/terrain/mountains_ne.png","./assets/terrain/mountains_nes.png","./assets/terrain/mountains_nesw.png","./assets/terrain/mountains_new.png","./assets/terrain/mountains_ns.png","./assets/terrain/mountains_nsw.png","./assets/terrain/mountains_nw.png","./assets/terrain/mountains_s.png","./assets/terrain/mountains_sw.png","./assets/terrain/mountains_w.png","./assets/terrain/oasis.png","./assets/terrain/ocean.png","./assets/terrain/oil.png","./assets/terrain/plains.png","./assets/terrain/plains_e.png","./assets/terrain/plains_es.png","./assets/terrain/plains_esw.png","./assets/terrain/plains_ew.png","./assets/terrain/plains_n.png","./assets/terrain/plains_ne.png","./assets/terrain/plains_nes.png","./assets/terrain/plains_nesw.png","./assets/terrain/plains_new.png","./assets/terrain/plains_ns.png","./assets/terrain/plains_nsw.png","./assets/terrain/plains_nw.png","./assets/terrain/plains_s.png","./assets/terrain/plains_sw.png","./assets/terrain/plains_w.png","./assets/terrain/river_e.png","./assets/terrain/river_es.png","./assets/terrain/river_esw.png","./assets/terrain/river_ew.png","./assets/terrain/river_mouth_e.png","./assets/terrain/river_mouth_n.png","./assets/terrain/river_mouth_s.png","./assets/terrain/river_mouth_w.png","./assets/terrain/river.png","./assets/terrain/river_n.png","./assets/terrain/river_ne.png","./assets/terrain/river_nes.png","./assets/terrain/river_nesw.png","./assets/terrain/river_new.png","./assets/terrain/river_ns.png","./assets/terrain/river_nsw.png","./assets/terrain/river_nw.png","./assets/terrain/river_s.png","./assets/terrain/river_sw.png","./assets/terrain/river_w.png","./assets/terrain/seal.png","./assets/terrain/shield.png","./assets/terrain/game.png","./assets/terrain/swamp.png","./assets/terrain/swamp_e.png","./assets/terrain/swamp_es.png","./assets/terrain/swamp_esw.png","./assets/terrain/swamp_ew.png","./assets/terrain/swamp_n.png","./assets/terrain/swamp_ne.png","./assets/terrain/swamp_nes.png","./assets/terrain/swamp_nesw.png","./assets/terrain/swamp_new.png","./assets/terrain/swamp_ns.png","./assets/terrain/swamp_nsw.png","./assets/terrain/swamp_nw.png","./assets/terrain/swamp_s.png","./assets/terrain/swamp_sw.png","./assets/terrain/swamp_w.png","./assets/terrain/tundra.png","./assets/terrain/tundra_e.png","./assets/terrain/tundra_es.png","./assets/terrain/tundra_esw.png","./assets/terrain/tundra_ew.png","./assets/terrain/tundra_n.png","./assets/terrain/tundra_ne.png","./assets/terrain/tundra_nes.png","./assets/terrain/tundra_nesw.png","./assets/terrain/tundra_new.png","./assets/terrain/tundra_ns.png","./assets/terrain/tundra_nsw.png","./assets/terrain/tundra_nw.png","./assets/terrain/tundra_s.png","./assets/terrain/tundra_sw.png","./assets/terrain/tundra_w.png","./assets/units/tank.png","./assets/units/artillery.png","./assets/units/battleship.png","./assets/units/bomber.png","./assets/units/cannon.png","./assets/units/caravan.png","./assets/units/carrier.png","./assets/units/catapult.png","./assets/units/horseman.png","./assets/units/chariot.png","./assets/units/combat_1.png","./assets/units/combat_2.png","./assets/units/combat_3.png","./assets/units/combat_4.png","./assets/units/combat_5.png","./assets/units/combat_6.png","./assets/units/combat_7.png","./assets/units/combat_8.png","./assets/units/cruiser.png","./assets/units/diplomat.png","./assets/units/fighter.png","./assets/units/frigate.png","./assets/units/ironclad.png","./assets/units/knight.png","./assets/units/swordman.png","./assets/units/mechanizedinfantry.png","./assets/units/warrior.png","./assets/units/musketman.png","./assets/units/nuclear.png","./assets/units/spearman.png","./assets/units/rifleman.png","./assets/units/sail.png","./assets/units/settlers.png","./assets/units/submarine.png","./assets/units/transport.png","./assets/units/trireme.png"])}async get(e){return r(this,st).has(e)||r(this,st).set(e,await super.get(e)),r(this,st).get(e)}async getImage(e){if(!r(this,nt).has(e)){let s=await this.get(e),n=document.createElement("img");n.src=s.uri,r(this,nt).set(e,n)}return r(this,nt).get(e)}async getScaled(e,s){return r(this,it).has(e)||r(this,it).set(e,ji(await this.getImage(e),s)),r(this,it).get(e)}async hasAllAssets(){return(await this.missingAssets()).length===0}async missingAssets(){let e=await this.keys();return r(this,Hs).filter(s=>!e.includes(s))}};l(ks,"AssetStore"),st=new WeakMap,nt=new WeakMap,it=new WeakMap,Hs=new WeakMap;var M=new ks;var ui=y(w());var zt,As=class extends q{constructor(){super(...arguments);c(this,zt,void 0)}activate(){let e=[];new z("Adjust trade rates",(0,ui.s)("<div></div>",...this.value().all.map(n=>{let a=new ki(n._,n.value*100);return e.push(a),a}))).on("close",()=>{let n=r(this,zt).sliders().map(a=>[a.label(),parseFloat((a.value()/100).toFixed(2))]);console.info("AdjustTradeRates: ",n),this.transport().send("action",{name:"AdjustTradeRates",id:this.value().id,value:n})}),u(this,zt,new Hi(...e))}build(){M.get("./assets/city/trade.png").then(e=>this.append((0,ui.s)(`<button class="adjustTradeRates" title="Adjust trade rates" style="background-image:url('${e.uri}')"></button>`)))}value(){return super.value()}};l(As,"AdjustTradeRates"),zt=new WeakMap;var Bi=As;var hi=[],Wt,$s=class extends tt{constructor(e,s,n={}){let a={queue:!0,...n};super(e,s,a);c(this,Wt,{});u(this,Wt,a),this.addClass("notificationWindow"),this.on("keydown",o=>{o.key==="Enter"&&(this.close(),o.stopPropagation())})}close(){if(super.close(),r(this,Wt).queue&&hi.length&&$s.hasOpenWindow()){let[e,s,n]=hi.shift();e.display(s),n()}}display(e=!0){return new Promise(s=>{if($s.hasOpenWindow()){hi.push([this,e,s]);return}if(super.display(),!e){s(void 0);return}this.element().focus(),s(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},xe=$s;l(xe,"NotificationWindow"),Wt=new WeakMap;var Rs=xe;var se=y(w());var Ki={0:"Insert",1:"End",2:"ArrowDown",3:"PageDown",4:"ArrowLeft",6:"ArrowRight",7:"Home",8:"ArrowUp",9:"PageUp",".":"Delete"},ve=l((i,t=!0)=>t&&i.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD&&i.key in Ki?Ki[i.key]:i.key,"mappedKeyFromEvent");var Nt,jt,ye=class extends xe{constructor(e,s,n,a="Please choose one of the following:",o={}){var d,h;o={autoFocus:!0,displayAll:!1,...o,actions:{primary:{label:"OK",action:g=>m(g.selectionList().value),...(h=(d=o.actions)==null?void 0:d.primary)!=null?h:{}},...o.actions}};let m=l(g=>{this.emit(new CustomEvent("selection",{detail:g})),this.close(),n(g)},"chooseHandler"),p=b((0,se.s)(`<select>${s.map(g=>`<option value="${g.value}">${g.label||g.value}</option>`).join("")}</select>`),{keydown:g=>{let f=ve(g);if(f==="Enter"&&(m(p.value),g.preventDefault()),["ArrowDown","ArrowUp","End","Home","PageDown","PageUp"].includes(f)&&!["ArrowDown","ArrowUp","End","Home","PageDown","PageUp"].includes(g.key)){let v=p.selectedIndex,E=["Home","PageUp"].includes(f)?0:["End","PageDown"].includes(f)?p.length-1:v+(f==="ArrowUp"?-1:1);E>-1&&E<p.length&&(p.selectedIndex=E),g.preventDefault()}},dblclick:()=>m(p.value)});o.displayAll&&s.length>1&&p.setAttribute("size",s.length.toString()),o.autoFocus&&s.length>1&&p.setAttribute("autofocus","");super(e,(0,se.s)("<div></div>",...a instanceof Node?[a]:a===null?[]:[(0,se.s)(`<p>${a}</p>`)],p,(0,se.s)("<footer></footer>",...Object.entries(o.actions).map(([,{label:g,action:f}])=>b((0,se.s)(`<button>${g}</button>`),{click:()=>f(this),keydown:v=>{v.key==="Enter"&&f(this)}})))),o);c(this,Nt,l(()=>this.resize(),"#resizeHandler"));c(this,jt,void 0);this.addClass("selectionWindow"),u(this,jt,p),this.resize(),(0,se.on)(window,"resize",r(this,Nt))}close(){(0,se.off)(window,"resize",r(this,Nt)),super.close()}display(){return super.display(!1).then(()=>{let e=this.query("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,s;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-this.element().firstElementChild.offsetHeight-((s=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?s:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2.1em)`}catch(n){console.warn(n)}}selectionList(){return r(this,jt)}};l(ye,"SelectionWindow"),Nt=new WeakMap,jt=new WeakMap;var we=ye;var Fi=y(w());var Os=class extends q{activate(){let t=new we("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){M.get("./assets/city/bulb.png").then(t=>this.append((0,Fi.s)(`<button class="chooseResearch" title="Choose research" style="background-image:url('${t.uri}')">`)))}value(){return super.value()}};l(Os,"ChooseResearch");var Gi=Os;var Bt={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLaw:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},Kt=Object.entries(Bt).reduce((i,[t,e])=>(Object.prototype.hasOwnProperty.call(i,e)||(i[e]=[]),Object.prototype.hasOwnProperty.call(i,t)||(i[t]=[]),i[e].push(t),i[t].push(t),i),{}),Ft=l((i,...t)=>i.reduce((e,s,n)=>(t.forEach((a,o)=>{var m;(m=Kt[a])!=null&&m.includes(s._)&&(e[o]+=s.value)}),e),t.map(()=>0)),"reduceKnownYields"),rt=l((i,t)=>Ft(i,t)[0],"reduceKnownYield"),at={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var ua=l((i,...t)=>i.classList.add(...t),"addClass"),qi=l((i,t)=>i.dispatchEvent(t),"emit"),ha=l((i,t,...e)=>qi(i,new CustomEvent(t,{detail:e})),"emitCustom"),ga=l(i=>{for(;i.hasChildNodes();)i.firstChild?.remove()},"empty"),fa=l((i,t)=>i.classList.contains(t),"hasClass"),xa=l((i,t,e,s={})=>i.removeEventListener(t,e,s),"off"),gi=l((i,t,e,s={})=>i.addEventListener(t,e,s),"on"),va=l((i,t,e,s={})=>t.forEach(n=>gi(i,n,e,s)),"onEach"),ya=l((i,t,e,s={})=>gi(i,t,e,{...typeof s=="boolean"?{capture:s}:s,once:!0}),"once"),wa=l((i,...t)=>i.classList.remove(...t),"removeClass"),Oe=l((i,...t)=>{let e=document.createElement("div");e.innerHTML=i;let s=e.firstElementChild;return t.forEach(n=>{if(n instanceof Re){s.append(n.element());return}if(n instanceof Node){s.append(n);return}s.append(ba(n))}),s},"s"),ba=l(i=>document.createTextNode(i),"t"),_a=l((i,...t)=>t.forEach(e=>i.classList.toggle(e)),"toggleClass"),Re=class{#e;constructor(t){this.#e=t}static fromString(t){return new Re(Oe(t))}addClass(...t){ua(this.element(),...t)}append(...t){t.forEach(e=>{e instanceof Re&&(e=e.element()),this.element().append(e)})}element(){return this.#e}emit(t){return qi(this.element(),t)}emitCustom(t,...e){return ha(this.element(),t,...e)}empty(){ga(this.element())}hasClass(t){return fa(this.element(),t)}off(t,e,s={}){xa(this.element(),t,e,s)}on(t,e,s={}){gi(this.element(),t,e,s)}onEach(t,e,s={}){va(this.element(),t,e,s)}once(t,e,s={}){ya(this.element(),t,e,s)}query(t){return this.element().querySelector(t)}queryAll(t){return this.element().querySelectorAll(t)}remove(){this.element().remove()}removeClass(...t){wa(this.element(),...t)}toggleClass(...t){_a(this.element(),...t)}};l(Re,"Element");var Us=l(i=>{let t=i.growth,e=parseInt(i.name.replace(/[^a-z]/gi,""),36).toString(2),s=new Array(t.size).fill(1),n=Oe('<div class="population"></div>'),[a,o]=Ft(i.yields,"Happiness","Unhappiness"),m=s.length-1;for(;o>0&&m>-1;)s[m--]=0,o--;for(m=0;a>0&&m<s.length;)s[m]===0&&(s[m]++,a--),s[m]===1&&(s[m++]++,a--),s[m]===2&&m++;return s.forEach((p,d)=>M.getScaled(`./assets/city/people_${["unhappy","content","happy"][p]}_${["f","m"][parseInt(e[d%e.length],10)]}.png`,2).then(h=>n.append(Oe('<span class="citizen"></span>',Oe(`<img src="${h.toDataURL("image/png")}">`))))),n},"renderPopulation"),Gt=l((i,t,e)=>`Progress ${i.progress.value} / ${i.cost.value} (${Ws(zs(i,t,e))})`,"renderProgress"),zs=l((i,t,e)=>Math.max(1,Math.ceil((i.cost.value-i.progress.value)/rt(t,e))),"turnsLeft"),Ws=l(i=>i+" turn"+(i===1?"":"s"),"turnsText"),Yi=l((i,t)=>i.yields.reduce(([e,s,n],a)=>{var m;let o=(m=Kt[t])==null?void 0:m.includes(a._);return o&&a.value>0&&(e+=a.value),o&&a.value<0&&(s+=a.value),o&&(n+=a.value),[e,s,n]},[0,0,0]),"yieldData"),qt=l(i=>new Array(Math.trunc(Math.abs(i.value))).fill(0).map(()=>{let t=Oe('<span class="yield-icon"></span>');return M.getScaled(`./assets/${at[Bt[i._]]}`,2).then(e=>t.append(Oe(`<img src="${e.toDataURL("image/png")}">`))),t}),"yieldImages");var Vi=y(w());var Xi,Qi=l(i=>Xi=i,"setPreloadContainer"),fi=l(i=>{let t=Xi.querySelector(`[data-path$="${i}.png"]`);return t===null?(console.error(`Missing image: ${i}.`),(0,Vi.s)("<canvas></canvas>")):t},"getPreloadedImage"),xi=fi;var Ji=y(w());var Ea=l((i,t,e)=>{let s=(0,Ji.s)("<canvas></canvas>"),n=s.getContext("2d");s.width=i.width,s.height=i.height,n.drawImage(i,0,0,i.width,i.height);let a=n.getImageData(0,0,s.width,s.height),o=l(d=>{var f;let h=null,g={r:0,g:0,b:0,a:0};return typeof d=="string"?(h=d.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?g={r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16),a:1}:(h=d.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?g={r:parseInt(h[1]+h[1],16),g:parseInt(h[2]+h[2],16),b:parseInt(h[3]+h[3],16),a:1}:(h=d.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:1}:(h=d.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:parseFloat((f=h[4])!=null?f:1)}):"length"in d&&(g={r:d[0]||0,g:d[1]||0,b:d[2]||0,a:d[3]||1}),g},"getColor"),m=t.map(o),p=e.map(o);for(let d=0;d<a.data.length;d+=4)m.forEach((h,g)=>{a.data[d]===h.r&&a.data[d+1]===h.g&&a.data[d+2]===h.b&&a.data[d+3]===h.a*255&&(a.data[d]=(p[g]||p[0]).r,a.data[d+1]=(p[g]||p[0]).g,a.data[d+2]=(p[g]||p[0]).b,a.data[d+3]=Math.trunc((p[g]||p[0]).a*255))});return n.putImageData(a,0,0),s},"replaceColours"),Ns=Ea;var Zi=y(w());var be,Ue,Yt,_e,Vt,Ee,V=class{constructor(t,e=2,s=16,n=(0,Zi.s)("<canvas></canvas>")){c(this,be,void 0);c(this,Ue,void 0);c(this,Yt,!0);c(this,_e,void 0);c(this,Vt,void 0);c(this,Ee,void 0);u(this,be,n),u(this,Ee,t),u(this,Vt,s),u(this,_e,e),this.setCanvasSize(),u(this,Ue,r(this,be).getContext("2d")),Qi(document.querySelector("#preload"))}canvas(){return r(this,be)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return r(this,Ue)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}renderTile({x:t,y:e}){let s=this.tileSize(),n=t*s,a=e*s;this.context().clearRect(n,a,s,s)}scale(){return r(this,_e)}tileSize(){return r(this,Vt)*r(this,_e)}update(t){t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}world(){return r(this,Ee)}drawImage(t,e,s,n={}){var d,h;let a=this.tileSize(),o=e*a,m=s*a,p=this.getPreloadedImage(t);this.putImage(n.augment?n.augment(p):p,o+((d=n.offsetX)!=null?d:0),m+((h=n.offsetY)!=null?h:0))}filterNeighbours(t,e,s=["n","e","s","w"]){return s.filter(n=>e(r(this,Ee).getNeighbour(t,n)))}getPreloadedImage(t){return fi(t)}putImage(t,e,s){r(this,Ue).imageSmoothingEnabled=!1,r(this,Ue).drawImage(t,e,s,t.width*r(this,_e),t.height*r(this,_e))}replaceColours(t,e,s){return Ns(t,e,s)}setCanvasSize(){r(this,be).height=r(this,Ee).height()*this.tileSize(),r(this,be).width=r(this,Ee).width()*this.tileSize()}isVisible(){return r(this,Yt)}setVisible(t){u(this,Yt,t)}};l(V,"Map"),be=new WeakMap,Ue=new WeakMap,Yt=new WeakMap,_e=new WeakMap,Vt=new WeakMap,Ee=new WeakMap;var er=V;var js=class extends V{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.city){let m=t.city,p=m.player,d=p.civilization,[h]=d.attributes.filter(g=>g.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(a,o,n,n)),this.context().fillStyle=h.value[0],this.context().fillRect(a+this.scale(),o+this.scale(),n-this.scale()*2,n-this.scale()*2),this.drawImage("map/city",e,s,{augment:g=>this.replaceColours(g,["#000"],[h.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}};l(js,"Cities");var Xt=js;var Qt=y(w());var Bs=class extends xe{constructor(t,e,s,n={}){var o,m;let a=b((0,Qt.s)(`<button>${(o=n.okLabel)!=null?o:"OK"}</button>`),{click:()=>{s(),this.close()},keydown:p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),p.stopPropagation(),s(),this.close())}});super(t,(0,Qt.s)(`<div class="content"><p>${e}</p></div>`,(0,Qt.s)("<footer></footer>",a,b((0,Qt.s)(`<button>${(m=n.cancelLabel)!=null?m:"Cancel"}</button>`),{click:()=>this.close(),keydown:p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),p.stopPropagation(),this.close())}}))),{...n,queue:!1}),a.focus()}};l(Bs,"ConfirmationWindow");var Ks=Bs;var ot,lt,Fs=class{constructor(t,e){c(this,ot,void 0);c(this,lt,[]);this.setIds(t),u(this,ot,s=>{let{detail:n}=s,a=n.value.objects;!a||r(this,lt).some(o=>o in a)&&document.addEventListener("dataupdated",o=>e(o.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",r(this,ot))}dispose(){document.removeEventListener("patchdatareceived",r(this,ot))}setIds(t){r(this,lt).splice(0,r(this,lt).length,...t)}};l(Fs,"DataObserver"),ot=new WeakMap,lt=new WeakMap;var Te=Fs;var Gs=class extends V{update(t){let e=[...t];return t.forEach(s=>{["n","ne","e","se","s","sw","w","nw"].forEach(n=>{let a=this.world().getNeighbour(s,n);e.includes(a)||e.push(a)})}),super.update(e)}};l(Gs,"TerrainAbstract");var B=Gs;var qs=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.terrain.features.length&&t.terrain.features.forEach(n=>n._==="Shield"?this.drawImage(`terrain/${n._.toLowerCase()}`,e,s,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${n._.toLowerCase()}`,e,s))}};l(qs,"Feature");var Ys=qs;var Vs=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;this.filterNeighbours(t,n=>n.terrain._==="Unknown").forEach(n=>this.drawImage(`map/fog_${n}`,e,s))}};l(Vs,"Fog");var Xs=Vs;var Qs=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=t.improvements.reduce((a,o)=>{let m=o._;return m in a&&(a[m]=!0),a},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(a=>{n[a]&&this.drawImage(`improvements/${a.toLowerCase()}`,e,s)}),n.Road){let a=this.filterNeighbours(t,m=>m.improvements.some(p=>p._==="Road"),["n","ne","e","se","s","sw","w","nw"]),o=this.filterNeighbours(t,m=>!!m.city||m.improvements.some(p=>p._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(a.forEach(m=>{(!n.Railroad||!o.includes(m))&&this.drawImage(`improvements/road_${m}`,e,s)}),n.Railroad&&o.forEach(m=>this.drawImage(`improvements/railroad_${m}`,e,s)),a.length===0&&o.length===0){let m=this.tileSize(),p=e*m,d=s*m,h=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=n.Railroad?"#000":"#8c5828",this.context().rect(p+h,d+h,this.scale()*2,this.scale()*2),this.context().fill()}}}};l(Qs,"Terrain");var Js=Qs;var Zs=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;!t.improvements.some(a=>a._==="Irrigation")||this.drawImage("improvements/irrigation",e,s)}};l(Zs,"Terrain");var en=Zs;var tr=y(w());var tn=class extends B{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,s);else if(t.isWater&&(this.drawImage("terrain/ocean",e,s),t.isCoast)){let m=this.getPreloadedImage("terrain/coast_sprite"),p=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(p>0){let d=p&7,h=p>>2&7,g=p>>4&7,f=p>>6&7|(p&1)<<2,v=(0,tr.s)('<canvas height="16" width="16"></canvas>'),E=v.getContext("2d");E.drawImage(m,d<<4,0,8,8,0,0,8,8),E.drawImage(m,(h<<4)+8,0,8,8,8,0,8,8),E.drawImage(m,(g<<4)+8,8,8,8,8,8,8,8),E.drawImage(m,f<<4,8,8,8,0,8,8,8),this.putImage(v,a,o)}this.filterNeighbours(t,d=>d.terrain._==="River").forEach(d=>this.drawImage(`terrain/river_mouth_${d}`,e,s))}}}};l(tn,"Land");var Jt=tn;var nr=y(sr()),ir=y(w());var Ta={playerId:null,scale:2,tileSize:16},O,W,We,Ne,es,mt,pt,ts,A,sn=class extends nr.EventEmitter{constructor(e,s,n=(0,ir.s)("<canvas></canvas>"),a={playerId:null,scale:2},...o){let m={...Ta,...a};super();c(this,O,void 0);c(this,W,{x:0,y:0});c(this,We,void 0);c(this,Ne,[]);c(this,es,null);c(this,mt,void 0);c(this,pt,void 0);c(this,ts,void 0);c(this,A,void 0);u(this,A,e),u(this,O,n),u(this,es,m.playerId),u(this,pt,m.tileSize),u(this,mt,m.scale),u(this,ts,s),o.forEach(p=>r(this,Ne).push(new p(r(this,A),this.scale(),r(this,pt)))),u(this,We,n.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){r(this,Ne).forEach(s=>s.update(e))}canvas(){return r(this,O)}center(){return r(this,W)}getLayer(e){var s;return(s=this.getLayers(e).shift())!=null?s:null}getLayers(e){return r(this,Ne).filter(s=>s instanceof e)}isVisible(e,s){let n=Math.floor(r(this,O).width/this.tileSize()),a=Math.floor(r(this,O).height/this.tileSize());if(n>=r(this,A).width()&&a>=r(this,A).height())return!0;let[o,m,p,d]=this.visibleBounds();return(n>=r(this,A).width()||(o>m?e<m||e>o:e<m&&e>o))&&(a>=r(this,A).height()||(p>d?s<d||s>p:s<d&&s>p))}playerId(){return r(this,es)}render(){let e=this.tileSize(),s=r(this,A).width()*e,n=r(this,W).x*e+Math.trunc(e/this.scale()),a=Math.trunc(r(this,O).width/2),o=r(this,A).height()*e,m=r(this,W).y*e+Math.trunc(e/this.scale()),p=Math.trunc(r(this,O).height/2),d=a-n,h=a+s,g=p-m,f=p+o;for(;d>0;)d-=s;for(;g>0;)g-=o;for(;h<r(this,O).width;)h+=s;for(;f<r(this,O).height;)f+=o;r(this,We).fillStyle="#000",r(this,We).fillRect(0,0,Math.max(r(this,A).width()*e,r(this,O).width),Math.max(r(this,A).height()*e,r(this,O).height));for(let v=d;v<h;v+=s)for(let E=g;E<f;E+=o)r(this,Ne).forEach(U=>{if(!U.isVisible())return;let j=U.canvas();r(this,We).drawImage(j,v,E,j.width,j.height)})}scale(){return r(this,mt)}setCenter(e,s){r(this,W).x=e,r(this,W).y=s,this.render(),this.emit("focus-changed",e,s)}tileSize(){return r(this,pt)*r(this,mt)}transport(){return r(this,ts)}visibleBounds(){let[{x:e,y:s},{x:n,y:a}]=this.visibleRange();return[e,n,s,a]}visibleRange(){let e=Math.floor(Math.floor(r(this,O).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,O).height/this.tileSize())/2);return[{x:(r(this,W).x-e+r(this,A).width())%r(this,A).width(),y:(r(this,W).y-s+r(this,A).height())%r(this,A).height()},{x:(r(this,W).x+e)%r(this,A).width(),y:(r(this,W).y+s)%r(this,A).height()}]}rawVisibleRange(){let e=Math.floor(Math.floor(r(this,O).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,O).height/this.tileSize())/2);return[{x:r(this,W).x-e,y:r(this,W).y-s},{x:r(this,W).x+e,y:r(this,W).y+s}]}world(){return r(this,A)}};l(sn,"Portal"),O=new WeakMap,W=new WeakMap,We=new WeakMap,Ne=new WeakMap,es=new WeakMap,mt=new WeakMap,pt=new WeakMap,ts=new WeakMap,A=new WeakMap;var nn=sn;var rn=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=this.filterNeighbours(t,a=>t.terrain._==="River"&&a.isWater||t.terrain._===a.terrain._).join("");t.terrain._!=="Ocean"&&(n?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${n}`,e,s):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,s))}};l(rn,"Terrain");var an=rn;var mn=y(w());var Ca={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},Ma=l((i,t=16)=>{var m,p;let e=i.player,s=e.civilization,[n]=s.attributes.filter(d=>d.name==="colors"),a=Ns(xi(`units/${i._.toLowerCase()}`),["#60E064","#2C7800"],n.value),o=a.getContext("2d");if(o.imageSmoothingEnabled=!1,(m=i.improvements)!=null&&m.some(d=>d._==="Fortified")&&o.drawImage(xi("map/fortify"),0,0),i.busy){let d=t/2,h=t*.75,g=(p=Ca[i.busy._])!=null?p:i.busy._.replace(/[a-z]+/g,"");o.font="bold 8px sans-serif",o.fillStyle="black",o.textAlign="center",o.fillText(g,d,h),o.fillStyle="white",o.fillText(g,d,h)}return a},"renderUnit"),on=Ma;var ss,ln=class extends mn.Element{constructor(e,s=2){super((0,mn.s)('<canvas width="32" height="32"></canvas>'));c(this,ss,2);u(this,ss,s),this.build(e)}build(e){let s=on(e),n=this.element().getContext("2d"),a=this.size(s.width),o=this.size(s.height),m=Math.floor((this.size(16)-a)/2),p=Math.floor((this.size(16)-o)/2);n.imageSmoothingEnabled=!1,n.drawImage(s,m,p,a,o)}element(){return super.element()}size(e){return e*r(this,ss)}};l(ln,"Unit"),ss=new WeakMap;var dt=ln;var pn=class extends we{constructor(t,e,s=()=>{}){super("Activate unit",t.map(n=>{var a,o;return{label:n._+" ["+((o=(a=n.city)==null?void 0:a.name)!=null?o:"NONE")+"]"+(n.busy?` (${n.busy._})`:""),value:n.id}}),n=>{let[a]=t.filter(o=>o.id===n);if(!!a){if(!a.active){e.send("action",{name:"InactiveUnit",id:n});return}s(a)}},null)}};l(pn,"UnitSelectionWindow");var dn=pn;var un,ct,Me,Le,Ie,cn=class{constructor(t){c(this,un,l((t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}),"#unknown"));c(this,ct,{});c(this,Me,void 0);c(this,Le,void 0);c(this,Ie,void 0);u(this,Le,t.height),u(this,Ie,t.width),u(this,Me,t.tiles||[])}get(t,e){for(;t<0;)t+=r(this,Ie);for(;e<0;)e+=r(this,Le);for(;t>=r(this,Ie);)t-=r(this,Ie);for(;e>=r(this,Le);)e-=r(this,Le);let s=[t,e].toString();if(!(s in r(this,ct))){let n=r(this,Me).findIndex(a=>a.x===t&&a.y===e);if(n===-1)return r(this,un).call(this,t,e);r(this,ct)[s]=n}return r(this,Me)[r(this,ct)[s]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return r(this,Le)}tiles(){return r(this,Me)}width(){return r(this,Ie)}setTiles(t){u(this,Me,t)}};l(cn,"World"),un=new WeakMap,ct=new WeakMap,Me=new WeakMap,Le=new WeakMap,Ie=new WeakMap;var hn=cn;var gn=class extends er{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.yields.reduce((g,f)=>g+f.value,0),p=t.yields.sort((g,f)=>g._.charCodeAt(0)-f._.charCodeAt(0)),d=0;if(m<5){let g=[[a,o],[a+n/2,o],[a,o+n/2],[a+n/2,o+n/2]];p.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[d++])});return}if(m<7){let g=[[a,o],[a+n/3,o],[a+n/3*2,o],[a,o+n/2],[a+n/3,o+n/2],[a+n/3*2,o+n/2]];p.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),g[d][0],g[d++][1])});return}if(m<9){let g=[[a,o],[a+n/4,o],[a+n/4*2,o],[a+n/4*3,o],[a,o+n/2],[a+n/4,o+n/2],[a+n/4*2,o+n/2],[a+n/4*3,o+n/2]];p.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[d++])});return}if(m<11){let g=[[a,o],[a+n/5,o],[a+n/5*2,o],[a+n/5*3,o],[a+n/5*4,o],[a,o+n/2],[a+n/5,o+n/2],[a+n/5*2,o+n/2],[a+n/5*3,o+n/2],[a+n/5*4,o+n/2]];p.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[d++])});return}let h=[[a,o],[a+n/6,o],[a+n/6*2,o],[a+n/6*3,o],[a+n/6*4,o],[a+n/6*5,o],[a,o+n/2],[a+n/6,o+n/2],[a+n/6*2,o+n/2],[a+n/6*3,o+n/2],[a+n/6*4,o+n/2],[a+n/6*5,o+n/2]];p.forEach(g=>{for(let f=0;f<g.value;f++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),...h[d++])})}};l(gn,"Yields");var ut=gn;var L=y(w());var fn=y(w());var je=class extends fn.Element{constructor(t,e,s=["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"]){super((0,fn.s)('<span class="supported-unit"></span>',new dt(e),...t.yields.filter(n=>s.includes(n._)).filter(n=>n.unit.id===e.id).flatMap(n=>qt(n))))}};l(je,"SupportedUnit");var La=l((i,t)=>t.filter(e=>Kt[i].includes(e._)).reduce(([e,s],n)=>[e+(n.value<0?-n.value:0),s+n.value],[0,0]),"reduceYield"),Ia=l(i=>(0,L.s)('<div class="yields-detail"></div>',...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>(0,L.s)(`<div class="yields" data-yields="${t.join(" ")}"></div>`,...t.map(e=>(0,L.s)(`<span class="yield" data-yield="${e}"></span>`,...La(e,i.yields).map((s,n)=>(0,L.s)(`<span class="${["used","free"][n]}"></span>`,...qt({_:e,value:s}))))))),...Object.entries(i.yields.filter(t=>!Object.keys(Bt).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>(0,L.s)(`<div><div>${t}</div><div>${e}</div></div>`))),"renderYields"),vi=l(i=>{let t=i.querySelectorAll(".yields-detail .yield");Array.from(t).forEach(e=>{let[s,n]=Array.from(e.children);for(;s.scrollWidth+n.scrollWidth>e.clientWidth;){let a=parseInt(e.getAttribute("data-max-width")||"14",10);if(a===0)break;e.setAttribute("data-max-width",(a-1).toString())}})},"resizeYields"),Pa=l((i,t,e)=>{let s=(0,L.s)("<canvas></canvas>"),n=new nn(new hn(t.player.world),e,s,{playerId:t.player.id,scale:i.scale(),tileSize:i.tileSize()/i.scale()},Jt,en,an,Js,Ys,Xs,Xt,ut);return s.height=i.tileSize()*5,s.width=i.tileSize()*5,n.setCenter(t.tile.x,t.tile.y),n.build(t.tiles),n.getLayer(ut).render(t.tilesWorked),n.render(),b((0,L.s)('<div class="city-map"></div>',s),{click:()=>e.send("action",{name:"ReassignWorkers",city:t.id})})},"renderMap"),Sa=l((i,t,e)=>(0,L.s)(`<div class="build"><header>Building ${i.build.building?i.build.building.item._:"nothing"}</header></div>`,b((0,L.s)(`<button>${i.build.building?"Change":"Choose"}</button>`),{click(){t()}}),b((0,L.s)("<button>Buy</button>"),{click(){e()}}),i.build.building?(0,L.s)(`<p>${Gt(i.build,i.yields,"Production")}</p>`):""),"renderBuild"),Da=l(i=>(0,L.s)(`<div class="growth"><header>Growth</header><p>Size ${i.growth.size.toString()}</p><p>${Gt(i.growth,i.yields,"Food")}</p></div>`),"renderGrowth"),ka=l(i=>(0,L.s)('<div class="improvements"></div>',(0,L.s)("<div></div>",...i.improvements.map(t=>(0,L.s)(`<div>${t._}</div>`,...i.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>qt(e)))))),"renderImprovements"),Ha=l((i,t)=>b((0,L.s)('<div class="garrisoned-units"><header>Garrisoned Units</header></div>',(0,L.s)('<div class="units"></div>',...i.tile.units.map(e=>new dt(e).element()))),{click(){let e=i.tile.units.filter(s=>s.player.id===i.player.id);e.length!==0&&new dn(e,t)}}),"renderGarrisonedUnits"),Aa=l(i=>(0,L.s)('<div class="supported-units"><header>Supported units</header></div>',(0,L.s)('<div class="units"></div>',...i.units.map(t=>new je(i,t)))),"renderSupportedUnits"),rr=l((i,t,e,s,n)=>(0,L.s)('<div class="city-screen"></div>',(0,L.s)('<div class="top-row"></div>',(0,L.s)('<div class="yield-details"></div>',Us(i),Ia(i),Aa(i)),Pa(t,i,e),ka(i)),(0,L.s)('<div class="bottom-row"></div>',Da(i),(0,L.s)('<div class="tabbed-details"></div>',(0,L.s)('<div class="info"></div>',Ha(i,e))),Sa(i,s,n))),"cityDetails"),ce,ht,ns,gt,xn=class extends z{constructor(e,s,n){super(e.name,rr(e,s,n,()=>this.changeProduction(),()=>this.completeProduction()),{canResize:!0,canMaximise:!0,size:"maximised"});c(this,ce,void 0);c(this,ht,void 0);c(this,ns,void 0);c(this,gt,void 0);setTimeout(()=>vi(this.element()),200),this.addClass("city-screen-window"),u(this,ce,e),u(this,ns,s),u(this,gt,n),u(this,ht,new Te([e.id,e.build.id,e.growth.id,...e.units.map(o=>o.id)],o=>{var p,d;let[m]=((d=(p=o.player)==null?void 0:p.cities)!=null?d:[]).filter(h=>e.id===h.id);if(!m){this.close();return}u(this,ce,m),r(this,ht).setIds([m.id,m.build.id,m.growth.id,...m.units.map(h=>h.id)]),this.update(rr(m,r(this,ns),n,()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus(),setTimeout(()=>vi(this.element()),200)})),this.on("keydown",o=>{["c","C"].includes(o.key)&&(this.changeProduction(),o.preventDefault(),o.stopPropagation()),["b","B"].includes(o.key)&&(this.completeProduction(),o.preventDefault(),o.stopPropagation()),["Enter","x","X"].includes(o.key)&&this.close()});let a=l(()=>setTimeout(()=>vi(this.element()),200),"resizeHandler");this.on("close",()=>window.removeEventListener("resize",a)),window.addEventListener("resize",a),this.on("close",()=>this.off("resize",a)),this.on("resize",a)}changeProduction(){new xt(r(this,ce).build,r(this,gt),()=>this.element().focus())}close(){r(this,ht).dispose(),super.close()}completeProduction(){!r(this,ce).build.building||new Ks("Are you sure?",`Do you want to rush building of ${r(this,ce).build.building.item._}`,()=>r(this,gt).send("action",{name:"CompleteProduction",id:r(this,ce).id}))}};l(xn,"City"),ce=new WeakMap,ht=new WeakMap,ns=new WeakMap,gt=new WeakMap;var ft=xn;var is,vn,vt=class extends ye{constructor(e,s,n=()=>{},a={}){let o=l(m=>Math.max(1,Math.ceil((m.cost.value-e.progress.value)/rt(e.city.yields,"Production"))),"turns");super(`What would you like to build in ${e.city.name}?`,e.available.map(m=>({label:`${m.item._} (Cost: ${m.cost.value} / ${o(m)} turn${o(m)===1?"":"s"})`,value:m.item._})),m=>{!m||(s.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:m||"@"}),this.close(!0))},null,{actions:a,displayAll:!0});c(this,is,void 0);c(this,vn,void 0);u(this,is,n),u(this,vn,s)}close(e=!1){super.close(),e&&r(this,is).call(this,e)}};l(vt,"CityBuildSelectionWindow"),is=new WeakMap,vn=new WeakMap,vt.showCityAction=l((e,s,n)=>({label:"View city",action(a){a.close(),new ft(e,s,n)}}),"showCityAction"),vt.showCityOnMapAction=l((e,s)=>({label:"Show on map",action(n){n.close(),s.setCenter(e.tile.x,e.tile.y)}}),"showCityOnMapAction");var xt=vt;var ar=y(w());var yt,yn=class extends q{constructor(e,s,n){super(e,n);c(this,yt,void 0);u(this,yt,s)}activate(){new xt(this.value(),this.transport(),()=>this.complete(),{showCity:xt.showCityAction(this.value().city,r(this,yt),this.transport()),showCityOnMap:xt.showCityOnMapAction(this.value().city,r(this,yt))})}build(){let e=this.value();M.get("./assets/city/production.png").then(s=>this.append((0,ar.s)(`<button class="cityBuild" title="What would you like to build in ${e.city.name}?" style="background-image:url('${s.uri}')">`)))}value(){return super.value()}};l(yn,"CityBuild"),yt=new WeakMap;var or=yn;var lr=y(w());var wn=class extends q{activate(){this.transport().send("action",{name:"EndTurn"})}build(){this.append((0,lr.s)('<button class="endTurn" title="End turn"></button>'))}};l(wn,"EndTurn");var mr=wn;var pr=y(w());var bn=class extends q{activate(){let t=new we("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){M.get("./assets/city/sad.png").then(t=>this.append((0,pr.s)(`<button class="chooseGovernment" title="Choose government" style="background-image:url('${t.uri}')"></button>`)))}value(){return super.value()}};l(bn,"Revolution");var dr=bn;var En,rs,as,_n=class{constructor(t=navigator.language,e=[...navigator.languages],s="en"){c(this,En,void 0);c(this,rs,void 0);c(this,as,void 0);u(this,rs,t||s),u(this,as,e.length>0?e.includes(s)?e:[...e,s]:t?[t,s]:[s]),u(this,En,s)}locale(){return r(this,rs)}locales(){return r(this,as)}list(t,e){return new Intl.ListFormat(this.locales(),{style:"long",type:"conjunction",...e}).format(t)}number(t,e){return new Intl.NumberFormat(this.locales(),{maximumFractionDigits:0,...e}).format(t)}percent(t,e){return this.number(t,{style:"percent",maximumFractionDigits:0,...e})}};l(_n,"LocaleProvider"),En=new WeakMap,rs=new WeakMap,as=new WeakMap;var ie=new _n;var Be=y(w());var $a=l((i,t)=>{let[e]=i.attributes.filter(s=>s.name===t);return e?e.value:null},"civilizationAttribute"),wt=$a;var os=class extends q{activate(){let t=this.value(),e=t.yields.reduce((p,d)=>d._ in p?d.value<0?(p[d._][1]+=Math.abs(d.value),p):(p[d._][0]+=d.value,p):p,{Energy:[0,0],LifeSupport:[0,0],Mass:[0,0],Population:[0,0]}),s=t.activeParts.reduce((p,d)=>(d._ in p&&p[d._]++,p),{Structural:0,Fuel:0,Propulsion:0,Habitation:0,LifeSupport:0,Power:0}),n=t.inactiveParts.reduce((p,d)=>(d._ in p&&p[d._]++,p),{Structural:0,Fuel:0,Propulsion:0,Habitation:0,LifeSupport:0,Power:0}),a=[["Chance of success",ie.percent(t.chanceOfSuccess)],["Flight time",ie.number(t.flightTime,{style:"unit",unit:"year",unitDisplay:"long"})],["Launched?",t.launched?"Yes":"No"],["Mass",ie.number(e.Mass[0]*1e3,{style:"unit",unit:"kilogram"})],["Population",ie.number(e.Population[0])],["Energy",ie.percent(e.Energy[1]>0?e.Energy[0]/e.Energy[1]:0)],["Life Support",ie.percent(e.LifeSupport[1]>0?e.LifeSupport[0]/e.LifeSupport[1]:0)]],o=l(()=>{this.transport().send("action",{name:"LaunchSpaceship",id:t.id}),m.close()},"launch"),m=new z(`${wt(t.player.civilization,"people")} spaceship`,(0,Be.s)("<div></div>",(0,Be.s)(`<dl>${Object.entries(s).map(([p,d])=>`<dd>${p}</dd><dt>${ie.number(d)}${n[p]===0?"":` <span class="inactive">(${n[p]} inactive)</span>`}</dt>`).join("")}</dl>`),(0,Be.s)(`<dl>${a.map(([p,d])=>`<dd>${p}</dd><dt>${d}</dt>`).join("")}</dl>`),(0,Be.s)("<footer></footer>",b((0,Be.s)(`<button${t.launched||t.chanceOfSuccess===0?" disabled":""}>${t.launched?"Launched":"Launch"}</button>`),{keydown(p){["Enter"," "].includes(p.key)&&o()},click(){o()}}))));m.addClass("spaceship")}build(){this.append((0,Be.s)('<button class="spaceship" title="View spaceship"></button>'))}value(){return super.value()}};l(os,"Spaceship");var ls,re,Tn=class extends Cn.Element{constructor(e=(0,Cn.s)('<div class="actions"></div>'),s,n){super(e);c(this,ls,void 0);c(this,re,void 0);u(this,ls,s),u(this,re,n),this.on("actioned",a=>a.detail.remove()),this.on("keydown",a=>{var g;let o=document.activeElement;if(!this.element().contains(o))return;let m=ve(a),p=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(m)||p.length===0)return;a.preventDefault(),a.stopPropagation();let d=o===this.element()?["ArrowLeft","ArrowUp"].includes(m)?o.firstElementChild:o.lastElementChild:o;for(;d.parentElement!==this.element();)d=d.parentElement;let h=p.indexOf(d);if(["ArrowUp","ArrowLeft"].includes(m)){if(h>0){(g=p[h-1].querySelector("button"))==null||g.focus();return}p.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(m)){if(h<p.length-1){p[h+1].querySelector("button").focus();return}p.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(s=>{let n;switch(s._){case"ActiveUnit":return;case"AdjustTradeRates":n=new Bi(s,r(this,re));break;case"ChooseResearch":n=new Gi(s,r(this,re));break;case"CityBuild":n=new or(s,r(this,ls),r(this,re));break;case"EndTurn":n=new mr(s,r(this,re));break;case"LaunchSpaceship":n=new os(s,r(this,re));break;case"Revolution":n=new dr(s,r(this,re));break;case"ChangeProduction":case"CompleteProduction":case"InactiveUnit":return;default:console.log("need to handle "+s._);return}this.element().prepend(b(n.element(),{click:()=>n.activate(),keydown:({key:a})=>{(a===" "||a==="Enter")&&n.activate()}}))})}};l(Tn,"Actions"),ls=new WeakMap,re=new WeakMap;var yi=Tn;var Ke,Mn=class extends V{constructor(){super(...arguments);c(this,Ke,null)}renderTile(e){super.renderTile(e);let{x:s,y:n}=e,a=this.tileSize(),o=s*a,m=n*a;if(e.units.length>0&&(r(this,Ke)!==null?r(this,Ke).tile.id!==e.id:!0)){let[p]=e.units.sort((h,g)=>{var f,v;return((f=g.defence)==null?void 0:f.value)-((v=h.defence)==null?void 0:v.value)}),d=this.renderUnit(p);e.units.length>1&&this.putImage(d,o-this.scale(),m-this.scale()),this.putImage(d,o,m)}}renderUnit(e){return on(e)}setActiveUnit(e){u(this,Ke,e)}activeUnit(){return r(this,Ke)}};l(Mn,"Units"),Ke=new WeakMap;var ms=Mn;var Ln=class extends ms{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:s}=t.tile,n=this.world().get(e,s),a=this.tileSize(),o=e*a,m=s*a,p=this.renderUnit(t);n.units.length>1&&this.putImage(p,o-this.scale(),m-this.scale()),this.putImage(p,o,m)}update(){this.render()}};l(Ln,"ActiveUnit");var wi=Ln;var In=class extends V{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.city,p=this.tileSize()/2,d=this.tileSize()*.75,h=this.tileSize()/2,g=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(m.growth.size.toString(),a+p+this.scale(),o+d),this.context().fillText(m.name,a+h+this.scale(),o+g),this.context().fillStyle="white",this.context().fillText(m.growth.size.toString(),a+p,o+d-this.scale()),this.context().fillText(m.name,a+h,o+g-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}};l(In,"CityNames");var bi=In;var Fe=y(w());var Ra=l(async i=>{let[t,e,s,n,a,o]=["Food","Production","Trade","Research","Gold","Luxuries"].map(v=>Yi(i,v)),[m,p,d,h,g,f]=await Promise.all(["Food","Production","Trade","Research","Gold","Luxuries"].map(v=>M.getScaled(`./assets/${at[v]}`,2).then(E=>`<img src="${E.toDataURL("image/png")}">`)));return[(0,Fe.s)(`<header>${i.name}</header>`),(0,Fe.s)(`<div class="growth"><strong>${i.growth.size}</strong> ${m} ${t[2]} [${t[0]}] (${Ws(zs(i.growth,i.yields,"Food"))})</div>`),(0,Fe.s)(`<div class="build">${p} ${e[2]} [${e[0]}] ${i.build.building?i.build.building.item._:"Nothing"}${i.build.building?` (${Ws(zs(i.build,i.yields,"Production"))})`:""}</div>`),(0,Fe.s)(`<div class="yields">${[[s,d],[n,h],[a,g],[o,f]].filter(([[v]])=>v!==0).map(([[v,,E],U])=>`${U} ${E}${E!==v?` [${v}]`:""}`).join(", ")}</div>`)]},"buildCityRow"),Ge,bt,ps,ds,Pn=class extends z{constructor(e,s,n){super("City details",(0,Fe.s)('<div class="loading"></div>'));c(this,Ge,void 0);c(this,bt,void 0);c(this,ps,void 0);c(this,ds,void 0);this.addClass("city-status"),u(this,Ge,e.cities),u(this,bt,new Te([e.id,...e.cities.flatMap(({id:a,build:o,growth:m})=>[a,m.id,o.id])],a=>{let o=a.player;u(this,Ge,o.cities),r(this,bt).setIds([o.id,...o.cities.flatMap(({id:m,build:p,growth:d})=>[m,d.id,p.id])]),this.update()})),u(this,ps,s),u(this,ds,n),this.update()}close(){return r(this,bt).dispose(),super.close()}update(){Promise.all(r(this,Ge).map(e=>Ra(e))).then(e=>super.update((0,Fe.s)("<table></table>",...e.map(([s,n,a,o],m)=>{let p=document.createElement("tr");return p.append(...[[s,"th"],[n,"td"],[a,"td"],[o,"td"]].map(([d,h])=>{let g=document.createElement(h);return g.append(d),g})),b(p,{click:()=>new ft(r(this,Ge)[m],r(this,ps),r(this,ds))})}))))}};l(Pn,"CityStatus"),Ge=new WeakMap,bt=new WeakMap,ps=new WeakMap,ds=new WeakMap;var cr=Pn;var Dn=y(w());var cs,us,Sn=class extends Dn.Element{constructor(e,s,n){super(e);c(this,cs,void 0);c(this,us,void 0);u(this,cs,s),u(this,us,n)}build(){this.empty(),this.append((0,Dn.s)(`<h3><span class="year">${this.year()}</span><span class="turn">${r(this,cs).value.toString()}</span></h3>`))}year(e=r(this,us).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};l(Sn,"GameDetails"),cs=new WeakMap,us=new WeakMap;var ur=Sn;var hr=y(w());var kn=class extends nn{bindEvents(){(0,hr.on)(this.canvas(),"click",t=>{let e=this.center(),s={x:Math.floor(this.canvas().width/2-this.tileSize()/2),y:Math.floor(this.canvas().height/2-this.tileSize()/2)},n=e.x+Math.trunc(((t.offsetX-s.x)/this.tileSize()+this.world().width())%this.world().width()),a=e.y+Math.trunc(((t.offsetY-s.y)/this.tileSize()+this.world().height())%this.world().height()),o=this.world().get(n,a),m=o.units.filter(p=>p.player.id===this.playerId());if(o.city&&o.city.player.id===this.playerId())new ft(o.city,this,this.transport());else if(m.length){new dn(m,this.transport(),p=>this.emit("activate-unit",p));return}this.setCenter(o.x,o.y)})}};l(kn,"GamePortal");var gr=kn;var Hn=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,s)}};l(Hn,"Terrain");var fr=Hn;var hs=y(w());var Oa=l(async i=>{let t={CityImprovementContent:s=>s.cityImprovement._,MartialLaw:s=>new dt(s.unit),MilitaryUnhappiness:s=>new je(i,s.unit,["MilitaryUnhappiness"])},e=i.yields.reduce((s,n)=>(n._ in t&&s.push(t[n._](n)),s),[]);return(0,hs.s)(`<div class="city"><div class="name">${i.name}</div></div>`,Us(i),(0,hs.s)('<div class="reasons"></div>',...e))},"buildCityRow"),_t,Et,An=class extends z{constructor(e){super("Happiness report",(0,hs.s)("<div></div>"));c(this,_t,void 0);c(this,Et,void 0);this.addClass("happiness-report"),u(this,_t,new Te([e.id,...e.cities.map(s=>s.id)],s=>{u(this,Et,s.player),r(this,_t).setIds([e.id,...e.cities.map(n=>n.id)]),this.update()})),u(this,Et,e),this.update()}close(){return r(this,_t).dispose(),super.close()}update(){Promise.all(r(this,Et).cities.map(e=>Oa(e))).then(e=>super.update((0,hs.s)("<div></div>",...e)))}};l(An,"HappinessReport"),_t=new WeakMap,Et=new WeakMap;var xr=An;var qe,Pe,$n=class{constructor(t=500){c(this,qe,!1);c(this,Pe,[]);setInterval(()=>this.check(),t)}check(){r(this,qe)||r(this,Pe).forEach(t=>t())}clear(){u(this,Pe,[])}off(t){u(this,Pe,r(this,Pe).filter(e=>e!==t))}on(t){r(this,Pe).push(t)}pause(){u(this,qe,!0)}isPaused(){return r(this,qe)}resume(){u(this,qe,!1)}};l($n,"IntervalHandler"),qe=new WeakMap,Pe=new WeakMap;var vr=$n;var ae=y(w());var gs,fs,Rn=class{constructor(t,...e){c(this,gs,void 0);c(this,fs,void 0);u(this,gs,e),u(this,fs,t)}args(){return r(this,gs)}channel(){return r(this,fs)}};l(Rn,"Request"),gs=new WeakMap,fs=new WeakMap;var Se=Rn;var On=class extends Se{constructor(t){super("getOptions",t)}};l(On,"Options");var yr=On;var N=y(w());var Tt,Ye,Un=class extends z{constructor(e,s){super("Customise world",(0,N.s)('<div class="customise-world"></div>'));c(this,Tt,void 0);c(this,Ye,void 0);u(this,Tt,s),u(this,Ye,e),this.init()}build(){super.build(),this.init()}async init(){var h,g,f,v,E,U;let e=await r(this,Ye).request(new yr(["players","height","width","landCoverage","landSize","maxIterations"])),s=(0,N.s)(`<input name="players" type="number" value="${(h=e.players)!=null?h:7}" step="1" min="1" max="20">`),n=(0,N.s)(`<input name="height" type="number" value="${(g=e.height)!=null?g:60}" step="1" min="1">`),a=(0,N.s)(`<input name="width" type="number" value="${(f=e.width)!=null?f:80}" step="1" min="1">`),o=(0,N.s)(`<input name="landCoverage" type="number" value="${(v=e.landCoverage)!=null?v:.4}" step="0.01" min="0">`),m=(0,N.s)(`<input name="landSize" type="number" value="${(E=e.landSize)!=null?E:.2}" step="0.01" min="0">`),p=(0,N.s)(`<input name="maxIterations" type="number" value="${(U=e.maxIterations)!=null?U:20}" step="1" min="1">`),d=l(async()=>{this.close(),await r(this,Ye).request(new Se("setOptions",{players:s.value,height:n.value,width:a.value,landCoverage:o.value,landSize:m.value,maxIterations:p.value})),r(this,Ye).send("start"),r(this,Tt)&&r(this,Tt).call(this)},"submit");this.update((0,N.s)('<div class="customise-world"></div>',(0,N.s)('<div class="option"><label>Players</label></div>',s),(0,N.s)('<div class="option"><label>Height</label></div>',n),(0,N.s)('<div class="option"><label>Width</label></div>',a),(0,N.s)('<div class="option"><label>Land coverage</label></div>',o),(0,N.s)('<div class="option"><label>Land size</label></div>',m),(0,N.s)('<div class="option"><label>Max iterations</label></div>',p),b((0,N.s)("<button>Build</button>"),{click:()=>d()}))),this.on("keydown",j=>{j.key==="Enter"&&d()})}};l(Un,"CustomiseWorldWindow"),Tt=new WeakMap,Ye=new WeakMap;var wr=Un;var zn=class extends ye{constructor(t,e,s,n="Please choose one of the following:",a={canClose:!1,displayAll:!1}){super(t,e,s,n,{...a,displayAll:!0})}display(){return new Promise(t=>{this.on("selection",({detail:e})=>t(e)),super.display()})}};l(zn,"MandatorySelection");var br=zn;var Ct=class extends br{constructor(t,e){super("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],async s=>{this.close(),await t.request(new Se("setOptions",{width:80,height:60,players:parseInt(s,10)})),e&&await e(),t.send("start")})}};l(Ct,"NewGameWindow");var _r=Ct;var Wn=class extends Ct{constructor(t,e){super(t,async()=>{e&&await e(),await t.request(new Se("setOptions",{width:80,height:50,earth:!0}))})}};l(Wn,"EarthWindow");var Er=Wn;var Nn=class{constructor(){this.blob=null;this.ptr=-1}fromString(t,e){this.blob=t,this.ptr=0,this.decode(e)}getUByte(){return this.blob.charCodeAt(this.ptr++)}getUShort(){let t=this.getUByte();return(this.getUByte()<<8)+t}getShort(){return(this.getUShort()+32768)%65536-32768}getString(t){let e=this.ptr;return this.ptr+=t,this.blob.substr(e,t)}decode(t){if(this.blob===null){console.warn("file has not been loaded!");return}console.warn("The decode function should be overwritten"),t&&t()}};l(Nn,"BinFile");var Tr=Nn;var jn=class{constructor(t){this.dicTable=[];this.dicTable=[],this.dicSize=1<<t;for(let e=0;e<this.dicSize;e++)e<256?this.dicTable[e]=[e]:this.dicTable[e]=null;this.curPos=257}getEntry(t){return t<this.curPos?this.dicTable[t]:null}isFull(){return this.curPos===this.dicTable.length}getCurPos(){return this.curPos}addEntry(t){return this.curPos<this.dicTable.length&&(this.dicTable[this.curPos]=t,this.curPos++),this.curPos-1}};l(jn,"LZWDictionary");var Cr=jn;var Bn=class{static parseByteStreamToIndexes(t,e,s){let n=[],a=0,o=0,m=1,p=1,d=256,h=0,g=0;for(;e>0;){for(;o<8+m;)a|=t.getUByte()<<o,e--,o+=8;for(;o>=8+m;)g=a&(p<<8&65280|255),a>>=8+m,o-=8+m,h++,h==d&&(h=0,m+=1,p<<=1,p|=1,d<<=1,8+m>s&&(h=0,m=1,p=1,d=256)),n.push(g)}return n}static decode(t,e){e=e||11;let s=t,n=[];for(;s.length>0;){let a=new Cr(e),o=[s[0]],m=s[0],p=a.getEntry(m),d=m,h,g=0;for(;!a.isFull()&&g++<s.length-1;){h=s[g];let f=[];h>=a.getCurPos()?(f=a.getEntry(m),f===null&&console.error(`No dictionary entry in LZW special case: oldCode=${m}; newCode=${h}; i=${g}; buffer=${p}`),f=[...f??[],d]):f=a.getEntry(s[g]),o.push.apply(o,f),d=f[0],a.addEntry(p.concat(d)),m=h,p=a.getEntry(m)}n.push.apply(n,o),s=s.slice(g+1)}return n}static RLEDecode(t){let e=[],s=0,n=!1;for(let a=0;a<t.length;a++){let o=t[a];if(n){if(o==0)s=144,e.push(144);else for(let m=0;m<o-1;m++)e.push(s);n=!1}else o==144?n=!0:(e.push(o),s=o)}return e}};l(Bn,"LZW");var Kn=Bn;var Ua=l(i=>i&15,"lowerNibble"),Mr=Ua;var za=l(i=>(i&240)>>4,"upperNibble"),Lr=za;var Fn=class extends Tr{constructor(){super(...arguments);this.palette=[];this.palette16=[{r:255,g:255,b:255,a:0},{r:170,g:0,b:0,a:255},{r:0,g:170,b:0,a:255},{r:170,g:170,b:0,a:255},{r:0,g:0,b:170,a:255},{r:0,g:0,b:0,a:255},{r:0,g:85,b:170,a:255},{r:170,g:170,b:170,a:255},{r:85,g:85,b:85,a:255},{r:255,g:85,b:85,a:255},{r:85,g:255,b:85,a:255},{r:255,g:255,b:85,a:255},{r:85,g:85,b:255,a:255},{r:255,g:85,b:255,a:255},{r:85,g:255,b:255,a:255},{r:255,g:255,b:255,a:255}];this.imageData=null;this.imageHeight=0;this.imageWidth=0;this.byteMode=11}decode(e){let s=this.getString(2),n=this.getShort();if(s=="M0")this.getPaletteData(),s=this.getString(2),n=this.getShort();else{console.log("Creating a random color palette...");for(let a=0;a<256;a++)a<16?this.palette.push(this.palette16[a]):this.palette.push({r:Math.floor(Math.random()*256),g:Math.floor(Math.random()*256),b:Math.floor(Math.random()*256),a:255})}s=="X0"?this.getX0ImageData(n):s=="X1"?this.getX1ImageData(n):console.error('"'+s+'" is an unknown chunk type'),e&&e()}getPaletteData(){let e=this.getUByte(),s=this.getUByte(),n=s-e+1,a=!1;for(let o=0;o<n;o++){let m={r:this.getUByte()*4,g:this.getUByte()*4,b:this.getUByte()*4,a:255};this.palette.push(m),m.r===m.g&&m.g===m.b&&m.r===0&&(a||(m.a=0),a=!0)}this.palette.push({r:0,g:0,b:0,a:0})}getX0ImageData(e){this.imageWidth=this.getShort(),this.imageHeight=this.getShort(),this.byteMode=this.getUByte();let s=Kn.parseByteStreamToIndexes(this,e-5,this.byteMode),n=Kn.decode(s,this.byteMode);this.imageData=Kn.RLEDecode(n)}getX1ImageData(e){this.getX0ImageData(e);let s=this.imageData;this.imageData=[];for(let n=0;n<s.length;n++)this.imageData.push(Mr(s[n])),this.imageData.push(Lr(s[n]));this.palette=this.palette16}draw(e,s=0,n=0){let a=e.getImageData(0,0,this.imageWidth,this.imageHeight),o=0;for(let m=0;m<this.imageHeight;m++)for(let p=0;p<this.imageWidth;p++){let d=this.imageData[o],h=(p+m*this.imageWidth)*4;a.data[h]=this.palette[d].r,a.data[h+1]=this.palette[d].g,a.data[h+2]=this.palette[d].b,a.data[h+3]=this.palette[d].a,o++}e.putImageData(a,s,n)}getPixel(e,s){return this.imageData?this.imageData[e+this.imageWidth*s]:0}};l(Fn,"PicImage");var Ir=Fn;var Pr=l((i,t,e,s,n=a=>console.log(a))=>{let a=s(320,200),o=new Ir,m=[];return o.fromString(i,()=>{o.draw(a.getContext("2d",{willReadFrequently:!0})),Object.entries(t).forEach(([p,d])=>d.forEach(h=>h.contents.forEach(g=>{let f={...e,...h,...g},v=`./assets/${p+f.name}.png`,E=s(f.width,f.height),U=E.getContext("2d",{willReadFrequently:!0});U.clearRect(0,0,f.width,f.height),U.drawImage(a,f.x,f.y,f.width,f.height,0,0,f.width,f.height);for(let j=0;j<a.width;j++)for(let ue=0;ue<a.height;ue++){let Ae=U.getImageData(j,ue,1,1).data;Ae[0]==f.clear.r&&Ae[1]==f.clear.g&&Ae[2]==f.clear.b&&U.clearRect(j,ue,1,1)}n(`Processing ${v}...`),m.push({name:v,uri:E.toDataURL("image/png")})})))}),m},"extractSprites");var xs={defaults:{height:16,width:16,clear:{r:0,g:170,b:170}},files:{"SP257.PIC":{"cursor/go":[{y:33,x:33,height:12,width:12,contents:[{name:""}]}],"city/pollution":[{y:32,x:48,contents:[{name:""}]}],"improvements/irrigation":[{y:32,x:64,contents:[{name:""}]}],"improvements/mine":[{y:32,x:80,contents:[{name:""}]}],"improvements/pollution":[{y:32,x:96,contents:[{name:""}]}],"cursor/torch":[{y:33,x:113,height:13,width:13,contents:[{name:""}]}],"city/food":[{y:33,x:129,height:7,width:7,contents:[{name:""}]}],"city/production":[{y:33,x:137,height:7,width:7,contents:[{name:""}]}],"city/trade":[{y:33,x:145,height:7,width:7,contents:[{name:""}]}],"city/gold":[{y:33,x:153,height:7,width:7,contents:[{name:""}]}],"city/bulb":[{y:41,x:129,height:7,width:7,contents:[{name:""}]}],"city/sad":[{y:41,x:137,height:7,width:7,contents:[{name:""}]}],"city/luxury":[{y:41,x:145,height:7,width:7,contents:[{name:""}]}],"terrain/":[{y:41,x:153,height:7,width:7,contents:[{name:"shield"}]}],"improvements/road":[{y:48,contents:[{name:"_n",x:0},{name:"_ne",x:16},{name:"_e",x:32},{name:"_se",x:48},{name:"_s",x:64},{name:"_sw",x:80},{name:"_w",x:96},{name:"_nw",x:112}]}],"status/science":[{y:48,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"status/pollution":[{y:56,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"terrain/land":[{y:64,contents:[{name:"",x:0}]}],"terrain/river":[{y:64,contents:[{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:224},{name:"_nesw",x:240}]}],"units/combat":[{y:97,height:15,width:15,contents:[{name:"_1",x:1},{name:"_2",x:17},{name:"_3",x:33},{name:"_4",x:49},{name:"_5",x:65},{name:"_6",x:81},{name:"_7",x:97},{name:"_8",x:113}]}],"improvements/railroad":[{y:96,contents:[{name:"_n",x:128},{name:"_ne",x:144},{name:"_e",x:160},{name:"_se",x:176},{name:"_s",x:192},{name:"_sw",x:208},{name:"_w",x:224},{name:"_nw",x:240}]}],"terrain/oasis":[{y:113,height:15,width:15,contents:[{name:"",x:1}]}],"terrain/horse":[{y:113,height:15,width:15,contents:[{name:"",x:17}]}],"terrain/doe":[{y:113,height:15,width:15,contents:[{name:"",x:49}]}],"terrain/coal":[{y:113,height:15,width:15,contents:[{name:"",x:65}]}],"terrain/gold":[{y:113,height:15,width:15,contents:[{name:"",x:81}]}],"terrain/game":[{y:113,height:15,width:15,contents:[{name:"",x:97}]}],"terrain/seal":[{y:113,height:15,width:15,contents:[{name:"",x:113}]}],"terrain/oil":[{y:113,height:15,width:15,contents:[{name:"",x:129}]}],"terrain/gems":[{y:113,height:15,width:15,contents:[{name:"",x:145}]}],"terrain/fish":[{y:113,width:15,height:15,contents:[{name:"",x:161}]}],"map/city":[{y:113,contents:[{name:"",x:193}]}],"map/fortify":[{width:15,height:15,y:113,contents:[{name:"",x:209}]}],"map/fort":[{width:15,height:15,y:113,contents:[{name:"",x:225}]}],"map/hut":[{y:113,height:15,width:15,contents:[{name:"",x:241}]}],"city/people":[{y:128,height:16,width:8,contents:[{name:"_happy_m",x:0},{name:"_happy_f",x:8},{name:"_content_m",x:16},{name:"_content_f",x:24},{name:"_unhappy_m",x:32},{name:"_unhappy_f",x:40},{name:"_tax",x:48},{name:"_science",x:56},{name:"_luxury",x:64}]}],"map/fog":[{y:128,contents:[{name:"_n",x:80},{name:"_e",x:96},{name:"_s",x:112},{name:"_w",x:128}]}],"units/":[{y:161,height:15,width:15,contents:[{name:"settlers",x:1},{name:"warrior",x:17},{name:"spearman",x:33},{name:"swordman",x:49},{name:"musketman",x:65},{name:"rifleman",x:81},{name:"horseman",x:97},{name:"knight",x:113},{name:"catapult",x:129},{name:"cannon",x:145},{name:"chariot",x:161},{name:"tank",x:177},{name:"mechanizedinfantry",x:193},{name:"artillery",x:209},{name:"fighter",x:225},{name:"bomber",x:241},{name:"trireme",x:257},{name:"sail",x:273},{name:"frigate",x:289},{name:"ironclad",x:305}]},{y:177,contents:[{name:"cruiser",x:1},{name:"battleship",x:17},{name:"submarine",x:33},{name:"carrier",x:49},{name:"transport",x:65},{name:"nuclear",x:81},{name:"diplomat",x:97},{name:"caravan",x:113}]}],"general/texture":[{y:176,contents:[{name:"_1",x:288},{name:"_2",x:304}]}]},"TER257.PIC":{"terrain/desert":[{y:0,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/plains":[{y:16,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/grassland":[{y:32,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/forest":[{y:48,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/hills":[{y:64,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/mountains":[{y:80,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/tundra":[{y:96,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/arctic":[{y:112,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/swamp":[{y:128,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/jungle":[{y:144,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/ocean":[{y:160,contents:[{name:"",x:0}]}],"terrain/coast_sprite":[{x:0,y:176,height:16,width:128,contents:[{name:""}]}],"terrain/river":[{y:160,contents:[{name:"",x:240}]},{y:176,contents:[{name:"_mouth_n",x:128},{name:"_mouth_e",x:144},{name:"_mouth_s",x:160},{name:"_mouth_w",x:176}]}]}}};var vs=y(w());var Mt,K,Gn=class extends z{constructor(){let e=(0,vs.s)('<input type="file" multiple>'),s=(0,vs.s)('<p class="loading" hidden></p>');super("Import assets",(0,vs.s)(`<div class="import-assets"><p>Upload ${Object.keys(xs.files).join(", ")} from the original Civilization files to extract assets (these will be stored locally). This process can take at least a few minutes.</p><div class="brave" ${navigator!=null&&navigator.brave?"":" hidden"}><p>It looks like you're using Brave and due to the use of <code>HTMLCanvasElement</code>'s <code>getImageData</code> and <code>toDataURL</code> functions, please put Shields down while importing, and playing, otherwise any colour-replaced icons won't look correct. <strong>Remember to put them back up after!</strong></p><p><a href="https://brave.com/privacy-updates/4-fingerprinting-defenses-2.0/#2-fingerprinting-protections-20-farbling-for-great-good" target="_blank">Read more about "farbling".</a></p></div></div>`,(0,vs.s)("<p></p>",b(e,{change:n=>this.handleFileUpload(n)})),s));c(this,Mt,void 0);c(this,K,void 0);u(this,Mt,e),u(this,K,s)}async handleFileUpload(e){var p;r(this,K).removeAttribute("hidden"),r(this,K).style.color="inherit";let s=Array.from((p=e.target.files)!=null?p:[]),n=s.map(d=>d.name),a=Object.keys(xs.files);if(!a.map(d=>new RegExp(d,"i")).every(d=>n.some(h=>h.match(d)))){r(this,K).style.color="#f00",r(this,K).innerText=`Please provide all files to generate assets: ${a.join(", ")}.`;return}r(this,Mt).setAttribute("disabled",""),r(this,K).innerText="Building image assets...";let m=[];if(await Promise.all(s.map(async d=>new Promise(h=>{let g=xs.files[d.name.toUpperCase()];if(!g){console.warn(`No definitions found for ${d.name}, skipping.`);return}let f=new FileReader;f.addEventListener("load",async v=>{Pr(v.target.result,g,xs.defaults,(E,U)=>{let j=document.createElement("canvas");return j.width=E,j.height=U,j},E=>{r(this,K).innerText=E}).forEach(E=>m.push(E)),h()}),f.readAsBinaryString(d)}))),r(this,K).innerText="Writing to database...",await Promise.all(m.map(d=>M.set(d))),!await M.hasAllAssets()){console.error("Something went wrong..."),r(this,K).style.color="#f00",r(this,K).innerText="Not all expected data was written. Might need to try again... Missing: "+(await M.missingAssets()).join(", "),r(this,Mt).removeAttribute("disabled");return}r(this,K).innerText="Done! Please reload the page to utilise the fresh assets.",location.reload()}};l(Gn,"ImportAssetsWindow"),Mt=new WeakMap,K=new WeakMap;var Sr=Gn;var Dr="0.1.0@8cae915";var De,qn=class extends ae.Element{constructor(e,s){super(e);c(this,De,void 0);u(this,De,s),this.build(),this.addClass("active")}async build(e=!1){let s=await M.hasAllAssets();s||(console.log("Missing assets:"),console.log(await M.missingAssets())),this.append(b((0,ae.s)("<nav></nav>",b((0,ae.s)(`<button autofocus${s?"":" hidden"}>Start a New Game</button>`),{click:()=>{new _r(r(this,De),()=>this.remove())}}),b((0,ae.s)(`<button${s?"":" hidden"}>Earth</button>`),{click:()=>new Er(r(this,De),()=>this.remove())}),b((0,ae.s)(`<button${s?"":" hidden"}>Customise World</button>`),{click:async()=>new wr(r(this,De),()=>this.remove())}),b((0,ae.s)("<button>Import Assets</button>"),{click:()=>new Sr}),b((0,ae.s)(`<button${e?"":" hidden"}>Quit</button>`),{click:()=>{this.remove(),r(this,De).send("quit")}})),{keydown(n){let a=document.activeElement,o=ve(n);a===null||!a.matches("#mainmenu nav button")||(o==="ArrowDown"&&a.nextElementSibling&&a.nextElementSibling.focus(),o==="ArrowUp"&&a.previousElementSibling&&a.previousElementSibling.focus())}}),(0,ae.s)(`<footer>version: ${Dr}</footer>`))}remove(){this.removeClass("active"),setTimeout(()=>super.remove(),2e3)}};l(qn,"MainMenu"),De=new WeakMap;var kr=qn;var Hr=y(w());var X,J,Ve,Lt,oe,Yn=class{constructor(t,e,s,...n){c(this,X,void 0);c(this,J,void 0);c(this,Ve,void 0);c(this,Lt,void 0);c(this,oe,void 0);u(this,J,t),u(this,oe,e),u(this,Lt,s),u(this,Ve,n),u(this,X,r(this,J).getContext("2d")),(0,Hr.on)(r(this,J),"click",a=>{let o=a.offsetX-r(this,J).offsetLeft,m=a.offsetY-r(this,J).offsetTop,p=Math.ceil(o/r(this,J).offsetWidth*r(this,oe).width()),d=Math.ceil(m/r(this,J).offsetHeight*r(this,oe).height());r(this,Lt).setCenter(p,d),this.update()})}update(){let t=r(this,Ve)[0].canvas().height*(190/r(this,Ve)[0].canvas().width);r(this,J).height=t,r(this,X).clearRect(0,0,190,t),r(this,Ve).forEach(n=>r(this,X).drawImage(n.canvas(),0,0,190,t));let[e,s]=r(this,Lt).rawVisibleRange();r(this,X).lineWidth=1,r(this,X).strokeStyle="#fff",r(this,X).fillStyle="rgba(255, 255, 255, .2)",r(this,X).rect(Math.floor(190/r(this,oe).width()*e.x),Math.floor(t/r(this,oe).height()*e.y),Math.floor(190/r(this,oe).width()*(s.x-e.x)),Math.floor(t/r(this,oe).height()*(s.y-e.y))),r(this,X).stroke(),r(this,X).fill()}};l(Yn,"Minimap"),X=new WeakMap,J=new WeakMap,Ve=new WeakMap,Lt=new WeakMap,oe=new WeakMap;var Ar=Yn;var ys,It,Vn=class{constructor(t=document.body){c(this,ys,void 0);c(this,It,[]);u(this,ys,t)}receive(t){r(this,It).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!r(this,It).length||t)return;let e=r(this,It).shift();this.publish(e)}publish(t){var s;new Rs((s=t.title)!=null?s:"Notification",t.message,{parent:r(this,ys)}).on("close",()=>this.check())}};l(Vn,"Notifications"),ys=new WeakMap,It=new WeakMap;var $r=Vn;var Pt=y(w());var ws,Xn=class extends Pt.Element{constructor(e,s){super(e);c(this,ws,void 0);u(this,ws,s)}build(){this.empty();let{civilization:e,treasury:s,research:n,cities:a}=r(this,ws),[o,m]=a.reduce(([d,h],g)=>{let[f,v]=Ft(g.yields,"Gold","Research");return[d+f,h+v]},[0,0]),p=Math.ceil((n.cost.value-n.progress.value)/m);this.append((0,Pt.s)(`<h3>${e.leader.name} of the ${wt(e,"people")} empire</h3>`),(0,Pt.s)(`<p><strong>Researching</strong><br/>${n.researching?`${n.researching._} ${n.progress.value} / ${n.cost.value} (${m} / turn - ${p} turn${p===1?"":"s"})`:`Nothing (${m} / turn)`}</p>`),(0,Pt.s)(`<p><strong>Treasury</strong><br/>${s.value} (${o} / turn)</p>`))}};l(Xn,"PlayerDetails"),ws=new WeakMap;var Rr=Xn;var Or=l(i=>i.cities.reduce((t,e)=>t.concat(e.yields),[]),"combinedYields");var _i=y(w());var ja=l(async(i,t)=>{let e=await M.getScaled(`./assets/${at.Research}`,2).then(s=>`<img src="${s.toDataURL("image/png")}">`);return(0,_i.s)(`<div><p><strong>Researching ${i.researching?i.researching._:"Nothing"}</strong>${i.researching?` ${Gt(i,t,"Research")}`:""}</p><p>${e} ${rt(t,"Research")} / turn</p><div class="discovered">${i.complete.map(s=>`<div>${s._}</div>`).join("")}</div></div>`)},"template"),St,Xe,Qn=class extends z{constructor(e){super("Player research",(0,_i.s)("<div></div>"));c(this,St,void 0);c(this,Xe,void 0);u(this,Xe,e),this.addClass("science-report"),this.update(),u(this,St,new Te([e.id,e.research.id,...e.cities.map(s=>s.id)],s=>{let n=s.player;r(this,St).setIds([n.id,n.research.id,...n.cities.map(a=>a.id)]),u(this,Xe,n),this.update()}))}close(){return r(this,St).dispose(),super.close()}update(){ja(r(this,Xe).research,Or(r(this,Xe))).then(e=>super.update(e))}};l(Qn,"ScienceReport"),St=new WeakMap,Xe=new WeakMap;var Ur=Qn;var le=y(w());var D,Jn=class extends le.Element{constructor(e,s){super(e);c(this,D,void 0);u(this,D,s),this.build()}build(){var e,s;this.empty(),r(this,D)!==null&&this.append((0,le.s)(`<p>${r(this,D)._} (${r(this,D).tile.x}, ${r(this,D).tile.y})</p>`),(0,le.s)(`<p>${(s=(e=r(this,D).city)==null?void 0:e.name)!=null?s:"NONE"}</p>`),(0,le.s)(`<p>${Number.isInteger(r(this,D).moves.value)?r(this,D).moves.value:r(this,D).moves.value.toFixed(2)} / ${r(this,D).movement.value} moves</p>`),(0,le.s)(`<p>A: ${r(this,D).attack.value} / D: ${r(this,D).defence.value} / V: ${r(this,D).visibility.value}</p>`),(0,le.s)(`<p>${r(this,D).improvements.map(n=>n._).join(", ")}</p>`),(0,le.s)(`<p>${r(this,D).tile.terrain._}${r(this,D).tile.terrain.features?" "+r(this,D).tile.terrain.features.map(n=>n._).join(", "):""}${r(this,D).tile.improvements.length?" ("+r(this,D).tile.improvements.map(n=>n._).join(", ")+")":""}</p>`),(0,le.s)(`<p>${r(this,D).tile.units.filter(n=>n!==r(this,D)).map(n=>n._).join(", ")}</p>`))}};l(Jn,"UnitDetails"),D=new WeakMap;var zr=Jn;var ke,Zn=class{constructor(t){c(this,ke,void 0);u(this,ke,t)}init(){let t=r(this,ke);M.hasAllAssets().then(s=>{!s||M.getScaled("./assets/cursor/torch.png",2).then(n=>document.body.style.cursor=`url('${n.toDataURL("image/png")}'), default`)}),(0,Qe.on)(document,"keypress",s=>{if(s.key==="F5"||["R","r"].includes(s.key)&&s.ctrlKey){s.preventDefault(),new Ks("Quit","Are you sure you want to reload?",()=>window.location.reload());return}});let e={autoEndOfTurn:!0};try{let s=document.getElementById("notification"),n=document.querySelector("#mainmenu"),a=document.getElementById("actions"),o=document.getElementById("other-actions"),m=document.getElementById("game"),p=document.getElementById("map"),d=p.querySelector("canvas"),h=document.getElementById("gameDetails"),g=document.getElementById("playerDetails"),f=document.getElementById("minimap"),v=document.getElementById("unitInfo"),E=document.getElementById("preload"),U=new $r,j=new kr(n,r(this,ke)),ue=l((C,$,he,me)=>{let ge=new zr(v,C);if(Q=C,ge.build(),he.setActiveUnit(C),he.render(),he.setVisible(!0),me.setActiveUnit(C),me.render(),me.setVisible(!0),C===null){$.render();return}F=C,he.update([...F!=null&&F.tile?[F.tile]:[],C.tile]),$.isVisible(C.tile.x,C.tile.y)||$.setCenter(C.tile.x,C.tile.y),$.render()},"setActiveUnit");M.getAll().then(C=>C.forEach($=>E.append(b((0,Qe.s)(`<img src="${$.uri}" data-path="${$.name}">`),{error:()=>console.error(`There was a problem preloading '${$.name}', you may have some missing details.`)}))));let Ae=[],bs,F=null,Q=null;t.receive("notification",C=>{s.innerHTML=C,bs&&window.clearTimeout(bs),bs=window.setTimeout(()=>{bs=void 0,s.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([C,$])=>t.receive(C,he=>{let{choices:me}=Ts(he);new we($,me.map(({_:ge})=>({label:ge,value:ge})),ge=>t.send(C,ge),$,{displayAll:!0})}));let H;t.receiveOnce("gameData",C=>{try{H=Ts(C),new Rs("Welcome",(0,Qe.s)(`<div class="welcome">
<p>${H.player.civilization.leader.name}, you have risen to become leader of the ${wt(H.player.civilization,"people")}.</p>
<p>Your people have knowledge of ${ie.list(["Irrigation","Mining","Roads",...H.player.research.complete.map(_=>_._)])}.</p>
</div>`)),m.classList.add("active"),d.width=d.parentElement.offsetWidth,d.height=d.parentElement.offsetHeight;let $=[],he=2,me=new hn(H.player.world),ge=new vr,I=new gr(me,t,d,{playerId:H.player.id,scale:he,tileSize:16},Jt,en,an,Js,Ys,fr,Xs,ut,ms,Xt,bi,wi),Br=I.getLayer(Jt),si=I.getLayer(ut),Dt=I.getLayer(ms),ni=I.getLayer(Xt),Ei=I.getLayer(bi),Je=I.getLayer(wi),ii=new Ar(f,me,I,Br,ni,Je),Ti=new yi(a,I,r(this,ke)),Kr=new yi(o,I,r(this,ke));si.setVisible(!1),I.on("focus-changed",()=>ii.update()),I.on("activate-unit",_=>ue(_,I,Dt,Je)),ge.on(()=>{Je.setVisible(!Je.isVisible()),I.build(Ae.splice(0)),I.render()}),(0,Qe.on)(window,"resize",()=>{d.width=d.parentElement.offsetWidth,d.height=d.parentElement.offsetHeight});let ri=l(_=>{H=Ts(_),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:H}})),Ti.build(H.player.mandatoryActions),Kr.build(H.player.actions.filter(S=>!["ActiveUnit","ChangeProduction","ChooseProduction","ChooseResearch","CityBuild","CompleteProduction","InactiveUnit"].includes(S._))),m.append(Ti.element()),me.setTiles(H.player.world.tiles),new ur(h,H.turn,H.year).build(),new Rr(g,H.player).build(),$=H.player.actions.filter(S=>S._==="ActiveUnit");let[k]=$.sort(({value:S},{value:R})=>R===F?1:S===F?-1:(I.isVisible(R.tile.x,R.tile.y)?1:0)-(I.isVisible(S.tile.x,S.tile.y)?1:0));if(F!==(k==null?void 0:k.value)&&(F=null),ue(F!=null&&F.active?F:k?k.value:null,I,Dt,Je),I.build(Ae.splice(0)),I.render(),ii.update(),e.autoEndOfTurn&&H.player.mandatoryActions.length===1&&H.player.mandatoryActions.every(S=>S._==="EndTurn")){t.send("action",{name:"EndTurn"});return}},"handler");ri(C),t.receive("gameData",_=>ri(_));let Fr=l(_=>_.replace(/]/g,"").split(/[.[]/),"pathToParts"),Ci=l((_,P)=>{let T=Fr(P),k=T.pop();return[T.reduce((R,_s)=>!R||!(_s in R)?null:R[_s],_),k]},"getPenultimateObject"),Gr=l((_,P,T)=>{let[k,S]=Ci(_,P);if(!k||!S){console.warn(`unable to set ${P} of ${_} (${S})`);return}k[S]=T},"setObjectPath"),qr=l((_,P)=>{let[T,k]=Ci(_,P);if(!T||!k){console.warn(`unable to set ${P} of ${_} (${k})`);return}delete T[k]},"removeObjectPath");t.receive("gameDataPatch",_=>{_.forEach(P=>Object.entries(P).forEach(([T,{type:k,index:S,value:R}])=>{if(k==="add"||k==="update"){if(!R.hierarchy){console.error("No hierarchy"),console.error(R);return}S?Gr(C.objects[T],S,R.hierarchy):C.objects[T]=R.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:R}})),Object.entries(R.objects).forEach(([_s,ai])=>{C.objects[_s]=ai,ai._==="PlayerTile"&&Ae.push(ai)})}if(k==="remove"){if(S){qr(C.objects[T],S);return}delete C.objects[T]}})),ri(C)}),t.receive("gameNotification",_=>U.receive(_));let Mi={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},Li={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},Ii={F1:()=>new cr(H.player,I,t),F4:()=>new xr(H.player),F6:()=>new Ur(H.player)},Pi="";(0,Qe.on)(document,"keydown",_=>{let P=ve(_);if(P in Ii&&(Ii[_.key](),_.preventDefault()),Q){if(P in Mi){let T=[...Mi[P]];for(;T.length;){let k=T.shift(),[S]=Q.actions.filter(R=>R._===k);if(S){t.send("action",{name:"ActiveUnit",id:Q.id,unitAction:S._,target:S.to.id}),_.stopPropagation(),_.preventDefault();return}}}if(P in Li){let[T]=Q.actionsForNeighbours[Li[P]];if(T){t.send("action",{name:"ActiveUnit",id:Q.id,unitAction:T._,target:T.to.id}),_.stopPropagation(),_.preventDefault();return}}}if(P==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(P==="Enter"&&H.player.mandatoryActions.some(T=>T._==="EndOfTurn")){t.send("action",{name:"EndTurn"}),_.stopPropagation(),_.preventDefault();return}if(P==="Tab"){let T=a.querySelector("div.action:first-child button");if(T!==null){T.focus(),_.preventDefault(),_.stopPropagation();return}}if(P==="c"&&Q){I.setCenter(Q.tile.x,Q.tile.y),I.render(),ii.update();return}if(P==="w"&&Q&&$.length>1){let T=$.map(R=>R.value),k=T.indexOf(Q),S=T[k===T.length-1?0:k+1];ue(S,I,Dt,Je)}if(P==="t"){Dt.setVisible(!Dt.isVisible()),ni.setVisible(!ni.isVisible()),Ei.setVisible(!Ei.isVisible()),I.render();return}if(P==="y"){si.setVisible(!si.isVisible()),I.render();return}if(Pi==="%"&&P==="^"){t.send("cheat",{name:"RevealMap"});return}Pi=P})}catch($){console.error($)}})}catch(s){console.error(s)}}};l(Zn,"Renderer"),ke=new WeakMap;var Wr=Zn;var ei=class{async request(t){return new Promise(e=>{this.send(t.channel(),...t.args()),this.receiveOnce(t.channel(),s=>e(s))})}};l(ei,"AbstractTransport");var Nr=ei;var He,ti=class extends Nr{constructor(e){super();c(this,He,void 0);u(this,He,e)}receive(e,s){r(this,He).addEventListener("message",({data:{channel:n,data:a}})=>{n===e&&s(a)})}receiveOnce(e,s){let n=l(({data:{channel:a,data:o}})=>{a===e&&(s(o),r(this,He).removeEventListener("message",n))},"onceHandler");r(this,He).addEventListener("message",n)}send(e,s){r(this,He).postMessage({channel:e,data:s})}};l(ti,"WorkerTransport"),He=new WeakMap;var jr=ti;var Ba=new Wr(new jr(new Worker("dist/backend.js")));Ba.init();})();
//# sourceMappingURL=frontend.js.map
