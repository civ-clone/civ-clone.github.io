"use strict";(()=>{var Wr=Object.create;var Zn=Object.defineProperty;var Nr=Object.getOwnPropertyDescriptor;var jr=Object.getOwnPropertyNames;var Br=Object.getPrototypeOf,Kr=Object.prototype.hasOwnProperty;var l=(i,t)=>Zn(i,"name",{value:t,configurable:!0});var bi=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var Gr=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of jr(t))!Kr.call(i,n)&&n!==e&&Zn(i,n,{get:()=>t[n],enumerable:!(s=Nr(t,n))||s.enumerable});return i};var w=(i,t,e)=>(e=i!=null?Wr(Br(i)):{},Gr(t||!i||!i.__esModule?Zn(e,"default",{value:i,enumerable:!0}):e,i));var _i=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var r=(i,t,e)=>(_i(i,t,"read from private field"),e?e.call(i):t.get(i)),c=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},u=(i,t,e,s)=>(_i(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var b=bi(x=>{"use strict";var fs,Fr=x&&x.__classPrivateFieldSet||function(i,t,e,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(i,e):n?n.value=e:t.set(i,e),e},qr=x&&x.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(x,"__esModule",{value:!0}),x.Element=x.toggleClass=x.t=x.s=x.removeClass=x.once=x.onEach=x.on=x.off=x.hasClass=x.empty=x.emitCustom=x.emit=x.addClass=void 0;x.addClass=(i,...t)=>i.classList.add(...t);x.emit=(i,t)=>i.dispatchEvent(t);x.emitCustom=(i,t,...e)=>(0,x.emit)(i,new CustomEvent(t,{detail:e}));x.empty=i=>{for(var t;i.hasChildNodes();)(t=i.firstChild)===null||t===void 0||t.remove()};x.hasClass=(i,t)=>i.classList.contains(t);x.off=(i,t,e,s={})=>i.removeEventListener(t,e,s);x.on=(i,t,e,s={})=>i.addEventListener(t,e,s);x.onEach=(i,t,e,s={})=>t.forEach(n=>(0,x.on)(i,n,e,s));x.once=(i,t,e,s={})=>(0,x.on)(i,t,e,Object.assign(Object.assign({},typeof s=="boolean"?{capture:s}:s),{once:!0}));x.removeClass=(i,...t)=>i.classList.remove(...t);x.s=(i,...t)=>{let e=document.createElement("div");e.innerHTML=i;let s=e.firstElementChild;return t.forEach(n=>{n instanceof me?s.append(n.element()):n instanceof Node?s.append(n):s.append((0,x.t)(n))}),s};x.t=i=>document.createTextNode(i);x.toggleClass=(i,...t)=>t.forEach(e=>i.classList.toggle(e));var me=class{constructor(t){fs.set(this,void 0),Fr(this,fs,t,"f")}static fromString(t){return new me((0,x.s)(t))}addClass(...t){(0,x.addClass)(this.element(),...t)}append(...t){t.forEach(e=>{e instanceof me&&(e=e.element()),this.element().append(e)})}element(){return qr(this,fs,"f")}emit(t){return(0,x.emit)(this.element(),t)}emitCustom(t,...e){return(0,x.emitCustom)(this.element(),t,...e)}empty(){(0,x.empty)(this.element())}hasClass(t){return(0,x.hasClass)(this.element(),t)}off(t,e,s={}){(0,x.off)(this.element(),t,e,s)}on(t,e,s={}){(0,x.on)(this.element(),t,e,s)}onEach(t,e,s={}){(0,x.onEach)(this.element(),t,e,s)}once(t,e,s={}){(0,x.once)(this.element(),t,e,s)}query(t){return this.element().querySelector(t)}queryAll(t){return this.element().querySelectorAll(t)}remove(){this.element().remove()}removeClass(...t){(0,x.removeClass)(this.element(),...t)}toggleClass(...t){(0,x.toggleClass)(this.element(),...t)}};l(me,"o");x.Element=me,fs=new WeakMap,x.default=me});var Fi=bi(Oe=>{"use strict";var re,_e=Oe&&Oe.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.EventEmitter=void 0;var Vt=class{constructor(){re.set(this,{})}on(t,e){t in _e(this,re,"f")||(_e(this,re,"f")[t]=[]),_e(this,re,"f")[t].push(e)}once(t,e){let s=l((...n)=>{e(...n),this.off(t,s)},"i");this.on(t,s)}off(t,e){if(!(t in _e(this,re,"f")))return;let s=_e(this,re,"f")[t].indexOf(e);s!==-1&&_e(this,re,"f")[t].splice(s,1)}emit(t,...e){t in _e(this,re,"f")&&_e(this,re,"f")[t].forEach(s=>s(...e))}};l(Vt,"i");Oe.EventEmitter=Vt,re=new WeakMap,Oe.default=Vt});var Ye=w(b());var xs=l(({hierarchy:i,objects:t},e=null)=>{let s=new Map;e&&Object.keys(t).forEach(a=>e.push(a));let n=l(a=>{if(s.has(a))return s.get(a);if(Array.isArray(a)){let o=[];return s.set(a,o),a.forEach(m=>o.push(n(m))),o}if(a&&a["#ref"]){if(e&&e.splice(e.indexOf(a["#ref"]),1),!(a["#ref"]in t))throw new TypeError(`missing ${a["#ref"]}`);let o=n(t[a["#ref"]]);return s.set(a,o),o}if(a instanceof Object){let o={};return s.set(a,o),Object.entries(a).forEach(([m,d])=>{o[m]=n(d)}),o}return a},"getReferences");return n(i)},"reconstituteData");var fn=w(b());var vs=w(b());var It,Pt,ys=class extends vs.Element{constructor(e,s){super((0,vs.s)('<div class="action"></div>'));c(this,It,void 0);c(this,Pt,void 0);u(this,It,e),u(this,Pt,s),this.on("keydown",n=>{n.key!=="Escape"&&n.stopPropagation()}),this.build()}activate(){}build(){}complete(){this.emit(new CustomEvent("actioned",{bubbles:!0,detail:this}))}transport(){return r(this,Pt)}value(){return r(this,It).value}};l(ys,"Action"),It=new WeakMap,Pt=new WeakMap;var ee=ys;var bs=w(b());var Yr=l((i,t)=>(0,bs.s)(`<fieldset><legend>${i}</legend><input type="range" max="100" min="0" step="1" value="${t}"><input type="number"><label><input type="checkbox">Lock</label></fieldset>`),"template"),St,q,te,Xe,Dt,ws=class extends bs.Element{constructor(e,s){super(Yr(e,s));c(this,St,void 0);c(this,q,void 0);c(this,te,void 0);c(this,Xe,void 0);c(this,Dt,[]);u(this,St,e),u(this,q,this.element().querySelector('input[type="range"]')),u(this,te,this.element().querySelector('input[type="number"]')),u(this,Xe,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(r(this,q).value),r(this,q).addEventListener("input",()=>this.set(r(this,q).value)),r(this,te).addEventListener("input",()=>this.set(r(this,te).value)),r(this,Xe).addEventListener("input",()=>this.lock()),this.lock()}label(){return r(this,St)}lock(){if(this.isLocked()){r(this,q).setAttribute("disabled",""),r(this,te).setAttribute("disabled","");return}r(this,q).removeAttribute("disabled"),r(this,te).removeAttribute("disabled")}onInput(e){r(this,Dt).push(e)}isLocked(){return r(this,Xe).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),r(this,q).value!==e&&(r(this,q).value=e),r(this,te).value!==e&&(r(this,te).value=e),r(this,Dt).forEach(s=>s())}value(){return parseInt(r(this,q).value,10)}};l(ws,"LockedSlider"),St=new WeakMap,q=new WeakMap,te=new WeakMap,Xe=new WeakMap,Dt=new WeakMap;var Ei=ws;var he,_s=class{constructor(...t){c(this,he,void 0);u(this,he,t),r(this,he).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let s=r(this,he).filter(a=>a!==e),n=s.filter(a=>!a.isLocked());if(this.total()!==100&&n.length===0){e.set((100-this.total(s)).toString());return}if(this.total()>100){let a=this.total()-100,o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()-Math.min(o,a)).toString()),a-=o}),this.total()>100&&e.set((100-this.total(s)).toString())}if(this.total()<100){let a=100-this.total(),o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()+Math.min(o,a)).toString()),a-=o}),this.total()<100&&e.set((100-this.total(s)).toString())}}))}sliders(){return r(this,he)}total(t=r(this,he)){return t.reduce((e,s)=>e+s.value(),0)}};l(_s,"LockedSliderGroup"),he=new WeakMap;var Ti=_s;var Es=w(b());var Qe,kt=class extends Es.Element{constructor(e,s=(0,Es.s)("<div></div>")){super(s);c(this,Qe,void 0);this.on("keydown",n=>{n.stopPropagation()}),this.element().setAttribute("tabindex","0"),u(this,Qe,e)}build(){}display(){this.build(),r(this,Qe).append(this.element())}parent(){return r(this,Qe)}};l(kt,"TransientElement"),Qe=new WeakMap;var F=w(b());var _=l((i,t)=>(Object.entries(t).forEach(([e,s])=>i.addEventListener(e,s)),i),"h");var Ci={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},He,Ht,Je=class extends kt{constructor(e,s,n={}){var a;super((a=n.parent)!=null?a:Ci.parent,(0,F.s)('<div class="window"></div>'));c(this,He,void 0);c(this,Ht,void 0);if(this.options={...Ci,...n},u(this,He,s),u(this,Ht,e),this.options.size==="auto"&&this.addClass("size-auto"),this.options.size==="maximised"&&this.addClass("maximised"),this.options.size!=="auto"&&["height","width"].forEach(o=>{let m=this.options.size[o];if(typeof m=="number"){this.element().style[o]=m+"px";return}this.element().style[o]=m}),this.options.position==="auto"&&this.addClass("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([o,m])=>{this.element().style[m]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[o]))+"px"}),this.options.autoDisplay){this.display();return}this.build()}build(){this.empty();let e=[[this.options.canMaximise,_((0,F.s)('<button class="maximise" aria-label="Maximise">Maximise</button>'),{click:()=>this.maximise()})],[this.options.canClose,_((0,F.s)('<button class="close" aria-label="Close">Maximise</button>'),{click:()=>this.close()})]].filter(([n])=>n).map(([,n])=>n),s=!1;this.append(_((0,F.s)(`<header><h3>${r(this,Ht)}</h3></header>`,...e),{dblclick:()=>this.maximise(),mousedown:n=>{if(n.target.matches("button, button img"))return;s=!0;let a=l(o=>{!s||this.move({x:o.movementX,y:o.movementY})},"moveHandler");(0,F.on)(document,"mousemove",a),(0,F.on)(document,"mouseup",()=>{(0,F.off)(document,"mousemove",a),s=!1},{once:!0})}}),(0,F.s)('<div class="body"></div>',r(this,He)instanceof Node?r(this,He):(0,F.s)(`<p>${r(this,He)}</p>`))),this.on("keydown",n=>{n.key==="Escape"&&this.options.canClose&&this.close(),n.stopPropagation()})}close(){this.remove(),this.emit(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||(this.element().classList.toggle("maximised"),this.emit(new CustomEvent("resize",{bubbles:!1})))}move({x:e,y:s}){if(this.hasClass("position-auto")){e+=this.element().offsetLeft,s+=this.element().offsetTop,this.removeClass("position-auto"),this.element().style.setProperty("top",s+"px"),this.element().style.setProperty("left",e+"px");return}let n=getComputedStyle(this.element()),a=parseInt(n.getPropertyValue("top"),10),o=parseInt(n.getPropertyValue("left"),10);this.element().style.setProperty("top",a+s+"px"),this.element().style.setProperty("left",o+e+"px")}update(e){this.element().lastElementChild.remove(),this.append(e instanceof Node?e:(0,F.s)(`<p>${e}</p>`))}};l(Je,"Window"),He=new WeakMap,Ht=new WeakMap;var j=Je;var Vr=l((i,t)=>t.some(e=>i instanceof e),"instanceOfAny"),Mi,Li;function Xr(){return Mi||(Mi=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}l(Xr,"getIdbProxyableTypes");function Qr(){return Li||(Li=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}l(Qr,"getCursorAdvanceMethods");var Ii=new WeakMap,ti=new WeakMap,Pi=new WeakMap,ei=new WeakMap,ni=new WeakMap;function Jr(i){let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("success",a),i.removeEventListener("error",o)},"unlisten"),a=l(()=>{e(se(i.result)),n()},"success"),o=l(()=>{s(i.error),n()},"error");i.addEventListener("success",a),i.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Ii.set(e,i)}).catch(()=>{}),ni.set(t,i),t}l(Jr,"promisifyRequest");function Zr(i){if(ti.has(i))return;let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("complete",a),i.removeEventListener("error",o),i.removeEventListener("abort",o)},"unlisten"),a=l(()=>{e(),n()},"complete"),o=l(()=>{s(i.error||new DOMException("AbortError","AbortError")),n()},"error");i.addEventListener("complete",a),i.addEventListener("error",o),i.addEventListener("abort",o)});ti.set(i,t)}l(Zr,"cacheDonePromiseForTransaction");var si={get(i,t,e){if(i instanceof IDBTransaction){if(t==="done")return ti.get(i);if(t==="objectStoreNames")return i.objectStoreNames||Pi.get(i);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return se(i[t])},set(i,t,e){return i[t]=e,!0},has(i,t){return i instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in i}};function Si(i){si=i(si)}l(Si,"replaceTraps");function ea(i){return i===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){let s=i.call(Ts(this),t,...e);return Pi.set(s,t.sort?t.sort():[t]),se(s)}:Qr().includes(i)?function(...t){return i.apply(Ts(this),t),se(Ii.get(this))}:function(...t){return se(i.apply(Ts(this),t))}}l(ea,"wrapFunction");function ta(i){return typeof i=="function"?ea(i):(i instanceof IDBTransaction&&Zr(i),Vr(i,Xr())?new Proxy(i,si):i)}l(ta,"transformCachableValue");function se(i){if(i instanceof IDBRequest)return Jr(i);if(ei.has(i))return ei.get(i);let t=ta(i);return t!==i&&(ei.set(i,t),ni.set(t,i)),t}l(se,"wrap");var Ts=l(i=>ni.get(i),"unwrap");function ki(i,t,{blocked:e,upgrade:s,blocking:n,terminated:a}={}){let o=indexedDB.open(i,t),m=se(o);return s&&o.addEventListener("upgradeneeded",d=>{s(se(o.result),d.oldVersion,d.newVersion,se(o.transaction),d)}),e&&o.addEventListener("blocked",d=>e(d.oldVersion,d.newVersion,d)),m.then(d=>{a&&d.addEventListener("close",()=>a()),n&&d.addEventListener("versionchange",p=>n(p.oldVersion,p.newVersion,p))}).catch(()=>{}),m}l(ki,"openDB");var sa=["get","getKey","getAll","getAllKeys","count"],na=["put","add","delete","clear"],ii=new Map;function Di(i,t){if(!(i instanceof IDBDatabase&&!(t in i)&&typeof t=="string"))return;if(ii.get(t))return ii.get(t);let e=t.replace(/FromIndex$/,""),s=t!==e,n=na.includes(e);if(!(e in(s?IDBIndex:IDBObjectStore).prototype)||!(n||sa.includes(e)))return;let a=l(async function(o,...m){let d=this.transaction(o,n?"readwrite":"readonly"),p=d.store;return s&&(p=p.index(m.shift())),(await Promise.all([p[e](...m),n&&d.done]))[0]},"method");return ii.set(t,a),a}l(Di,"getMethod");Si(i=>({...i,get:(t,e,s)=>Di(t,e)||i.get(t,e,s),has:(t,e)=>!!Di(t,e)||i.has(t,e)}));var de,ne,At=class{constructor(t,e,s){c(this,de,void 0);c(this,ne,void 0);u(this,ne,e),u(this,de,ki(t,1,{upgrade:n=>n.createObjectStore(r(this,ne),s)}))}async get(t){return(await r(this,de)).get(r(this,ne),t)}async getAll(t,e){return(await r(this,de)).getAll(r(this,ne),t,e)}async set(t,e){return(await r(this,de)).put(r(this,ne),t,e)}async clear(){return(await r(this,de)).clear(r(this,ne))}async keys(){return(await r(this,de)).getAllKeys(r(this,ne))}};l(At,"Store"),de=new WeakMap,ne=new WeakMap;var ia=l((i,t,e)=>{let s=document.createElement("canvas"),n=s.getContext("2d");return s.width=i.width*t,s.height=i.height*t,e!=null&&e.smoothing||(n.imageSmoothingEnabled=!1),n.drawImage(i,0,0,s.width,s.height),s},"scaleImage"),Hi=ia;var Ze,et,tt,Ms,Cs=class extends At{constructor(){super("civ-clone-assets","assets",{keyPath:"name"});c(this,Ze,new Map);c(this,et,new Map);c(this,tt,new Map);c(this,Ms,["./assets/city/bulb.png","./assets/city/food.png","./assets/city/gold.png","./assets/city/luxury.png","./assets/city/people_content_f.png","./assets/city/people_content_m.png","./assets/city/people_happy_f.png","./assets/city/people_happy_m.png","./assets/city/people_luxury.png","./assets/city/people_science.png","./assets/city/people_tax.png","./assets/city/people_unhappy_f.png","./assets/city/people_unhappy_m.png","./assets/city/pollution.png","./assets/city/sad.png","./assets/city/production.png","./assets/city/trade.png","./assets/cursor/go.png","./assets/cursor/torch.png","./assets/general/texture_1.png","./assets/general/texture_2.png","./assets/improvements/irrigation.png","./assets/improvements/mine.png","./assets/improvements/pollution.png","./assets/improvements/railroad_e.png","./assets/improvements/railroad_se.png","./assets/improvements/railroad_n.png","./assets/improvements/railroad_ne.png","./assets/improvements/railroad_nw.png","./assets/improvements/railroad_s.png","./assets/improvements/railroad_sw.png","./assets/improvements/railroad_w.png","./assets/improvements/road_e.png","./assets/improvements/road_n.png","./assets/improvements/road_ne.png","./assets/improvements/road_nw.png","./assets/improvements/road_s.png","./assets/improvements/road_se.png","./assets/improvements/road_sw.png","./assets/improvements/road_w.png","./assets/map/city.png","./assets/map/fog_e.png","./assets/map/fog_n.png","./assets/map/fog_s.png","./assets/map/fog_w.png","./assets/map/fort.png","./assets/map/fortify.png","./assets/map/hut.png","./assets/status/pollution_0.png","./assets/status/pollution_25.png","./assets/status/pollution_50.png","./assets/status/pollution_75.png","./assets/status/science_0.png","./assets/status/science_25.png","./assets/status/science_50.png","./assets/status/science_75.png","./assets/terrain/arctic.png","./assets/terrain/arctic_e.png","./assets/terrain/arctic_es.png","./assets/terrain/arctic_esw.png","./assets/terrain/arctic_ew.png","./assets/terrain/arctic_n.png","./assets/terrain/arctic_ne.png","./assets/terrain/arctic_nes.png","./assets/terrain/arctic_nesw.png","./assets/terrain/arctic_new.png","./assets/terrain/arctic_ns.png","./assets/terrain/arctic_nsw.png","./assets/terrain/arctic_nw.png","./assets/terrain/arctic_s.png","./assets/terrain/arctic_sw.png","./assets/terrain/arctic_w.png","./assets/terrain/coal.png","./assets/terrain/coast_sprite.png","./assets/terrain/desert.png","./assets/terrain/desert_e.png","./assets/terrain/desert_es.png","./assets/terrain/desert_esw.png","./assets/terrain/desert_ew.png","./assets/terrain/desert_n.png","./assets/terrain/desert_ne.png","./assets/terrain/desert_nes.png","./assets/terrain/desert_nesw.png","./assets/terrain/desert_new.png","./assets/terrain/desert_ns.png","./assets/terrain/desert_nsw.png","./assets/terrain/desert_nw.png","./assets/terrain/desert_s.png","./assets/terrain/desert_sw.png","./assets/terrain/desert_w.png","./assets/terrain/doe.png","./assets/terrain/fish.png","./assets/terrain/forest.png","./assets/terrain/forest_e.png","./assets/terrain/forest_es.png","./assets/terrain/forest_esw.png","./assets/terrain/forest_ew.png","./assets/terrain/forest_n.png","./assets/terrain/forest_ne.png","./assets/terrain/forest_nes.png","./assets/terrain/forest_nesw.png","./assets/terrain/forest_new.png","./assets/terrain/forest_ns.png","./assets/terrain/forest_nsw.png","./assets/terrain/forest_nw.png","./assets/terrain/forest_s.png","./assets/terrain/forest_sw.png","./assets/terrain/forest_w.png","./assets/terrain/gems.png","./assets/terrain/gold.png","./assets/terrain/grassland.png","./assets/terrain/grassland_e.png","./assets/terrain/grassland_es.png","./assets/terrain/grassland_esw.png","./assets/terrain/grassland_ew.png","./assets/terrain/grassland_n.png","./assets/terrain/grassland_ne.png","./assets/terrain/grassland_nes.png","./assets/terrain/grassland_nesw.png","./assets/terrain/grassland_new.png","./assets/terrain/grassland_ns.png","./assets/terrain/grassland_nsw.png","./assets/terrain/grassland_nw.png","./assets/terrain/grassland_s.png","./assets/terrain/grassland_sw.png","./assets/terrain/grassland_w.png","./assets/terrain/hills.png","./assets/terrain/hills_e.png","./assets/terrain/hills_es.png","./assets/terrain/hills_esw.png","./assets/terrain/hills_ew.png","./assets/terrain/hills_n.png","./assets/terrain/hills_ne.png","./assets/terrain/hills_nes.png","./assets/terrain/hills_nesw.png","./assets/terrain/hills_new.png","./assets/terrain/hills_ns.png","./assets/terrain/hills_nsw.png","./assets/terrain/hills_nw.png","./assets/terrain/hills_s.png","./assets/terrain/hills_sw.png","./assets/terrain/hills_w.png","./assets/terrain/horse.png","./assets/terrain/jungle.png","./assets/terrain/jungle_e.png","./assets/terrain/jungle_es.png","./assets/terrain/jungle_esw.png","./assets/terrain/jungle_ew.png","./assets/terrain/jungle_n.png","./assets/terrain/jungle_ne.png","./assets/terrain/jungle_nes.png","./assets/terrain/jungle_nesw.png","./assets/terrain/jungle_new.png","./assets/terrain/jungle_ns.png","./assets/terrain/jungle_nsw.png","./assets/terrain/jungle_nw.png","./assets/terrain/jungle_s.png","./assets/terrain/jungle_sw.png","./assets/terrain/jungle_w.png","./assets/terrain/land.png","./assets/terrain/mountains.png","./assets/terrain/mountains_e.png","./assets/terrain/mountains_es.png","./assets/terrain/mountains_esw.png","./assets/terrain/mountains_ew.png","./assets/terrain/mountains_n.png","./assets/terrain/mountains_ne.png","./assets/terrain/mountains_nes.png","./assets/terrain/mountains_nesw.png","./assets/terrain/mountains_new.png","./assets/terrain/mountains_ns.png","./assets/terrain/mountains_nsw.png","./assets/terrain/mountains_nw.png","./assets/terrain/mountains_s.png","./assets/terrain/mountains_sw.png","./assets/terrain/mountains_w.png","./assets/terrain/oasis.png","./assets/terrain/ocean.png","./assets/terrain/oil.png","./assets/terrain/plains.png","./assets/terrain/plains_e.png","./assets/terrain/plains_es.png","./assets/terrain/plains_esw.png","./assets/terrain/plains_ew.png","./assets/terrain/plains_n.png","./assets/terrain/plains_ne.png","./assets/terrain/plains_nes.png","./assets/terrain/plains_nesw.png","./assets/terrain/plains_new.png","./assets/terrain/plains_ns.png","./assets/terrain/plains_nsw.png","./assets/terrain/plains_nw.png","./assets/terrain/plains_s.png","./assets/terrain/plains_sw.png","./assets/terrain/plains_w.png","./assets/terrain/river_e.png","./assets/terrain/river_es.png","./assets/terrain/river_esw.png","./assets/terrain/river_ew.png","./assets/terrain/river_mouth_e.png","./assets/terrain/river_mouth_n.png","./assets/terrain/river_mouth_s.png","./assets/terrain/river_mouth_w.png","./assets/terrain/river.png","./assets/terrain/river_n.png","./assets/terrain/river_ne.png","./assets/terrain/river_nes.png","./assets/terrain/river_nesw.png","./assets/terrain/river_new.png","./assets/terrain/river_ns.png","./assets/terrain/river_nsw.png","./assets/terrain/river_nw.png","./assets/terrain/river_s.png","./assets/terrain/river_sw.png","./assets/terrain/river_w.png","./assets/terrain/seal.png","./assets/terrain/shield.png","./assets/terrain/game.png","./assets/terrain/swamp.png","./assets/terrain/swamp_e.png","./assets/terrain/swamp_es.png","./assets/terrain/swamp_esw.png","./assets/terrain/swamp_ew.png","./assets/terrain/swamp_n.png","./assets/terrain/swamp_ne.png","./assets/terrain/swamp_nes.png","./assets/terrain/swamp_nesw.png","./assets/terrain/swamp_new.png","./assets/terrain/swamp_ns.png","./assets/terrain/swamp_nsw.png","./assets/terrain/swamp_nw.png","./assets/terrain/swamp_s.png","./assets/terrain/swamp_sw.png","./assets/terrain/swamp_w.png","./assets/terrain/tundra.png","./assets/terrain/tundra_e.png","./assets/terrain/tundra_es.png","./assets/terrain/tundra_esw.png","./assets/terrain/tundra_ew.png","./assets/terrain/tundra_n.png","./assets/terrain/tundra_ne.png","./assets/terrain/tundra_nes.png","./assets/terrain/tundra_nesw.png","./assets/terrain/tundra_new.png","./assets/terrain/tundra_ns.png","./assets/terrain/tundra_nsw.png","./assets/terrain/tundra_nw.png","./assets/terrain/tundra_s.png","./assets/terrain/tundra_sw.png","./assets/terrain/tundra_w.png","./assets/units/tank.png","./assets/units/artillery.png","./assets/units/battleship.png","./assets/units/bomber.png","./assets/units/cannon.png","./assets/units/caravan.png","./assets/units/carrier.png","./assets/units/catapult.png","./assets/units/horseman.png","./assets/units/chariot.png","./assets/units/combat_1.png","./assets/units/combat_2.png","./assets/units/combat_3.png","./assets/units/combat_4.png","./assets/units/combat_5.png","./assets/units/combat_6.png","./assets/units/combat_7.png","./assets/units/combat_8.png","./assets/units/cruiser.png","./assets/units/diplomat.png","./assets/units/fighter.png","./assets/units/frigate.png","./assets/units/ironclad.png","./assets/units/knight.png","./assets/units/swordman.png","./assets/units/mechanizedinfantry.png","./assets/units/warrior.png","./assets/units/musketman.png","./assets/units/nuclear.png","./assets/units/spearman.png","./assets/units/rifleman.png","./assets/units/sail.png","./assets/units/settlers.png","./assets/units/submarine.png","./assets/units/transport.png","./assets/units/trireme.png"])}async get(e){return r(this,Ze).has(e)||r(this,Ze).set(e,await super.get(e)),r(this,Ze).get(e)}async getImage(e){if(!r(this,et).has(e)){let s=await this.get(e),n=document.createElement("img");n.src=s.uri,r(this,et).set(e,n)}return r(this,et).get(e)}async getScaled(e,s){return r(this,tt).has(e)||r(this,tt).set(e,Hi(await this.getImage(e),s)),r(this,tt).get(e)}async hasAllAssets(){return(await this.missingAssets()).length===0}async missingAssets(){let e=await this.keys();return r(this,Ms).filter(s=>!e.includes(s))}};l(Cs,"AssetStore"),Ze=new WeakMap,et=new WeakMap,tt=new WeakMap,Ms=new WeakMap;var M=new Cs;var ri=w(b());var Rt,Ls=class extends ee{constructor(){super(...arguments);c(this,Rt,void 0)}activate(){let e=[];new j("Adjust trade rates",(0,ri.s)("<div></div>",...this.value().all.map(n=>{let a=new Ei(n._,n.value*100);return e.push(a),a}))).on("close",()=>{let n=r(this,Rt).sliders().map(a=>[a.label(),parseFloat((a.value()/100).toFixed(2))]);console.info("AdjustTradeRates: ",n),this.transport().send("action",{name:"AdjustTradeRates",id:this.value().id,value:n})}),u(this,Rt,new Ti(...e))}build(){M.get("./assets/city/trade.png").then(e=>this.append((0,ri.s)(`<button class="adjustTradeRates" title="Adjust trade rates" style="background-image:url('${e.uri}')"></button>`)))}value(){return super.value()}};l(Ls,"AdjustTradeRates"),Rt=new WeakMap;var Ai=Ls;var ai=[],$t,Is=class extends Je{constructor(e,s,n={}){let a={queue:!0,...n};super(e,s,a);c(this,$t,{});u(this,$t,a),this.addClass("notificationWindow"),this.on("keydown",o=>{o.key==="Enter"&&(this.close(),o.stopPropagation())})}close(){if(super.close(),r(this,$t).queue&&ai.length&&Is.hasOpenWindow()){let[e,s,n]=ai.shift();e.display(s),n()}}display(e=!0){return new Promise(s=>{if(Is.hasOpenWindow()){ai.push([this,e,s]);return}if(super.display(),!e){s(void 0);return}this.element().focus(),s(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},ge=Is;l(ge,"NotificationWindow"),$t=new WeakMap;var Ps=ge;var ie=w(b());var Ot,Ut,fe=class extends ge{constructor(e,s,n,a="Please choose one of the following:",o={}){var p,h;o={autoFocus:!0,displayAll:!1,...o,actions:{primary:{label:"OK",action:g=>m(g.selectionList().value),...(h=(p=o.actions)==null?void 0:p.primary)!=null?h:{}},...o.actions}};let m=l(g=>{this.emit(new CustomEvent("selection",{detail:g})),this.close(),n(g)},"chooseHandler"),d=_((0,ie.s)(`<select>${s.map(g=>`<option value="${g.value}">${g.label||g.value}</option>`).join("")}</select>`),{keydown:g=>{g.key==="Enter"&&m(d.value)},dblclick:()=>m(d.value)});o.displayAll&&s.length>1&&d.setAttribute("size",s.length.toString()),o.autoFocus&&s.length>1&&d.setAttribute("autofocus","");super(e,(0,ie.s)("<div></div>",...a instanceof Node?[a]:a===null?[]:[(0,ie.s)(`<p>${a}</p>`)],d,(0,ie.s)("<footer></footer>",...Object.entries(o.actions).map(([,{label:g,action:f}])=>_((0,ie.s)(`<button>${g}</button>`),{click:()=>f(this),keydown:v=>{v.key==="Enter"&&f(this)}})))),o);c(this,Ot,l(()=>this.resize(),"#resizeHandler"));c(this,Ut,void 0);this.addClass("selectionWindow"),u(this,Ut,d),this.resize(),(0,ie.on)(window,"resize",r(this,Ot))}close(){(0,ie.off)(window,"resize",r(this,Ot)),super.close()}display(){return super.display(!1).then(()=>{let e=this.query("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,s;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-this.element().firstElementChild.offsetHeight-((s=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?s:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2.1em)`}catch(n){console.warn(n)}}selectionList(){return r(this,Ut)}};l(fe,"SelectionWindow"),Ot=new WeakMap,Ut=new WeakMap;var xe=fe;var Ri=w(b());var Ss=class extends ee{activate(){let t=new xe("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){M.get("./assets/city/bulb.png").then(t=>this.append((0,Ri.s)(`<button class="chooseResearch" title="Choose research" style="background-image:url('${t.uri}')">`)))}value(){return super.value()}};l(Ss,"ChooseResearch");var $i=Ss;var zt={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLaw:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},Wt=Object.entries(zt).reduce((i,[t,e])=>(Object.prototype.hasOwnProperty.call(i,e)||(i[e]=[]),Object.prototype.hasOwnProperty.call(i,t)||(i[t]=[]),i[e].push(t),i[t].push(t),i),{}),Nt=l((i,...t)=>i.reduce((e,s,n)=>(t.forEach((a,o)=>{var m;(m=Wt[a])!=null&&m.includes(s._)&&(e[o]+=s.value)}),e),t.map(()=>0)),"reduceKnownYields"),st=l((i,t)=>Nt(i,t)[0],"reduceKnownYield"),nt={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var ra=l((i,...t)=>i.classList.add(...t),"addClass"),Oi=l((i,t)=>i.dispatchEvent(t),"emit"),aa=l((i,t,...e)=>Oi(i,new CustomEvent(t,{detail:e})),"emitCustom"),oa=l(i=>{for(;i.hasChildNodes();)i.firstChild?.remove()},"empty"),la=l((i,t)=>i.classList.contains(t),"hasClass"),ma=l((i,t,e,s={})=>i.removeEventListener(t,e,s),"off"),oi=l((i,t,e,s={})=>i.addEventListener(t,e,s),"on"),da=l((i,t,e,s={})=>t.forEach(n=>oi(i,n,e,s)),"onEach"),pa=l((i,t,e,s={})=>oi(i,t,e,{...typeof s=="boolean"?{capture:s}:s,once:!0}),"once"),ca=l((i,...t)=>i.classList.remove(...t),"removeClass"),Re=l((i,...t)=>{let e=document.createElement("div");e.innerHTML=i;let s=e.firstElementChild;return t.forEach(n=>{if(n instanceof Ae){s.append(n.element());return}if(n instanceof Node){s.append(n);return}s.append(ua(n))}),s},"s"),ua=l(i=>document.createTextNode(i),"t"),ha=l((i,...t)=>t.forEach(e=>i.classList.toggle(e)),"toggleClass"),Ae=class{#e;constructor(t){this.#e=t}static fromString(t){return new Ae(Re(t))}addClass(...t){ra(this.element(),...t)}append(...t){t.forEach(e=>{e instanceof Ae&&(e=e.element()),this.element().append(e)})}element(){return this.#e}emit(t){return Oi(this.element(),t)}emitCustom(t,...e){return aa(this.element(),t,...e)}empty(){oa(this.element())}hasClass(t){return la(this.element(),t)}off(t,e,s={}){ma(this.element(),t,e,s)}on(t,e,s={}){oi(this.element(),t,e,s)}onEach(t,e,s={}){da(this.element(),t,e,s)}once(t,e,s={}){pa(this.element(),t,e,s)}query(t){return this.element().querySelector(t)}queryAll(t){return this.element().querySelectorAll(t)}remove(){this.element().remove()}removeClass(...t){ca(this.element(),...t)}toggleClass(...t){ha(this.element(),...t)}};l(Ae,"Element");var Ds=l(i=>{let t=i.growth,e=parseInt(i.name.replace(/[^a-z]/gi,""),36).toString(2),s=new Array(t.size).fill(1),n=Re('<div class="population"></div>'),[a,o]=Nt(i.yields,"Happiness","Unhappiness"),m=s.length-1;for(;o>0&&m>-1;)s[m--]=0,o--;for(m=0;a>0&&m<s.length;)s[m]===0&&(s[m]++,a--),s[m]===1&&(s[m++]++,a--),s[m]===2&&m++;return s.forEach((d,p)=>M.getScaled(`./assets/city/people_${["unhappy","content","happy"][d]}_${["f","m"][parseInt(e[p%e.length],10)]}.png`,2).then(h=>n.append(Re('<span class="citizen"></span>',Re(`<img src="${h.toDataURL("image/png")}">`))))),n},"renderPopulation"),jt=l((i,t,e)=>`Progress ${i.progress.value} / ${i.cost.value} (${Hs(ks(i,t,e))})`,"renderProgress"),ks=l((i,t,e)=>Math.max(1,Math.ceil((i.cost.value-i.progress.value)/st(t,e))),"turnsLeft"),Hs=l(i=>i+" turn"+(i===1?"":"s"),"turnsText"),Ui=l((i,t)=>i.yields.reduce(([e,s,n],a)=>{var m;let o=(m=Wt[t])==null?void 0:m.includes(a._);return o&&a.value>0&&(e+=a.value),o&&a.value<0&&(s+=a.value),o&&(n+=a.value),[e,s,n]},[0,0,0]),"yieldData"),Bt=l(i=>new Array(Math.abs(i.value)).fill(0).map(()=>{let t=Re('<span class="yield-icon"></span>');return M.getScaled(`./assets/${nt[zt[i._]]}`,2).then(e=>t.append(Re(`<img src="${e.toDataURL("image/png")}">`))),t}),"yieldImages");var zi=w(b());var Wi,Ni=l(i=>Wi=i,"setPreloadContainer"),li=l(i=>{let t=Wi.querySelector(`[data-path$="${i}.png"]`);return t===null?(console.error(`Missing image: ${i}.`),(0,zi.s)("<canvas></canvas>")):t},"getPreloadedImage"),mi=li;var ji=w(b());var ga=l((i,t,e)=>{let s=(0,ji.s)("<canvas></canvas>"),n=s.getContext("2d");s.width=i.width,s.height=i.height,n.drawImage(i,0,0,i.width,i.height);let a=n.getImageData(0,0,s.width,s.height),o=l(p=>{var f;let h=null,g={r:0,g:0,b:0,a:0};return typeof p=="string"?(h=p.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?g={r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16),a:1}:(h=p.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?g={r:parseInt(h[1]+h[1],16),g:parseInt(h[2]+h[2],16),b:parseInt(h[3]+h[3],16),a:1}:(h=p.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:1}:(h=p.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:parseFloat((f=h[4])!=null?f:1)}):"length"in p&&(g={r:p[0]||0,g:p[1]||0,b:p[2]||0,a:p[3]||1}),g},"getColor"),m=t.map(o),d=e.map(o);for(let p=0;p<a.data.length;p+=4)m.forEach((h,g)=>{a.data[p]===h.r&&a.data[p+1]===h.g&&a.data[p+2]===h.b&&a.data[p+3]===h.a*255&&(a.data[p]=(d[g]||d[0]).r,a.data[p+1]=(d[g]||d[0]).g,a.data[p+2]=(d[g]||d[0]).b,a.data[p+3]=Math.trunc((d[g]||d[0]).a*255))});return n.putImageData(a,0,0),s},"replaceColours"),As=ga;var Bi=w(b());var ye,$e,Kt,ve,Gt,we,Y=class{constructor(t,e=2,s=16,n=(0,Bi.s)("<canvas></canvas>")){c(this,ye,void 0);c(this,$e,void 0);c(this,Kt,!0);c(this,ve,void 0);c(this,Gt,void 0);c(this,we,void 0);u(this,ye,n),u(this,we,t),u(this,Gt,s),u(this,ve,e),this.setCanvasSize(),u(this,$e,r(this,ye).getContext("2d")),Ni(document.querySelector("#preload"))}canvas(){return r(this,ye)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return r(this,$e)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}renderTile({x:t,y:e}){let s=this.tileSize(),n=t*s,a=e*s;this.context().clearRect(n,a,s,s)}scale(){return r(this,ve)}tileSize(){return r(this,Gt)*r(this,ve)}update(t){t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}world(){return r(this,we)}drawImage(t,e,s,n={}){var p,h;let a=this.tileSize(),o=e*a,m=s*a,d=this.getPreloadedImage(t);this.putImage(n.augment?n.augment(d):d,o+((p=n.offsetX)!=null?p:0),m+((h=n.offsetY)!=null?h:0))}filterNeighbours(t,e,s=["n","e","s","w"]){return s.filter(n=>e(r(this,we).getNeighbour(t,n)))}getPreloadedImage(t){return li(t)}putImage(t,e,s){r(this,$e).imageSmoothingEnabled=!1,r(this,$e).drawImage(t,e,s,t.width*r(this,ve),t.height*r(this,ve))}replaceColours(t,e,s){return As(t,e,s)}setCanvasSize(){r(this,ye).height=r(this,we).height()*this.tileSize(),r(this,ye).width=r(this,we).width()*this.tileSize()}isVisible(){return r(this,Kt)}setVisible(t){u(this,Kt,t)}};l(Y,"Map"),ye=new WeakMap,$e=new WeakMap,Kt=new WeakMap,ve=new WeakMap,Gt=new WeakMap,we=new WeakMap;var Ki=Y;var Rs=class extends Y{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.city){let m=t.city,d=m.player,p=d.civilization,[h]=p.attributes.filter(g=>g.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(a,o,n,n)),this.context().fillStyle=h.value[0],this.context().fillRect(a+this.scale(),o+this.scale(),n-this.scale()*2,n-this.scale()*2),this.drawImage("map/city",e,s,{augment:g=>this.replaceColours(g,["#000"],[h.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}};l(Rs,"Cities");var Ft=Rs;var qt=w(b());var $s=class extends ge{constructor(t,e,s,n={}){var o,m;let a=_((0,qt.s)(`<button>${(o=n.okLabel)!=null?o:"OK"}</button>`),{click:()=>{s(),this.close()},keydown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),d.stopPropagation(),s(),this.close())}});super(t,(0,qt.s)(`<div class="content"><p>${e}</p></div>`,(0,qt.s)("<footer></footer>",a,_((0,qt.s)(`<button>${(m=n.cancelLabel)!=null?m:"Cancel"}</button>`),{click:()=>this.close(),keydown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),d.stopPropagation(),this.close())}}))),{...n,queue:!1}),a.focus()}};l($s,"ConfirmationWindow");var Os=$s;var it,rt,Us=class{constructor(t,e){c(this,it,void 0);c(this,rt,[]);this.setIds(t),u(this,it,s=>{let{detail:n}=s,a=n.value.objects;!a||r(this,rt).some(o=>o in a)&&document.addEventListener("dataupdated",o=>e(o.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",r(this,it))}dispose(){document.removeEventListener("patchdatareceived",r(this,it))}setIds(t){r(this,rt).splice(0,r(this,rt).length,...t)}};l(Us,"DataObserver"),it=new WeakMap,rt=new WeakMap;var be=Us;var zs=class extends Y{update(t){let e=[...t];return t.forEach(s=>{["n","ne","e","se","s","sw","w","nw"].forEach(n=>{let a=this.world().getNeighbour(s,n);e.includes(a)||e.push(a)})}),super.update(e)}};l(zs,"TerrainAbstract");var B=zs;var Ws=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.terrain.features.length&&t.terrain.features.forEach(n=>n._==="Shield"?this.drawImage(`terrain/${n._.toLowerCase()}`,e,s,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${n._.toLowerCase()}`,e,s))}};l(Ws,"Feature");var Ns=Ws;var js=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;this.filterNeighbours(t,n=>n.terrain._==="Unknown").forEach(n=>this.drawImage(`map/fog_${n}`,e,s))}};l(js,"Fog");var Bs=js;var Ks=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=t.improvements.reduce((a,o)=>{let m=o._;return m in a&&(a[m]=!0),a},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(a=>{n[a]&&this.drawImage(`improvements/${a.toLowerCase()}`,e,s)}),n.Road){let a=this.filterNeighbours(t,m=>m.improvements.some(d=>d._==="Road"),["n","ne","e","se","s","sw","w","nw"]),o=this.filterNeighbours(t,m=>!!m.city||m.improvements.some(d=>d._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(a.forEach(m=>{(!n.Railroad||!o.includes(m))&&this.drawImage(`improvements/road_${m}`,e,s)}),n.Railroad&&o.forEach(m=>this.drawImage(`improvements/railroad_${m}`,e,s)),a.length===0&&o.length===0){let m=this.tileSize(),d=e*m,p=s*m,h=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=n.Railroad?"#000":"#8c5828",this.context().rect(d+h,p+h,this.scale()*2,this.scale()*2),this.context().fill()}}}};l(Ks,"Terrain");var Gs=Ks;var Fs=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;!t.improvements.some(a=>a._==="Irrigation")||this.drawImage("improvements/irrigation",e,s)}};l(Fs,"Terrain");var qs=Fs;var Gi=w(b());var Ys=class extends B{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,s);else if(t.isWater&&(this.drawImage("terrain/ocean",e,s),t.isCoast)){let m=this.getPreloadedImage("terrain/coast_sprite"),d=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(d>0){let p=d&7,h=d>>2&7,g=d>>4&7,f=d>>6&7|(d&1)<<2,v=(0,Gi.s)('<canvas height="16" width="16"></canvas>'),E=v.getContext("2d");E.drawImage(m,p<<4,0,8,8,0,0,8,8),E.drawImage(m,(h<<4)+8,0,8,8,8,0,8,8),E.drawImage(m,(g<<4)+8,8,8,8,8,8,8,8),E.drawImage(m,f<<4,8,8,8,0,8,8,8),this.putImage(v,a,o)}this.filterNeighbours(t,p=>p.terrain._==="River").forEach(p=>this.drawImage(`terrain/river_mouth_${p}`,e,s))}}}};l(Ys,"Land");var Yt=Ys;var qi=w(Fi()),Yi=w(b());var fa={playerId:null,scale:2,tileSize:16},R,O,Ue,ze,Xt,at,ot,Qt,H,Vs=class extends qi.EventEmitter{constructor(e,s,n=(0,Yi.s)("<canvas></canvas>"),a={playerId:null,scale:2},...o){let m={...fa,...a};super();c(this,R,void 0);c(this,O,{x:0,y:0});c(this,Ue,void 0);c(this,ze,[]);c(this,Xt,null);c(this,at,void 0);c(this,ot,void 0);c(this,Qt,void 0);c(this,H,void 0);u(this,H,e),u(this,R,n),u(this,Xt,m.playerId),u(this,ot,m.tileSize),u(this,at,m.scale),u(this,Qt,s),o.forEach(d=>r(this,ze).push(new d(r(this,H),this.scale(),r(this,ot)))),u(this,Ue,n.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){r(this,ze).forEach(s=>s.update(e))}canvas(){return r(this,R)}center(){return r(this,O)}getLayer(e){var s;return(s=this.getLayers(e).shift())!=null?s:null}getLayers(e){return r(this,ze).filter(s=>s instanceof e)}isVisible(e,s){let n=Math.floor(r(this,R).width/this.tileSize()),a=Math.floor(r(this,R).height/this.tileSize());if(n>=r(this,H).width()&&a>=r(this,H).height())return!0;let[o,m,d,p]=this.visibleBounds();return(n>=r(this,H).width()||(o>m?e<m||e>o:e<m&&e>o))&&(a>=r(this,H).height()||(d>p?s<p||s>d:s<p&&s>d))}playerId(){return r(this,Xt)}render(){let e=this.tileSize(),s=r(this,H).width()*e,n=r(this,O).x*e+Math.trunc(e/this.scale()),a=Math.trunc(r(this,R).width/2),o=r(this,H).height()*e,m=r(this,O).y*e+Math.trunc(e/this.scale()),d=Math.trunc(r(this,R).height/2),p=a-n,h=a+s,g=d-m,f=d+o;for(;p>0;)p-=s;for(;g>0;)g-=o;for(;h<r(this,R).width;)h+=s;for(;f<r(this,R).height;)f+=o;r(this,Ue).fillStyle="#000",r(this,Ue).fillRect(0,0,Math.max(r(this,H).width()*e,r(this,R).width),Math.max(r(this,H).height()*e,r(this,R).height));for(let v=p;v<h;v+=s)for(let E=g;E<f;E+=o)r(this,ze).forEach($=>{if(!$.isVisible())return;let z=$.canvas();r(this,Ue).drawImage(z,v,E,z.width,z.height)})}scale(){return r(this,at)}setCenter(e,s){r(this,O).x=e,r(this,O).y=s,this.render(),this.emit("focus-changed",e,s)}tileSize(){return r(this,ot)*r(this,at)}transport(){return r(this,Qt)}visibleBounds(){let[{x:e,y:s},{x:n,y:a}]=this.visibleRange();return[e,n,s,a]}visibleRange(){let e=Math.floor(Math.floor(r(this,R).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,R).height/this.tileSize())/2);return[{x:(r(this,O).x-e+r(this,H).width())%r(this,H).width(),y:(r(this,O).y-s+r(this,H).height())%r(this,H).height()},{x:(r(this,O).x+e)%r(this,H).width(),y:(r(this,O).y+s)%r(this,H).height()}]}rawVisibleRange(){let e=Math.floor(Math.floor(r(this,R).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,R).height/this.tileSize())/2);return[{x:r(this,O).x-e,y:r(this,O).y-s},{x:r(this,O).x+e,y:r(this,O).y+s}]}world(){return r(this,H)}};l(Vs,"Portal"),R=new WeakMap,O=new WeakMap,Ue=new WeakMap,ze=new WeakMap,Xt=new WeakMap,at=new WeakMap,ot=new WeakMap,Qt=new WeakMap,H=new WeakMap;var Xs=Vs;var Qs=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=this.filterNeighbours(t,a=>t.terrain._==="River"&&a.isWater||t.terrain._===a.terrain._).join("");t.terrain._!=="Ocean"&&(n?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${n}`,e,s):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,s))}};l(Qs,"Terrain");var Js=Qs;var tn=w(b());var xa={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},ya=l((i,t=16)=>{var m,d;let e=i.player,s=e.civilization,[n]=s.attributes.filter(p=>p.name==="colors"),a=As(mi(`units/${i._.toLowerCase()}`),["#60E064","#2C7800"],n.value),o=a.getContext("2d");if(o.imageSmoothingEnabled=!1,(m=i.improvements)!=null&&m.some(p=>p._==="Fortified")&&o.drawImage(mi("map/fortify"),0,0),i.busy){let p=t/2,h=t*.75,g=(d=xa[i.busy._])!=null?d:i.busy._.replace(/[a-z]+/g,"");o.font="bold 8px sans-serif",o.fillStyle="black",o.textAlign="center",o.fillText(g,p,h),o.fillStyle="white",o.fillText(g,p,h)}return a},"renderUnit"),Zs=ya;var Jt,en=class extends tn.Element{constructor(e,s=2){super((0,tn.s)('<canvas width="32" height="32"></canvas>'));c(this,Jt,2);u(this,Jt,s),this.build(e)}build(e){let s=Zs(e),n=this.element().getContext("2d"),a=this.size(s.width),o=this.size(s.height),m=Math.floor((this.size(16)-a)/2),d=Math.floor((this.size(16)-o)/2);n.imageSmoothingEnabled=!1,n.drawImage(s,m,d,a,o)}element(){return super.element()}size(e){return e*r(this,Jt)}};l(en,"Unit"),Jt=new WeakMap;var lt=en;var sn=class extends xe{constructor(t,e,s=()=>{}){super("Activate unit",t.map(n=>{var a,o;return{label:n._+" ["+((o=(a=n.city)==null?void 0:a.name)!=null?o:"NONE")+"]"+(n.busy?` (${n.busy._})`:""),value:n.id}}),n=>{let[a]=t.filter(o=>o.id===n);if(!!a){if(!a.active){e.send("action",{name:"InactiveUnit",id:n});return}s(a)}},null)}};l(sn,"UnitSelectionWindow");var nn=sn;var an,mt,Ee,Te,Ce,rn=class{constructor(t){c(this,an,l((t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}),"#unknown"));c(this,mt,{});c(this,Ee,void 0);c(this,Te,void 0);c(this,Ce,void 0);u(this,Te,t.height),u(this,Ce,t.width),u(this,Ee,t.tiles||[])}get(t,e){for(;t<0;)t+=r(this,Ce);for(;e<0;)e+=r(this,Te);for(;t>=r(this,Ce);)t-=r(this,Ce);for(;e>=r(this,Te);)e-=r(this,Te);let s=[t,e].toString();if(!(s in r(this,mt))){let n=r(this,Ee).findIndex(a=>a.x===t&&a.y===e);if(n===-1)return r(this,an).call(this,t,e);r(this,mt)[s]=n}return r(this,Ee)[r(this,mt)[s]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return r(this,Te)}tiles(){return r(this,Ee)}width(){return r(this,Ce)}setTiles(t){u(this,Ee,t)}};l(rn,"World"),an=new WeakMap,mt=new WeakMap,Ee=new WeakMap,Te=new WeakMap,Ce=new WeakMap;var on=rn;var ln=class extends Ki{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.yields.reduce((g,f)=>g+f.value,0),d=t.yields.sort((g,f)=>g._.charCodeAt(0)-f._.charCodeAt(0)),p=0;if(m<5){let g=[[a,o],[a+n/2,o],[a,o+n/2],[a+n/2,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])});return}if(m<7){let g=[[a,o],[a+n/3,o],[a+n/3*2,o],[a,o+n/2],[a+n/3,o+n/2],[a+n/3*2,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),g[p][0],g[p++][1])});return}if(m<9){let g=[[a,o],[a+n/4,o],[a+n/4*2,o],[a+n/4*3,o],[a,o+n/2],[a+n/4,o+n/2],[a+n/4*2,o+n/2],[a+n/4*3,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])});return}if(m<11){let g=[[a,o],[a+n/5,o],[a+n/5*2,o],[a+n/5*3,o],[a+n/5*4,o],[a,o+n/2],[a+n/5,o+n/2],[a+n/5*2,o+n/2],[a+n/5*3,o+n/2],[a+n/5*4,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])});return}let h=[[a,o],[a+n/6,o],[a+n/6*2,o],[a+n/6*3,o],[a+n/6*4,o],[a+n/6*5,o],[a,o+n/2],[a+n/6,o+n/2],[a+n/6*2,o+n/2],[a+n/6*3,o+n/2],[a+n/6*4,o+n/2],[a+n/6*5,o+n/2]];d.forEach(g=>{for(let f=0;f<g.value;f++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),...h[p++])})}};l(ln,"Yields");var dt=ln;var L=w(b());var mn=w(b());var We=class extends mn.Element{constructor(t,e,s=["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"]){super((0,mn.s)('<span class="supported-unit"></span>',new lt(e),...t.yields.filter(n=>s.includes(n._)).filter(n=>n.unit.id===e.id).flatMap(n=>Bt(n))))}};l(We,"SupportedUnit");var va=l((i,t)=>t.filter(e=>Wt[i].includes(e._)).reduce(([e,s],n)=>[e+(n.value<0?-n.value:0),s+n.value],[0,0]),"reduceYield"),wa=l(i=>(0,L.s)('<div class="yields-detail"></div>',...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>(0,L.s)(`<div class="yields" data-yields="${t.join(" ")}"></div>`,...t.map(e=>(0,L.s)(`<span class="yield" data-yield="${e}"></span>`,...va(e,i.yields).map((s,n)=>(0,L.s)(`<span class="${["used","free"][n]}"></span>`,...Bt({_:e,value:s}))))))),...Object.entries(i.yields.filter(t=>!Object.keys(zt).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>(0,L.s)(`<div><div>${t}</div><div>${e}</div></div>`))),"renderYields"),di=l(i=>{let t=i.querySelectorAll(".yields-detail .yield");Array.from(t).forEach(e=>{let[s,n]=Array.from(e.children);for(;s.scrollWidth+n.scrollWidth>e.clientWidth;){let a=parseInt(e.getAttribute("data-max-width")||"14",10);if(a===0)break;e.setAttribute("data-max-width",(a-1).toString())}})},"resizeYields"),ba=l((i,t,e)=>{let s=(0,L.s)("<canvas></canvas>"),n=new Xs(new on(t.player.world),e,s,{playerId:t.player.id,scale:i.scale(),tileSize:i.tileSize()/i.scale()},Yt,qs,Js,Gs,Ns,Bs,Ft,dt);return s.height=i.tileSize()*5,s.width=i.tileSize()*5,n.setCenter(t.tile.x,t.tile.y),n.build(t.tiles),n.getLayer(dt).render(t.tilesWorked),n.render(),_((0,L.s)('<div class="city-map"></div>',s),{click:()=>e.send("action",{name:"ReassignWorkers",city:t.id})})},"renderMap"),_a=l((i,t,e)=>(0,L.s)(`<div class="build"><header>Building ${i.build.building?i.build.building.item._:"nothing"}</header></div>`,_((0,L.s)(`<button>${i.build.building?"Change":"Choose"}</button>`),{click(){t()}}),_((0,L.s)("<button>Buy</button>"),{click(){e()}}),i.build.building?(0,L.s)(`<p>${jt(i.build,i.yields,"Production")}</p>`):""),"renderBuild"),Ea=l(i=>(0,L.s)(`<div class="growth"><header>Growth</header><p>Size ${i.growth.size.toString()}</p><p>${jt(i.growth,i.yields,"Food")}</p></div>`),"renderGrowth"),Ta=l(i=>(0,L.s)('<div class="improvements"></div>',(0,L.s)("<div></div>",...i.improvements.map(t=>(0,L.s)(`<div>${t._}</div>`,...i.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>Bt(e)))))),"renderImprovements"),Ca=l((i,t)=>_((0,L.s)('<div class="garrisoned-units"><header>Garrisoned Units</header></div>',(0,L.s)('<div class="units"></div>',...i.tile.units.map(e=>new lt(e).element()))),{click(){let e=i.tile.units.filter(s=>s.player.id===i.player.id);e.length!==0&&new nn(e,t)}}),"renderGarrisonedUnits"),Ma=l(i=>(0,L.s)('<div class="supported-units"><header>Supported units</header></div>',(0,L.s)('<div class="units"></div>',...i.units.map(t=>new We(i,t)))),"renderSupportedUnits"),Vi=l((i,t,e,s,n)=>(0,L.s)('<div class="city-screen"></div>',(0,L.s)('<div class="top-row"></div>',(0,L.s)('<div class="yield-details"></div>',Ds(i),wa(i),Ma(i)),ba(t,i,e),Ta(i)),(0,L.s)('<div class="bottom-row"></div>',Ea(i),(0,L.s)('<div class="tabbed-details"></div>',(0,L.s)('<div class="info"></div>',Ca(i,e))),_a(i,s,n))),"cityDetails"),pe,pt,Zt,ct,dn=class extends j{constructor(e,s,n){super(e.name,Vi(e,s,n,()=>this.changeProduction(),()=>this.completeProduction()),{canResize:!0,canMaximise:!0,size:"maximised"});c(this,pe,void 0);c(this,pt,void 0);c(this,Zt,void 0);c(this,ct,void 0);setTimeout(()=>di(this.element()),200),this.addClass("city-screen-window"),u(this,pe,e),u(this,Zt,s),u(this,ct,n),u(this,pt,new be([e.id,e.build.id,e.growth.id,...e.units.map(o=>o.id)],o=>{var d,p;let[m]=((p=(d=o.player)==null?void 0:d.cities)!=null?p:[]).filter(h=>e.id===h.id);if(!m){this.close();return}u(this,pe,m),r(this,pt).setIds([m.id,m.build.id,m.growth.id,...m.units.map(h=>h.id)]),this.update(Vi(m,r(this,Zt),n,()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus(),setTimeout(()=>di(this.element()),200)})),this.on("keydown",o=>{["c","C"].includes(o.key)&&(this.changeProduction(),o.preventDefault(),o.stopPropagation()),["b","B"].includes(o.key)&&(this.completeProduction(),o.preventDefault(),o.stopPropagation()),["Enter","x","X"].includes(o.key)&&this.close()});let a=l(()=>setTimeout(()=>di(this.element()),200),"resizeHandler");this.on("close",()=>window.removeEventListener("resize",a)),window.addEventListener("resize",a),this.on("close",()=>this.off("resize",a)),this.on("resize",a)}changeProduction(){new ht(r(this,pe).build,r(this,ct),()=>this.element().focus())}close(){r(this,pt).dispose(),super.close()}completeProduction(){!r(this,pe).build.building||new Os("Are you sure?",`Do you want to rush building of ${r(this,pe).build.building.item._}`,()=>r(this,ct).send("action",{name:"CompleteProduction",id:r(this,pe).id}))}};l(dn,"City"),pe=new WeakMap,pt=new WeakMap,Zt=new WeakMap,ct=new WeakMap;var ut=dn;var es,pn,gt=class extends fe{constructor(e,s,n=()=>{},a={}){let o=l(m=>Math.max(1,Math.ceil((m.cost.value-e.progress.value)/st(e.city.yields,"Production"))),"turns");super(`What would you like to build in ${e.city.name}?`,e.available.map(m=>({label:`${m.item._} (Cost: ${m.cost.value} / ${o(m)} turn${o(m)===1?"":"s"})`,value:m.item._})),m=>{!m||(s.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:m||"@"}),this.close(!0))},null,{actions:a,displayAll:!0});c(this,es,void 0);c(this,pn,void 0);u(this,es,n),u(this,pn,s)}close(e=!1){super.close(),e&&r(this,es).call(this,e)}};l(gt,"CityBuildSelectionWindow"),es=new WeakMap,pn=new WeakMap,gt.showCityAction=l((e,s,n)=>({label:"View city",action(a){a.close(),new ut(e,s,n)}}),"showCityAction"),gt.showCityOnMapAction=l((e,s)=>({label:"Show on map",action(n){n.close(),s.setCenter(e.tile.x,e.tile.y)}}),"showCityOnMapAction");var ht=gt;var Xi=w(b());var ft,cn=class extends ee{constructor(e,s,n){super(e,n);c(this,ft,void 0);u(this,ft,s)}activate(){new ht(this.value(),this.transport(),()=>this.complete(),{showCity:ht.showCityAction(this.value().city,r(this,ft),this.transport()),showCityOnMap:ht.showCityOnMapAction(this.value().city,r(this,ft))})}build(){let e=this.value();M.get("./assets/city/production.png").then(s=>this.append((0,Xi.s)(`<button class="cityBuild" title="What would you like to build in ${e.city.name}?" style="background-image:url('${s.uri}')">`)))}value(){return super.value()}};l(cn,"CityBuild"),ft=new WeakMap;var Qi=cn;var Ji=w(b());var un=class extends ee{activate(){this.transport().send("action",{name:"EndTurn"})}build(){this.append((0,Ji.s)('<button class="endTurn" title="End turn"></button>'))}};l(un,"EndTurn");var Zi=un;var er=w(b());var hn=class extends ee{activate(){let t=new xe("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){M.get("./assets/city/sad.png").then(t=>this.append((0,er.s)(`<button class="chooseGovernment" title="Choose government" style="background-image:url('${t.uri}')"></button>`)))}value(){return super.value()}};l(hn,"Revolution");var tr=hn;var ts,ce,gn=class extends fn.Element{constructor(e=(0,fn.s)('<div class="actions"></div>'),s,n){super(e);c(this,ts,void 0);c(this,ce,void 0);u(this,ts,s),u(this,ce,n),this.on("actioned",a=>a.detail.remove()),this.on("keydown",a=>{var g;let o=document.activeElement;if(!this.element().contains(o))return;let{key:m}=a,d=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(m)||d.length===0)return;a.preventDefault(),a.stopPropagation();let p=o===this.element()?["ArrowLeft","ArrowUp"].includes(m)?o.firstElementChild:o.lastElementChild:o;for(;p.parentElement!==this.element();)p=p.parentElement;let h=d.indexOf(p);if(["ArrowUp","ArrowLeft"].includes(m)){if(h>0){(g=d[h-1].querySelector("button"))==null||g.focus();return}d.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(m)){if(h<d.length-1){d[h+1].querySelector("button").focus();return}d.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(s=>{let n;switch(s._){case"ActiveUnit":return;case"AdjustTradeRates":n=new Ai(s,r(this,ce));break;case"ChooseResearch":n=new $i(s,r(this,ce));break;case"CityBuild":n=new Qi(s,r(this,ts),r(this,ce));break;case"EndTurn":n=new Zi(s,r(this,ce));break;case"Revolution":n=new tr(s,r(this,ce));break;default:console.log("need to handle "+s._);return}this.element().prepend(_(n.element(),{click:()=>n.activate(),keydown:({key:a})=>{(a===" "||a==="Enter")&&n.activate()}}))})}};l(gn,"Actions"),ts=new WeakMap,ce=new WeakMap;var pi=gn;var Ne,xn=class extends Y{constructor(){super(...arguments);c(this,Ne,null)}renderTile(e){super.renderTile(e);let{x:s,y:n}=e,a=this.tileSize(),o=s*a,m=n*a;if(e.units.length>0&&(r(this,Ne)!==null?r(this,Ne).tile.id!==e.id:!0)){let[d]=e.units.sort((h,g)=>{var f,v;return((f=g.defence)==null?void 0:f.value)-((v=h.defence)==null?void 0:v.value)}),p=this.renderUnit(d);e.units.length>1&&this.putImage(p,o-this.scale(),m-this.scale()),this.putImage(p,o,m)}}renderUnit(e){return Zs(e)}setActiveUnit(e){u(this,Ne,e)}activeUnit(){return r(this,Ne)}};l(xn,"Units"),Ne=new WeakMap;var ss=xn;var yn=class extends ss{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:s}=t.tile,n=this.world().get(e,s),a=this.tileSize(),o=e*a,m=s*a,d=this.renderUnit(t);n.units.length>1&&this.putImage(d,o-this.scale(),m-this.scale()),this.putImage(d,o,m)}update(){this.render()}};l(yn,"ActiveUnit");var ci=yn;var vn=class extends Y{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.city,d=this.tileSize()/2,p=this.tileSize()*.75,h=this.tileSize()/2,g=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(m.growth.size.toString(),a+d+this.scale(),o+p),this.context().fillText(m.name,a+h+this.scale(),o+g),this.context().fillStyle="white",this.context().fillText(m.growth.size.toString(),a+d,o+p-this.scale()),this.context().fillText(m.name,a+h,o+g-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}};l(vn,"CityNames");var ui=vn;var je=w(b());var La=l(async i=>{let[t,e,s,n,a,o]=["Food","Production","Trade","Research","Gold","Luxuries"].map(v=>Ui(i,v)),[m,d,p,h,g,f]=await Promise.all(["Food","Production","Trade","Research","Gold","Luxuries"].map(v=>M.getScaled(`./assets/${nt[v]}`,2).then(E=>`<img src="${E.toDataURL("image/png")}">`)));return[(0,je.s)(`<header>${i.name}</header>`),(0,je.s)(`<div class="growth"><strong>${i.growth.size}</strong> ${m} ${t[2]} [${t[0]}] (${Hs(ks(i.growth,i.yields,"Food"))})</div>`),(0,je.s)(`<div class="build">${d} ${e[2]} [${e[0]}] ${i.build.building?i.build.building.item._:"Nothing"}${i.build.building?` (${Hs(ks(i.build,i.yields,"Production"))})`:""}</div>`),(0,je.s)(`<div class="yields">${[[s,p],[n,h],[a,g],[o,f]].filter(([[v]])=>v!==0).map(([[v,,E],$])=>`${$} ${E}${E!==v?` [${v}]`:""}`).join(", ")}</div>`)]},"buildCityRow"),Be,xt,ns,is,wn=class extends j{constructor(e,s,n){super("City details",(0,je.s)('<div class="loading"></div>'));c(this,Be,void 0);c(this,xt,void 0);c(this,ns,void 0);c(this,is,void 0);this.addClass("city-status"),u(this,Be,e.cities),u(this,xt,new be([e.id,...e.cities.flatMap(({id:a,build:o,growth:m})=>[a,m.id,o.id])],a=>{let o=a.player;u(this,Be,o.cities),r(this,xt).setIds([o.id,...o.cities.flatMap(({id:m,build:d,growth:p})=>[m,p.id,d.id])]),this.update()})),u(this,ns,s),u(this,is,n),this.update()}close(){return r(this,xt).dispose(),super.close()}update(){Promise.all(r(this,Be).map(e=>La(e))).then(e=>super.update((0,je.s)("<table></table>",...e.map(([s,n,a,o],m)=>{let d=document.createElement("tr");return d.append(...[[s,"th"],[n,"td"],[a,"td"],[o,"td"]].map(([p,h])=>{let g=document.createElement(h);return g.append(p),g})),_(d,{click:()=>new ut(r(this,Be)[m],r(this,ns),r(this,is))})}))))}};l(wn,"CityStatus"),Be=new WeakMap,xt=new WeakMap,ns=new WeakMap,is=new WeakMap;var sr=wn;var _n=w(b());var rs,as,bn=class extends _n.Element{constructor(e,s,n){super(e);c(this,rs,void 0);c(this,as,void 0);u(this,rs,s),u(this,as,n)}build(){this.empty(),this.append((0,_n.s)(`<h3><span class="year">${this.year()}</span><span class="turn">${r(this,rs).value.toString()}</span></h3>`))}year(e=r(this,as).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};l(bn,"GameDetails"),rs=new WeakMap,as=new WeakMap;var nr=bn;var ir=w(b());var En=class extends Xs{bindEvents(){(0,ir.on)(this.canvas(),"click",t=>{let e=this.center(),s={x:Math.floor(this.canvas().width/2-this.tileSize()/2),y:Math.floor(this.canvas().height/2-this.tileSize()/2)},n=e.x+Math.trunc(((t.offsetX-s.x)/this.tileSize()+this.world().width())%this.world().width()),a=e.y+Math.trunc(((t.offsetY-s.y)/this.tileSize()+this.world().height())%this.world().height()),o=this.world().get(n,a),m=o.units.filter(d=>d.player.id===this.playerId());if(o.city&&o.city.player.id===this.playerId())new ut(o.city,this,this.transport());else if(m.length){new nn(m,this.transport(),d=>this.emit("activate-unit",d));return}this.setCenter(o.x,o.y)})}};l(En,"GamePortal");var rr=En;var Tn=class extends B{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,s)}};l(Tn,"Terrain");var ar=Tn;var os=w(b());var Ia=l(async i=>{let t={CityImprovementContent:s=>s.cityImprovement._,MartialLaw:s=>new lt(s.unit),MilitaryUnhappiness:s=>new We(i,s.unit,["MilitaryUnhappiness"])},e=i.yields.reduce((s,n)=>(n._ in t&&s.push(t[n._](n)),s),[]);return(0,os.s)(`<div class="city"><div class="name">${i.name}</div></div>`,Ds(i),(0,os.s)('<div class="reasons"></div>',...e))},"buildCityRow"),yt,vt,Cn=class extends j{constructor(e){super("Happiness report",(0,os.s)("<div></div>"));c(this,yt,void 0);c(this,vt,void 0);this.addClass("happiness-report"),u(this,yt,new be([e.id,...e.cities.map(s=>s.id)],s=>{u(this,vt,s.player),r(this,yt).setIds([e.id,...e.cities.map(n=>n.id)]),this.update()})),u(this,vt,e),this.update()}close(){return r(this,yt).dispose(),super.close()}update(){Promise.all(r(this,vt).cities.map(e=>Ia(e))).then(e=>super.update((0,os.s)("<div></div>",...e)))}};l(Cn,"HappinessReport"),yt=new WeakMap,vt=new WeakMap;var or=Cn;var Ke,Me,Mn=class{constructor(t=500){c(this,Ke,!1);c(this,Me,[]);setInterval(()=>this.check(),t)}check(){r(this,Ke)||r(this,Me).forEach(t=>t())}clear(){u(this,Me,[])}off(t){u(this,Me,r(this,Me).filter(e=>e!==t))}on(t){r(this,Me).push(t)}pause(){u(this,Ke,!0)}isPaused(){return r(this,Ke)}resume(){u(this,Ke,!1)}};l(Mn,"IntervalHandler"),Ke=new WeakMap,Me=new WeakMap;var lr=Mn;var ae=w(b());var ls,ms,Ln=class{constructor(t,...e){c(this,ls,void 0);c(this,ms,void 0);u(this,ls,e),u(this,ms,t)}args(){return r(this,ls)}channel(){return r(this,ms)}};l(Ln,"Request"),ls=new WeakMap,ms=new WeakMap;var Le=Ln;var In=class extends Le{constructor(t){super("getOptions",t)}};l(In,"Options");var mr=In;var U=w(b());var wt,Ge,Pn=class extends j{constructor(e,s){super("Customise world",(0,U.s)('<div class="customise-world"></div>'));c(this,wt,void 0);c(this,Ge,void 0);u(this,wt,s),u(this,Ge,e),this.init()}build(){super.build(),this.init()}async init(){var h,g,f,v,E,$;let e=await r(this,Ge).request(new mr(["players","height","width","landCoverage","landSize","maxIterations"])),s=(0,U.s)(`<input name="players" type="number" value="${(h=e.players)!=null?h:7}" step="1" min="1" max="20">`),n=(0,U.s)(`<input name="height" type="number" value="${(g=e.height)!=null?g:60}" step="1" min="1">`),a=(0,U.s)(`<input name="width" type="number" value="${(f=e.width)!=null?f:80}" step="1" min="1">`),o=(0,U.s)(`<input name="landCoverage" type="number" value="${(v=e.landCoverage)!=null?v:.4}" step="0.01" min="0">`),m=(0,U.s)(`<input name="landSize" type="number" value="${(E=e.landSize)!=null?E:.2}" step="0.01" min="0">`),d=(0,U.s)(`<input name="maxIterations" type="number" value="${($=e.maxIterations)!=null?$:20}" step="1" min="1">`),p=l(async()=>{this.close(),await r(this,Ge).request(new Le("setOptions",{players:s.value,height:n.value,width:a.value,landCoverage:o.value,landSize:m.value,maxIterations:d.value})),r(this,Ge).send("start"),r(this,wt)&&r(this,wt).call(this)},"submit");this.update((0,U.s)('<div class="customise-world"></div>',(0,U.s)('<div class="option"><label>Players</label></div>',s),(0,U.s)('<div class="option"><label>Height</label></div>',n),(0,U.s)('<div class="option"><label>Width</label></div>',a),(0,U.s)('<div class="option"><label>Land coverage</label></div>',o),(0,U.s)('<div class="option"><label>Land size</label></div>',m),(0,U.s)('<div class="option"><label>Max iterations</label></div>',d),_((0,U.s)("<button>Build</button>"),{click:()=>p()}))),this.on("keydown",z=>{z.key==="Enter"&&p()})}};l(Pn,"CustomiseWorldWindow"),wt=new WeakMap,Ge=new WeakMap;var dr=Pn;var Sn=class extends fe{constructor(t,e,s,n="Please choose one of the following:",a={canClose:!1,displayAll:!1}){super(t,e,s,n,{...a,displayAll:!0})}display(){return new Promise(t=>{this.on("selection",({detail:e})=>t(e)),super.display()})}};l(Sn,"MandatorySelection");var pr=Sn;var bt=class extends pr{constructor(t,e){super("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],async s=>{this.close(),await t.request(new Le("setOptions",{width:80,height:60,players:parseInt(s,10)})),e&&await e(),t.send("start")})}};l(bt,"NewGameWindow");var cr=bt;var Dn=class extends bt{constructor(t,e){super(t,async()=>{e&&await e(),await t.request(new Le("setOptions",{width:80,height:50,earth:!0}))})}};l(Dn,"EarthWindow");var ur=Dn;var kn=class{constructor(){this.blob=null;this.ptr=-1}fromString(t,e){this.blob=t,this.ptr=0,this.decode(e)}getUByte(){return this.blob.charCodeAt(this.ptr++)}getUShort(){let t=this.getUByte();return(this.getUByte()<<8)+t}getShort(){return(this.getUShort()+32768)%65536-32768}getString(t){let e=this.ptr;return this.ptr+=t,this.blob.substr(e,t)}decode(t){if(this.blob===null){console.warn("file has not been loaded!");return}console.warn("The decode function should be overwritten"),t&&t()}};l(kn,"BinFile");var hr=kn;var Hn=class{constructor(t){this.dicTable=[];this.dicTable=[],this.dicSize=1<<t;for(let e=0;e<this.dicSize;e++)e<256?this.dicTable[e]=[e]:this.dicTable[e]=null;this.curPos=257}getEntry(t){return t<this.curPos?this.dicTable[t]:null}isFull(){return this.curPos===this.dicTable.length}getCurPos(){return this.curPos}addEntry(t){return this.curPos<this.dicTable.length&&(this.dicTable[this.curPos]=t,this.curPos++),this.curPos-1}};l(Hn,"LZWDictionary");var gr=Hn;var An=class{static parseByteStreamToIndexes(t,e,s){let n=[],a=0,o=0,m=1,d=1,p=256,h=0,g=0;for(;e>0;){for(;o<8+m;)a|=t.getUByte()<<o,e--,o+=8;for(;o>=8+m;)g=a&(d<<8&65280|255),a>>=8+m,o-=8+m,h++,h==p&&(h=0,m+=1,d<<=1,d|=1,p<<=1,8+m>s&&(h=0,m=1,d=1,p=256)),n.push(g)}return n}static decode(t,e){e=e||11;let s=t,n=[];for(;s.length>0;){let a=new gr(e),o=[s[0]],m=s[0],d=a.getEntry(m),p=m,h,g=0;for(;!a.isFull()&&g++<s.length-1;){h=s[g];let f=[];h>=a.getCurPos()?(f=a.getEntry(m),f===null&&console.error(`No dictionary entry in LZW special case: oldCode=${m}; newCode=${h}; i=${g}; buffer=${d}`),f=[...f??[],p]):f=a.getEntry(s[g]),o.push.apply(o,f),p=f[0],a.addEntry(d.concat(p)),m=h,d=a.getEntry(m)}n.push.apply(n,o),s=s.slice(g+1)}return n}static RLEDecode(t){let e=[],s=0,n=!1;for(let a=0;a<t.length;a++){let o=t[a];if(n){if(o==0)s=144,e.push(144);else for(let m=0;m<o-1;m++)e.push(s);n=!1}else o==144?n=!0:(e.push(o),s=o)}return e}};l(An,"LZW");var Rn=An;var Pa=l(i=>i&15,"lowerNibble"),fr=Pa;var Sa=l(i=>(i&240)>>4,"upperNibble"),xr=Sa;var $n=class extends hr{constructor(){super(...arguments);this.palette=[];this.palette16=[{r:255,g:255,b:255,a:0},{r:170,g:0,b:0,a:255},{r:0,g:170,b:0,a:255},{r:170,g:170,b:0,a:255},{r:0,g:0,b:170,a:255},{r:0,g:0,b:0,a:255},{r:0,g:85,b:170,a:255},{r:170,g:170,b:170,a:255},{r:85,g:85,b:85,a:255},{r:255,g:85,b:85,a:255},{r:85,g:255,b:85,a:255},{r:255,g:255,b:85,a:255},{r:85,g:85,b:255,a:255},{r:255,g:85,b:255,a:255},{r:85,g:255,b:255,a:255},{r:255,g:255,b:255,a:255}];this.imageData=null;this.imageHeight=0;this.imageWidth=0;this.byteMode=11}decode(e){let s=this.getString(2),n=this.getShort();if(s=="M0")this.getPaletteData(),s=this.getString(2),n=this.getShort();else{console.log("Creating a random color palette...");for(let a=0;a<256;a++)a<16?this.palette.push(this.palette16[a]):this.palette.push({r:Math.floor(Math.random()*256),g:Math.floor(Math.random()*256),b:Math.floor(Math.random()*256),a:255})}s=="X0"?this.getX0ImageData(n):s=="X1"?this.getX1ImageData(n):console.error('"'+s+'" is an unknown chunk type'),e&&e()}getPaletteData(){let e=this.getUByte(),s=this.getUByte(),n=s-e+1,a=!1;for(let o=0;o<n;o++){let m={r:this.getUByte()*4,g:this.getUByte()*4,b:this.getUByte()*4,a:255};this.palette.push(m),m.r===m.g&&m.g===m.b&&m.r===0&&(a||(m.a=0),a=!0)}this.palette.push({r:0,g:0,b:0,a:0})}getX0ImageData(e){this.imageWidth=this.getShort(),this.imageHeight=this.getShort(),this.byteMode=this.getUByte();let s=Rn.parseByteStreamToIndexes(this,e-5,this.byteMode),n=Rn.decode(s,this.byteMode);this.imageData=Rn.RLEDecode(n)}getX1ImageData(e){this.getX0ImageData(e);let s=this.imageData;this.imageData=[];for(let n=0;n<s.length;n++)this.imageData.push(fr(s[n])),this.imageData.push(xr(s[n]));this.palette=this.palette16}draw(e,s=0,n=0){let a=e.getImageData(0,0,this.imageWidth,this.imageHeight),o=0;for(let m=0;m<this.imageHeight;m++)for(let d=0;d<this.imageWidth;d++){let p=this.imageData[o],h=(d+m*this.imageWidth)*4;a.data[h]=this.palette[p].r,a.data[h+1]=this.palette[p].g,a.data[h+2]=this.palette[p].b,a.data[h+3]=this.palette[p].a,o++}e.putImageData(a,s,n)}getPixel(e,s){return this.imageData?this.imageData[e+this.imageWidth*s]:0}};l($n,"PicImage");var yr=$n;var vr=l((i,t,e,s,n=a=>console.log(a))=>{let a=s(320,200),o=new yr,m=[];return o.fromString(i,()=>{o.draw(a.getContext("2d",{willReadFrequently:!0})),Object.entries(t).forEach(([d,p])=>p.forEach(h=>h.contents.forEach(g=>{let f={...e,...h,...g},v=`./assets/${d+f.name}.png`,E=s(f.width,f.height),$=E.getContext("2d",{willReadFrequently:!0});$.clearRect(0,0,f.width,f.height),$.drawImage(a,f.x,f.y,f.width,f.height,0,0,f.width,f.height);for(let z=0;z<a.width;z++)for(let ue=0;ue<a.height;ue++){let De=$.getImageData(z,ue,1,1).data;De[0]==f.clear.r&&De[1]==f.clear.g&&De[2]==f.clear.b&&$.clearRect(z,ue,1,1)}n(`Processing ${v}...`),m.push({name:v,uri:E.toDataURL("image/png")})})))}),m},"extractSprites");var ds={defaults:{height:16,width:16,clear:{r:0,g:170,b:170}},files:{"SP257.PIC":{"cursor/go":[{y:33,x:33,height:12,width:12,contents:[{name:""}]}],"city/pollution":[{y:32,x:48,contents:[{name:""}]}],"improvements/irrigation":[{y:32,x:64,contents:[{name:""}]}],"improvements/mine":[{y:32,x:80,contents:[{name:""}]}],"improvements/pollution":[{y:32,x:96,contents:[{name:""}]}],"cursor/torch":[{y:33,x:113,height:13,width:13,contents:[{name:""}]}],"city/food":[{y:33,x:129,height:7,width:7,contents:[{name:""}]}],"city/production":[{y:33,x:137,height:7,width:7,contents:[{name:""}]}],"city/trade":[{y:33,x:145,height:7,width:7,contents:[{name:""}]}],"city/gold":[{y:33,x:153,height:7,width:7,contents:[{name:""}]}],"city/bulb":[{y:41,x:129,height:7,width:7,contents:[{name:""}]}],"city/sad":[{y:41,x:137,height:7,width:7,contents:[{name:""}]}],"city/luxury":[{y:41,x:145,height:7,width:7,contents:[{name:""}]}],"terrain/":[{y:41,x:153,height:7,width:7,contents:[{name:"shield"}]}],"improvements/road":[{y:48,contents:[{name:"_n",x:0},{name:"_ne",x:16},{name:"_e",x:32},{name:"_se",x:48},{name:"_s",x:64},{name:"_sw",x:80},{name:"_w",x:96},{name:"_nw",x:112}]}],"status/science":[{y:48,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"status/pollution":[{y:56,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"terrain/land":[{y:64,contents:[{name:"",x:0}]}],"terrain/river":[{y:64,contents:[{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:224},{name:"_nesw",x:240}]}],"units/combat":[{y:97,height:15,width:15,contents:[{name:"_1",x:1},{name:"_2",x:17},{name:"_3",x:33},{name:"_4",x:49},{name:"_5",x:65},{name:"_6",x:81},{name:"_7",x:97},{name:"_8",x:113}]}],"improvements/railroad":[{y:96,contents:[{name:"_n",x:128},{name:"_ne",x:144},{name:"_e",x:160},{name:"_se",x:176},{name:"_s",x:192},{name:"_sw",x:208},{name:"_w",x:224},{name:"_nw",x:240}]}],"terrain/oasis":[{y:113,height:15,width:15,contents:[{name:"",x:1}]}],"terrain/horse":[{y:113,height:15,width:15,contents:[{name:"",x:17}]}],"terrain/doe":[{y:113,height:15,width:15,contents:[{name:"",x:49}]}],"terrain/coal":[{y:113,height:15,width:15,contents:[{name:"",x:65}]}],"terrain/gold":[{y:113,height:15,width:15,contents:[{name:"",x:81}]}],"terrain/game":[{y:113,height:15,width:15,contents:[{name:"",x:97}]}],"terrain/seal":[{y:113,height:15,width:15,contents:[{name:"",x:113}]}],"terrain/oil":[{y:113,height:15,width:15,contents:[{name:"",x:129}]}],"terrain/gems":[{y:113,height:15,width:15,contents:[{name:"",x:145}]}],"terrain/fish":[{y:113,width:15,height:15,contents:[{name:"",x:161}]}],"map/city":[{y:113,contents:[{name:"",x:193}]}],"map/fortify":[{width:15,height:15,y:113,contents:[{name:"",x:209}]}],"map/fort":[{width:15,height:15,y:113,contents:[{name:"",x:225}]}],"map/hut":[{y:113,height:15,width:15,contents:[{name:"",x:241}]}],"city/people":[{y:128,height:16,width:8,contents:[{name:"_happy_m",x:0},{name:"_happy_f",x:8},{name:"_content_m",x:16},{name:"_content_f",x:24},{name:"_unhappy_m",x:32},{name:"_unhappy_f",x:40},{name:"_tax",x:48},{name:"_science",x:56},{name:"_luxury",x:64}]}],"map/fog":[{y:128,contents:[{name:"_n",x:80},{name:"_e",x:96},{name:"_s",x:112},{name:"_w",x:128}]}],"units/":[{y:161,height:15,width:15,contents:[{name:"settlers",x:1},{name:"warrior",x:17},{name:"spearman",x:33},{name:"swordman",x:49},{name:"musketman",x:65},{name:"rifleman",x:81},{name:"horseman",x:97},{name:"knight",x:113},{name:"catapult",x:129},{name:"cannon",x:145},{name:"chariot",x:161},{name:"tank",x:177},{name:"mechanizedinfantry",x:193},{name:"artillery",x:209},{name:"fighter",x:225},{name:"bomber",x:241},{name:"trireme",x:257},{name:"sail",x:273},{name:"frigate",x:289},{name:"ironclad",x:305}]},{y:177,contents:[{name:"cruiser",x:1},{name:"battleship",x:17},{name:"submarine",x:33},{name:"carrier",x:49},{name:"transport",x:65},{name:"nuclear",x:81},{name:"diplomat",x:97},{name:"caravan",x:113}]}],"general/texture":[{y:176,contents:[{name:"_1",x:288},{name:"_2",x:304}]}]},"TER257.PIC":{"terrain/desert":[{y:0,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/plains":[{y:16,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/grassland":[{y:32,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/forest":[{y:48,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/hills":[{y:64,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/mountains":[{y:80,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/tundra":[{y:96,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/arctic":[{y:112,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/swamp":[{y:128,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/jungle":[{y:144,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/ocean":[{y:160,contents:[{name:"",x:0}]}],"terrain/coast_sprite":[{x:0,y:176,height:16,width:128,contents:[{name:""}]}],"terrain/river":[{y:160,contents:[{name:"",x:240}]},{y:176,contents:[{name:"_mouth_n",x:128},{name:"_mouth_e",x:144},{name:"_mouth_s",x:160},{name:"_mouth_w",x:176}]}]}}};var ps=w(b());var _t,K,On=class extends j{constructor(){let e=(0,ps.s)('<input type="file" multiple>'),s=(0,ps.s)('<p class="loading" hidden></p>');super("Import assets",(0,ps.s)(`<div class="import-assets"><p>Upload ${Object.keys(ds.files).join(", ")} from the original Civilization files to extract assets (these will be stored locally). This process can take at least a few minutes.</p><div class="brave" ${navigator!=null&&navigator.brave?"":" hidden"}><p>It looks like you're using Brave and due to the use of <code>HTMLCanvasElement</code>'s <code>getImageData</code> and <code>toDataURL</code> functions, please put Shields down while importing, and playing, otherwise any colour-replaced icons won't look correct. <strong>Remember to put them back up after!</strong></p><p><a href="https://brave.com/privacy-updates/4-fingerprinting-defenses-2.0/#2-fingerprinting-protections-20-farbling-for-great-good" target="_blank">Read more about "farbling".</a></p></div></div>`,(0,ps.s)("<p></p>",_(e,{change:n=>this.handleFileUpload(n)})),s));c(this,_t,void 0);c(this,K,void 0);u(this,_t,e),u(this,K,s)}async handleFileUpload(e){var d;r(this,K).removeAttribute("hidden"),r(this,K).style.color="inherit";let s=Array.from((d=e.target.files)!=null?d:[]),n=s.map(p=>p.name),a=Object.keys(ds.files);if(!a.map(p=>new RegExp(p,"i")).every(p=>n.some(h=>h.match(p)))){r(this,K).style.color="#f00",r(this,K).innerText=`Please provide all files to generate assets: ${a.join(", ")}.`;return}r(this,_t).setAttribute("disabled",""),r(this,K).innerText="Building image assets...";let m=[];if(await Promise.all(s.map(async p=>new Promise(h=>{let g=ds.files[p.name.toUpperCase()];if(!g){console.warn(`No definitions found for ${p.name}, skipping.`);return}let f=new FileReader;f.addEventListener("load",async v=>{vr(v.target.result,g,ds.defaults,(E,$)=>{let z=document.createElement("canvas");return z.width=E,z.height=$,z},E=>{r(this,K).innerText=E}).forEach(E=>m.push(E)),h()}),f.readAsBinaryString(p)}))),r(this,K).innerText="Writing to database...",await Promise.all(m.map(p=>M.set(p))),!await M.hasAllAssets()){console.error("Something went wrong..."),r(this,K).style.color="#f00",r(this,K).innerText="Not all expected data was written. Might need to try again... Missing: "+(await M.missingAssets()).join(", "),r(this,_t).removeAttribute("disabled");return}r(this,K).innerText="Done! Please reload the page to utilise the fresh assets.",location.reload()}};l(On,"ImportAssetsWindow"),_t=new WeakMap,K=new WeakMap;var wr=On;var br="0.1.0@39cbaeb";var Ie,Un=class extends ae.Element{constructor(e,s){super(e);c(this,Ie,void 0);u(this,Ie,s),this.build(),this.addClass("active")}async build(e=!1){let s=await M.hasAllAssets();s||(console.log("Missing assets:"),console.log(await M.missingAssets())),this.append(_((0,ae.s)("<nav></nav>",_((0,ae.s)(`<button autofocus${s?"":" hidden"}>Start a New Game</button>`),{click:()=>{new cr(r(this,Ie),()=>this.remove())}}),_((0,ae.s)(`<button${s?"":" hidden"}>Earth</button>`),{click:()=>new ur(r(this,Ie),()=>this.remove())}),_((0,ae.s)(`<button${s?"":" hidden"}>Customise World</button>`),{click:async()=>new dr(r(this,Ie),()=>this.remove())}),_((0,ae.s)("<button>Import Assets</button>"),{click:()=>new wr}),_((0,ae.s)(`<button${e?"":" hidden"}>Quit</button>`),{click:()=>{this.remove(),r(this,Ie).send("quit")}})),{keydown(n){let a=document.activeElement;a===null||!a.matches("#mainmenu nav button")||(n.key==="ArrowDown"&&a.nextElementSibling&&a.nextElementSibling.focus(),n.key==="ArrowUp"&&a.previousElementSibling&&a.previousElementSibling.focus())}}),(0,ae.s)(`<footer>version: ${br}</footer>`))}remove(){this.removeClass("active"),setTimeout(()=>super.remove(),2e3)}};l(Un,"MainMenu"),Ie=new WeakMap;var _r=Un;var Er=w(b());var V,J,Fe,Et,oe,zn=class{constructor(t,e,s,...n){c(this,V,void 0);c(this,J,void 0);c(this,Fe,void 0);c(this,Et,void 0);c(this,oe,void 0);u(this,J,t),u(this,oe,e),u(this,Et,s),u(this,Fe,n),u(this,V,r(this,J).getContext("2d")),(0,Er.on)(r(this,J),"click",a=>{let o=a.offsetX-r(this,J).offsetLeft,m=a.offsetY-r(this,J).offsetTop,d=Math.ceil(o/r(this,J).offsetWidth*r(this,oe).width()),p=Math.ceil(m/r(this,J).offsetHeight*r(this,oe).height());r(this,Et).setCenter(d,p),this.update()})}update(){let t=r(this,Fe)[0].canvas().height*(190/r(this,Fe)[0].canvas().width);r(this,J).height=t,r(this,V).clearRect(0,0,190,t),r(this,Fe).forEach(n=>r(this,V).drawImage(n.canvas(),0,0,190,t));let[e,s]=r(this,Et).rawVisibleRange();r(this,V).lineWidth=1,r(this,V).strokeStyle="#fff",r(this,V).fillStyle="rgba(255, 255, 255, .2)",r(this,V).rect(Math.floor(190/r(this,oe).width()*e.x),Math.floor(t/r(this,oe).height()*e.y),Math.floor(190/r(this,oe).width()*(s.x-e.x)),Math.floor(t/r(this,oe).height()*(s.y-e.y))),r(this,V).stroke(),r(this,V).fill()}};l(zn,"Minimap"),V=new WeakMap,J=new WeakMap,Fe=new WeakMap,Et=new WeakMap,oe=new WeakMap;var Tr=zn;var cs,Tt,Wn=class{constructor(t=document.body){c(this,cs,void 0);c(this,Tt,[]);u(this,cs,t)}receive(t){r(this,Tt).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!r(this,Tt).length||t)return;let e=r(this,Tt).shift();this.publish(e)}publish(t){var s;new Ps((s=t.title)!=null?s:"Notification",t.message,{parent:r(this,cs)}).on("close",()=>this.check())}};l(Wn,"Notifications"),cs=new WeakMap,Tt=new WeakMap;var Cr=Wn;var Ct=w(b());var us,Nn=class extends Ct.Element{constructor(e,s){super(e);c(this,us,void 0);u(this,us,s)}build(){this.empty();let{civilization:e,treasury:s,research:n,cities:a}=r(this,us),[o,m]=a.reduce(([p,h],g)=>{let[f,v]=Nt(g.yields,"Gold","Research");return[p+f,h+v]},[0,0]),d=Math.ceil((n.cost.value-n.progress.value)/m);this.append((0,Ct.s)(`<h3>${e.leader.name} of the ${e._} empire</h3>`),(0,Ct.s)(`<p><strong>Researching</strong><br/>${n.researching?`${n.researching._} ${n.progress.value} / ${n.cost.value} (${d} turn${d===1?"":"s"})`:"Nothing"}</p>`),(0,Ct.s)(`<p><strong>Treasury</strong><br/>${s.value} (${o} / turn}</p>`))}};l(Nn,"PlayerDetails"),us=new WeakMap;var Mr=Nn;var Lr=l(i=>i.cities.reduce((t,e)=>t.concat(e.yields),[]),"combinedYields");var hi=w(b());var Ha=l(async(i,t)=>{let e=await M.getScaled(`./assets/${nt.Research}`,2).then(s=>`<img src="${s.toDataURL("image/png")}">`);return(0,hi.s)(`<div><p><strong>Researching ${i.researching?i.researching._:"Nothing"}</strong>${i.researching?` ${jt(i,t,"Research")}`:""}</p><p>${e} ${st(t,"Research")} / turn</p><div class="discovered">${i.complete.map(s=>`<div>${s._}</div>`).join("")}</div></div>`)},"template"),Mt,qe,jn=class extends j{constructor(e){super("Player research",(0,hi.s)("<div></div>"));c(this,Mt,void 0);c(this,qe,void 0);u(this,qe,e),this.addClass("science-report"),this.update(),u(this,Mt,new be([e.id,e.research.id,...e.cities.map(s=>s.id)],s=>{let n=s.player;r(this,Mt).setIds([n.id,n.research.id,...n.cities.map(a=>a.id)]),u(this,qe,n),this.update()}))}close(){return r(this,Mt).dispose(),super.close()}update(){Ha(r(this,qe).research,Lr(r(this,qe))).then(e=>super.update(e))}};l(jn,"ScienceReport"),Mt=new WeakMap,qe=new WeakMap;var Ir=jn;var le=w(b());var S,Bn=class extends le.Element{constructor(e,s){super(e);c(this,S,void 0);u(this,S,s),this.build()}build(){var e,s;this.empty(),r(this,S)!==null&&this.append((0,le.s)(`<p>${r(this,S)._} (${r(this,S).tile.x}, ${r(this,S).tile.y})</p>`),(0,le.s)(`<p>${(s=(e=r(this,S).city)==null?void 0:e.name)!=null?s:"NONE"}</p>`),(0,le.s)(`<p>${Number.isInteger(r(this,S).moves.value)?r(this,S).moves.value:r(this,S).moves.value.toFixed(2)} / ${r(this,S).movement.value} moves</p>`),(0,le.s)(`<p>A: ${r(this,S).attack.value} / D: ${r(this,S).defence.value} / V: ${r(this,S).visibility.value}</p>`),(0,le.s)(`<p>${r(this,S).improvements.map(n=>n._).join(", ")}</p>`),(0,le.s)(`<p>${r(this,S).tile.terrain._}${r(this,S).tile.terrain.features?" "+r(this,S).tile.terrain.features.map(n=>n._).join(", "):""}${r(this,S).tile.improvements.length?" ("+r(this,S).tile.improvements.map(n=>n._).join(", ")+")":""}</p>`),(0,le.s)(`<p>${r(this,S).tile.units.filter(n=>n!==r(this,S)).map(n=>n._).join(", ")}</p>`))}};l(Bn,"UnitDetails"),S=new WeakMap;var Pr=Bn;var Pe,Kn=class{constructor(t){c(this,Pe,void 0);u(this,Pe,t)}init(){let t=r(this,Pe);M.hasAllAssets().then(s=>{!s||M.getScaled("./assets/cursor/torch.png",2).then(n=>document.body.style.cursor=`url('${n.toDataURL("image/png")}'), default`)}),(0,Ye.on)(document,"keypress",s=>{if(s.key==="F5"||["R","r"].includes(s.key)&&s.ctrlKey){s.preventDefault(),new Os("Quit","Are you sure you want to reload?",()=>window.location.reload());return}});let e={autoEndOfTurn:!0};try{let s=document.getElementById("notification"),n=document.querySelector("#mainmenu"),a=document.getElementById("actions"),o=document.getElementById("other-actions"),m=document.getElementById("game"),d=document.getElementById("map"),p=d.querySelector("canvas"),h=document.getElementById("gameDetails"),g=document.getElementById("playerDetails"),f=document.getElementById("minimap"),v=document.getElementById("unitInfo"),E=document.getElementById("preload"),$=new Cr,z=new _r(n,r(this,Pe)),ue=l((T,W,Q,ke)=>{let Z=new Pr(v,T);if(X=T,Z.build(),Q.setActiveUnit(T),Q.render(),Q.setVisible(!0),ke.setActiveUnit(T),ke.render(),ke.setVisible(!0),T===null){W.render();return}G=T,Q.update([...G!=null&&G.tile?[G.tile]:[],T.tile]),W.isVisible(T.tile.x,T.tile.y)||W.setCenter(T.tile.x,T.tile.y),W.render()},"setActiveUnit");M.getAll().then(T=>T.forEach(W=>E.append(_((0,Ye.s)(`<img src="${W.uri}" data-path="${W.name}">`),{error:()=>console.error(`There was a problem preloading '${W.name}', you may have some missing details.`)}))));let De=[],hs,G=null,X=null;t.receive("notification",T=>{s.innerHTML=T,hs&&window.clearTimeout(hs),hs=window.setTimeout(()=>{hs=void 0,s.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([T,W])=>t.receive(T,Q=>{let{choices:ke}=xs(Q);new xe(W,ke.map(({_:Z})=>({label:Z,value:Z})),Z=>t.send(T,Z),W,{displayAll:!0})}));let k;t.receiveOnce("gameData",T=>{try{let W=new Intl.ListFormat;k=xs(T),new Ps("Welcome",(0,Ye.s)(`<div class="welcome">
<p>${k.player.civilization.leader.name}, you have risen to become leader of the ${k.player.civilization._}.</p>
<p>Your people have knowledge of ${W.format(["Irrigation","Mining","Roads",...k.player.research.complete.map(y=>y._)])}.</p>
</div>`)),m.classList.add("active"),p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight;let Q=[],ke=2,Z=new on(k.player.world),Hr=new lr,I=new rr(Z,t,p,{playerId:k.player.id,scale:ke,tileSize:16},Yt,qs,Js,Gs,Ns,ar,Bs,dt,ss,Ft,ui,ci),Ar=I.getLayer(Yt),qn=I.getLayer(dt),Lt=I.getLayer(ss),Yn=I.getLayer(Ft),gi=I.getLayer(ui),Ve=I.getLayer(ci),Vn=new Tr(f,Z,I,Ar,Yn,Ve),fi=new pi(a,I,r(this,Pe)),Rr=new pi(o,I,r(this,Pe));qn.setVisible(!1),I.on("focus-changed",()=>Vn.update()),I.on("activate-unit",y=>ue(y,I,Lt,Ve)),Hr.on(()=>{Ve.setVisible(!Ve.isVisible()),I.build(De.splice(0)),I.render()}),(0,Ye.on)(window,"resize",()=>{p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight});let Xn=l(y=>{k=xs(y),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:k}})),fi.build(k.player.mandatoryActions),Rr.build(k.player.actions.filter(D=>["AdjustTradeRates","Revolution"].includes(D._))),m.append(fi.element()),Z.setTiles(k.player.world.tiles),new nr(h,k.turn,k.year).build(),new Mr(g,k.player).build(),Q=k.player.actions.filter(D=>D._==="ActiveUnit");let[P]=Q.sort(({value:D},{value:N})=>N===G?1:D===G?-1:(I.isVisible(N.tile.x,N.tile.y)?1:0)-(I.isVisible(D.tile.x,D.tile.y)?1:0));if(G!==(P==null?void 0:P.value)&&(G=null),ue(G!=null&&G.active?G:P?P.value:null,I,Lt,Ve),I.build(De.splice(0)),I.render(),Vn.update(),e.autoEndOfTurn&&k.player.mandatoryActions.length===1&&k.player.mandatoryActions.every(D=>D._==="EndTurn")){t.send("action",{name:"EndTurn"});return}},"handler");Xn(T),t.receive("gameData",y=>Xn(y));let $r=l(y=>y.replace(/]/g,"").split(/[.[]/),"pathToParts"),xi=l((y,C)=>{let A=$r(C),P=A.pop();return[A.reduce((N,gs)=>!N||!(gs in N)?null:N[gs],y),P]},"getPenultimateObject"),Or=l((y,C,A)=>{let[P,D]=xi(y,C);if(!P||!D){console.warn(`unable to set ${C} of ${y} (${D})`);return}P[D]=A},"setObjectPath"),Ur=l((y,C)=>{let[A,P]=xi(y,C);if(!A||!P){console.warn(`unable to set ${C} of ${y} (${P})`);return}delete A[P]},"removeObjectPath");t.receive("gameDataPatch",y=>{y.forEach(C=>Object.entries(C).forEach(([A,{type:P,index:D,value:N}])=>{if(P==="add"||P==="update"){if(!N.hierarchy){console.error("No hierarchy"),console.error(N);return}D?Or(T.objects[A],D,N.hierarchy):T.objects[A]=N.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:N}})),Object.entries(N.objects).forEach(([gs,Jn])=>{T.objects[gs]=Jn,Jn._==="PlayerTile"&&De.push(Jn)})}if(P==="remove"){if(D){Ur(T.objects[A],D);return}delete T.objects[A]}})),Xn(T)}),t.receive("gameNotification",y=>$.receive(y));let yi={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},Qn={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},zr={8:"n",9:"ne",6:"e",3:"se",2:"s",1:"sw",4:"w",7:"nw"},Ra={[KeyboardEvent.DOM_KEY_LOCATION_STANDARD]:Qn,[KeyboardEvent.DOM_KEY_LOCATION_NUMPAD]:zr},vi={F1:()=>new sr(k.player,I,t),F4:()=>new or(k.player),F6:()=>new Ir(k.player)},wi="";(0,Ye.on)(document,"keydown",y=>{if(y.key in vi&&(vi[y.key](),y.preventDefault()),X){if(y.key in yi){let C=[...yi[y.key]];for(;C.length;){let A=C.shift(),[P]=X.actions.filter(D=>D._===A);if(P){t.send("action",{name:"ActiveUnit",id:X.id,unitAction:P._,target:P.to.id}),y.stopPropagation(),y.preventDefault();return}}}if(y.key in Qn){let[C]=X.actionsForNeighbours[Qn[y.key]];if(C){t.send("action",{name:"ActiveUnit",id:X.id,unitAction:C._,target:C.to.id}),y.stopPropagation(),y.preventDefault();return}}}if(y.key==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(y.key==="Enter"&&k.player.mandatoryActions.some(C=>C._==="EndOfTurn")){t.send("action",{name:"EndTurn"}),y.stopPropagation(),y.preventDefault();return}if(y.key==="Tab"){let C=a.querySelector("div.action:first-child button");if(C!==null){C.focus(),y.preventDefault(),y.stopPropagation();return}}if(y.key==="c"&&X){I.setCenter(X.tile.x,X.tile.y),I.render(),Vn.update();return}if(y.key==="w"&&X&&Q.length>1){let C=Q.map(D=>D.value),A=C.indexOf(X),P=C[A===C.length-1?0:A+1];ue(P,I,Lt,Ve)}if(y.key==="t"){Lt.setVisible(!Lt.isVisible()),Yn.setVisible(!Yn.isVisible()),gi.setVisible(!gi.isVisible()),I.render();return}if(y.key==="y"){qn.setVisible(!qn.isVisible()),I.render();return}if(wi==="%"&&y.key==="^"){t.send("cheat",{name:"RevealMap"});return}wi=y.key})}catch(W){console.error(W)}})}catch(s){console.error(s)}}};l(Kn,"Renderer"),Pe=new WeakMap;var Sr=Kn;var Gn=class{async request(t){return new Promise(e=>{this.send(t.channel(),...t.args()),this.receiveOnce(t.channel(),s=>e(s))})}};l(Gn,"AbstractTransport");var Dr=Gn;var Se,Fn=class extends Dr{constructor(e){super();c(this,Se,void 0);u(this,Se,e)}receive(e,s){r(this,Se).addEventListener("message",({data:{channel:n,data:a}})=>{n===e&&s(a)})}receiveOnce(e,s){let n=l(({data:{channel:a,data:o}})=>{a===e&&(s(o),r(this,Se).removeEventListener("message",n))},"onceHandler");r(this,Se).addEventListener("message",n)}send(e,s){r(this,Se).postMessage({channel:e,data:s})}};l(Fn,"WorkerTransport"),Se=new WeakMap;var kr=Fn;var Aa=new Sr(new kr(new Worker("dist/backend.js")));Aa.init();})();
//# sourceMappingURL=frontend.js.map
