"use strict";(()=>{var Ni=Object.create;var ds=Object.defineProperty;var Ui=Object.getOwnPropertyDescriptor;var zi=Object.getOwnPropertyNames;var Oi=Object.getPrototypeOf,Wi=Object.prototype.hasOwnProperty;var l=(a,t)=>ds(a,"name",{value:t,configurable:!0});var $i=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var ji=(a,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of zi(t))!Wi.call(a,s)&&s!==e&&ds(a,s,{get:()=>t[s],enumerable:!(n=Ui(t,s))||n.enumerable});return a};var Bi=(a,t,e)=>(e=a!=null?Ni(Oi(a)):{},ji(t||!a||!a.__esModule?ds(e,"default",{value:a,enumerable:!0}):e,a));var Ds=(a,t,e)=>{if(!t.has(a))throw TypeError("Cannot "+e)};var i=(a,t,e)=>(Ds(a,t,"read from private field"),e?e.call(a):t.get(a)),u=(a,t,e)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,e)},h=(a,t,e,n)=>(Ds(a,t,"write to private field"),n?n.call(a,e):t.set(a,e),e);var Js=$i(Ae=>{"use strict";var ee,be=Ae&&Ae.__classPrivateFieldGet||function(a,t,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?a!==t||!n:!t.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(a):n?n.value:t.get(a)};Object.defineProperty(Ae,"__esModule",{value:!0}),Ae.EventEmitter=void 0;var It=class{constructor(){ee.set(this,{})}on(t,e){t in be(this,ee,"f")||(be(this,ee,"f")[t]=[]),be(this,ee,"f")[t].push(e)}once(t,e){let n=l((...s)=>{e(...s),this.off(t,n)},"i");this.on(t,n)}off(t,e){if(!(t in be(this,ee,"f")))return;let n=be(this,ee,"f")[t].indexOf(e);n!==-1&&be(this,ee,"f")[t].splice(n,1)}emit(t,...e){t in be(this,ee,"f")&&be(this,ee,"f")[t].forEach(n=>n(...e))}};l(It,"i");Ae.EventEmitter=It,ee=new WeakMap,Ae.default=It});var Gi=l(a=>{let t=[],e={},n=[],s="div";return a.replace(/(?!<\\)(["']).+?(?!<\\)(\1)/g,o=>"string$"+(n.push(o.slice(1,-1))-1)).split(/(?=[.#[])/).forEach(o=>{var d;if(!o.match(/^[.#\[]/)){s=o;return}if(o[0]==="."){t.push(o.slice(1));return}if(o[0]==="#"){e.id=o[0].slice(1);return}if(o[0]==="["){let m=o.match(/\[([^=]+)(=(["']?)(.+?)\3)?]/);m!==null&&(e[m[1]]=((d=m[4])!=null?d:"").replace(/string\$(\d+)/,(c,g)=>n[g]));return}}),[s,t,e]},"parseSelector"),y=l(a=>document.createTextNode(a),"t"),p=l((a,...t)=>{let[e,n,s]=Gi(a),r=document.createElement(e);return n.length&&r.classList.add(...n),Fi(r,s),t.length&&r.append(...t),r},"e");var Fi=l((a,t)=>(Object.entries(t).forEach(([e,n])=>a.setAttribute(e,n)),a),"a"),I=l((a,t)=>(Object.entries(t).forEach(([e,n])=>a.addEventListener(e,n)),a),"h");var Ot=l(({hierarchy:a,objects:t},e=null)=>{let n=new Map;e&&Object.keys(t).forEach(r=>e.push(r));let s=l(r=>{if(n.has(r))return n.get(r);if(Array.isArray(r)){let o=[];return n.set(r,o),r.forEach(d=>o.push(s(d))),o}if(r&&r["#ref"]){if(e&&e.splice(e.indexOf(r["#ref"]),1),!(r["#ref"]in t))throw new TypeError(`missing ${r["#ref"]}`);let o=s(t[r["#ref"]]);return n.set(r,o),o}if(r instanceof Object){let o={};return n.set(r,o),Object.entries(r).forEach(([d,m])=>{o[d]=s(m)}),o}return r},"getReferences");return s(a)},"reconstituteData");var Le,pe=class{constructor(t=p("div")){u(this,Le,void 0);h(this,Le,t)}build(...t){}element(){return i(this,Le)}empty(){for(;i(this,Le).firstChild!==null;)i(this,Le).firstChild.remove()}};l(pe,"Element"),Le=new WeakMap;var W=pe;var mt,Se,pt,Wt=class{constructor(t,e){u(this,mt,void 0);u(this,Se,void 0);u(this,pt,void 0);h(this,mt,t),h(this,pt,e),h(this,Se,p("div.action")),i(this,Se).addEventListener("keydown",n=>{n.key!=="Escape"&&n.stopPropagation()}),this.build()}activate(){}build(){}complete(){let t=new CustomEvent("actioned",{bubbles:!0,detail:this});i(this,Se).dispatchEvent(t)}element(){return i(this,Se)}transport(){return i(this,pt)}value(){return i(this,mt).value}};l(Wt,"Action"),mt=new WeakMap,Se=new WeakMap,pt=new WeakMap;var K=Wt;var Xi=l((a,t)=>p("fieldset",p("legend",y(a)),p(`input[type="range"][max="100"][min="0"][step="1"][value="${t}"]`),p('input[type="number"]'),p("label",p('input[type="checkbox"]'),y("Lock"))),"template"),dt,$,Z,We,ct,$t=class extends W{constructor(e,n){super(Xi(e,n));u(this,dt,void 0);u(this,$,void 0);u(this,Z,void 0);u(this,We,void 0);u(this,ct,[]);h(this,dt,e),h(this,$,this.element().querySelector('input[type="range"]')),h(this,Z,this.element().querySelector('input[type="number"]')),h(this,We,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(i(this,$).value),i(this,$).addEventListener("input",()=>this.set(i(this,$).value)),i(this,Z).addEventListener("input",()=>this.set(i(this,Z).value)),i(this,We).addEventListener("input",()=>this.lock()),this.lock()}label(){return i(this,dt)}lock(){if(this.isLocked()){i(this,$).setAttribute("disabled",""),i(this,Z).setAttribute("disabled","");return}i(this,$).removeAttribute("disabled"),i(this,Z).removeAttribute("disabled")}onInput(e){i(this,ct).push(e)}isLocked(){return i(this,We).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),i(this,$).value!==e&&(i(this,$).value=e),i(this,Z).value!==e&&(i(this,Z).value=e),i(this,ct).forEach(n=>n())}value(){return parseInt(i(this,$).value,10)}};l($t,"LockedSlider"),dt=new WeakMap,$=new WeakMap,Z=new WeakMap,We=new WeakMap,ct=new WeakMap;var As=$t;var de,jt=class{constructor(...t){u(this,de,void 0);h(this,de,t),i(this,de).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let n=i(this,de).filter(r=>r!==e),s=n.filter(r=>!r.isLocked());if(this.total()!==100&&s.length===0){e.set((100-this.total(n)).toString());return}if(this.total()>100){let r=this.total()-100,o=Math.ceil(r/s.length);s.forEach(d=>{d.set((d.value()-Math.min(o,r)).toString()),r-=o}),this.total()>100&&e.set((100-this.total(n)).toString())}if(this.total()<100){let r=100-this.total(),o=Math.ceil(r/s.length);s.forEach(d=>{d.set((d.value()+Math.min(o,r)).toString()),r-=o}),this.total()<100&&e.set((100-this.total(n)).toString())}}))}sliders(){return i(this,de)}total(t=i(this,de)){return t.reduce((e,n)=>e+n.value(),0)}};l(jt,"LockedSliderGroup"),de=new WeakMap;var ks=jt;var $e,Bt=class extends pe{constructor(e,n=p("div")){super(n);u(this,$e,void 0);this.element().addEventListener("keydown",s=>{s.stopPropagation()}),this.element().setAttribute("tabindex","0"),h(this,$e,e)}display(){this.build(),i(this,$e).append(this.element())}parent(){return i(this,$e)}};l(Bt,"TransientElement"),$e=new WeakMap;var Hs=Bt;var Rs={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},Pe,ut,je=class extends Hs{constructor(e,n,s={}){var r;super((r=s.parent)!=null?r:Rs.parent,p("div.window"));u(this,Pe,void 0);u(this,ut,void 0);if(this.options={...Rs,...s},h(this,Pe,n),h(this,ut,e),this.options.size==="auto"&&this.element().classList.add("size-auto"),this.options.size==="maximised"&&this.element().classList.add("maximised"),this.options.size!=="auto"&&["height","width"].forEach(o=>{let d=this.options.size[o];if(typeof d=="number"){this.element().style[o]=d+"px";return}this.element().style[o]=d}),this.options.position==="auto"&&this.element().classList.add("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([o,d])=>{this.element().style[d]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[o]))+"px"}),this.options.autoDisplay){this.display();return}this.build()}build(){this.empty();let e=[[this.options.canMaximise,I(p('button.maximise[aria-label="Maximise"]',y("Maximise"),p('img.maximise[src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItbWF4aW1pemUiPjxwYXRoIGQ9Ik04IDNINWEyIDIgMCAwIDAtMiAydjNtMTggMFY1YTIgMiAwIDAgMC0yLTJoLTNtMCAxOGgzYTIgMiAwIDAgMCAyLTJ2LTNNMyAxNnYzYTIgMiAwIDAgMCAyIDJoMyI+PC9wYXRoPjwvc3ZnPg=="][alt="Maximise"]'),p('img.restore[src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItbWluaW1pemUiPjxwYXRoIGQ9Ik04IDN2M2EyIDIgMCAwIDEtMiAySDNtMTggMGgtM2EyIDIgMCAwIDEtMi0yVjNtMCAxOHYtM2EyIDIgMCAwIDEgMi0yaDNNMyAxNmgzYTIgMiAwIDAgMSAyIDJ2MyI+PC9wYXRoPjwvc3ZnPg=="][alt="Restore"]')),{click:()=>this.maximise()})],[this.options.canClose,I(p('button.close[aria-label="Close"]',y("Close"),p('img[src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXIteCI+PGxpbmUgeDE9IjE4IiB5MT0iNiIgeDI9IjYiIHkyPSIxOCI+PC9saW5lPjxsaW5lIHgxPSI2IiB5MT0iNiIgeDI9IjE4IiB5Mj0iMTgiPjwvbGluZT48L3N2Zz4="][alt="Close"]')),{click:()=>this.close()})]].filter(([s])=>s).map(([,s])=>s),n=!1;this.element().append(I(p("header",p("h3",y(i(this,ut))),...e),{dblclick:()=>this.maximise(),mousedown:s=>{if(s.target.matches("button, button img"))return;n=!0;let r=l(o=>{if(!n)return;let d=getComputedStyle(this.element()),m=parseInt(d.getPropertyValue("top"),10),c=parseInt(d.getPropertyValue("left"),10);this.element().style.setProperty("top",m+o.movementY+"px"),this.element().style.setProperty("left",c+o.movementX+"px")},"moveHandler");document.addEventListener("mousemove",r),document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",r),n=!1},{once:!0})}}),p("div.body",i(this,Pe)instanceof Node?i(this,Pe):p("p",y(i(this,Pe))))),this.element().addEventListener("keydown",s=>{s.key==="Escape"&&this.options.canClose&&this.close(),s.stopPropagation()})}close(){this.element().remove(),this.element().dispatchEvent(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||this.element().classList.toggle("maximised")}update(e){this.element().lastElementChild.remove(),this.element().append(e instanceof Node?e:p("p",y(e)))}};l(je,"Window"),Pe=new WeakMap,ut=new WeakMap;var ce=je;var qi=l((a,t)=>t.some(e=>a instanceof e),"instanceOfAny"),Ns,Us;function Vi(){return Ns||(Ns=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}l(Vi,"getIdbProxyableTypes");function Yi(){return Us||(Us=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}l(Yi,"getCursorAdvanceMethods");var zs=new WeakMap,us=new WeakMap,Os=new WeakMap,cs=new WeakMap,gs=new WeakMap;function Ki(a){let t=new Promise((e,n)=>{let s=l(()=>{a.removeEventListener("success",r),a.removeEventListener("error",o)},"unlisten"),r=l(()=>{e(J(a.result)),s()},"success"),o=l(()=>{n(a.error),s()},"error");a.addEventListener("success",r),a.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&zs.set(e,a)}).catch(()=>{}),gs.set(t,a),t}l(Ki,"promisifyRequest");function Zi(a){if(us.has(a))return;let t=new Promise((e,n)=>{let s=l(()=>{a.removeEventListener("complete",r),a.removeEventListener("error",o),a.removeEventListener("abort",o)},"unlisten"),r=l(()=>{e(),s()},"complete"),o=l(()=>{n(a.error||new DOMException("AbortError","AbortError")),s()},"error");a.addEventListener("complete",r),a.addEventListener("error",o),a.addEventListener("abort",o)});us.set(a,t)}l(Zi,"cacheDonePromiseForTransaction");var hs={get(a,t,e){if(a instanceof IDBTransaction){if(t==="done")return us.get(a);if(t==="objectStoreNames")return a.objectStoreNames||Os.get(a);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return J(a[t])},set(a,t,e){return a[t]=e,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function Ws(a){hs=a(hs)}l(Ws,"replaceTraps");function Ji(a){return a===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){let n=a.call(Gt(this),t,...e);return Os.set(n,t.sort?t.sort():[t]),J(n)}:Yi().includes(a)?function(...t){return a.apply(Gt(this),t),J(zs.get(this))}:function(...t){return J(a.apply(Gt(this),t))}}l(Ji,"wrapFunction");function Qi(a){return typeof a=="function"?Ji(a):(a instanceof IDBTransaction&&Zi(a),qi(a,Vi())?new Proxy(a,hs):a)}l(Qi,"transformCachableValue");function J(a){if(a instanceof IDBRequest)return Ki(a);if(cs.has(a))return cs.get(a);let t=Qi(a);return t!==a&&(cs.set(a,t),gs.set(t,a)),t}l(J,"wrap");var Gt=l(a=>gs.get(a),"unwrap");function js(a,t,{blocked:e,upgrade:n,blocking:s,terminated:r}={}){let o=indexedDB.open(a,t),d=J(o);return n&&o.addEventListener("upgradeneeded",m=>{n(J(o.result),m.oldVersion,m.newVersion,J(o.transaction),m)}),e&&o.addEventListener("blocked",m=>e(m.oldVersion,m.newVersion,m)),d.then(m=>{r&&m.addEventListener("close",()=>r()),s&&m.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),d}l(js,"openDB");var er=["get","getKey","getAll","getAllKeys","count"],tr=["put","add","delete","clear"],fs=new Map;function $s(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(fs.get(t))return fs.get(t);let e=t.replace(/FromIndex$/,""),n=t!==e,s=tr.includes(e);if(!(e in(n?IDBIndex:IDBObjectStore).prototype)||!(s||er.includes(e)))return;let r=l(async function(o,...d){let m=this.transaction(o,s?"readwrite":"readonly"),c=m.store;return n&&(c=c.index(d.shift())),(await Promise.all([c[e](...d),s&&m.done]))[0]},"method");return fs.set(t,r),r}l($s,"getMethod");Ws(a=>({...a,get:(t,e,n)=>$s(t,e)||a.get(t,e,n),has:(t,e)=>!!$s(t,e)||a.has(t,e)}));var ne,Q,ht=class{constructor(t,e,n){u(this,ne,void 0);u(this,Q,void 0);h(this,Q,e),h(this,ne,js(t,1,{upgrade:s=>s.createObjectStore(i(this,Q),n)}))}async get(t){return(await i(this,ne)).get(i(this,Q),t)}async getAll(t,e){return(await i(this,ne)).getAll(i(this,Q),t,e)}async set(t,e){return(await i(this,ne)).put(i(this,Q),t,e)}async clear(){return(await i(this,ne)).clear(i(this,Q))}async keys(){return(await i(this,ne)).getAllKeys(i(this,Q))}};l(ht,"Store"),ne=new WeakMap,Q=new WeakMap;var nr=l((a,t,e)=>{let n=document.createElement("canvas"),s=n.getContext("2d");return n.width=a.width*t,n.height=a.height*t,e!=null&&e.smoothing||(s.imageSmoothingEnabled=!1),s.drawImage(a,0,0,n.width,n.height),n},"scaleImage"),Bs=nr;var Be,Ge,Fe,Xt,Ft=class extends ht{constructor(){super("civ-clone-assets","assets",{keyPath:"name"});u(this,Be,new Map);u(this,Ge,new Map);u(this,Fe,new Map);u(this,Xt,["./assets/city/bulb.png","./assets/city/food.png","./assets/city/gold.png","./assets/city/luxury.png","./assets/city/people_content_f.png","./assets/city/people_content_m.png","./assets/city/people_happy_f.png","./assets/city/people_happy_m.png","./assets/city/people_luxury.png","./assets/city/people_science.png","./assets/city/people_tax.png","./assets/city/people_unhappy_f.png","./assets/city/people_unhappy_m.png","./assets/city/pollution.png","./assets/city/sad.png","./assets/city/production.png","./assets/city/trade.png","./assets/cursor/go.png","./assets/cursor/torch.png","./assets/general/texture_1.png","./assets/general/texture_2.png","./assets/improvements/irrigation.png","./assets/improvements/mine.png","./assets/improvements/pollution.png","./assets/improvements/railroad_e.png","./assets/improvements/railroad_se.png","./assets/improvements/railroad_n.png","./assets/improvements/railroad_ne.png","./assets/improvements/railroad_nw.png","./assets/improvements/railroad_s.png","./assets/improvements/railroad_sw.png","./assets/improvements/railroad_w.png","./assets/improvements/road_e.png","./assets/improvements/road_n.png","./assets/improvements/road_ne.png","./assets/improvements/road_nw.png","./assets/improvements/road_s.png","./assets/improvements/road_se.png","./assets/improvements/road_sw.png","./assets/improvements/road_w.png","./assets/map/city.png","./assets/map/fog_e.png","./assets/map/fog_n.png","./assets/map/fog_s.png","./assets/map/fog_w.png","./assets/map/fort.png","./assets/map/fortify.png","./assets/map/hut.png","./assets/status/pollution_0.png","./assets/status/pollution_25.png","./assets/status/pollution_50.png","./assets/status/pollution_75.png","./assets/status/science_0.png","./assets/status/science_25.png","./assets/status/science_50.png","./assets/status/science_75.png","./assets/terrain/arctic.png","./assets/terrain/arctic_e.png","./assets/terrain/arctic_es.png","./assets/terrain/arctic_esw.png","./assets/terrain/arctic_ew.png","./assets/terrain/arctic_n.png","./assets/terrain/arctic_ne.png","./assets/terrain/arctic_nes.png","./assets/terrain/arctic_nesw.png","./assets/terrain/arctic_new.png","./assets/terrain/arctic_ns.png","./assets/terrain/arctic_nsw.png","./assets/terrain/arctic_nw.png","./assets/terrain/arctic_s.png","./assets/terrain/arctic_sw.png","./assets/terrain/arctic_w.png","./assets/terrain/coal.png","./assets/terrain/coast_sprite.png","./assets/terrain/desert.png","./assets/terrain/desert_e.png","./assets/terrain/desert_es.png","./assets/terrain/desert_esw.png","./assets/terrain/desert_ew.png","./assets/terrain/desert_n.png","./assets/terrain/desert_ne.png","./assets/terrain/desert_nes.png","./assets/terrain/desert_nesw.png","./assets/terrain/desert_new.png","./assets/terrain/desert_ns.png","./assets/terrain/desert_nsw.png","./assets/terrain/desert_nw.png","./assets/terrain/desert_s.png","./assets/terrain/desert_sw.png","./assets/terrain/desert_w.png","./assets/terrain/doe.png","./assets/terrain/fish.png","./assets/terrain/forest.png","./assets/terrain/forest_e.png","./assets/terrain/forest_es.png","./assets/terrain/forest_esw.png","./assets/terrain/forest_ew.png","./assets/terrain/forest_n.png","./assets/terrain/forest_ne.png","./assets/terrain/forest_nes.png","./assets/terrain/forest_nesw.png","./assets/terrain/forest_new.png","./assets/terrain/forest_ns.png","./assets/terrain/forest_nsw.png","./assets/terrain/forest_nw.png","./assets/terrain/forest_s.png","./assets/terrain/forest_sw.png","./assets/terrain/forest_w.png","./assets/terrain/gems.png","./assets/terrain/gold.png","./assets/terrain/grassland.png","./assets/terrain/grassland_e.png","./assets/terrain/grassland_es.png","./assets/terrain/grassland_esw.png","./assets/terrain/grassland_ew.png","./assets/terrain/grassland_n.png","./assets/terrain/grassland_ne.png","./assets/terrain/grassland_nes.png","./assets/terrain/grassland_nesw.png","./assets/terrain/grassland_new.png","./assets/terrain/grassland_ns.png","./assets/terrain/grassland_nsw.png","./assets/terrain/grassland_nw.png","./assets/terrain/grassland_s.png","./assets/terrain/grassland_sw.png","./assets/terrain/grassland_w.png","./assets/terrain/hills.png","./assets/terrain/hills_e.png","./assets/terrain/hills_es.png","./assets/terrain/hills_esw.png","./assets/terrain/hills_ew.png","./assets/terrain/hills_n.png","./assets/terrain/hills_ne.png","./assets/terrain/hills_nes.png","./assets/terrain/hills_nesw.png","./assets/terrain/hills_new.png","./assets/terrain/hills_ns.png","./assets/terrain/hills_nsw.png","./assets/terrain/hills_nw.png","./assets/terrain/hills_s.png","./assets/terrain/hills_sw.png","./assets/terrain/hills_w.png","./assets/terrain/horse.png","./assets/terrain/jungle.png","./assets/terrain/jungle_e.png","./assets/terrain/jungle_es.png","./assets/terrain/jungle_esw.png","./assets/terrain/jungle_ew.png","./assets/terrain/jungle_n.png","./assets/terrain/jungle_ne.png","./assets/terrain/jungle_nes.png","./assets/terrain/jungle_nesw.png","./assets/terrain/jungle_new.png","./assets/terrain/jungle_ns.png","./assets/terrain/jungle_nsw.png","./assets/terrain/jungle_nw.png","./assets/terrain/jungle_s.png","./assets/terrain/jungle_sw.png","./assets/terrain/jungle_w.png","./assets/terrain/land.png","./assets/terrain/mountains.png","./assets/terrain/mountains_e.png","./assets/terrain/mountains_es.png","./assets/terrain/mountains_esw.png","./assets/terrain/mountains_ew.png","./assets/terrain/mountains_n.png","./assets/terrain/mountains_ne.png","./assets/terrain/mountains_nes.png","./assets/terrain/mountains_nesw.png","./assets/terrain/mountains_new.png","./assets/terrain/mountains_ns.png","./assets/terrain/mountains_nsw.png","./assets/terrain/mountains_nw.png","./assets/terrain/mountains_s.png","./assets/terrain/mountains_sw.png","./assets/terrain/mountains_w.png","./assets/terrain/oasis.png","./assets/terrain/ocean.png","./assets/terrain/oil.png","./assets/terrain/plains.png","./assets/terrain/plains_e.png","./assets/terrain/plains_es.png","./assets/terrain/plains_esw.png","./assets/terrain/plains_ew.png","./assets/terrain/plains_n.png","./assets/terrain/plains_ne.png","./assets/terrain/plains_nes.png","./assets/terrain/plains_nesw.png","./assets/terrain/plains_new.png","./assets/terrain/plains_ns.png","./assets/terrain/plains_nsw.png","./assets/terrain/plains_nw.png","./assets/terrain/plains_s.png","./assets/terrain/plains_sw.png","./assets/terrain/plains_w.png","./assets/terrain/river_e.png","./assets/terrain/river_es.png","./assets/terrain/river_esw.png","./assets/terrain/river_ew.png","./assets/terrain/river_mouth_e.png","./assets/terrain/river_mouth_n.png","./assets/terrain/river_mouth_s.png","./assets/terrain/river_mouth_w.png","./assets/terrain/river.png","./assets/terrain/river_n.png","./assets/terrain/river_ne.png","./assets/terrain/river_nes.png","./assets/terrain/river_nesw.png","./assets/terrain/river_new.png","./assets/terrain/river_ns.png","./assets/terrain/river_nsw.png","./assets/terrain/river_nw.png","./assets/terrain/river_s.png","./assets/terrain/river_sw.png","./assets/terrain/river_w.png","./assets/terrain/seal.png","./assets/terrain/shield.png","./assets/terrain/game.png","./assets/terrain/swamp.png","./assets/terrain/swamp_e.png","./assets/terrain/swamp_es.png","./assets/terrain/swamp_esw.png","./assets/terrain/swamp_ew.png","./assets/terrain/swamp_n.png","./assets/terrain/swamp_ne.png","./assets/terrain/swamp_nes.png","./assets/terrain/swamp_nesw.png","./assets/terrain/swamp_new.png","./assets/terrain/swamp_ns.png","./assets/terrain/swamp_nsw.png","./assets/terrain/swamp_nw.png","./assets/terrain/swamp_s.png","./assets/terrain/swamp_sw.png","./assets/terrain/swamp_w.png","./assets/terrain/tundra.png","./assets/terrain/tundra_e.png","./assets/terrain/tundra_es.png","./assets/terrain/tundra_esw.png","./assets/terrain/tundra_ew.png","./assets/terrain/tundra_n.png","./assets/terrain/tundra_ne.png","./assets/terrain/tundra_nes.png","./assets/terrain/tundra_nesw.png","./assets/terrain/tundra_new.png","./assets/terrain/tundra_ns.png","./assets/terrain/tundra_nsw.png","./assets/terrain/tundra_nw.png","./assets/terrain/tundra_s.png","./assets/terrain/tundra_sw.png","./assets/terrain/tundra_w.png","./assets/units/tank.png","./assets/units/artillery.png","./assets/units/battleship.png","./assets/units/bomber.png","./assets/units/cannon.png","./assets/units/caravan.png","./assets/units/carrier.png","./assets/units/catapult.png","./assets/units/horseman.png","./assets/units/chariot.png","./assets/units/combat_1.png","./assets/units/combat_2.png","./assets/units/combat_3.png","./assets/units/combat_4.png","./assets/units/combat_5.png","./assets/units/combat_6.png","./assets/units/combat_7.png","./assets/units/combat_8.png","./assets/units/cruiser.png","./assets/units/diplomat.png","./assets/units/fighter.png","./assets/units/frigate.png","./assets/units/ironclad.png","./assets/units/knight.png","./assets/units/swordman.png","./assets/units/mechanizedinfantry.png","./assets/units/warrior.png","./assets/units/musketman.png","./assets/units/nuclear.png","./assets/units/spearman.png","./assets/units/rifleman.png","./assets/units/sail.png","./assets/units/settlers.png","./assets/units/submarine.png","./assets/units/transport.png","./assets/units/trireme.png"])}async get(e){return i(this,Be).has(e)||i(this,Be).set(e,await super.get(e)),i(this,Be).get(e)}async getImage(e){if(!i(this,Ge).has(e)){let n=await this.get(e),s=document.createElement("img");s.src=n.uri,i(this,Ge).set(e,s)}return i(this,Ge).get(e)}async getScaled(e,n){return i(this,Fe).has(e)||i(this,Fe).set(e,Bs(await this.getImage(e),n)),i(this,Fe).get(e)}async hasAllAssets(){return(await this.missingAssets()).length===0}async missingAssets(){let e=await this.keys();return i(this,Xt).filter(n=>!e.includes(n))}};l(Ft,"AssetStore"),Be=new WeakMap,Ge=new WeakMap,Fe=new WeakMap,Xt=new WeakMap;var L=new Ft;var gt,qt=class extends K{constructor(){super(...arguments);u(this,gt,void 0)}activate(){let e=[];new ce("Adjust trade rates",p("div",...this.value().all.map(s=>{let r=new As(s._,s.value*100);return e.push(r),r.element()}))).element().addEventListener("close",()=>{this.transport().send("action",{name:"AdjustTradeRates",id:this.value().id,value:i(this,gt).sliders().map(s=>[s.label(),parseFloat((s.value()/100).toFixed(2))])})}),h(this,gt,new ks(...e))}build(){L.get("./assets/city/trade.png").then(e=>this.element().append(p(`button.adjustTradeRates[title="Adjust trade rates"][style="background-image:url('${e.uri}')"]`)))}value(){return super.value()}};l(qt,"AdjustTradeRates"),gt=new WeakMap;var Gs=qt;var xs=[],ft,Vt=class extends je{constructor(e,n,s={}){let r={queue:!0,...s};super(e,n,r);u(this,ft,{});h(this,ft,r),this.element().classList.add("notificationWindow"),this.element().addEventListener("keydown",o=>{o.key==="Enter"&&(this.close(),o.stopPropagation())})}close(){if(super.close(),i(this,ft).queue&&xs.length&&Vt.hasOpenWindow()){let[e,n,s]=xs.shift();e.display(n),s()}}display(e=!0){return new Promise(n=>{if(Vt.hasOpenWindow()){xs.push([this,e,n]);return}if(super.display(),!e){n(void 0);return}this.element().focus(),n(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},ue=Vt;l(ue,"NotificationWindow"),ft=new WeakMap;var Yt=ue;var xt,yt,he=class extends ue{constructor(e,n,s,r="Please choose one of the following:",o={}){var c,g;o={autoFocus:!0,displayAll:!1,...o,actions:{primary:{label:"OK",action:f=>d(f.selectionList().value),...(g=(c=o.actions)==null?void 0:c.primary)!=null?g:{}},...o.actions}};let d=l(f=>{this.element().dispatchEvent(new CustomEvent("selection",{detail:f})),this.close(),s(f)},"chooseHandler"),m=I(p("select",...n.map(f=>p(`option[value="${f.value}"]`,y(f.label||f.value)))),{keydown:f=>{f.key==="Enter"&&d(m.value)},dblclick:()=>d(m.value)});o.displayAll&&n.length>1&&m.setAttribute("size",n.length.toString()),o.autoFocus&&m.setAttribute("autofocus","");super(e,p("div",...r instanceof Node?[r]:r===null?[]:[p("p",y(r))],m,p("footer",...Object.entries(o.actions).map(([,{label:f,action:x}])=>I(p("button",y(f)),{click:()=>x(this),keydown:b=>{b.key==="Enter"&&x(this)}})))),o);u(this,xt,l(()=>this.resize(),"#resizeHandler"));u(this,yt,void 0);this.element().classList.add("selectionWindow"),h(this,yt,m),this.resize(),window.addEventListener("resize",i(this,xt))}close(){window.removeEventListener("resize",i(this,xt)),super.close()}display(){return super.display(!1).then(()=>{let e=this.element().querySelector("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,n;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-this.element().firstElementChild.offsetHeight-((n=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?n:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2em)`}catch(s){console.warn(s)}}selectionList(){return i(this,yt)}};l(he,"SelectionWindow"),xt=new WeakMap,yt=new WeakMap;var ge=he;var Kt=class extends K{activate(){let t=new ge("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){L.get("./assets/city/bulb.png").then(t=>this.element().append(p(`button.chooseResearch[title="Choose research"][style="background-image:url('${t.uri}')"]`)))}value(){return super.value()}};l(Kt,"ChooseResearch");var Fs=Kt;var Zt={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLawContent:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},fe=Object.entries(Zt).reduce((a,[t,e])=>(Object.prototype.hasOwnProperty.call(a,e)||(a[e]=[]),a[e].push(t),a),{}),Xs={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var qs,Vs=l(a=>qs=a,"setPreloadContainer"),ys=l(a=>{let t=qs.querySelector(`[data-path$="${a}.png"]`);return t===null?(console.error(`Missing image: ${a}.`),p("canvas")):t},"getPreloadedImage"),ws=ys;var sr=l((a,t,e)=>{let n=p("canvas"),s=n.getContext("2d");n.width=a.width,n.height=a.height,s.drawImage(a,0,0,a.width,a.height);let r=s.getImageData(0,0,n.width,n.height),o=l(c=>{var x;let g=null,f={r:0,g:0,b:0,a:0};return typeof c=="string"?(g=c.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?f={r:parseInt(g[1],16),g:parseInt(g[2],16),b:parseInt(g[3],16),a:1}:(g=c.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?f={r:parseInt(g[1]+g[1],16),g:parseInt(g[2]+g[2],16),b:parseInt(g[3]+g[3],16),a:1}:(g=c.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?f={r:parseInt(g[1]),g:parseInt(g[2]),b:parseInt(g[3]),a:1}:(g=c.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(f={r:parseInt(g[1]),g:parseInt(g[2]),b:parseInt(g[3]),a:parseFloat((x=g[4])!=null?x:1)}):"length"in c&&(f={r:c[0]||0,g:c[1]||0,b:c[2]||0,a:c[3]||1}),f},"getColor"),d=t.map(o),m=e.map(o);for(let c=0;c<r.data.length;c+=4)d.forEach((g,f)=>{r.data[c]===g.r&&r.data[c+1]===g.g&&r.data[c+2]===g.b&&r.data[c+3]===g.a*255&&(r.data[c]=(m[f]||m[0]).r,r.data[c+1]=(m[f]||m[0]).g,r.data[c+2]=(m[f]||m[0]).b,r.data[c+3]=Math.trunc((m[f]||m[0]).a*255))});return s.putImageData(r,0,0),n},"replaceColours"),Jt=sr;var xe,De,wt,ye,bt,we,j=class{constructor(t,e=2,n=16,s=p("canvas")){u(this,xe,void 0);u(this,De,void 0);u(this,wt,!0);u(this,ye,void 0);u(this,bt,void 0);u(this,we,void 0);h(this,xe,s),h(this,we,t),h(this,bt,n),h(this,ye,e),this.setCanvasSize(),h(this,De,i(this,xe).getContext("2d")),Vs(document.querySelector("#preload"))}canvas(){return i(this,xe)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return i(this,De)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:n})=>this.renderTile(this.world().get(e,n)))}renderTile({x:t,y:e}){let n=this.tileSize(),s=t*n,r=e*n;this.context().clearRect(s,r,n,n)}scale(){return i(this,ye)}tileSize(){return i(this,bt)*i(this,ye)}update(t){t.forEach(({x:e,y:n})=>this.renderTile(this.world().get(e,n)))}world(){return i(this,we)}drawImage(t,e,n,s={}){var c,g;let r=this.tileSize(),o=e*r,d=n*r,m=this.getPreloadedImage(t);this.putImage(s.augment?s.augment(m):m,o+((c=s.offsetX)!=null?c:0),d+((g=s.offsetY)!=null?g:0))}filterNeighbours(t,e,n=["n","e","s","w"]){return n.filter(s=>e(i(this,we).getNeighbour(t,s)))}getPreloadedImage(t){return ys(t)}putImage(t,e,n){i(this,De).imageSmoothingEnabled=!1,i(this,De).drawImage(t,e,n,t.width*i(this,ye),t.height*i(this,ye))}replaceColours(t,e,n){return Jt(t,e,n)}setCanvasSize(){i(this,xe).height=i(this,we).height()*this.tileSize(),i(this,xe).width=i(this,we).width()*this.tileSize()}isVisible(){return i(this,wt)}setVisible(t){h(this,wt,t)}};l(j,"Map"),xe=new WeakMap,De=new WeakMap,wt=new WeakMap,ye=new WeakMap,bt=new WeakMap,we=new WeakMap;var Ys=j;var Qt=class extends j{renderTile(t){super.renderTile(t);let{x:e,y:n}=t,s=this.tileSize(),r=e*s,o=n*s;if(t.city){let d=t.city,m=d.player,c=m.civilization,[g]=c.attributes.filter(f=>f.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(r,o,s,s)),this.context().fillStyle=g.value[0],this.context().fillRect(r+this.scale(),o+this.scale(),s-this.scale()*2,s-this.scale()*2),this.drawImage("map/city",e,n,{augment:f=>this.replaceColours(f,["#000"],[g.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}};l(Qt,"Cities");var vt=Qt;var en=class extends ue{constructor(t,e,n,s={}){var o,d;let r=I(p("button",y((o=s.okLabel)!=null?o:"OK")),{click:()=>{n(),this.close()},keydown:m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),m.stopPropagation(),n(),this.close())}});super(t,p("div.content",p("p",y(e)),p("footer",r,I(p("button",y((d=s.cancelLabel)!=null?d:"Cancel")),{click:()=>this.close(),keydown:m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),m.stopPropagation(),this.close())}}))),{...s,queue:!1}),r.focus()}};l(en,"ConfirmationWindow");var Ks=en;var Xe,qe,tn=class{constructor(t,e){u(this,Xe,void 0);u(this,qe,[]);this.setIds(t),h(this,Xe,n=>{let{detail:s}=n,r=s.value.objects;!r||i(this,qe).some(o=>o in r)&&document.addEventListener("dataupdated",o=>e(o.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",i(this,Xe))}dispose(){document.removeEventListener("patchdatareceived",i(this,Xe))}setIds(t){i(this,qe).splice(0,i(this,qe).length,...t)}};l(tn,"DataObserver"),Xe=new WeakMap,qe=new WeakMap;var Zs=tn;var nn=class extends j{update(t){let e=[...t];return t.forEach(n=>{["n","ne","e","se","s","sw","w","nw"].forEach(s=>{let r=this.world().getNeighbour(n,s);e.includes(r)||e.push(r)})}),super.update(e)}};l(nn,"TerrainAbstract");var z=nn;var sn=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:n}=t;t.terrain.features.length&&t.terrain.features.forEach(s=>s._==="Shield"?this.drawImage(`terrain/${s._.toLowerCase()}`,e,n,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${s._.toLowerCase()}`,e,n))}};l(sn,"Feature");var rn=sn;var an=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:n}=t;this.filterNeighbours(t,s=>s.terrain._==="Unknown").forEach(s=>this.drawImage(`map/fog_${s}`,e,n))}};l(an,"Fog");var on=an;var ln=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:n}=t,s=t.improvements.reduce((r,o)=>{let d=o._;return d in r&&(r[d]=!0),r},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(r=>{s[r]&&this.drawImage(`improvements/${r.toLowerCase()}`,e,n)}),s.Road){let r=this.filterNeighbours(t,d=>d.improvements.some(m=>m._==="Road"),["n","ne","e","se","s","sw","w","nw"]),o=this.filterNeighbours(t,d=>!!d.city||d.improvements.some(m=>m._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(r.forEach(d=>{(!s.Railroad||!o.includes(d))&&this.drawImage(`improvements/road_${d}`,e,n)}),s.Railroad&&o.forEach(d=>this.drawImage(`improvements/railroad_${d}`,e,n)),r.length===0&&o.length===0){let d=this.tileSize(),m=e*d,c=n*d,g=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=s.Railroad?"#000":"#8c5828",this.context().rect(m+g,c+g,this.scale()*2,this.scale()*2),this.context().fill()}}}};l(ln,"Terrain");var mn=ln;var pn=class extends ge{constructor(t,e,n=()=>{}){super("Activate unit",t.map(s=>{var r,o;return{label:s._+" ["+((o=(r=s.city)==null?void 0:r.name)!=null?o:"NONE")+"]"+(s.busy?` (${s.busy._})`:""),value:s.id}}),s=>{let[r]=t.filter(o=>o.id===s);if(!!r){if(!r.active){e.send("action",{name:"InactiveUnit",id:s});return}n(r)}},null)}};l(pn,"InactiveUnitSelectionWindow");var dn=pn;var cn=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:n}=t;!t.improvements.some(r=>r._==="Irrigation")||this.drawImage("improvements/irrigation",e,n)}};l(cn,"Terrain");var un=cn;var hn=class extends z{renderTile(t){super.renderTile(t);let{x:e,y:n}=t,s=this.tileSize(),r=e*s,o=n*s;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,n);else if(t.isWater&&(this.drawImage("terrain/ocean",e,n),t.isCoast)){let d=this.getPreloadedImage("terrain/coast_sprite"),m=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(m>0){let c=m&7,g=m>>2&7,f=m>>4&7,x=m>>6&7|(m&1)<<2,b=p('canvas[height="16"][width="16"]'),C=b.getContext("2d");C.drawImage(d,c<<4,0,8,8,0,0,8,8),C.drawImage(d,(g<<4)+8,0,8,8,8,0,8,8),C.drawImage(d,(f<<4)+8,8,8,8,8,8,8,8),C.drawImage(d,x<<4,8,8,8,0,8,8,8),this.putImage(b,r,o)}this.filterNeighbours(t,c=>c.terrain._==="River").forEach(c=>this.drawImage(`terrain/river_mouth_${c}`,e,n))}}}};l(hn,"Land");var _t=hn;var Qs=Bi(Js());var ir={playerId:null,scale:2,tileSize:16},k,N,ke,B,Et,se,He,Tt,P,gn=class extends Qs.EventEmitter{constructor(e,n,s=p("canvas"),r={playerId:null,scale:2},...o){let d={...ir,...r};super();u(this,k,void 0);u(this,N,{x:0,y:0});u(this,ke,void 0);u(this,B,[]);u(this,Et,null);u(this,se,void 0);u(this,He,void 0);u(this,Tt,void 0);u(this,P,void 0);h(this,P,e),h(this,k,s),h(this,Et,d.playerId),h(this,He,d.tileSize),h(this,se,d.scale),h(this,Tt,n),o.forEach(m=>i(this,B).push(new m(i(this,P),this.scale(),this.tileSize()))),h(this,ke,s.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){i(this,B).forEach(n=>n.update(e))}canvas(){return i(this,k)}center(){return i(this,N)}getLayer(e){var n;return(n=this.getLayers(e).shift())!=null?n:null}getLayers(e){return i(this,B).filter(n=>n instanceof e)}isVisible(e,n){let s=Math.floor(i(this,k).width/i(this,He)),r=Math.floor(i(this,k).height/i(this,He));if(s>=i(this,P).width()&&r>=i(this,P).height())return!0;let[o,d,m,c]=this.visibleBounds();return(s>=i(this,P).width()||(o>d?e<d||e>o:e<d&&e>o))&&(r>=i(this,P).height()||(m>c?n<c||n>m:n<c&&n>m))}playerId(){return i(this,Et)}render(){let e=i(this,B)[0].tileSize(),n=i(this,P).width()*e,s=i(this,N).x*e+Math.trunc(e/this.scale()),r=Math.trunc(i(this,k).width/2),o=i(this,P).height()*e,d=i(this,N).y*e+Math.trunc(e/this.scale()),m=Math.trunc(i(this,k).height/2),c=r-s,g=r+n,f=m-d,x=m+o;for(;c>0;)c-=n;for(;f>0;)f-=o;for(;g<i(this,k).width;)g+=n;for(;x<i(this,k).height;)x+=o;i(this,ke).fillStyle="#000",i(this,ke).fillRect(0,0,Math.max(i(this,P).width()*e,i(this,k).width),Math.max(i(this,P).height()*e,i(this,k).height));for(let b=c;b<g;b+=n)for(let C=f;C<x;C+=o)i(this,B).forEach(H=>{if(!H.isVisible())return;let F=H.canvas();i(this,ke).drawImage(F,b,C,F.width,F.height)})}scale(){return i(this,se)}setCenter(e,n){i(this,N).x=e,i(this,N).y=n,this.render(),this.emit("focus-changed",e,n)}tileSize(){return i(this,He)}transport(){return i(this,Tt)}visibleBounds(){let e=Math.floor(i(this,k).width/i(this,B)[0].tileSize()/i(this,se)),n=Math.floor(i(this,k).height/i(this,B)[0].tileSize()/i(this,se)),s=(i(this,N).x-e+i(this,P).width())%i(this,P).width(),r=(i(this,N).x+e)%i(this,P).width(),o=(i(this,N).y-n+i(this,P).height())%i(this,P).height(),d=(i(this,N).y+n)%i(this,P).height();return[s,r,o,d]}visibleRange(){let e=Math.floor(i(this,k).width/i(this,B)[0].tileSize()/i(this,se)),n=Math.floor(i(this,k).height/i(this,B)[0].tileSize()/i(this,se));return[{x:i(this,N).x-e,y:i(this,N).y-n},{x:i(this,N).x+e,y:i(this,N).y+n}]}world(){return i(this,P)}};l(gn,"Portal"),k=new WeakMap,N=new WeakMap,ke=new WeakMap,B=new WeakMap,Et=new WeakMap,se=new WeakMap,He=new WeakMap,Tt=new WeakMap,P=new WeakMap;var fn=gn;var xn=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:n}=t,s=this.filterNeighbours(t,r=>t.terrain._==="River"&&r.isWater||t.terrain._===r.terrain._).join("");t.terrain._!=="Ocean"&&(s?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${s}`,e,n):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,n))}};l(xn,"Terrain");var yn=xn;var bn,Ve,ve,_e,Ie,wn=class{constructor(t){u(this,bn,l((t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}),"#unknown"));u(this,Ve,{});u(this,ve,void 0);u(this,_e,void 0);u(this,Ie,void 0);h(this,_e,t.height),h(this,Ie,t.width),h(this,ve,t.tiles||[])}get(t,e){for(;t<0;)t+=i(this,Ie);for(;e<0;)e+=i(this,_e);for(;t>=i(this,Ie);)t-=i(this,Ie);for(;e>=i(this,_e);)e-=i(this,_e);let n=[t,e].toString();if(!(n in i(this,Ve))){let s=i(this,ve).findIndex(r=>r.x===t&&r.y===e);if(s===-1)return i(this,bn).call(this,t,e);i(this,Ve)[n]=s}return i(this,ve)[i(this,Ve)[n]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return i(this,_e)}tiles(){return i(this,ve)}width(){return i(this,Ie)}setTiles(t){h(this,ve,t)}};l(wn,"World"),bn=new WeakMap,Ve=new WeakMap,ve=new WeakMap,_e=new WeakMap,Ie=new WeakMap;var vn=wn;var _n=class extends Ys{renderTile(t){super.renderTile(t);let{x:e,y:n}=t,s=this.tileSize(),r=e*s,o=n*s,d=t.yields.reduce((f,x)=>f+x.value,0),m=t.yields.sort((f,x)=>f._.charCodeAt(0)-x._.charCodeAt(0)),c=0;if(d<5){let f=[[r,o],[r+s/2,o],[r,o+s/2],[r+s/2,o+s/2]];m.forEach(x=>{for(let b=0;b<x.value;b++)this.putImage(this.getPreloadedImage(`city/${x._.toLowerCase()}`),...f[c++])});return}if(d<7){let f=[[r,o],[r+s/3,o],[r+s/3*2,o],[r,o+s/2],[r+s/3,o+s/2],[r+s/3*2,o+s/2]];m.forEach(x=>{for(let b=0;b<x.value;b++)this.putImage(this.getPreloadedImage(`city/${x._.toLowerCase()}`),f[c][0],f[c++][1])});return}if(d<9){let f=[[r,o],[r+s/4,o],[r+s/4*2,o],[r+s/4*3,o],[r,o+s/2],[r+s/4,o+s/2],[r+s/4*2,o+s/2],[r+s/4*3,o+s/2]];m.forEach(x=>{for(let b=0;b<x.value;b++)this.putImage(this.getPreloadedImage(`city/${x._.toLowerCase()}`),...f[c++])});return}if(d<11){let f=[[r,o],[r+s/5,o],[r+s/5*2,o],[r+s/5*3,o],[r+s/5*4,o],[r,o+s/2],[r+s/5,o+s/2],[r+s/5*2,o+s/2],[r+s/5*3,o+s/2],[r+s/5*4,o+s/2]];m.forEach(x=>{for(let b=0;b<x.value;b++)this.putImage(this.getPreloadedImage(`city/${x._.toLowerCase()}`),...f[c++])});return}let g=[[r,o],[r+s/6,o],[r+s/6*2,o],[r+s/6*3,o],[r+s/6*4,o],[r+s/6*5,o],[r,o+s/2],[r+s/6,o+s/2],[r+s/6*2,o+s/2],[r+s/6*3,o+s/2],[r+s/6*4,o+s/2],[r+s/6*5,o+s/2]];m.forEach(f=>{for(let x=0;x<f.value;x++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[c++])})}};l(_n,"Yields");var Ye=_n;var rr={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},ar=l((a,t=16)=>{var d,m;let e=a.player,n=e.civilization,[s]=n.attributes.filter(c=>c.name==="colors"),r=Jt(ws(`units/${a._.toLowerCase()}`),["#60E064","#2C7800"],s.value),o=r.getContext("2d");if(o.imageSmoothingEnabled=!1,(d=a.improvements)!=null&&d.some(c=>c._==="Fortified")&&o.drawImage(ws("map/fortify"),0,0),a.busy){let c=t/2,g=t*.75,f=(m=rr[a.busy._])!=null?m:a.busy._.replace(/[a-z]+/g,"");o.font="bold 8px sans-serif",o.fillStyle="black",o.textAlign="center",o.fillText(f,c,g),o.fillStyle="white",o.fillText(f,c,g)}return r},"renderUnit"),In=ar;var Mt,En=class extends W{constructor(e,n=2){super(p('canvas[width="32"][height="32"]'));u(this,Mt,2);h(this,Mt,n),this.build(e)}build(e){let n=In(e),s=this.element().getContext("2d");s.imageSmoothingEnabled=!1;let r=this.size(n.width),o=this.size(n.height),d=Math.floor((this.size(16)-r)/2),m=Math.floor((this.size(16)-o)/2);s.drawImage(n,d,m,r,o)}element(){return super.element()}size(e=16){return e*i(this,Mt)}};l(En,"Unit"),Mt=new WeakMap;var bs=En;var or=l(a=>Math.max(1,Math.ceil((a.build.cost.value-a.build.progress.value)/a.yields.filter(t=>fe.Production.includes(t._)).reduce((t,e)=>t+e.value,0))),"buildTurns"),lr=l(a=>Math.max(1,Math.ceil((a.growth.cost.value-a.growth.progress.value)/a.yields.filter(t=>fe.Food.includes(t._)).reduce((t,e)=>t+e.value,0))),"growthTurns"),mr=l(a=>{let t=a.growth,e=parseInt(a.name.replace(/[^a-z]/gi,""),36).toString(2),[n,s]=a.yields.reduce(([m,c],g)=>(fe.Happiness.includes(g._)&&(m+=g.value),fe.Unhappiness.includes(g._)&&(c+=g.value),[m,c]),[0,0]),r=new Array(t.size).fill(1),o=r.length-1;for(;s>0&&o>-1;)r[o--]=0,s--;for(o=0;n>0&&o<r.length;)r[o]===0&&(r[o]++,n--),r[o]===1&&(r[o++]++,n--),r[o]===2&&o++;let d=p("div.population");return r.forEach((m,c)=>L.getScaled(`./assets/city/people_${["unhappy","content","happy"][m]}_${["f","m"][parseInt(e[c%e.length],10)]}.png`,2).then(g=>d.append(p("span.citizen",p(`img[src="${g.toDataURL("image/png")}"]`))))),d},"renderPopulation"),pr=l((a,t)=>t.filter(e=>fe[a].includes(e._)).reduce(([e,n],s)=>[e+(s.value<0?-s.value:0),n+s.value],[0,0]),"reduceYield"),dr=l(a=>p("div.yields-detail",...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>p(`div.yields[data-yields="${t.join(" ")}"]`,...t.map(e=>p(`span.yield[data-yield="${e}"]`,...pr(e,a.yields).map((n,s)=>p(`span.${["used","free"][s]}`,...vs({id:"",_:e,value:n,values:[]}))))))),...Object.entries(a.yields.filter(t=>!Object.keys(Zt).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>p("div",p("div",y(t)),p("div",y(e))))),"renderYields"),cr=l((a,t,e)=>{let n=p("canvas"),s=new fn(new vn(t.player.world),e,n,{playerId:t.player.id,scale:a.scale(),tileSize:a.tileSize()},_t,un,yn,mn,rn,on,vt,Ye);return n.height=a.tileSize()*a.scale()*5,n.width=a.tileSize()*a.scale()*5,s.setCenter(t.tile.x,t.tile.y),s.build(t.tiles),s.getLayer(Ye).render(t.tilesWorked),s.render(),I(p("div.city-map",n),{click:()=>e.send("action",{name:"ReassignWorkers",city:t.id})})},"renderMap"),vs=l(a=>new Array(Math.abs(a.value)).fill(0).map(()=>{let t=p("span.yield-icon");return L.getScaled(`./assets/${Xs[Zt[a._]]}`,2).then(e=>{t.append(p(`img[src="${e.toDataURL("image/png")}"]`))}),t}),"yieldImages"),ur=l((a,t,e)=>{let n=or(a);return p("div.build",p("header",y(`Building ${a.build.building?a.build.building.item._:"nothing"}`)),I(p("button",y(a.build.building?"Change":"Choose")),{click(){t()}}),I(p("button",y("Buy")),{click(){e()}}),a.build.building?p("p",y(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${n} turn${n===1?"":"s"})`)):y(""))},"renderBuildDetails"),hr=l(a=>{let t=a.growth,e=lr(a);return p("div.growth",p("header",y("Growth")),p("p",y(`Size ${t.size.toString()}`)),p("p",y(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${e} turn${e===1?"":"s"})`)))},"renderGrowth"),gr=l(a=>p("div.improvements",p("div",...a.improvements.map(t=>p("div",y(t._),...a.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>vs(e)))))),"renderImprovements"),fr=l((a,t)=>I(p("div.garrisoned-units",p("header",y("Garrisoned Units")),p("div.units",...a.tile.units.map(e=>new bs(e).element()))),{click(){let e=a.tile.units.filter(n=>n.player.id===a.player.id);e.length!==0&&new dn(e,t)}}),"renderGarrisonedUnits"),xr=l(a=>p("div.supported-units",p("header",y("Supported Units")),p("div.units",...a.units.map(t=>p("span.unit",new bs(t).element(),...a.yields.filter(e=>["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"].includes(e._)).filter(e=>e.unit.id===t.id).flatMap(e=>vs(e)))))),"renderSupportedUnits"),ei=l((a,t,e,n,s)=>p("div.city-screen",p("div.top-row",p("div.yield-details",mr(a),dr(a),xr(a)),cr(t,a,e),gr(a)),p("div.bottom-row",hr(a),p("div.tabbed-details",p("div.info",fr(a,e))),ur(a,n,s))),"buildDetails"),ie,Ke,Ct,Ze,Tn=class extends ce{constructor(e,n,s){super(e.name,ei(e,n,s,()=>this.changeProduction(),()=>this.completeProduction()),{size:"maximised"});u(this,ie,void 0);u(this,Ke,void 0);u(this,Ct,void 0);u(this,Ze,void 0);this.element().classList.add("city-screen-window"),h(this,ie,e),h(this,Ct,n),h(this,Ze,s),h(this,Ke,new Zs([e.id,e.build.id,e.growth.id,...e.units.map(r=>r.id)],r=>{var d,m;let[o]=((m=(d=r.player)==null?void 0:d.cities)!=null?m:[]).filter(c=>e.id===c.id);if(!o){this.close();return}h(this,ie,o),i(this,Ke).setIds([o.id,o.build.id,o.growth.id,...o.units.map(c=>c.id)]),this.update(ei(o,i(this,Ct),s,()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus()})),this.element().addEventListener("keydown",r=>{["c","C"].includes(r.key)&&(this.changeProduction(),r.preventDefault(),r.stopPropagation()),["b","B"].includes(r.key)&&(this.completeProduction(),r.preventDefault(),r.stopPropagation()),["Enter","x","X"].includes(r.key)&&this.close()})}changeProduction(){new Je(i(this,ie).build,i(this,Ze),()=>this.element().focus())}close(){i(this,Ke).dispose(),super.close()}completeProduction(){!i(this,ie).build.building||new Ks("Are you sure?",`Do you want to rush building of ${i(this,ie).build.building.item._}`,()=>i(this,Ze).send("action",{name:"CompleteProduction",id:i(this,ie).id}))}};l(Tn,"City"),ie=new WeakMap,Ke=new WeakMap,Ct=new WeakMap,Ze=new WeakMap;var Mn=Tn;var Lt,Cn,Qe=class extends he{constructor(e,n,s=()=>{},r={}){let o=e.city.yields.filter(m=>m._==="Production").reduce((m,c)=>m+c.value,0),d=l(m=>Math.ceil((m.cost.value-e.progress.value)/o),"turns");super(`What would you like to build in ${e.city.name}?`,e.available.map(m=>({label:`${m.item._} (Cost: ${m.cost.value} / ${d(m)} turn${d(m)===1?"":"s"})`,value:m.item._})),m=>{!m||(n.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:m||"@"}),this.close(!0))},null,{actions:r,displayAll:!0});u(this,Lt,void 0);u(this,Cn,void 0);h(this,Lt,s),h(this,Cn,n)}close(e=!1){super.close(),e&&i(this,Lt).call(this,e)}};l(Qe,"CityBuildSelectionWindow"),Lt=new WeakMap,Cn=new WeakMap,Qe.showCityAction=l((e,n,s)=>({label:"View city",action(r){r.close(),new Mn(e,n,s)}}),"showCityAction"),Qe.showCityOnMapAction=l((e,n)=>({label:"Show on map",action(s){s.close(),n.setCenter(e.tile.x,e.tile.y)}}),"showCityOnMapAction");var Je=Qe;var et,Ln=class extends K{constructor(e,n,s){super(e,s);u(this,et,void 0);h(this,et,n)}activate(){new Je(this.value(),this.transport(),()=>this.complete(),{showCity:Je.showCityAction(this.value().city,i(this,et),this.transport()),showCityOnMap:Je.showCityOnMapAction(this.value().city,i(this,et))})}build(){let e=this.value();L.get("./assets/city/production.png").then(n=>this.element().append(p(`button.cityBuild[title="What would you like to build in ${e.city.name}?"][style="background-image:url('${n.uri}')"]`)))}value(){return super.value()}};l(Ln,"CityBuild"),et=new WeakMap;var ti=Ln;var Sn=class extends K{activate(){this.transport().send("action",{name:"EndTurn"})}build(){this.element().append(p('button.endTurn[title="End turn"]'))}};l(Sn,"EndTurn");var ni=Sn;var Pn=class extends K{activate(){let t=new ge("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){L.get("./assets/city/sad.png").then(t=>this.element().append(p(`button.chooseGovernment[title="Choose government"][style="background-image:url('${t.uri}')"]`)))}value(){return super.value()}};l(Pn,"Revolution");var si=Pn;var St,re,Dn=class extends pe{constructor(e=p("div.actions"),n,s){super(e);u(this,St,void 0);u(this,re,void 0);h(this,St,n),h(this,re,s),this.element().addEventListener("actioned",r=>r.detail.element().remove()),this.element().addEventListener("keydown",r=>{var f;let o=document.activeElement;if(!this.element().contains(o))return;let{key:d}=r,m=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(d)||m.length===0)return;r.preventDefault(),r.stopPropagation();let c=o===this.element()?["ArrowLeft","ArrowUp"].includes(d)?o.firstElementChild:o.lastElementChild:o;for(;c.parentElement!==this.element();)c=c.parentElement;let g=m.indexOf(c);if(["ArrowUp","ArrowLeft"].includes(d)){if(g>0){(f=m[g-1].querySelector("button"))==null||f.focus();return}m.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(d)){if(g<m.length-1){m[g+1].querySelector("button").focus();return}m.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(n=>{let s;switch(n._){case"ActiveUnit":return;case"AdjustTradeRates":s=new Gs(n,i(this,re));break;case"ChooseResearch":s=new Fs(n,i(this,re));break;case"CityBuild":s=new ti(n,i(this,St),i(this,re));break;case"EndTurn":s=new ni(n,i(this,re));break;case"Revolution":s=new si(n,i(this,re));break;default:console.log("need to handle "+n._);return}this.element().prepend(I(s.element(),{click:()=>s.activate(),keydown:({key:r})=>{(r===" "||r==="Enter")&&s.activate()}}))})}};l(Dn,"Actions"),St=new WeakMap,re=new WeakMap;var _s=Dn;var Re,An=class extends j{constructor(){super(...arguments);u(this,Re,null)}renderTile(e){super.renderTile(e);let{x:n,y:s}=e,r=this.tileSize(),o=n*r,d=s*r;if(e.units.length>0&&(i(this,Re)!==null?i(this,Re).tile.id!==e.id:!0)){let[m]=e.units.sort((g,f)=>{var x,b;return((x=f.defence)==null?void 0:x.value)-((b=g.defence)==null?void 0:b.value)}),c=this.renderUnit(m);e.units.length>1&&this.putImage(c,o-this.scale(),d-this.scale()),this.putImage(c,o,d)}}renderUnit(e){return In(e)}setActiveUnit(e){h(this,Re,e)}activeUnit(){return i(this,Re)}};l(An,"Units"),Re=new WeakMap;var Pt=An;var kn=class extends Pt{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:n}=t.tile,s=this.world().get(e,n),r=this.tileSize(),o=e*r,d=n*r,m=this.renderUnit(t);s.units.length>1&&this.putImage(m,o-this.scale(),d-this.scale()),this.putImage(m,o,d)}update(){this.render()}};l(kn,"ActiveUnit");var Is=kn;var Hn=class extends j{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:n}=t,s=this.tileSize(),r=e*s,o=n*s,d=t.city,m=this.tileSize()/2,c=this.tileSize()*.75,g=this.tileSize()/2,f=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(d.growth.size.toString(),r+m+this.scale(),o+c),this.context().fillText(d.name,r+g+this.scale(),o+f),this.context().fillStyle="white",this.context().fillText(d.growth.size.toString(),r+m,o+c-this.scale()),this.context().fillText(d.name,r+g,o+f-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}};l(Hn,"CityNames");var Es=Hn;var Dt,At,Rn=class extends W{constructor(e,n,s){super(e);u(this,Dt,void 0);u(this,At,void 0);h(this,Dt,n),h(this,At,s)}build(){this.empty(),this.element().append(p("h3",p("span#year",y(this.year())),p("span#turn",y(`(${i(this,Dt).value.toString()})`))))}year(e=i(this,At).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};l(Rn,"GameDetails"),Dt=new WeakMap,At=new WeakMap;var ii=Rn;var Nn=class extends fn{bindEvents(){this.canvas().addEventListener("click",t=>{let e=this.center(),n=t.offsetX,s=t.offsetY;for(n=(n-(this.canvas().width/2-this.tileSize()))/(this.tileSize()*this.scale())+e.x,s=(s-(this.canvas().height/2-this.tileSize()))/(this.tileSize()*this.scale())+e.y;n<0;)n+=this.world().width();for(;s<0;)s+=this.world().height();for(;n>this.world().width();)n-=this.world().width();for(;s>this.world().height();)s-=this.world().height();let r=this.world().get(Math.trunc(n),Math.trunc(s)),o=r.units.filter(d=>d.player.id===this.playerId());if(r.city)new Mn(r.city,this,this.transport());else if(o.length){new dn(o,this.transport(),d=>this.emit("activate-unit",d));return}this.setCenter(r.x,r.y)})}};l(Nn,"GamePortal");var ri=Nn;var Un=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:n}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,n)}};l(Un,"Terrain");var ai=Un;var Ne,Ee,zn=class{constructor(t=500){u(this,Ne,!1);u(this,Ee,[]);setInterval(()=>this.check(),t)}check(){i(this,Ne)||i(this,Ee).forEach(t=>t())}clear(){h(this,Ee,[])}off(t){h(this,Ee,i(this,Ee).filter(e=>e!==t))}on(t){i(this,Ee).push(t)}pause(){h(this,Ne,!0)}isPaused(){return i(this,Ne)}resume(){h(this,Ne,!1)}};l(zn,"IntervalHandler"),Ne=new WeakMap,Ee=new WeakMap;var oi=zn;var kt,Ht,On=class{constructor(t,...e){u(this,kt,void 0);u(this,Ht,void 0);h(this,kt,e),h(this,Ht,t)}args(){return i(this,kt)}channel(){return i(this,Ht)}};l(On,"Request"),kt=new WeakMap,Ht=new WeakMap;var tt=On;var Wn=class extends tt{constructor(t){super("getOptions",t)}};l(Wn,"Options");var li=Wn;var nt,Ue,$n=class extends ce{constructor(e,n){super("Customise world",p("div.customise-world"));u(this,nt,void 0);u(this,Ue,void 0);h(this,nt,n),h(this,Ue,e),this.init()}build(){super.build(),this.init()}async init(){var g,f,x,b,C,H;let e=await i(this,Ue).request(new li(["players","height","width","landCoverage","landSize","maxIterations"])),n=p(`input[name="players"][type="number"][value="${(g=e.players)!=null?g:7}"][step="1"][min="1"][max="20"]`),s=p(`input[name="height"][type="number"][value="${(f=e.height)!=null?f:60}"][step="1"][min="1"]`),r=p(`input[name="width"][type="number"][value="${(x=e.width)!=null?x:80}"][step="1"][min="1"]`),o=p(`input[name="landCoverage"][type="number"][value="${(b=e.landCoverage)!=null?b:.4}"][step="0.01"][min="0"]`),d=p(`input[name="landSize"][type="number"][value="${(C=e.landSize)!=null?C:.2}"][step="0.01"][min="0"]`),m=p(`input[name="maxIterations"][type="number"][value="${(H=e.maxIterations)!=null?H:20}"][step="1"][min="1"]`),c=l(async()=>{this.close(),await i(this,Ue).request(new tt("setOptions",{players:n.value,height:s.value,width:r.value,landCoverage:o.value,landSize:d.value,maxIterations:m.value})),i(this,Ue).send("start"),i(this,nt)&&i(this,nt).call(this)},"submit");this.update(p("div.customise-world",p("div.option",p("label",y("Players")),n),p("div.option",p("label",y("Height")),s),p("div.option",p("label",y("Width")),r),p("div.option",p("label",y("Land coverage")),o),p("div.option",p("label",y("Land size")),d),p("div.option",p("label",y("Max iterations")),m),I(p("button",y("Build")),{click:()=>c()}))),this.element().addEventListener("keydown",F=>{F.key==="Enter"&&c()})}};l($n,"CustomiseWorldWindow"),nt=new WeakMap,Ue=new WeakMap;var mi=$n;var jn=class{constructor(){this.blob=null;this.ptr=-1}fromString(t,e){this.blob=t,this.ptr=0,this.decode(e)}getUByte(){return this.blob.charCodeAt(this.ptr++)}getUShort(){let t=this.getUByte();return(this.getUByte()<<8)+t}getShort(){return(this.getUShort()+32768)%65536-32768}getString(t){let e=this.ptr;return this.ptr+=t,this.blob.substr(e,t)}decode(t){if(this.blob===null){console.warn("file has not been loaded!");return}console.warn("The decode function should be overwritten"),t&&t()}};l(jn,"BinFile");var pi=jn;var Bn=class{constructor(t){this.dicTable=[];this.dicTable=[],this.dicSize=1<<t;for(let e=0;e<this.dicSize;e++)e<256?this.dicTable[e]=[e]:this.dicTable[e]=null;this.curPos=257}getEntry(t){return t<this.curPos?this.dicTable[t]:null}isFull(){return this.curPos===this.dicTable.length}getCurPos(){return this.curPos}addEntry(t){return this.curPos<this.dicTable.length&&(this.dicTable[this.curPos]=t,this.curPos++),this.curPos-1}};l(Bn,"LZWDictionary");var di=Bn;var Gn=class{static parseByteStreamToIndexes(t,e,n){let s=[],r=0,o=0,d=1,m=1,c=256,g=0,f=0;for(;e>0;){for(;o<8+d;)r|=t.getUByte()<<o,e--,o+=8;for(;o>=8+d;)f=r&(m<<8&65280|255),r>>=8+d,o-=8+d,g++,g==c&&(g=0,d+=1,m<<=1,m|=1,c<<=1,8+d>n&&(g=0,d=1,m=1,c=256)),s.push(f)}return s}static decode(t,e){e=e||11;let n=t,s=[];for(;n.length>0;){let r=new di(e),o=[n[0]],d=n[0],m=r.getEntry(d),c=d,g,f=0;for(;!r.isFull()&&f++<n.length-1;){g=n[f];let x=[];g>=r.getCurPos()?(x=r.getEntry(d),x===null&&console.error(`No dictionary entry in LZW special case: oldCode=${d}; newCode=${g}; i=${f}; buffer=${m}`),x=[...x??[],c]):x=r.getEntry(n[f]),o.push.apply(o,x),c=x[0],r.addEntry(m.concat(c)),d=g,m=r.getEntry(d)}s.push.apply(s,o),n=n.slice(f+1)}return s}static RLEDecode(t){let e=[],n=0,s=!1;for(let r=0;r<t.length;r++){let o=t[r];if(s){if(o==0)n=144,e.push(144);else for(let d=0;d<o-1;d++)e.push(n);s=!1}else o==144?s=!0:(e.push(o),n=o)}return e}};l(Gn,"LZW");var Fn=Gn;var yr=l(a=>a&15,"lowerNibble"),ci=yr;var wr=l(a=>(a&240)>>4,"upperNibble"),ui=wr;var Xn=class extends pi{constructor(){super(...arguments);this.palette=[];this.palette16=[{r:255,g:255,b:255,a:0},{r:170,g:0,b:0,a:255},{r:0,g:170,b:0,a:255},{r:170,g:170,b:0,a:255},{r:0,g:0,b:170,a:255},{r:0,g:0,b:0,a:255},{r:0,g:85,b:170,a:255},{r:170,g:170,b:170,a:255},{r:85,g:85,b:85,a:255},{r:255,g:85,b:85,a:255},{r:85,g:255,b:85,a:255},{r:255,g:255,b:85,a:255},{r:85,g:85,b:255,a:255},{r:255,g:85,b:255,a:255},{r:85,g:255,b:255,a:255},{r:255,g:255,b:255,a:255}];this.imageData=null;this.imageHeight=0;this.imageWidth=0;this.byteMode=11}decode(e){let n=this.getString(2),s=this.getShort();if(n=="M0")this.getPaletteData(),n=this.getString(2),s=this.getShort();else{console.log("Creating a random color palette...");for(let r=0;r<256;r++)r<16?this.palette.push(this.palette16[r]):this.palette.push({r:Math.floor(Math.random()*256),g:Math.floor(Math.random()*256),b:Math.floor(Math.random()*256),a:255})}n=="X0"?this.getX0ImageData(s):n=="X1"?this.getX1ImageData(s):console.error('"'+n+'" is an unknown chunk type'),e&&e()}getPaletteData(){let e=this.getUByte(),n=this.getUByte(),s=n-e+1,r=!1;for(let o=0;o<s;o++){let d={r:this.getUByte()*4,g:this.getUByte()*4,b:this.getUByte()*4,a:255};this.palette.push(d),d.r===d.g&&d.g===d.b&&d.r===0&&(r||(d.a=0),r=!0)}this.palette.push({r:0,g:0,b:0,a:0})}getX0ImageData(e){this.imageWidth=this.getShort(),this.imageHeight=this.getShort(),this.byteMode=this.getUByte();let n=Fn.parseByteStreamToIndexes(this,e-5,this.byteMode),s=Fn.decode(n,this.byteMode);this.imageData=Fn.RLEDecode(s)}getX1ImageData(e){this.getX0ImageData(e);let n=this.imageData;this.imageData=[];for(let s=0;s<n.length;s++)this.imageData.push(ci(n[s])),this.imageData.push(ui(n[s]));this.palette=this.palette16}draw(e,n=0,s=0){let r=e.getImageData(0,0,this.imageWidth,this.imageHeight),o=0;for(let d=0;d<this.imageHeight;d++)for(let m=0;m<this.imageWidth;m++){let c=this.imageData[o],g=(m+d*this.imageWidth)*4;r.data[g]=this.palette[c].r,r.data[g+1]=this.palette[c].g,r.data[g+2]=this.palette[c].b,r.data[g+3]=this.palette[c].a,o++}e.putImageData(r,n,s)}};l(Xn,"PicImage");var hi=Xn;var gi=l((a,t,e,n,s=r=>console.log(r))=>{let r=n(320,200),o=new hi,d=[];return o.fromString(a,()=>{o.draw(r.getContext("2d",{willReadFrequently:!0})),Object.entries(t).forEach(([m,c])=>c.forEach(g=>g.contents.forEach(f=>{let x={...e,...g,...f},b=`./assets/${m+x.name}.png`,C=n(x.width,x.height),H=C.getContext("2d",{willReadFrequently:!0});H.clearRect(0,0,x.width,x.height),H.drawImage(r,x.x,x.y,x.width,x.height,0,0,x.width,x.height);for(let F=0;F<r.width;F++)for(let ae=0;ae<r.height;ae++){let Ce=H.getImageData(F,ae,1,1).data;Ce[0]==x.clear.r&&Ce[1]==x.clear.g&&Ce[2]==x.clear.b&&H.clearRect(F,ae,1,1)}s(`Processing ${b}...`),d.push({name:b,uri:C.toDataURL("image/png")})})))}),d},"extractSprites");var Rt={defaults:{height:16,width:16,clear:{r:0,g:170,b:170}},files:{"SP257.PIC":{"cursor/go":[{y:33,x:33,height:12,width:12,contents:[{name:""}]}],"city/pollution":[{y:32,x:48,contents:[{name:""}]}],"improvements/irrigation":[{y:32,x:64,contents:[{name:""}]}],"improvements/mine":[{y:32,x:80,contents:[{name:""}]}],"improvements/pollution":[{y:32,x:96,contents:[{name:""}]}],"cursor/torch":[{y:33,x:113,height:13,width:13,contents:[{name:""}]}],"city/food":[{y:33,x:129,height:7,width:7,contents:[{name:""}]}],"city/production":[{y:33,x:137,height:7,width:7,contents:[{name:""}]}],"city/trade":[{y:33,x:145,height:7,width:7,contents:[{name:""}]}],"city/gold":[{y:33,x:153,height:7,width:7,contents:[{name:""}]}],"city/bulb":[{y:41,x:129,height:7,width:7,contents:[{name:""}]}],"city/sad":[{y:41,x:137,height:7,width:7,contents:[{name:""}]}],"city/luxury":[{y:41,x:145,height:7,width:7,contents:[{name:""}]}],"terrain/":[{y:41,x:153,height:7,width:7,contents:[{name:"shield"}]}],"improvements/road":[{y:48,contents:[{name:"_n",x:0},{name:"_ne",x:16},{name:"_e",x:32},{name:"_se",x:48},{name:"_s",x:64},{name:"_sw",x:80},{name:"_w",x:96},{name:"_nw",x:112}]}],"status/science":[{y:48,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"status/pollution":[{y:56,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"terrain/land":[{y:64,contents:[{name:"",x:0}]}],"terrain/river":[{y:64,contents:[{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:224},{name:"_nesw",x:240}]}],"units/combat":[{y:97,height:15,width:15,contents:[{name:"_1",x:1},{name:"_2",x:17},{name:"_3",x:33},{name:"_4",x:49},{name:"_5",x:65},{name:"_6",x:81},{name:"_7",x:97},{name:"_8",x:113}]}],"improvements/railroad":[{y:96,contents:[{name:"_n",x:128},{name:"_ne",x:144},{name:"_e",x:160},{name:"_se",x:176},{name:"_s",x:192},{name:"_sw",x:208},{name:"_w",x:224},{name:"_nw",x:240}]}],"terrain/oasis":[{y:113,height:15,width:15,contents:[{name:"",x:1}]}],"terrain/horse":[{y:113,height:15,width:15,contents:[{name:"",x:17}]}],"terrain/doe":[{y:113,height:15,width:15,contents:[{name:"",x:49}]}],"terrain/coal":[{y:113,height:15,width:15,contents:[{name:"",x:65}]}],"terrain/gold":[{y:113,height:15,width:15,contents:[{name:"",x:81}]}],"terrain/game":[{y:113,height:15,width:15,contents:[{name:"",x:97}]}],"terrain/seal":[{y:113,height:15,width:15,contents:[{name:"",x:113}]}],"terrain/oil":[{y:113,height:15,width:15,contents:[{name:"",x:129}]}],"terrain/gems":[{y:113,height:15,width:15,contents:[{name:"",x:145}]}],"terrain/fish":[{y:113,width:15,height:15,contents:[{name:"",x:161}]}],"map/city":[{y:113,contents:[{name:"",x:193}]}],"map/fortify":[{width:15,height:15,y:113,contents:[{name:"",x:209}]}],"map/fort":[{width:15,height:15,y:113,contents:[{name:"",x:225}]}],"map/hut":[{y:113,height:15,width:15,contents:[{name:"",x:241}]}],"city/people":[{y:128,height:16,width:8,contents:[{name:"_happy_m",x:0},{name:"_happy_f",x:8},{name:"_content_m",x:16},{name:"_content_f",x:24},{name:"_unhappy_m",x:32},{name:"_unhappy_f",x:40},{name:"_tax",x:48},{name:"_science",x:56},{name:"_luxury",x:64}]}],"map/fog":[{y:128,contents:[{name:"_n",x:80},{name:"_e",x:96},{name:"_s",x:112},{name:"_w",x:128}]}],"units/":[{y:161,height:15,width:15,contents:[{name:"settlers",x:1},{name:"warrior",x:17},{name:"spearman",x:33},{name:"swordman",x:49},{name:"musketman",x:65},{name:"rifleman",x:81},{name:"horseman",x:97},{name:"knight",x:113},{name:"catapult",x:129},{name:"cannon",x:145},{name:"chariot",x:161},{name:"tank",x:177},{name:"mechanizedinfantry",x:193},{name:"artillery",x:209},{name:"fighter",x:225},{name:"bomber",x:241},{name:"trireme",x:257},{name:"sail",x:273},{name:"frigate",x:289},{name:"ironclad",x:305}]},{y:177,contents:[{name:"cruiser",x:1},{name:"battleship",x:17},{name:"submarine",x:33},{name:"carrier",x:49},{name:"transport",x:65},{name:"nuclear",x:81},{name:"diplomat",x:97},{name:"caravan",x:113}]}],"general/texture":[{y:176,contents:[{name:"_1",x:288},{name:"_2",x:304}]}]},"TER257.PIC":{"terrain/desert":[{y:0,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/plains":[{y:16,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/grassland":[{y:32,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/forest":[{y:48,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/hills":[{y:64,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/mountains":[{y:80,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/tundra":[{y:96,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/arctic":[{y:112,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/swamp":[{y:128,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/jungle":[{y:144,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/ocean":[{y:160,contents:[{name:"",x:0}]}],"terrain/coast_sprite":[{x:0,y:176,height:16,width:128,contents:[{name:""}]}],"terrain/river":[{y:160,contents:[{name:"",x:240}]},{y:176,contents:[{name:"_mouth_n",x:128},{name:"_mouth_e",x:144},{name:"_mouth_s",x:160},{name:"_mouth_w",x:176}]}]}}};var st,q,qn=class extends ce{constructor(){let e=p('input[type="file"][multiple]'),n=p("p.loading[hidden]");super("Import assets",p("div.import-assets",p("p",y(`Upload ${Object.keys(Rt.files).join(", ")} from the original Civilization files to extract assets (these will be stored locally). This process can take at least a few minutes.`)),p("p",I(e,{change:s=>this.handleFileUpload(s)})),n));u(this,st,void 0);u(this,q,void 0);h(this,st,e),h(this,q,n)}async handleFileUpload(e){var d;i(this,st).setAttribute("disabled",""),i(this,q).removeAttribute("hidden"),i(this,q).innerText="Building image assets...";let n=Array.from((d=e.target.files)!=null?d:[]),s=n.map(m=>m.name);if(!Object.keys(Rt.files).map(m=>new RegExp(m,"i")).every(m=>s.some(c=>c.match(m)))){console.error(`Please provide ${s.join(", ")} to process the assets.`);return}let o=[];if(await Promise.all(n.map(async m=>new Promise(c=>{let g=Rt.files[m.name.toUpperCase()];if(!g){console.warn(`No definitions found for ${m.name}, skipping.`);return}let f=new FileReader;f.addEventListener("load",async x=>{gi(x.target.result,g,Rt.defaults,(b,C)=>{let H=document.createElement("canvas");return H.width=b,H.height=C,H},b=>{i(this,q).innerText=b}).forEach(b=>o.push(b)),c()}),f.readAsBinaryString(m)}))),i(this,q).innerText="Writing to database...",await Promise.all(o.map(m=>L.set(m))),!await L.hasAllAssets()){console.error("Something went wrong..."),i(this,q).style.color="#f00",i(this,q).innerText="Not all expected data was written. Might need to try again... Missing: "+(await L.missingAssets()).join(", "),i(this,st).removeAttribute("disabled");return}i(this,q).innerText="Done! Please reload the page to utilise the fresh assets.",location.reload()}};l(qn,"ImportAssetsWindow"),st=new WeakMap,q=new WeakMap;var fi=qn;var Vn=class extends he{constructor(t,e,n,s="Please choose one of the following:",r={canClose:!1,displayAll:!1}){super(t,e,n,s,{...r,displayAll:!0})}display(){return new Promise(t=>{this.element().addEventListener("selection",({detail:e})=>t(e)),super.display()})}};l(Vn,"MandatorySelection");var xi=Vn;var Yn=class extends xi{constructor(t,e){super("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],async n=>{this.close(),await t.request(new tt("setOptions",{width:80,height:60,players:parseInt(n,10)})),t.send("start"),e&&e()})}};l(Yn,"NewGameWindow");var yi=Yn;var ze,Kn=class extends W{constructor(e,n){super(e);u(this,ze,void 0);h(this,ze,n),this.build(),e.classList.add("active")}async build(e=!1){let n=await L.hasAllAssets();n||(console.log("Missing assets:"),console.log(await L.missingAssets())),this.element().append(I(p("nav",I(p("button[autofocus]"+(n?"":"[hidden]"),y("Start a New Game")),{click:()=>new yi(i(this,ze),()=>this.remove())}),I(p("button"+(n?"":"[hidden]"),y("Customise World")),{click:async()=>new mi(i(this,ze),()=>this.remove())}),I(p("button",y(n?"Update assets":"Import assets")),{click:()=>new fi}),I(p("button"+(e?"":"[hidden]"),y("Quit")),{click:()=>{this.remove(),i(this,ze).send("quit")}})),{keydown(s){let r=document.activeElement;r===null||!r.matches("#mainmenu nav button")||(s.key==="ArrowDown"&&r.nextElementSibling&&r.nextElementSibling.focus(),s.key==="ArrowUp"&&r.previousElementSibling&&r.previousElementSibling.focus())}}))}disableButtons(){this.element().querySelectorAll("button").forEach(e=>e.setAttribute("disabled",""))}remove(){this.element().classList.remove("active"),setTimeout(()=>{this.element().remove()},2e3)}};l(Kn,"MainMenu"),ze=new WeakMap;var wi=Kn;var G,V,Oe,it,te,Zn=class{constructor(t,e,n,...s){u(this,G,void 0);u(this,V,void 0);u(this,Oe,void 0);u(this,it,void 0);u(this,te,void 0);h(this,V,t),h(this,te,e),h(this,it,n),h(this,Oe,s),h(this,G,i(this,V).getContext("2d")),i(this,V).addEventListener("click",r=>{let o=r.offsetX-i(this,V).offsetLeft,d=r.offsetY-i(this,V).offsetTop,m=Math.ceil(o/i(this,V).offsetWidth*i(this,te).width()),c=Math.ceil(d/i(this,V).offsetHeight*i(this,te).height());i(this,it).setCenter(m,c),this.update()})}update(){let t=i(this,Oe)[0].canvas().height*(190/i(this,Oe)[0].canvas().width);i(this,V).height=t,i(this,G).clearRect(0,0,190,t),i(this,Oe).forEach(s=>i(this,G).drawImage(s.canvas(),0,0,190,t));let[e,n]=i(this,it).visibleRange();i(this,G).lineWidth=1,i(this,G).strokeStyle="#fff",i(this,G).fillStyle="rgba(255, 255, 255, .2)",i(this,G).rect(Math.floor(190/i(this,te).width()*e.x),Math.floor(t/i(this,te).height()*e.y),Math.floor(190/i(this,te).width()*(n.x-e.x)),Math.floor(t/i(this,te).height()*(n.y-e.y))),i(this,G).stroke(),i(this,G).fill()}};l(Zn,"Minimap"),G=new WeakMap,V=new WeakMap,Oe=new WeakMap,it=new WeakMap,te=new WeakMap;var bi=Zn;var Nt,rt,Jn=class{constructor(t=document.body){u(this,Nt,void 0);u(this,rt,[]);h(this,Nt,t)}receive(t){i(this,rt).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!i(this,rt).length||t)return;let e=i(this,rt).shift();this.publish(e)}publish(t){var n;new Yt((n=t.title)!=null?n:"Notification",t.message,{parent:i(this,Nt)}).element().addEventListener("close",()=>this.check())}};l(Jn,"Notifications"),Nt=new WeakMap,rt=new WeakMap;var vi=Jn;var Ut,Qn=class extends W{constructor(e,n){super(e);u(this,Ut,void 0);h(this,Ut,n)}build(){this.empty();let{civilization:e,treasury:n,research:s,cities:r}=i(this,Ut),[o,d]=r.reduce(([c,g],f)=>f.yields.reduce(([x,b],C)=>C._==="Research"?[x,b+C.value]:fe.Gold.includes(C._)?[x+C.value,b]:[x,b],[c,g]),[0,0]),m=Math.ceil((s.cost.value-s.progress.value)/d);this.element().append(p("h3",y(`${e.leader.name} of the ${e._} empire`)),p("p",p("strong",y("Researching")),p("br"),y(s.researching?`${s.researching._} ${s.progress.value} / ${s.cost.value} (${m} turn${m===1?"":"s"})`:"Nothing")),p("p",p("strong",y("Treasury")),p("br"),y(`${n.value} (${o} / turn)`)))}};l(Qn,"PlayerDetails"),Ut=new WeakMap;var _i=Qn;var M,es=class extends W{constructor(e,n){super(e);u(this,M,void 0);h(this,M,n),this.build()}build(){var e,n;this.empty(),i(this,M)!==null&&this.element().append(p("p",y(`${i(this,M)._} (${i(this,M).tile.x}, ${i(this,M).tile.y})`)),p("p",y((n=(e=i(this,M).city)==null?void 0:e.name)!=null?n:"NONE")),p("p",y(`${Number.isInteger(i(this,M).moves.value)?i(this,M).moves.value:i(this,M).moves.value.toFixed(2)} / ${i(this,M).movement.value} moves`)),p("p",y(`A: ${i(this,M).attack.value} / D: ${i(this,M).defence.value} / V: ${i(this,M).visibility.value}`)),p("p",y(`${i(this,M).improvements.map(s=>s._).join(", ")}`)),p("p",y(`${i(this,M).tile.terrain._}${i(this,M).tile.terrain.features?" "+i(this,M).tile.terrain.features.map(s=>s._).join(", "):""}${i(this,M).tile.improvements.length?" ("+i(this,M).tile.improvements.map(s=>s._).join(", ")+")":""}`)),p("p",y(`${i(this,M).tile.units.filter(s=>s!==i(this,M)).map(s=>s._).join(", ")}`)))}};l(es,"UnitDetails"),M=new WeakMap;var Ii=es;var Te,ts=class{constructor(t){u(this,Te,void 0);h(this,Te,t)}init(){let t=i(this,Te);L.getScaled("./assets/cursor/torch.png",2).then(n=>document.body.style.cursor=`url('${n.toDataURL("image/png")}'), default`);let e={autoEndOfTurn:!0};try{let n=document.getElementById("notification"),s=document.querySelector("#mainmenu"),r=document.getElementById("actions"),o=document.getElementById("other-actions"),d=document.getElementById("game"),m=document.getElementById("map"),c=m.querySelector("canvas"),g=document.getElementById("gameDetails"),f=document.getElementById("playerDetails"),x=document.getElementById("minimap"),b=document.getElementById("unitInfo"),C=document.getElementById("preload"),H=new vi,F=new wi(s,i(this,Te)),ae=l((E,S,oe,Y)=>{let le=new Ii(b,E);if(X=E,le.build(),oe.setActiveUnit(E),oe.render(),oe.setVisible(!0),Y.setActiveUnit(E),Y.render(),Y.setVisible(!0),E===null){S.render();return}O=E,oe.update([...O!=null&&O.tile?[O.tile]:[],E.tile]),S.isVisible(E.tile.x,E.tile.y)||S.setCenter(E.tile.x,E.tile.y),S.render()},"setActiveUnit");L.getAll().then(E=>E.forEach(S=>C.append(I(p(`img[src="${S.uri}"][data-path="${S.name}"]`),{error:()=>console.error(`There was a problem preloading '${S.name}', you may have some missing details.`)}))));let Ce=[],zt,O=null,X=null;t.receive("notification",E=>{n.innerHTML=E,zt&&window.clearTimeout(zt),zt=window.setTimeout(()=>{zt=void 0,n.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([E,S])=>t.receive(E,oe=>{let{choices:Y}=Ot(oe);new ge(S,Y.map(({_:le})=>({label:le,value:le})),le=>t.send(E,le),S,{displayAll:!0})})),t.receiveOnce("gameData",E=>{try{let S=Ot(E),oe=new Intl.ListFormat;new Yt("Welcome",p("div.welcome",p("p",y(`${S.player.civilization.leader.name}, you have risen to become leader of the ${S.player.civilization._}.`)),p("p",y(`Your people have knowledge of ${oe.format(["Irrigation","Mining","Roads",...S.player.research.complete.map(w=>w._)])}`)))),d.classList.add("active"),c.width=c.parentElement.offsetWidth,c.height=c.parentElement.offsetHeight;let Y=[],le=2,is=new vn(S.player.world),Ci=new oi,T=new ri(is,t,c,{playerId:S.player.id,scale:le,tileSize:16},_t,un,yn,mn,rn,ai,on,Ye,Pt,vt,Es,Is),Li=T.getLayer(_t),rs=T.getLayer(Ye),at=T.getLayer(Pt),as=T.getLayer(vt),Ts=T.getLayer(Es),ot=T.getLayer(Is),os=new bi(x,is,T,Li,as),Ms=new _s(r,T,i(this,Te)),Si=new _s(o,T,i(this,Te));rs.setVisible(!1),T.on("focus-changed",()=>os.update()),T.on("activate-unit",w=>ae(w,T,at,ot)),Ci.on(()=>{ot.setVisible(!ot.isVisible()),T.build(Ce.splice(0)),T.render()}),window.addEventListener("resize",()=>{c.width=c.parentElement.offsetWidth,c.height=c.parentElement.offsetHeight});let Cs=1,ls=!1,ms=l(w=>{let _=ls?[]:null,v=Ot(w,_);_&&((A=>{for(let lt=0,Hi=Math.ceil(A.length/1e3);lt<Hi;lt++)setTimeout(()=>A.slice(lt*1e3,(lt+1)*1e3-1).forEach(Ri=>delete w.objects[Ri]),(lt+1)*200)})(_),ls=!1),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:v}})),Cs!==v.turn.value&&(ls=!0,Cs=v.turn.value),Ms.build(v.player.mandatoryActions),Si.build(v.player.actions.filter(A=>["AdjustTradeRates","Revolution"].includes(A._))),d.append(Ms.element()),is.setTiles(v.player.world.tiles),new ii(g,v.turn,v.year).build(),new _i(f,v.player).build(),Y=v.player.actions.filter(A=>A._==="ActiveUnit");let[R]=Y.sort(({value:A},{value:me})=>me===O?1:A===O?-1:(T.isVisible(me.tile.x,me.tile.y)?1:0)-(T.isVisible(A.tile.x,A.tile.y)?1:0));if(O!==(R==null?void 0:R.value)&&(O=null),ae(O!=null&&O.active?O:R?R.value:null,T,at,ot),T.build(Ce.splice(0)),T.render(),os.update(),e.autoEndOfTurn&&v.player.mandatoryActions.length===1&&v.player.mandatoryActions.every(A=>A._==="EndTurn")){t.send("action",{name:"EndTurn"});return}},"handler");ms(E),t.receive("gameData",w=>ms(w));let Pi=l(w=>w.replace(/]/g,"").split(/[.[]/),"pathToParts"),Ls=l((w,_)=>{let v=Pi(_),D=v.pop();return[v.reduce((R,A)=>!R||!(A in R)?null:R[A],w),D]},"getPenultimateObject"),Di=l((w,_,v)=>{let[D,U]=Ls(w,_);if(!D||!U){console.warn(`unable to set ${_} of ${w} (${U})`);return}D[U]=v},"setObjectPath"),Ai=l((w,_)=>{let[v,D]=Ls(w,_);if(!v||!D){console.warn(`unable to set ${_} of ${w} (${D})`);return}delete v[D]},"removeObjectPath");t.receive("gameDataPatch",w=>{w.forEach(_=>Object.entries(_).forEach(([v,{type:D,index:U,value:R}])=>{if(D==="add"||D==="update"){if(!R.hierarchy){console.error("No hierarchy"),console.error(R);return}U?Di(E.objects[v],U,R.hierarchy):E.objects[v]=R.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:R}})),Object.entries(R.objects).forEach(([A,me])=>{E.objects[A]=me,me._==="PlayerTile"&&Ce.push(me)})}if(D==="remove"){if(U){Ai(E.objects[v],U);return}delete E.objects[v]}})),ms(E)}),t.receive("gameNotification",w=>H.receive(w));let Ss={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},ps={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},ki={8:"n",9:"ne",6:"e",3:"se",2:"s",1:"sw",4:"w",7:"nw"},_r={[KeyboardEvent.DOM_KEY_LOCATION_STANDARD]:ps,[KeyboardEvent.DOM_KEY_LOCATION_NUMPAD]:ki},Ps="";document.addEventListener("keydown",w=>{if(X){if(w.key in Ss){let _=[...Ss[w.key]];for(;_.length;){let v=_.shift(),[D]=X.actions.filter(U=>U._===v);if(D){t.send("action",{name:"ActiveUnit",id:X.id,unitAction:D._,target:D.to.id}),w.stopPropagation(),w.preventDefault();return}}}if(w.key in ps){let[_]=X.actionsForNeighbours[ps[w.key]];if(_){t.send("action",{name:"ActiveUnit",id:X.id,unitAction:_._,target:_.to.id}),w.stopPropagation(),w.preventDefault();return}}}if(w.key==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(w.key==="Enter"&&S.player.mandatoryActions.some(_=>_._==="EndOfTurn")){t.send("action",{name:"EndTurn"}),w.stopPropagation(),w.preventDefault();return}if(w.key==="Tab"){let _=r.querySelector("div.action:first-child button");if(_!==null){_.focus(),w.preventDefault(),w.stopPropagation();return}}if(w.key==="c"&&X){T.setCenter(X.tile.x,X.tile.y),T.render(),os.update();return}if(w.key==="w"&&X&&Y.length>1){let _=Y.map(U=>U.value),v=_.indexOf(X),D=_[v===_.length-1?0:v+1];ae(D,T,at,ot)}if(w.key==="t"){at.setVisible(!at.isVisible()),as.setVisible(!as.isVisible()),Ts.setVisible(!Ts.isVisible()),T.render();return}if(w.key==="y"){rs.setVisible(!rs.isVisible()),T.render();return}if(Ps==="%"&&w.key==="^"){t.send("cheat",{name:"RevealMap"});return}Ps=w.key})}catch(S){console.error(S)}})}catch(n){console.error(n)}}};l(ts,"Renderer"),Te=new WeakMap;var Ei=ts;var ns=class{async request(t){return new Promise(e=>{this.send(t.channel(),...t.args()),this.receiveOnce(t.channel(),n=>e(n))})}};l(ns,"AbstractTransport");var Ti=ns;var Me,ss=class extends Ti{constructor(e){super();u(this,Me,void 0);h(this,Me,e)}receive(e,n){i(this,Me).addEventListener("message",({data:{channel:s,data:r}})=>{s===e&&n(r)})}receiveOnce(e,n){let s=l(({data:{channel:r,data:o}})=>{r===e&&(n(o),i(this,Me).removeEventListener("message",s))},"onceHandler");i(this,Me).addEventListener("message",s)}send(e,n){i(this,Me).postMessage({channel:e,data:n})}};l(ss,"WorkerTransport"),Me=new WeakMap;var Mi=ss;var vr=new Ei(new Mi(new Worker("dist/backend.js")));vr.init();})();
//# sourceMappingURL=frontend.js.map
