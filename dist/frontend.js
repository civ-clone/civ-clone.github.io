"use strict";(()=>{var jr=Object.create;var Zn=Object.defineProperty;var Nr=Object.getOwnPropertyDescriptor;var Kr=Object.getOwnPropertyNames;var Br=Object.getPrototypeOf,Fr=Object.prototype.hasOwnProperty;var l=(i,t)=>Zn(i,"name",{value:t,configurable:!0});var _i=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var Gr=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Kr(t))!Fr.call(i,n)&&n!==e&&Zn(i,n,{get:()=>t[n],enumerable:!(s=Nr(t,n))||s.enumerable});return i};var w=(i,t,e)=>(e=i!=null?jr(Br(i)):{},Gr(t||!i||!i.__esModule?Zn(e,"default",{value:i,enumerable:!0}):e,i));var Ei=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var r=(i,t,e)=>(Ei(i,t,"read from private field"),e?e.call(i):t.get(i)),c=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},u=(i,t,e,s)=>(Ei(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var b=_i(x=>{"use strict";var xs,qr=x&&x.__classPrivateFieldSet||function(i,t,e,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(i,e):n?n.value=e:t.set(i,e),e},Yr=x&&x.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(x,"__esModule",{value:!0}),x.Element=x.toggleClass=x.t=x.s=x.removeClass=x.once=x.onEach=x.on=x.off=x.hasClass=x.empty=x.emitCustom=x.emit=x.addClass=void 0;x.addClass=(i,...t)=>i.classList.add(...t);x.emit=(i,t)=>i.dispatchEvent(t);x.emitCustom=(i,t,...e)=>(0,x.emit)(i,new CustomEvent(t,{detail:e}));x.empty=i=>{for(var t;i.hasChildNodes();)(t=i.firstChild)===null||t===void 0||t.remove()};x.hasClass=(i,t)=>i.classList.contains(t);x.off=(i,t,e,s={})=>i.removeEventListener(t,e,s);x.on=(i,t,e,s={})=>i.addEventListener(t,e,s);x.onEach=(i,t,e,s={})=>t.forEach(n=>(0,x.on)(i,n,e,s));x.once=(i,t,e,s={})=>(0,x.on)(i,t,e,Object.assign(Object.assign({},typeof s=="boolean"?{capture:s}:s),{once:!0}));x.removeClass=(i,...t)=>i.classList.remove(...t);x.s=(i,...t)=>{let e=document.createElement("div");e.innerHTML=i;let s=e.firstElementChild;return t.forEach(n=>{n instanceof me?s.append(n.element()):n instanceof Node?s.append(n):s.append((0,x.t)(n))}),s};x.t=i=>document.createTextNode(i);x.toggleClass=(i,...t)=>t.forEach(e=>i.classList.toggle(e));var me=class{constructor(t){xs.set(this,void 0),qr(this,xs,t,"f")}static fromString(t){return new me((0,x.s)(t))}addClass(...t){(0,x.addClass)(this.element(),...t)}append(...t){t.forEach(e=>{e instanceof me&&(e=e.element()),this.element().append(e)})}element(){return Yr(this,xs,"f")}emit(t){return(0,x.emit)(this.element(),t)}emitCustom(t,...e){return(0,x.emitCustom)(this.element(),t,...e)}empty(){(0,x.empty)(this.element())}hasClass(t){return(0,x.hasClass)(this.element(),t)}off(t,e,s={}){(0,x.off)(this.element(),t,e,s)}on(t,e,s={}){(0,x.on)(this.element(),t,e,s)}onEach(t,e,s={}){(0,x.onEach)(this.element(),t,e,s)}once(t,e,s={}){(0,x.once)(this.element(),t,e,s)}query(t){return this.element().querySelector(t)}queryAll(t){return this.element().querySelectorAll(t)}remove(){this.element().remove()}removeClass(...t){(0,x.removeClass)(this.element(),...t)}toggleClass(...t){(0,x.toggleClass)(this.element(),...t)}};l(me,"o");x.Element=me,xs=new WeakMap,x.default=me});var Yi=_i(Oe=>{"use strict";var re,Ee=Oe&&Oe.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.EventEmitter=void 0;var Xt=class{constructor(){re.set(this,{})}on(t,e){t in Ee(this,re,"f")||(Ee(this,re,"f")[t]=[]),Ee(this,re,"f")[t].push(e)}once(t,e){let s=l((...n)=>{e(...n),this.off(t,s)},"i");this.on(t,s)}off(t,e){if(!(t in Ee(this,re,"f")))return;let s=Ee(this,re,"f")[t].indexOf(e);s!==-1&&Ee(this,re,"f")[t].splice(s,1)}emit(t,...e){t in Ee(this,re,"f")&&Ee(this,re,"f")[t].forEach(s=>s(...e))}};l(Xt,"i");Oe.EventEmitter=Xt,re=new WeakMap,Oe.default=Xt});var Ve=w(b());var vs=l(({hierarchy:i,objects:t},e=null)=>{let s=new Map;e&&Object.keys(t).forEach(a=>e.push(a));let n=l(a=>{if(s.has(a))return s.get(a);if(Array.isArray(a)){let o=[];return s.set(a,o),a.forEach(m=>o.push(n(m))),o}if(a&&a["#ref"]){if(e&&e.splice(e.indexOf(a["#ref"]),1),!(a["#ref"]in t))throw new TypeError(`missing ${a["#ref"]}`);let o=n(t[a["#ref"]]);return s.set(a,o),o}if(a instanceof Object){let o={};return s.set(a,o),Object.entries(a).forEach(([m,d])=>{o[m]=n(d)}),o}return a},"getReferences");return n(i)},"reconstituteData");var xn=w(b());var ws=w(b());var Pt,St,ys=class extends ws.Element{constructor(e,s){super((0,ws.s)('<div class="action"></div>'));c(this,Pt,void 0);c(this,St,void 0);u(this,Pt,e),u(this,St,s),this.on("keydown",n=>{n.key!=="Escape"&&n.stopPropagation()}),this.build()}activate(){}build(){}complete(){this.emit(new CustomEvent("actioned",{bubbles:!0,detail:this}))}transport(){return r(this,St)}value(){return r(this,Pt).value}};l(ys,"Action"),Pt=new WeakMap,St=new WeakMap;var ee=ys;var _s=w(b());var Vr=l((i,t)=>(0,_s.s)(`<fieldset><legend>${i}</legend><input type="range" max="100" min="0" step="1" value="${t}"><input type="number"><label><input type="checkbox">Lock</label></fieldset>`),"template"),Dt,q,te,Qe,kt,bs=class extends _s.Element{constructor(e,s){super(Vr(e,s));c(this,Dt,void 0);c(this,q,void 0);c(this,te,void 0);c(this,Qe,void 0);c(this,kt,[]);u(this,Dt,e),u(this,q,this.element().querySelector('input[type="range"]')),u(this,te,this.element().querySelector('input[type="number"]')),u(this,Qe,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(r(this,q).value),r(this,q).addEventListener("input",()=>this.set(r(this,q).value)),r(this,te).addEventListener("input",()=>this.set(r(this,te).value)),r(this,Qe).addEventListener("input",()=>this.lock()),this.lock()}label(){return r(this,Dt)}lock(){if(this.isLocked()){r(this,q).setAttribute("disabled",""),r(this,te).setAttribute("disabled","");return}r(this,q).removeAttribute("disabled"),r(this,te).removeAttribute("disabled")}onInput(e){r(this,kt).push(e)}isLocked(){return r(this,Qe).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),r(this,q).value!==e&&(r(this,q).value=e),r(this,te).value!==e&&(r(this,te).value=e),r(this,kt).forEach(s=>s())}value(){return parseInt(r(this,q).value,10)}};l(bs,"LockedSlider"),Dt=new WeakMap,q=new WeakMap,te=new WeakMap,Qe=new WeakMap,kt=new WeakMap;var Ti=bs;var he,Es=class{constructor(...t){c(this,he,void 0);u(this,he,t),r(this,he).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let s=r(this,he).filter(a=>a!==e),n=s.filter(a=>!a.isLocked());if(this.total()!==100&&n.length===0){e.set((100-this.total(s)).toString());return}if(this.total()>100){let a=this.total()-100,o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()-Math.min(o,a)).toString()),a-=o}),this.total()>100&&e.set((100-this.total(s)).toString())}if(this.total()<100){let a=100-this.total(),o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()+Math.min(o,a)).toString()),a-=o}),this.total()<100&&e.set((100-this.total(s)).toString())}}))}sliders(){return r(this,he)}total(t=r(this,he)){return t.reduce((e,s)=>e+s.value(),0)}};l(Es,"LockedSliderGroup"),he=new WeakMap;var Ci=Es;var Ts=w(b());var Je,Ht=class extends Ts.Element{constructor(e,s=(0,Ts.s)("<div></div>")){super(s);c(this,Je,void 0);this.on("keydown",n=>{n.stopPropagation()}),this.element().setAttribute("tabindex","0"),u(this,Je,e)}build(){}display(){this.build(),r(this,Je).append(this.element())}parent(){return r(this,Je)}};l(Ht,"TransientElement"),Je=new WeakMap;var G=w(b());var _=l((i,t)=>(Object.entries(t).forEach(([e,s])=>i.addEventListener(e,s)),i),"h");var Mi={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},Ae,At,Ze=class extends Ht{constructor(e,s,n={}){var a;super((a=n.parent)!=null?a:Mi.parent,(0,G.s)('<div class="window"></div>'));c(this,Ae,void 0);c(this,At,void 0);if(this.options={...Mi,...n},u(this,Ae,s),u(this,At,e),this.options.size==="auto"&&this.addClass("size-auto"),this.options.size==="maximised"&&this.addClass("maximised"),this.options.size!=="auto"&&["height","width"].forEach(o=>{let m=this.options.size[o];if(typeof m=="number"){this.element().style[o]=m+"px";return}this.element().style[o]=m}),this.options.position==="auto"&&this.addClass("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([o,m])=>{this.element().style[m]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[o]))+"px"}),this.options.autoDisplay){this.display();return}this.build()}build(){this.empty();let e=[[this.options.canMaximise,_((0,G.s)('<button class="maximise" aria-label="Maximise">Maximise</button>'),{click:()=>this.maximise()})],[this.options.canClose,_((0,G.s)('<button class="close" aria-label="Close">Maximise</button>'),{click:()=>this.close()})]].filter(([n])=>n).map(([,n])=>n),s=!1;this.append(_((0,G.s)(`<header><h3>${r(this,At)}</h3></header>`,...e),{dblclick:()=>this.maximise(),mousedown:n=>{if(n.target.matches("button, button img"))return;s=!0;let a=l(o=>{!s||this.move({x:o.movementX,y:o.movementY})},"moveHandler");(0,G.on)(document,"mousemove",a),(0,G.on)(document,"mouseup",()=>{(0,G.off)(document,"mousemove",a),s=!1},{once:!0})}}),(0,G.s)('<div class="body"></div>',r(this,Ae)instanceof Node?r(this,Ae):(0,G.s)(`<p>${r(this,Ae)}</p>`))),this.on("keydown",n=>{n.key==="Escape"&&this.options.canClose&&this.close(),n.stopPropagation()})}close(){this.remove(),this.emit(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||(this.element().classList.toggle("maximised"),this.emit(new CustomEvent("resize",{bubbles:!1})))}move({x:e,y:s}){if(this.hasClass("position-auto")){e+=this.element().offsetLeft,s+=this.element().offsetTop,this.removeClass("position-auto"),this.element().style.setProperty("top",s+"px"),this.element().style.setProperty("left",e+"px");return}let n=getComputedStyle(this.element()),a=parseInt(n.getPropertyValue("top"),10),o=parseInt(n.getPropertyValue("left"),10);this.element().style.setProperty("top",a+s+"px"),this.element().style.setProperty("left",o+e+"px")}update(e){this.element().lastElementChild.remove(),this.append(e instanceof Node?e:(0,G.s)(`<p>${e}</p>`))}};l(Ze,"Window"),Ae=new WeakMap,At=new WeakMap;var N=Ze;var Xr=l((i,t)=>t.some(e=>i instanceof e),"instanceOfAny"),Li,Ii;function Qr(){return Li||(Li=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}l(Qr,"getIdbProxyableTypes");function Jr(){return Ii||(Ii=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}l(Jr,"getCursorAdvanceMethods");var Pi=new WeakMap,ti=new WeakMap,Si=new WeakMap,ei=new WeakMap,ni=new WeakMap;function Zr(i){let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("success",a),i.removeEventListener("error",o)},"unlisten"),a=l(()=>{e(se(i.result)),n()},"success"),o=l(()=>{s(i.error),n()},"error");i.addEventListener("success",a),i.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Pi.set(e,i)}).catch(()=>{}),ni.set(t,i),t}l(Zr,"promisifyRequest");function ea(i){if(ti.has(i))return;let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("complete",a),i.removeEventListener("error",o),i.removeEventListener("abort",o)},"unlisten"),a=l(()=>{e(),n()},"complete"),o=l(()=>{s(i.error||new DOMException("AbortError","AbortError")),n()},"error");i.addEventListener("complete",a),i.addEventListener("error",o),i.addEventListener("abort",o)});ti.set(i,t)}l(ea,"cacheDonePromiseForTransaction");var si={get(i,t,e){if(i instanceof IDBTransaction){if(t==="done")return ti.get(i);if(t==="objectStoreNames")return i.objectStoreNames||Si.get(i);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return se(i[t])},set(i,t,e){return i[t]=e,!0},has(i,t){return i instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in i}};function Di(i){si=i(si)}l(Di,"replaceTraps");function ta(i){return i===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){let s=i.call(Cs(this),t,...e);return Si.set(s,t.sort?t.sort():[t]),se(s)}:Jr().includes(i)?function(...t){return i.apply(Cs(this),t),se(Pi.get(this))}:function(...t){return se(i.apply(Cs(this),t))}}l(ta,"wrapFunction");function sa(i){return typeof i=="function"?ta(i):(i instanceof IDBTransaction&&ea(i),Xr(i,Qr())?new Proxy(i,si):i)}l(sa,"transformCachableValue");function se(i){if(i instanceof IDBRequest)return Zr(i);if(ei.has(i))return ei.get(i);let t=sa(i);return t!==i&&(ei.set(i,t),ni.set(t,i)),t}l(se,"wrap");var Cs=l(i=>ni.get(i),"unwrap");function Hi(i,t,{blocked:e,upgrade:s,blocking:n,terminated:a}={}){let o=indexedDB.open(i,t),m=se(o);return s&&o.addEventListener("upgradeneeded",d=>{s(se(o.result),d.oldVersion,d.newVersion,se(o.transaction),d)}),e&&o.addEventListener("blocked",d=>e(d.oldVersion,d.newVersion,d)),m.then(d=>{a&&d.addEventListener("close",()=>a()),n&&d.addEventListener("versionchange",p=>n(p.oldVersion,p.newVersion,p))}).catch(()=>{}),m}l(Hi,"openDB");var na=["get","getKey","getAll","getAllKeys","count"],ia=["put","add","delete","clear"],ii=new Map;function ki(i,t){if(!(i instanceof IDBDatabase&&!(t in i)&&typeof t=="string"))return;if(ii.get(t))return ii.get(t);let e=t.replace(/FromIndex$/,""),s=t!==e,n=ia.includes(e);if(!(e in(s?IDBIndex:IDBObjectStore).prototype)||!(n||na.includes(e)))return;let a=l(async function(o,...m){let d=this.transaction(o,n?"readwrite":"readonly"),p=d.store;return s&&(p=p.index(m.shift())),(await Promise.all([p[e](...m),n&&d.done]))[0]},"method");return ii.set(t,a),a}l(ki,"getMethod");Di(i=>({...i,get:(t,e,s)=>ki(t,e)||i.get(t,e,s),has:(t,e)=>!!ki(t,e)||i.has(t,e)}));var de,ne,Rt=class{constructor(t,e,s){c(this,de,void 0);c(this,ne,void 0);u(this,ne,e),u(this,de,Hi(t,1,{upgrade:n=>n.createObjectStore(r(this,ne),s)}))}async get(t){return(await r(this,de)).get(r(this,ne),t)}async getAll(t,e){return(await r(this,de)).getAll(r(this,ne),t,e)}async set(t,e){return(await r(this,de)).put(r(this,ne),t,e)}async clear(){return(await r(this,de)).clear(r(this,ne))}async keys(){return(await r(this,de)).getAllKeys(r(this,ne))}};l(Rt,"Store"),de=new WeakMap,ne=new WeakMap;var ra=l((i,t,e)=>{let s=document.createElement("canvas"),n=s.getContext("2d");return s.width=i.width*t,s.height=i.height*t,e!=null&&e.smoothing||(n.imageSmoothingEnabled=!1),n.drawImage(i,0,0,s.width,s.height),s},"scaleImage"),Ai=ra;var et,tt,st,Ls,Ms=class extends Rt{constructor(){super("civ-clone-assets","assets",{keyPath:"name"});c(this,et,new Map);c(this,tt,new Map);c(this,st,new Map);c(this,Ls,["./assets/city/bulb.png","./assets/city/food.png","./assets/city/gold.png","./assets/city/luxury.png","./assets/city/people_content_f.png","./assets/city/people_content_m.png","./assets/city/people_happy_f.png","./assets/city/people_happy_m.png","./assets/city/people_luxury.png","./assets/city/people_science.png","./assets/city/people_tax.png","./assets/city/people_unhappy_f.png","./assets/city/people_unhappy_m.png","./assets/city/pollution.png","./assets/city/sad.png","./assets/city/production.png","./assets/city/trade.png","./assets/cursor/go.png","./assets/cursor/torch.png","./assets/general/texture_1.png","./assets/general/texture_2.png","./assets/improvements/irrigation.png","./assets/improvements/mine.png","./assets/improvements/pollution.png","./assets/improvements/railroad_e.png","./assets/improvements/railroad_se.png","./assets/improvements/railroad_n.png","./assets/improvements/railroad_ne.png","./assets/improvements/railroad_nw.png","./assets/improvements/railroad_s.png","./assets/improvements/railroad_sw.png","./assets/improvements/railroad_w.png","./assets/improvements/road_e.png","./assets/improvements/road_n.png","./assets/improvements/road_ne.png","./assets/improvements/road_nw.png","./assets/improvements/road_s.png","./assets/improvements/road_se.png","./assets/improvements/road_sw.png","./assets/improvements/road_w.png","./assets/map/city.png","./assets/map/fog_e.png","./assets/map/fog_n.png","./assets/map/fog_s.png","./assets/map/fog_w.png","./assets/map/fort.png","./assets/map/fortify.png","./assets/map/hut.png","./assets/status/pollution_0.png","./assets/status/pollution_25.png","./assets/status/pollution_50.png","./assets/status/pollution_75.png","./assets/status/science_0.png","./assets/status/science_25.png","./assets/status/science_50.png","./assets/status/science_75.png","./assets/terrain/arctic.png","./assets/terrain/arctic_e.png","./assets/terrain/arctic_es.png","./assets/terrain/arctic_esw.png","./assets/terrain/arctic_ew.png","./assets/terrain/arctic_n.png","./assets/terrain/arctic_ne.png","./assets/terrain/arctic_nes.png","./assets/terrain/arctic_nesw.png","./assets/terrain/arctic_new.png","./assets/terrain/arctic_ns.png","./assets/terrain/arctic_nsw.png","./assets/terrain/arctic_nw.png","./assets/terrain/arctic_s.png","./assets/terrain/arctic_sw.png","./assets/terrain/arctic_w.png","./assets/terrain/coal.png","./assets/terrain/coast_sprite.png","./assets/terrain/desert.png","./assets/terrain/desert_e.png","./assets/terrain/desert_es.png","./assets/terrain/desert_esw.png","./assets/terrain/desert_ew.png","./assets/terrain/desert_n.png","./assets/terrain/desert_ne.png","./assets/terrain/desert_nes.png","./assets/terrain/desert_nesw.png","./assets/terrain/desert_new.png","./assets/terrain/desert_ns.png","./assets/terrain/desert_nsw.png","./assets/terrain/desert_nw.png","./assets/terrain/desert_s.png","./assets/terrain/desert_sw.png","./assets/terrain/desert_w.png","./assets/terrain/doe.png","./assets/terrain/fish.png","./assets/terrain/forest.png","./assets/terrain/forest_e.png","./assets/terrain/forest_es.png","./assets/terrain/forest_esw.png","./assets/terrain/forest_ew.png","./assets/terrain/forest_n.png","./assets/terrain/forest_ne.png","./assets/terrain/forest_nes.png","./assets/terrain/forest_nesw.png","./assets/terrain/forest_new.png","./assets/terrain/forest_ns.png","./assets/terrain/forest_nsw.png","./assets/terrain/forest_nw.png","./assets/terrain/forest_s.png","./assets/terrain/forest_sw.png","./assets/terrain/forest_w.png","./assets/terrain/gems.png","./assets/terrain/gold.png","./assets/terrain/grassland.png","./assets/terrain/grassland_e.png","./assets/terrain/grassland_es.png","./assets/terrain/grassland_esw.png","./assets/terrain/grassland_ew.png","./assets/terrain/grassland_n.png","./assets/terrain/grassland_ne.png","./assets/terrain/grassland_nes.png","./assets/terrain/grassland_nesw.png","./assets/terrain/grassland_new.png","./assets/terrain/grassland_ns.png","./assets/terrain/grassland_nsw.png","./assets/terrain/grassland_nw.png","./assets/terrain/grassland_s.png","./assets/terrain/grassland_sw.png","./assets/terrain/grassland_w.png","./assets/terrain/hills.png","./assets/terrain/hills_e.png","./assets/terrain/hills_es.png","./assets/terrain/hills_esw.png","./assets/terrain/hills_ew.png","./assets/terrain/hills_n.png","./assets/terrain/hills_ne.png","./assets/terrain/hills_nes.png","./assets/terrain/hills_nesw.png","./assets/terrain/hills_new.png","./assets/terrain/hills_ns.png","./assets/terrain/hills_nsw.png","./assets/terrain/hills_nw.png","./assets/terrain/hills_s.png","./assets/terrain/hills_sw.png","./assets/terrain/hills_w.png","./assets/terrain/horse.png","./assets/terrain/jungle.png","./assets/terrain/jungle_e.png","./assets/terrain/jungle_es.png","./assets/terrain/jungle_esw.png","./assets/terrain/jungle_ew.png","./assets/terrain/jungle_n.png","./assets/terrain/jungle_ne.png","./assets/terrain/jungle_nes.png","./assets/terrain/jungle_nesw.png","./assets/terrain/jungle_new.png","./assets/terrain/jungle_ns.png","./assets/terrain/jungle_nsw.png","./assets/terrain/jungle_nw.png","./assets/terrain/jungle_s.png","./assets/terrain/jungle_sw.png","./assets/terrain/jungle_w.png","./assets/terrain/land.png","./assets/terrain/mountains.png","./assets/terrain/mountains_e.png","./assets/terrain/mountains_es.png","./assets/terrain/mountains_esw.png","./assets/terrain/mountains_ew.png","./assets/terrain/mountains_n.png","./assets/terrain/mountains_ne.png","./assets/terrain/mountains_nes.png","./assets/terrain/mountains_nesw.png","./assets/terrain/mountains_new.png","./assets/terrain/mountains_ns.png","./assets/terrain/mountains_nsw.png","./assets/terrain/mountains_nw.png","./assets/terrain/mountains_s.png","./assets/terrain/mountains_sw.png","./assets/terrain/mountains_w.png","./assets/terrain/oasis.png","./assets/terrain/ocean.png","./assets/terrain/oil.png","./assets/terrain/plains.png","./assets/terrain/plains_e.png","./assets/terrain/plains_es.png","./assets/terrain/plains_esw.png","./assets/terrain/plains_ew.png","./assets/terrain/plains_n.png","./assets/terrain/plains_ne.png","./assets/terrain/plains_nes.png","./assets/terrain/plains_nesw.png","./assets/terrain/plains_new.png","./assets/terrain/plains_ns.png","./assets/terrain/plains_nsw.png","./assets/terrain/plains_nw.png","./assets/terrain/plains_s.png","./assets/terrain/plains_sw.png","./assets/terrain/plains_w.png","./assets/terrain/river_e.png","./assets/terrain/river_es.png","./assets/terrain/river_esw.png","./assets/terrain/river_ew.png","./assets/terrain/river_mouth_e.png","./assets/terrain/river_mouth_n.png","./assets/terrain/river_mouth_s.png","./assets/terrain/river_mouth_w.png","./assets/terrain/river.png","./assets/terrain/river_n.png","./assets/terrain/river_ne.png","./assets/terrain/river_nes.png","./assets/terrain/river_nesw.png","./assets/terrain/river_new.png","./assets/terrain/river_ns.png","./assets/terrain/river_nsw.png","./assets/terrain/river_nw.png","./assets/terrain/river_s.png","./assets/terrain/river_sw.png","./assets/terrain/river_w.png","./assets/terrain/seal.png","./assets/terrain/shield.png","./assets/terrain/game.png","./assets/terrain/swamp.png","./assets/terrain/swamp_e.png","./assets/terrain/swamp_es.png","./assets/terrain/swamp_esw.png","./assets/terrain/swamp_ew.png","./assets/terrain/swamp_n.png","./assets/terrain/swamp_ne.png","./assets/terrain/swamp_nes.png","./assets/terrain/swamp_nesw.png","./assets/terrain/swamp_new.png","./assets/terrain/swamp_ns.png","./assets/terrain/swamp_nsw.png","./assets/terrain/swamp_nw.png","./assets/terrain/swamp_s.png","./assets/terrain/swamp_sw.png","./assets/terrain/swamp_w.png","./assets/terrain/tundra.png","./assets/terrain/tundra_e.png","./assets/terrain/tundra_es.png","./assets/terrain/tundra_esw.png","./assets/terrain/tundra_ew.png","./assets/terrain/tundra_n.png","./assets/terrain/tundra_ne.png","./assets/terrain/tundra_nes.png","./assets/terrain/tundra_nesw.png","./assets/terrain/tundra_new.png","./assets/terrain/tundra_ns.png","./assets/terrain/tundra_nsw.png","./assets/terrain/tundra_nw.png","./assets/terrain/tundra_s.png","./assets/terrain/tundra_sw.png","./assets/terrain/tundra_w.png","./assets/units/tank.png","./assets/units/artillery.png","./assets/units/battleship.png","./assets/units/bomber.png","./assets/units/cannon.png","./assets/units/caravan.png","./assets/units/carrier.png","./assets/units/catapult.png","./assets/units/horseman.png","./assets/units/chariot.png","./assets/units/combat_1.png","./assets/units/combat_2.png","./assets/units/combat_3.png","./assets/units/combat_4.png","./assets/units/combat_5.png","./assets/units/combat_6.png","./assets/units/combat_7.png","./assets/units/combat_8.png","./assets/units/cruiser.png","./assets/units/diplomat.png","./assets/units/fighter.png","./assets/units/frigate.png","./assets/units/ironclad.png","./assets/units/knight.png","./assets/units/swordman.png","./assets/units/mechanizedinfantry.png","./assets/units/warrior.png","./assets/units/musketman.png","./assets/units/nuclear.png","./assets/units/spearman.png","./assets/units/rifleman.png","./assets/units/sail.png","./assets/units/settlers.png","./assets/units/submarine.png","./assets/units/transport.png","./assets/units/trireme.png"])}async get(e){return r(this,et).has(e)||r(this,et).set(e,await super.get(e)),r(this,et).get(e)}async getImage(e){if(!r(this,tt).has(e)){let s=await this.get(e),n=document.createElement("img");n.src=s.uri,r(this,tt).set(e,n)}return r(this,tt).get(e)}async getScaled(e,s){return r(this,st).has(e)||r(this,st).set(e,Ai(await this.getImage(e),s)),r(this,st).get(e)}async hasAllAssets(){return(await this.missingAssets()).length===0}async missingAssets(){let e=await this.keys();return r(this,Ls).filter(s=>!e.includes(s))}};l(Ms,"AssetStore"),et=new WeakMap,tt=new WeakMap,st=new WeakMap,Ls=new WeakMap;var M=new Ms;var ri=w(b());var $t,Is=class extends ee{constructor(){super(...arguments);c(this,$t,void 0)}activate(){let e=[];new N("Adjust trade rates",(0,ri.s)("<div></div>",...this.value().all.map(n=>{let a=new Ti(n._,n.value*100);return e.push(a),a}))).on("close",()=>{let n=r(this,$t).sliders().map(a=>[a.label(),parseFloat((a.value()/100).toFixed(2))]);console.info("AdjustTradeRates: ",n),this.transport().send("action",{name:"AdjustTradeRates",id:this.value().id,value:n})}),u(this,$t,new Ci(...e))}build(){M.get("./assets/city/trade.png").then(e=>this.append((0,ri.s)(`<button class="adjustTradeRates" title="Adjust trade rates" style="background-image:url('${e.uri}')"></button>`)))}value(){return super.value()}};l(Is,"AdjustTradeRates"),$t=new WeakMap;var Ri=Is;var ai=[],Ut,Ps=class extends Ze{constructor(e,s,n={}){let a={queue:!0,...n};super(e,s,a);c(this,Ut,{});u(this,Ut,a),this.addClass("notificationWindow"),this.on("keydown",o=>{o.key==="Enter"&&(this.close(),o.stopPropagation())})}close(){if(super.close(),r(this,Ut).queue&&ai.length&&Ps.hasOpenWindow()){let[e,s,n]=ai.shift();e.display(s),n()}}display(e=!0){return new Promise(s=>{if(Ps.hasOpenWindow()){ai.push([this,e,s]);return}if(super.display(),!e){s(void 0);return}this.element().focus(),s(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},ge=Ps;l(ge,"NotificationWindow"),Ut=new WeakMap;var Ss=ge;var ie=w(b());var $i={0:"Insert",1:"End",2:"ArrowDown",3:"PageDown",4:"ArrowLeft",6:"ArrowRight",7:"Home",8:"ArrowUp",9:"PageUp",".":"Delete"},fe=l((i,t=!0)=>t&&i.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD&&i.key in $i?$i[i.key]:i.key,"mappedKeyFromEvent");var Ot,zt,xe=class extends ge{constructor(e,s,n,a="Please choose one of the following:",o={}){var p,h;o={autoFocus:!0,displayAll:!1,...o,actions:{primary:{label:"OK",action:g=>m(g.selectionList().value),...(h=(p=o.actions)==null?void 0:p.primary)!=null?h:{}},...o.actions}};let m=l(g=>{this.emit(new CustomEvent("selection",{detail:g})),this.close(),n(g)},"chooseHandler"),d=_((0,ie.s)(`<select>${s.map(g=>`<option value="${g.value}">${g.label||g.value}</option>`).join("")}</select>`),{keydown:g=>{let f=fe(g);if(f==="Enter"&&(m(d.value),g.preventDefault()),["ArrowDown","ArrowUp","End","Home","PageDown","PageUp"].includes(f)&&!["ArrowDown","ArrowUp","End","Home","PageDown","PageUp"].includes(g.key)){let v=d.selectedIndex,E=["Home","PageUp"].includes(f)?0:["End","PageDown"].includes(f)?d.length-1:v+(f==="ArrowUp"?-1:1);E>-1&&E<d.length&&(d.selectedIndex=E),g.preventDefault()}},dblclick:()=>m(d.value)});o.displayAll&&s.length>1&&d.setAttribute("size",s.length.toString()),o.autoFocus&&s.length>1&&d.setAttribute("autofocus","");super(e,(0,ie.s)("<div></div>",...a instanceof Node?[a]:a===null?[]:[(0,ie.s)(`<p>${a}</p>`)],d,(0,ie.s)("<footer></footer>",...Object.entries(o.actions).map(([,{label:g,action:f}])=>_((0,ie.s)(`<button>${g}</button>`),{click:()=>f(this),keydown:v=>{v.key==="Enter"&&f(this)}})))),o);c(this,Ot,l(()=>this.resize(),"#resizeHandler"));c(this,zt,void 0);this.addClass("selectionWindow"),u(this,zt,d),this.resize(),(0,ie.on)(window,"resize",r(this,Ot))}close(){(0,ie.off)(window,"resize",r(this,Ot)),super.close()}display(){return super.display(!1).then(()=>{let e=this.query("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,s;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-this.element().firstElementChild.offsetHeight-((s=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?s:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2.1em)`}catch(n){console.warn(n)}}selectionList(){return r(this,zt)}};l(xe,"SelectionWindow"),Ot=new WeakMap,zt=new WeakMap;var ve=xe;var Ui=w(b());var Ds=class extends ee{activate(){let t=new ve("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){M.get("./assets/city/bulb.png").then(t=>this.append((0,Ui.s)(`<button class="chooseResearch" title="Choose research" style="background-image:url('${t.uri}')">`)))}value(){return super.value()}};l(Ds,"ChooseResearch");var Oi=Ds;var Wt={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLaw:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},jt=Object.entries(Wt).reduce((i,[t,e])=>(Object.prototype.hasOwnProperty.call(i,e)||(i[e]=[]),Object.prototype.hasOwnProperty.call(i,t)||(i[t]=[]),i[e].push(t),i[t].push(t),i),{}),Nt=l((i,...t)=>i.reduce((e,s,n)=>(t.forEach((a,o)=>{var m;(m=jt[a])!=null&&m.includes(s._)&&(e[o]+=s.value)}),e),t.map(()=>0)),"reduceKnownYields"),nt=l((i,t)=>Nt(i,t)[0],"reduceKnownYield"),it={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var aa=l((i,...t)=>i.classList.add(...t),"addClass"),zi=l((i,t)=>i.dispatchEvent(t),"emit"),oa=l((i,t,...e)=>zi(i,new CustomEvent(t,{detail:e})),"emitCustom"),la=l(i=>{for(;i.hasChildNodes();)i.firstChild?.remove()},"empty"),ma=l((i,t)=>i.classList.contains(t),"hasClass"),da=l((i,t,e,s={})=>i.removeEventListener(t,e,s),"off"),oi=l((i,t,e,s={})=>i.addEventListener(t,e,s),"on"),pa=l((i,t,e,s={})=>t.forEach(n=>oi(i,n,e,s)),"onEach"),ca=l((i,t,e,s={})=>oi(i,t,e,{...typeof s=="boolean"?{capture:s}:s,once:!0}),"once"),ua=l((i,...t)=>i.classList.remove(...t),"removeClass"),$e=l((i,...t)=>{let e=document.createElement("div");e.innerHTML=i;let s=e.firstElementChild;return t.forEach(n=>{if(n instanceof Re){s.append(n.element());return}if(n instanceof Node){s.append(n);return}s.append(ha(n))}),s},"s"),ha=l(i=>document.createTextNode(i),"t"),ga=l((i,...t)=>t.forEach(e=>i.classList.toggle(e)),"toggleClass"),Re=class{#e;constructor(t){this.#e=t}static fromString(t){return new Re($e(t))}addClass(...t){aa(this.element(),...t)}append(...t){t.forEach(e=>{e instanceof Re&&(e=e.element()),this.element().append(e)})}element(){return this.#e}emit(t){return zi(this.element(),t)}emitCustom(t,...e){return oa(this.element(),t,...e)}empty(){la(this.element())}hasClass(t){return ma(this.element(),t)}off(t,e,s={}){da(this.element(),t,e,s)}on(t,e,s={}){oi(this.element(),t,e,s)}onEach(t,e,s={}){pa(this.element(),t,e,s)}once(t,e,s={}){ca(this.element(),t,e,s)}query(t){return this.element().querySelector(t)}queryAll(t){return this.element().querySelectorAll(t)}remove(){this.element().remove()}removeClass(...t){ua(this.element(),...t)}toggleClass(...t){ga(this.element(),...t)}};l(Re,"Element");var ks=l(i=>{let t=i.growth,e=parseInt(i.name.replace(/[^a-z]/gi,""),36).toString(2),s=new Array(t.size).fill(1),n=$e('<div class="population"></div>'),[a,o]=Nt(i.yields,"Happiness","Unhappiness"),m=s.length-1;for(;o>0&&m>-1;)s[m--]=0,o--;for(m=0;a>0&&m<s.length;)s[m]===0&&(s[m]++,a--),s[m]===1&&(s[m++]++,a--),s[m]===2&&m++;return s.forEach((d,p)=>M.getScaled(`./assets/city/people_${["unhappy","content","happy"][d]}_${["f","m"][parseInt(e[p%e.length],10)]}.png`,2).then(h=>n.append($e('<span class="citizen"></span>',$e(`<img src="${h.toDataURL("image/png")}">`))))),n},"renderPopulation"),Kt=l((i,t,e)=>`Progress ${i.progress.value} / ${i.cost.value} (${As(Hs(i,t,e))})`,"renderProgress"),Hs=l((i,t,e)=>Math.max(1,Math.ceil((i.cost.value-i.progress.value)/nt(t,e))),"turnsLeft"),As=l(i=>i+" turn"+(i===1?"":"s"),"turnsText"),Wi=l((i,t)=>i.yields.reduce(([e,s,n],a)=>{var m;let o=(m=jt[t])==null?void 0:m.includes(a._);return o&&a.value>0&&(e+=a.value),o&&a.value<0&&(s+=a.value),o&&(n+=a.value),[e,s,n]},[0,0,0]),"yieldData"),Bt=l(i=>new Array(Math.abs(i.value)).fill(0).map(()=>{let t=$e('<span class="yield-icon"></span>');return M.getScaled(`./assets/${it[Wt[i._]]}`,2).then(e=>t.append($e(`<img src="${e.toDataURL("image/png")}">`))),t}),"yieldImages");var ji=w(b());var Ni,Ki=l(i=>Ni=i,"setPreloadContainer"),li=l(i=>{let t=Ni.querySelector(`[data-path$="${i}.png"]`);return t===null?(console.error(`Missing image: ${i}.`),(0,ji.s)("<canvas></canvas>")):t},"getPreloadedImage"),mi=li;var Bi=w(b());var fa=l((i,t,e)=>{let s=(0,Bi.s)("<canvas></canvas>"),n=s.getContext("2d");s.width=i.width,s.height=i.height,n.drawImage(i,0,0,i.width,i.height);let a=n.getImageData(0,0,s.width,s.height),o=l(p=>{var f;let h=null,g={r:0,g:0,b:0,a:0};return typeof p=="string"?(h=p.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?g={r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16),a:1}:(h=p.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?g={r:parseInt(h[1]+h[1],16),g:parseInt(h[2]+h[2],16),b:parseInt(h[3]+h[3],16),a:1}:(h=p.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:1}:(h=p.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:parseFloat((f=h[4])!=null?f:1)}):"length"in p&&(g={r:p[0]||0,g:p[1]||0,b:p[2]||0,a:p[3]||1}),g},"getColor"),m=t.map(o),d=e.map(o);for(let p=0;p<a.data.length;p+=4)m.forEach((h,g)=>{a.data[p]===h.r&&a.data[p+1]===h.g&&a.data[p+2]===h.b&&a.data[p+3]===h.a*255&&(a.data[p]=(d[g]||d[0]).r,a.data[p+1]=(d[g]||d[0]).g,a.data[p+2]=(d[g]||d[0]).b,a.data[p+3]=Math.trunc((d[g]||d[0]).a*255))});return n.putImageData(a,0,0),s},"replaceColours"),Rs=fa;var Fi=w(b());var ye,Ue,Ft,we,Gt,be,Y=class{constructor(t,e=2,s=16,n=(0,Fi.s)("<canvas></canvas>")){c(this,ye,void 0);c(this,Ue,void 0);c(this,Ft,!0);c(this,we,void 0);c(this,Gt,void 0);c(this,be,void 0);u(this,ye,n),u(this,be,t),u(this,Gt,s),u(this,we,e),this.setCanvasSize(),u(this,Ue,r(this,ye).getContext("2d")),Ki(document.querySelector("#preload"))}canvas(){return r(this,ye)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return r(this,Ue)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}renderTile({x:t,y:e}){let s=this.tileSize(),n=t*s,a=e*s;this.context().clearRect(n,a,s,s)}scale(){return r(this,we)}tileSize(){return r(this,Gt)*r(this,we)}update(t){t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}world(){return r(this,be)}drawImage(t,e,s,n={}){var p,h;let a=this.tileSize(),o=e*a,m=s*a,d=this.getPreloadedImage(t);this.putImage(n.augment?n.augment(d):d,o+((p=n.offsetX)!=null?p:0),m+((h=n.offsetY)!=null?h:0))}filterNeighbours(t,e,s=["n","e","s","w"]){return s.filter(n=>e(r(this,be).getNeighbour(t,n)))}getPreloadedImage(t){return li(t)}putImage(t,e,s){r(this,Ue).imageSmoothingEnabled=!1,r(this,Ue).drawImage(t,e,s,t.width*r(this,we),t.height*r(this,we))}replaceColours(t,e,s){return Rs(t,e,s)}setCanvasSize(){r(this,ye).height=r(this,be).height()*this.tileSize(),r(this,ye).width=r(this,be).width()*this.tileSize()}isVisible(){return r(this,Ft)}setVisible(t){u(this,Ft,t)}};l(Y,"Map"),ye=new WeakMap,Ue=new WeakMap,Ft=new WeakMap,we=new WeakMap,Gt=new WeakMap,be=new WeakMap;var Gi=Y;var $s=class extends Y{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.city){let m=t.city,d=m.player,p=d.civilization,[h]=p.attributes.filter(g=>g.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(a,o,n,n)),this.context().fillStyle=h.value[0],this.context().fillRect(a+this.scale(),o+this.scale(),n-this.scale()*2,n-this.scale()*2),this.drawImage("map/city",e,s,{augment:g=>this.replaceColours(g,["#000"],[h.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}};l($s,"Cities");var qt=$s;var Yt=w(b());var Us=class extends ge{constructor(t,e,s,n={}){var o,m;let a=_((0,Yt.s)(`<button>${(o=n.okLabel)!=null?o:"OK"}</button>`),{click:()=>{s(),this.close()},keydown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),d.stopPropagation(),s(),this.close())}});super(t,(0,Yt.s)(`<div class="content"><p>${e}</p></div>`,(0,Yt.s)("<footer></footer>",a,_((0,Yt.s)(`<button>${(m=n.cancelLabel)!=null?m:"Cancel"}</button>`),{click:()=>this.close(),keydown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),d.stopPropagation(),this.close())}}))),{...n,queue:!1}),a.focus()}};l(Us,"ConfirmationWindow");var Os=Us;var rt,at,zs=class{constructor(t,e){c(this,rt,void 0);c(this,at,[]);this.setIds(t),u(this,rt,s=>{let{detail:n}=s,a=n.value.objects;!a||r(this,at).some(o=>o in a)&&document.addEventListener("dataupdated",o=>e(o.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",r(this,rt))}dispose(){document.removeEventListener("patchdatareceived",r(this,rt))}setIds(t){r(this,at).splice(0,r(this,at).length,...t)}};l(zs,"DataObserver"),rt=new WeakMap,at=new WeakMap;var _e=zs;var Ws=class extends Y{update(t){let e=[...t];return t.forEach(s=>{["n","ne","e","se","s","sw","w","nw"].forEach(n=>{let a=this.world().getNeighbour(s,n);e.includes(a)||e.push(a)})}),super.update(e)}};l(Ws,"TerrainAbstract");var K=Ws;var js=class extends K{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.terrain.features.length&&t.terrain.features.forEach(n=>n._==="Shield"?this.drawImage(`terrain/${n._.toLowerCase()}`,e,s,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${n._.toLowerCase()}`,e,s))}};l(js,"Feature");var Ns=js;var Ks=class extends K{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;this.filterNeighbours(t,n=>n.terrain._==="Unknown").forEach(n=>this.drawImage(`map/fog_${n}`,e,s))}};l(Ks,"Fog");var Bs=Ks;var Fs=class extends K{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=t.improvements.reduce((a,o)=>{let m=o._;return m in a&&(a[m]=!0),a},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(a=>{n[a]&&this.drawImage(`improvements/${a.toLowerCase()}`,e,s)}),n.Road){let a=this.filterNeighbours(t,m=>m.improvements.some(d=>d._==="Road"),["n","ne","e","se","s","sw","w","nw"]),o=this.filterNeighbours(t,m=>!!m.city||m.improvements.some(d=>d._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(a.forEach(m=>{(!n.Railroad||!o.includes(m))&&this.drawImage(`improvements/road_${m}`,e,s)}),n.Railroad&&o.forEach(m=>this.drawImage(`improvements/railroad_${m}`,e,s)),a.length===0&&o.length===0){let m=this.tileSize(),d=e*m,p=s*m,h=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=n.Railroad?"#000":"#8c5828",this.context().rect(d+h,p+h,this.scale()*2,this.scale()*2),this.context().fill()}}}};l(Fs,"Terrain");var Gs=Fs;var qs=class extends K{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;!t.improvements.some(a=>a._==="Irrigation")||this.drawImage("improvements/irrigation",e,s)}};l(qs,"Terrain");var Ys=qs;var qi=w(b());var Vs=class extends K{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,s);else if(t.isWater&&(this.drawImage("terrain/ocean",e,s),t.isCoast)){let m=this.getPreloadedImage("terrain/coast_sprite"),d=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(d>0){let p=d&7,h=d>>2&7,g=d>>4&7,f=d>>6&7|(d&1)<<2,v=(0,qi.s)('<canvas height="16" width="16"></canvas>'),E=v.getContext("2d");E.drawImage(m,p<<4,0,8,8,0,0,8,8),E.drawImage(m,(h<<4)+8,0,8,8,8,0,8,8),E.drawImage(m,(g<<4)+8,8,8,8,8,8,8,8),E.drawImage(m,f<<4,8,8,8,0,8,8,8),this.putImage(v,a,o)}this.filterNeighbours(t,p=>p.terrain._==="River").forEach(p=>this.drawImage(`terrain/river_mouth_${p}`,e,s))}}}};l(Vs,"Land");var Vt=Vs;var Vi=w(Yi()),Xi=w(b());var xa={playerId:null,scale:2,tileSize:16},$,O,ze,We,Qt,ot,lt,Jt,A,Xs=class extends Vi.EventEmitter{constructor(e,s,n=(0,Xi.s)("<canvas></canvas>"),a={playerId:null,scale:2},...o){let m={...xa,...a};super();c(this,$,void 0);c(this,O,{x:0,y:0});c(this,ze,void 0);c(this,We,[]);c(this,Qt,null);c(this,ot,void 0);c(this,lt,void 0);c(this,Jt,void 0);c(this,A,void 0);u(this,A,e),u(this,$,n),u(this,Qt,m.playerId),u(this,lt,m.tileSize),u(this,ot,m.scale),u(this,Jt,s),o.forEach(d=>r(this,We).push(new d(r(this,A),this.scale(),r(this,lt)))),u(this,ze,n.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){r(this,We).forEach(s=>s.update(e))}canvas(){return r(this,$)}center(){return r(this,O)}getLayer(e){var s;return(s=this.getLayers(e).shift())!=null?s:null}getLayers(e){return r(this,We).filter(s=>s instanceof e)}isVisible(e,s){let n=Math.floor(r(this,$).width/this.tileSize()),a=Math.floor(r(this,$).height/this.tileSize());if(n>=r(this,A).width()&&a>=r(this,A).height())return!0;let[o,m,d,p]=this.visibleBounds();return(n>=r(this,A).width()||(o>m?e<m||e>o:e<m&&e>o))&&(a>=r(this,A).height()||(d>p?s<p||s>d:s<p&&s>d))}playerId(){return r(this,Qt)}render(){let e=this.tileSize(),s=r(this,A).width()*e,n=r(this,O).x*e+Math.trunc(e/this.scale()),a=Math.trunc(r(this,$).width/2),o=r(this,A).height()*e,m=r(this,O).y*e+Math.trunc(e/this.scale()),d=Math.trunc(r(this,$).height/2),p=a-n,h=a+s,g=d-m,f=d+o;for(;p>0;)p-=s;for(;g>0;)g-=o;for(;h<r(this,$).width;)h+=s;for(;f<r(this,$).height;)f+=o;r(this,ze).fillStyle="#000",r(this,ze).fillRect(0,0,Math.max(r(this,A).width()*e,r(this,$).width),Math.max(r(this,A).height()*e,r(this,$).height));for(let v=p;v<h;v+=s)for(let E=g;E<f;E+=o)r(this,We).forEach(U=>{if(!U.isVisible())return;let W=U.canvas();r(this,ze).drawImage(W,v,E,W.width,W.height)})}scale(){return r(this,ot)}setCenter(e,s){r(this,O).x=e,r(this,O).y=s,this.render(),this.emit("focus-changed",e,s)}tileSize(){return r(this,lt)*r(this,ot)}transport(){return r(this,Jt)}visibleBounds(){let[{x:e,y:s},{x:n,y:a}]=this.visibleRange();return[e,n,s,a]}visibleRange(){let e=Math.floor(Math.floor(r(this,$).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,$).height/this.tileSize())/2);return[{x:(r(this,O).x-e+r(this,A).width())%r(this,A).width(),y:(r(this,O).y-s+r(this,A).height())%r(this,A).height()},{x:(r(this,O).x+e)%r(this,A).width(),y:(r(this,O).y+s)%r(this,A).height()}]}rawVisibleRange(){let e=Math.floor(Math.floor(r(this,$).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,$).height/this.tileSize())/2);return[{x:r(this,O).x-e,y:r(this,O).y-s},{x:r(this,O).x+e,y:r(this,O).y+s}]}world(){return r(this,A)}};l(Xs,"Portal"),$=new WeakMap,O=new WeakMap,ze=new WeakMap,We=new WeakMap,Qt=new WeakMap,ot=new WeakMap,lt=new WeakMap,Jt=new WeakMap,A=new WeakMap;var Qs=Xs;var Js=class extends K{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=this.filterNeighbours(t,a=>t.terrain._==="River"&&a.isWater||t.terrain._===a.terrain._).join("");t.terrain._!=="Ocean"&&(n?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${n}`,e,s):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,s))}};l(Js,"Terrain");var Zs=Js;var sn=w(b());var va={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},ya=l((i,t=16)=>{var m,d;let e=i.player,s=e.civilization,[n]=s.attributes.filter(p=>p.name==="colors"),a=Rs(mi(`units/${i._.toLowerCase()}`),["#60E064","#2C7800"],n.value),o=a.getContext("2d");if(o.imageSmoothingEnabled=!1,(m=i.improvements)!=null&&m.some(p=>p._==="Fortified")&&o.drawImage(mi("map/fortify"),0,0),i.busy){let p=t/2,h=t*.75,g=(d=va[i.busy._])!=null?d:i.busy._.replace(/[a-z]+/g,"");o.font="bold 8px sans-serif",o.fillStyle="black",o.textAlign="center",o.fillText(g,p,h),o.fillStyle="white",o.fillText(g,p,h)}return a},"renderUnit"),en=ya;var Zt,tn=class extends sn.Element{constructor(e,s=2){super((0,sn.s)('<canvas width="32" height="32"></canvas>'));c(this,Zt,2);u(this,Zt,s),this.build(e)}build(e){let s=en(e),n=this.element().getContext("2d"),a=this.size(s.width),o=this.size(s.height),m=Math.floor((this.size(16)-a)/2),d=Math.floor((this.size(16)-o)/2);n.imageSmoothingEnabled=!1,n.drawImage(s,m,d,a,o)}element(){return super.element()}size(e){return e*r(this,Zt)}};l(tn,"Unit"),Zt=new WeakMap;var mt=tn;var nn=class extends ve{constructor(t,e,s=()=>{}){super("Activate unit",t.map(n=>{var a,o;return{label:n._+" ["+((o=(a=n.city)==null?void 0:a.name)!=null?o:"NONE")+"]"+(n.busy?` (${n.busy._})`:""),value:n.id}}),n=>{let[a]=t.filter(o=>o.id===n);if(!!a){if(!a.active){e.send("action",{name:"InactiveUnit",id:n});return}s(a)}},null)}};l(nn,"UnitSelectionWindow");var rn=nn;var on,dt,Te,Ce,Me,an=class{constructor(t){c(this,on,l((t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}),"#unknown"));c(this,dt,{});c(this,Te,void 0);c(this,Ce,void 0);c(this,Me,void 0);u(this,Ce,t.height),u(this,Me,t.width),u(this,Te,t.tiles||[])}get(t,e){for(;t<0;)t+=r(this,Me);for(;e<0;)e+=r(this,Ce);for(;t>=r(this,Me);)t-=r(this,Me);for(;e>=r(this,Ce);)e-=r(this,Ce);let s=[t,e].toString();if(!(s in r(this,dt))){let n=r(this,Te).findIndex(a=>a.x===t&&a.y===e);if(n===-1)return r(this,on).call(this,t,e);r(this,dt)[s]=n}return r(this,Te)[r(this,dt)[s]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return r(this,Ce)}tiles(){return r(this,Te)}width(){return r(this,Me)}setTiles(t){u(this,Te,t)}};l(an,"World"),on=new WeakMap,dt=new WeakMap,Te=new WeakMap,Ce=new WeakMap,Me=new WeakMap;var ln=an;var mn=class extends Gi{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.yields.reduce((g,f)=>g+f.value,0),d=t.yields.sort((g,f)=>g._.charCodeAt(0)-f._.charCodeAt(0)),p=0;if(m<5){let g=[[a,o],[a+n/2,o],[a,o+n/2],[a+n/2,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])});return}if(m<7){let g=[[a,o],[a+n/3,o],[a+n/3*2,o],[a,o+n/2],[a+n/3,o+n/2],[a+n/3*2,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),g[p][0],g[p++][1])});return}if(m<9){let g=[[a,o],[a+n/4,o],[a+n/4*2,o],[a+n/4*3,o],[a,o+n/2],[a+n/4,o+n/2],[a+n/4*2,o+n/2],[a+n/4*3,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])});return}if(m<11){let g=[[a,o],[a+n/5,o],[a+n/5*2,o],[a+n/5*3,o],[a+n/5*4,o],[a,o+n/2],[a+n/5,o+n/2],[a+n/5*2,o+n/2],[a+n/5*3,o+n/2],[a+n/5*4,o+n/2]];d.forEach(f=>{for(let v=0;v<f.value;v++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[p++])});return}let h=[[a,o],[a+n/6,o],[a+n/6*2,o],[a+n/6*3,o],[a+n/6*4,o],[a+n/6*5,o],[a,o+n/2],[a+n/6,o+n/2],[a+n/6*2,o+n/2],[a+n/6*3,o+n/2],[a+n/6*4,o+n/2],[a+n/6*5,o+n/2]];d.forEach(g=>{for(let f=0;f<g.value;f++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),...h[p++])})}};l(mn,"Yields");var pt=mn;var L=w(b());var dn=w(b());var je=class extends dn.Element{constructor(t,e,s=["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"]){super((0,dn.s)('<span class="supported-unit"></span>',new mt(e),...t.yields.filter(n=>s.includes(n._)).filter(n=>n.unit.id===e.id).flatMap(n=>Bt(n))))}};l(je,"SupportedUnit");var wa=l((i,t)=>t.filter(e=>jt[i].includes(e._)).reduce(([e,s],n)=>[e+(n.value<0?-n.value:0),s+n.value],[0,0]),"reduceYield"),ba=l(i=>(0,L.s)('<div class="yields-detail"></div>',...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>(0,L.s)(`<div class="yields" data-yields="${t.join(" ")}"></div>`,...t.map(e=>(0,L.s)(`<span class="yield" data-yield="${e}"></span>`,...wa(e,i.yields).map((s,n)=>(0,L.s)(`<span class="${["used","free"][n]}"></span>`,...Bt({_:e,value:s}))))))),...Object.entries(i.yields.filter(t=>!Object.keys(Wt).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>(0,L.s)(`<div><div>${t}</div><div>${e}</div></div>`))),"renderYields"),di=l(i=>{let t=i.querySelectorAll(".yields-detail .yield");Array.from(t).forEach(e=>{let[s,n]=Array.from(e.children);for(;s.scrollWidth+n.scrollWidth>e.clientWidth;){let a=parseInt(e.getAttribute("data-max-width")||"14",10);if(a===0)break;e.setAttribute("data-max-width",(a-1).toString())}})},"resizeYields"),_a=l((i,t,e)=>{let s=(0,L.s)("<canvas></canvas>"),n=new Qs(new ln(t.player.world),e,s,{playerId:t.player.id,scale:i.scale(),tileSize:i.tileSize()/i.scale()},Vt,Ys,Zs,Gs,Ns,Bs,qt,pt);return s.height=i.tileSize()*5,s.width=i.tileSize()*5,n.setCenter(t.tile.x,t.tile.y),n.build(t.tiles),n.getLayer(pt).render(t.tilesWorked),n.render(),_((0,L.s)('<div class="city-map"></div>',s),{click:()=>e.send("action",{name:"ReassignWorkers",city:t.id})})},"renderMap"),Ea=l((i,t,e)=>(0,L.s)(`<div class="build"><header>Building ${i.build.building?i.build.building.item._:"nothing"}</header></div>`,_((0,L.s)(`<button>${i.build.building?"Change":"Choose"}</button>`),{click(){t()}}),_((0,L.s)("<button>Buy</button>"),{click(){e()}}),i.build.building?(0,L.s)(`<p>${Kt(i.build,i.yields,"Production")}</p>`):""),"renderBuild"),Ta=l(i=>(0,L.s)(`<div class="growth"><header>Growth</header><p>Size ${i.growth.size.toString()}</p><p>${Kt(i.growth,i.yields,"Food")}</p></div>`),"renderGrowth"),Ca=l(i=>(0,L.s)('<div class="improvements"></div>',(0,L.s)("<div></div>",...i.improvements.map(t=>(0,L.s)(`<div>${t._}</div>`,...i.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>Bt(e)))))),"renderImprovements"),Ma=l((i,t)=>_((0,L.s)('<div class="garrisoned-units"><header>Garrisoned Units</header></div>',(0,L.s)('<div class="units"></div>',...i.tile.units.map(e=>new mt(e).element()))),{click(){let e=i.tile.units.filter(s=>s.player.id===i.player.id);e.length!==0&&new rn(e,t)}}),"renderGarrisonedUnits"),La=l(i=>(0,L.s)('<div class="supported-units"><header>Supported units</header></div>',(0,L.s)('<div class="units"></div>',...i.units.map(t=>new je(i,t)))),"renderSupportedUnits"),Qi=l((i,t,e,s,n)=>(0,L.s)('<div class="city-screen"></div>',(0,L.s)('<div class="top-row"></div>',(0,L.s)('<div class="yield-details"></div>',ks(i),ba(i),La(i)),_a(t,i,e),Ca(i)),(0,L.s)('<div class="bottom-row"></div>',Ta(i),(0,L.s)('<div class="tabbed-details"></div>',(0,L.s)('<div class="info"></div>',Ma(i,e))),Ea(i,s,n))),"cityDetails"),pe,ct,es,ut,pn=class extends N{constructor(e,s,n){super(e.name,Qi(e,s,n,()=>this.changeProduction(),()=>this.completeProduction()),{canResize:!0,canMaximise:!0,size:"maximised"});c(this,pe,void 0);c(this,ct,void 0);c(this,es,void 0);c(this,ut,void 0);setTimeout(()=>di(this.element()),200),this.addClass("city-screen-window"),u(this,pe,e),u(this,es,s),u(this,ut,n),u(this,ct,new _e([e.id,e.build.id,e.growth.id,...e.units.map(o=>o.id)],o=>{var d,p;let[m]=((p=(d=o.player)==null?void 0:d.cities)!=null?p:[]).filter(h=>e.id===h.id);if(!m){this.close();return}u(this,pe,m),r(this,ct).setIds([m.id,m.build.id,m.growth.id,...m.units.map(h=>h.id)]),this.update(Qi(m,r(this,es),n,()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus(),setTimeout(()=>di(this.element()),200)})),this.on("keydown",o=>{["c","C"].includes(o.key)&&(this.changeProduction(),o.preventDefault(),o.stopPropagation()),["b","B"].includes(o.key)&&(this.completeProduction(),o.preventDefault(),o.stopPropagation()),["Enter","x","X"].includes(o.key)&&this.close()});let a=l(()=>setTimeout(()=>di(this.element()),200),"resizeHandler");this.on("close",()=>window.removeEventListener("resize",a)),window.addEventListener("resize",a),this.on("close",()=>this.off("resize",a)),this.on("resize",a)}changeProduction(){new gt(r(this,pe).build,r(this,ut),()=>this.element().focus())}close(){r(this,ct).dispose(),super.close()}completeProduction(){!r(this,pe).build.building||new Os("Are you sure?",`Do you want to rush building of ${r(this,pe).build.building.item._}`,()=>r(this,ut).send("action",{name:"CompleteProduction",id:r(this,pe).id}))}};l(pn,"City"),pe=new WeakMap,ct=new WeakMap,es=new WeakMap,ut=new WeakMap;var ht=pn;var ts,cn,ft=class extends xe{constructor(e,s,n=()=>{},a={}){let o=l(m=>Math.max(1,Math.ceil((m.cost.value-e.progress.value)/nt(e.city.yields,"Production"))),"turns");super(`What would you like to build in ${e.city.name}?`,e.available.map(m=>({label:`${m.item._} (Cost: ${m.cost.value} / ${o(m)} turn${o(m)===1?"":"s"})`,value:m.item._})),m=>{!m||(s.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:m||"@"}),this.close(!0))},null,{actions:a,displayAll:!0});c(this,ts,void 0);c(this,cn,void 0);u(this,ts,n),u(this,cn,s)}close(e=!1){super.close(),e&&r(this,ts).call(this,e)}};l(ft,"CityBuildSelectionWindow"),ts=new WeakMap,cn=new WeakMap,ft.showCityAction=l((e,s,n)=>({label:"View city",action(a){a.close(),new ht(e,s,n)}}),"showCityAction"),ft.showCityOnMapAction=l((e,s)=>({label:"Show on map",action(n){n.close(),s.setCenter(e.tile.x,e.tile.y)}}),"showCityOnMapAction");var gt=ft;var Ji=w(b());var xt,un=class extends ee{constructor(e,s,n){super(e,n);c(this,xt,void 0);u(this,xt,s)}activate(){new gt(this.value(),this.transport(),()=>this.complete(),{showCity:gt.showCityAction(this.value().city,r(this,xt),this.transport()),showCityOnMap:gt.showCityOnMapAction(this.value().city,r(this,xt))})}build(){let e=this.value();M.get("./assets/city/production.png").then(s=>this.append((0,Ji.s)(`<button class="cityBuild" title="What would you like to build in ${e.city.name}?" style="background-image:url('${s.uri}')">`)))}value(){return super.value()}};l(un,"CityBuild"),xt=new WeakMap;var Zi=un;var er=w(b());var hn=class extends ee{activate(){this.transport().send("action",{name:"EndTurn"})}build(){this.append((0,er.s)('<button class="endTurn" title="End turn"></button>'))}};l(hn,"EndTurn");var tr=hn;var sr=w(b());var gn=class extends ee{activate(){let t=new ve("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){M.get("./assets/city/sad.png").then(t=>this.append((0,sr.s)(`<button class="chooseGovernment" title="Choose government" style="background-image:url('${t.uri}')"></button>`)))}value(){return super.value()}};l(gn,"Revolution");var nr=gn;var ss,ce,fn=class extends xn.Element{constructor(e=(0,xn.s)('<div class="actions"></div>'),s,n){super(e);c(this,ss,void 0);c(this,ce,void 0);u(this,ss,s),u(this,ce,n),this.on("actioned",a=>a.detail.remove()),this.on("keydown",a=>{var g;let o=document.activeElement;if(!this.element().contains(o))return;let m=fe(a),d=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(m)||d.length===0)return;a.preventDefault(),a.stopPropagation();let p=o===this.element()?["ArrowLeft","ArrowUp"].includes(m)?o.firstElementChild:o.lastElementChild:o;for(;p.parentElement!==this.element();)p=p.parentElement;let h=d.indexOf(p);if(["ArrowUp","ArrowLeft"].includes(m)){if(h>0){(g=d[h-1].querySelector("button"))==null||g.focus();return}d.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(m)){if(h<d.length-1){d[h+1].querySelector("button").focus();return}d.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(s=>{let n;switch(s._){case"ActiveUnit":return;case"AdjustTradeRates":n=new Ri(s,r(this,ce));break;case"ChooseResearch":n=new Oi(s,r(this,ce));break;case"CityBuild":n=new Zi(s,r(this,ss),r(this,ce));break;case"EndTurn":n=new tr(s,r(this,ce));break;case"Revolution":n=new nr(s,r(this,ce));break;default:console.log("need to handle "+s._);return}this.element().prepend(_(n.element(),{click:()=>n.activate(),keydown:({key:a})=>{(a===" "||a==="Enter")&&n.activate()}}))})}};l(fn,"Actions"),ss=new WeakMap,ce=new WeakMap;var pi=fn;var Ne,vn=class extends Y{constructor(){super(...arguments);c(this,Ne,null)}renderTile(e){super.renderTile(e);let{x:s,y:n}=e,a=this.tileSize(),o=s*a,m=n*a;if(e.units.length>0&&(r(this,Ne)!==null?r(this,Ne).tile.id!==e.id:!0)){let[d]=e.units.sort((h,g)=>{var f,v;return((f=g.defence)==null?void 0:f.value)-((v=h.defence)==null?void 0:v.value)}),p=this.renderUnit(d);e.units.length>1&&this.putImage(p,o-this.scale(),m-this.scale()),this.putImage(p,o,m)}}renderUnit(e){return en(e)}setActiveUnit(e){u(this,Ne,e)}activeUnit(){return r(this,Ne)}};l(vn,"Units"),Ne=new WeakMap;var ns=vn;var yn=class extends ns{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:s}=t.tile,n=this.world().get(e,s),a=this.tileSize(),o=e*a,m=s*a,d=this.renderUnit(t);n.units.length>1&&this.putImage(d,o-this.scale(),m-this.scale()),this.putImage(d,o,m)}update(){this.render()}};l(yn,"ActiveUnit");var ci=yn;var wn=class extends Y{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.city,d=this.tileSize()/2,p=this.tileSize()*.75,h=this.tileSize()/2,g=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(m.growth.size.toString(),a+d+this.scale(),o+p),this.context().fillText(m.name,a+h+this.scale(),o+g),this.context().fillStyle="white",this.context().fillText(m.growth.size.toString(),a+d,o+p-this.scale()),this.context().fillText(m.name,a+h,o+g-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}};l(wn,"CityNames");var ui=wn;var Ke=w(b());var Ia=l(async i=>{let[t,e,s,n,a,o]=["Food","Production","Trade","Research","Gold","Luxuries"].map(v=>Wi(i,v)),[m,d,p,h,g,f]=await Promise.all(["Food","Production","Trade","Research","Gold","Luxuries"].map(v=>M.getScaled(`./assets/${it[v]}`,2).then(E=>`<img src="${E.toDataURL("image/png")}">`)));return[(0,Ke.s)(`<header>${i.name}</header>`),(0,Ke.s)(`<div class="growth"><strong>${i.growth.size}</strong> ${m} ${t[2]} [${t[0]}] (${As(Hs(i.growth,i.yields,"Food"))})</div>`),(0,Ke.s)(`<div class="build">${d} ${e[2]} [${e[0]}] ${i.build.building?i.build.building.item._:"Nothing"}${i.build.building?` (${As(Hs(i.build,i.yields,"Production"))})`:""}</div>`),(0,Ke.s)(`<div class="yields">${[[s,p],[n,h],[a,g],[o,f]].filter(([[v]])=>v!==0).map(([[v,,E],U])=>`${U} ${E}${E!==v?` [${v}]`:""}`).join(", ")}</div>`)]},"buildCityRow"),Be,vt,is,rs,bn=class extends N{constructor(e,s,n){super("City details",(0,Ke.s)('<div class="loading"></div>'));c(this,Be,void 0);c(this,vt,void 0);c(this,is,void 0);c(this,rs,void 0);this.addClass("city-status"),u(this,Be,e.cities),u(this,vt,new _e([e.id,...e.cities.flatMap(({id:a,build:o,growth:m})=>[a,m.id,o.id])],a=>{let o=a.player;u(this,Be,o.cities),r(this,vt).setIds([o.id,...o.cities.flatMap(({id:m,build:d,growth:p})=>[m,p.id,d.id])]),this.update()})),u(this,is,s),u(this,rs,n),this.update()}close(){return r(this,vt).dispose(),super.close()}update(){Promise.all(r(this,Be).map(e=>Ia(e))).then(e=>super.update((0,Ke.s)("<table></table>",...e.map(([s,n,a,o],m)=>{let d=document.createElement("tr");return d.append(...[[s,"th"],[n,"td"],[a,"td"],[o,"td"]].map(([p,h])=>{let g=document.createElement(h);return g.append(p),g})),_(d,{click:()=>new ht(r(this,Be)[m],r(this,is),r(this,rs))})}))))}};l(bn,"CityStatus"),Be=new WeakMap,vt=new WeakMap,is=new WeakMap,rs=new WeakMap;var ir=bn;var En=w(b());var as,os,_n=class extends En.Element{constructor(e,s,n){super(e);c(this,as,void 0);c(this,os,void 0);u(this,as,s),u(this,os,n)}build(){this.empty(),this.append((0,En.s)(`<h3><span class="year">${this.year()}</span><span class="turn">${r(this,as).value.toString()}</span></h3>`))}year(e=r(this,os).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};l(_n,"GameDetails"),as=new WeakMap,os=new WeakMap;var rr=_n;var ar=w(b());var Tn=class extends Qs{bindEvents(){(0,ar.on)(this.canvas(),"click",t=>{let e=this.center(),s={x:Math.floor(this.canvas().width/2-this.tileSize()/2),y:Math.floor(this.canvas().height/2-this.tileSize()/2)},n=e.x+Math.trunc(((t.offsetX-s.x)/this.tileSize()+this.world().width())%this.world().width()),a=e.y+Math.trunc(((t.offsetY-s.y)/this.tileSize()+this.world().height())%this.world().height()),o=this.world().get(n,a),m=o.units.filter(d=>d.player.id===this.playerId());if(o.city&&o.city.player.id===this.playerId())new ht(o.city,this,this.transport());else if(m.length){new rn(m,this.transport(),d=>this.emit("activate-unit",d));return}this.setCenter(o.x,o.y)})}};l(Tn,"GamePortal");var or=Tn;var Cn=class extends K{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,s)}};l(Cn,"Terrain");var lr=Cn;var ls=w(b());var Pa=l(async i=>{let t={CityImprovementContent:s=>s.cityImprovement._,MartialLaw:s=>new mt(s.unit),MilitaryUnhappiness:s=>new je(i,s.unit,["MilitaryUnhappiness"])},e=i.yields.reduce((s,n)=>(n._ in t&&s.push(t[n._](n)),s),[]);return(0,ls.s)(`<div class="city"><div class="name">${i.name}</div></div>`,ks(i),(0,ls.s)('<div class="reasons"></div>',...e))},"buildCityRow"),yt,wt,Mn=class extends N{constructor(e){super("Happiness report",(0,ls.s)("<div></div>"));c(this,yt,void 0);c(this,wt,void 0);this.addClass("happiness-report"),u(this,yt,new _e([e.id,...e.cities.map(s=>s.id)],s=>{u(this,wt,s.player),r(this,yt).setIds([e.id,...e.cities.map(n=>n.id)]),this.update()})),u(this,wt,e),this.update()}close(){return r(this,yt).dispose(),super.close()}update(){Promise.all(r(this,wt).cities.map(e=>Pa(e))).then(e=>super.update((0,ls.s)("<div></div>",...e)))}};l(Mn,"HappinessReport"),yt=new WeakMap,wt=new WeakMap;var mr=Mn;var Fe,Le,Ln=class{constructor(t=500){c(this,Fe,!1);c(this,Le,[]);setInterval(()=>this.check(),t)}check(){r(this,Fe)||r(this,Le).forEach(t=>t())}clear(){u(this,Le,[])}off(t){u(this,Le,r(this,Le).filter(e=>e!==t))}on(t){r(this,Le).push(t)}pause(){u(this,Fe,!0)}isPaused(){return r(this,Fe)}resume(){u(this,Fe,!1)}};l(Ln,"IntervalHandler"),Fe=new WeakMap,Le=new WeakMap;var dr=Ln;var ae=w(b());var ms,ds,In=class{constructor(t,...e){c(this,ms,void 0);c(this,ds,void 0);u(this,ms,e),u(this,ds,t)}args(){return r(this,ms)}channel(){return r(this,ds)}};l(In,"Request"),ms=new WeakMap,ds=new WeakMap;var Ie=In;var Pn=class extends Ie{constructor(t){super("getOptions",t)}};l(Pn,"Options");var pr=Pn;var z=w(b());var bt,Ge,Sn=class extends N{constructor(e,s){super("Customise world",(0,z.s)('<div class="customise-world"></div>'));c(this,bt,void 0);c(this,Ge,void 0);u(this,bt,s),u(this,Ge,e),this.init()}build(){super.build(),this.init()}async init(){var h,g,f,v,E,U;let e=await r(this,Ge).request(new pr(["players","height","width","landCoverage","landSize","maxIterations"])),s=(0,z.s)(`<input name="players" type="number" value="${(h=e.players)!=null?h:7}" step="1" min="1" max="20">`),n=(0,z.s)(`<input name="height" type="number" value="${(g=e.height)!=null?g:60}" step="1" min="1">`),a=(0,z.s)(`<input name="width" type="number" value="${(f=e.width)!=null?f:80}" step="1" min="1">`),o=(0,z.s)(`<input name="landCoverage" type="number" value="${(v=e.landCoverage)!=null?v:.4}" step="0.01" min="0">`),m=(0,z.s)(`<input name="landSize" type="number" value="${(E=e.landSize)!=null?E:.2}" step="0.01" min="0">`),d=(0,z.s)(`<input name="maxIterations" type="number" value="${(U=e.maxIterations)!=null?U:20}" step="1" min="1">`),p=l(async()=>{this.close(),await r(this,Ge).request(new Ie("setOptions",{players:s.value,height:n.value,width:a.value,landCoverage:o.value,landSize:m.value,maxIterations:d.value})),r(this,Ge).send("start"),r(this,bt)&&r(this,bt).call(this)},"submit");this.update((0,z.s)('<div class="customise-world"></div>',(0,z.s)('<div class="option"><label>Players</label></div>',s),(0,z.s)('<div class="option"><label>Height</label></div>',n),(0,z.s)('<div class="option"><label>Width</label></div>',a),(0,z.s)('<div class="option"><label>Land coverage</label></div>',o),(0,z.s)('<div class="option"><label>Land size</label></div>',m),(0,z.s)('<div class="option"><label>Max iterations</label></div>',d),_((0,z.s)("<button>Build</button>"),{click:()=>p()}))),this.on("keydown",W=>{W.key==="Enter"&&p()})}};l(Sn,"CustomiseWorldWindow"),bt=new WeakMap,Ge=new WeakMap;var cr=Sn;var Dn=class extends xe{constructor(t,e,s,n="Please choose one of the following:",a={canClose:!1,displayAll:!1}){super(t,e,s,n,{...a,displayAll:!0})}display(){return new Promise(t=>{this.on("selection",({detail:e})=>t(e)),super.display()})}};l(Dn,"MandatorySelection");var ur=Dn;var _t=class extends ur{constructor(t,e){super("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],async s=>{this.close(),await t.request(new Ie("setOptions",{width:80,height:60,players:parseInt(s,10)})),e&&await e(),t.send("start")})}};l(_t,"NewGameWindow");var hr=_t;var kn=class extends _t{constructor(t,e){super(t,async()=>{e&&await e(),await t.request(new Ie("setOptions",{width:80,height:50,earth:!0}))})}};l(kn,"EarthWindow");var gr=kn;var Hn=class{constructor(){this.blob=null;this.ptr=-1}fromString(t,e){this.blob=t,this.ptr=0,this.decode(e)}getUByte(){return this.blob.charCodeAt(this.ptr++)}getUShort(){let t=this.getUByte();return(this.getUByte()<<8)+t}getShort(){return(this.getUShort()+32768)%65536-32768}getString(t){let e=this.ptr;return this.ptr+=t,this.blob.substr(e,t)}decode(t){if(this.blob===null){console.warn("file has not been loaded!");return}console.warn("The decode function should be overwritten"),t&&t()}};l(Hn,"BinFile");var fr=Hn;var An=class{constructor(t){this.dicTable=[];this.dicTable=[],this.dicSize=1<<t;for(let e=0;e<this.dicSize;e++)e<256?this.dicTable[e]=[e]:this.dicTable[e]=null;this.curPos=257}getEntry(t){return t<this.curPos?this.dicTable[t]:null}isFull(){return this.curPos===this.dicTable.length}getCurPos(){return this.curPos}addEntry(t){return this.curPos<this.dicTable.length&&(this.dicTable[this.curPos]=t,this.curPos++),this.curPos-1}};l(An,"LZWDictionary");var xr=An;var Rn=class{static parseByteStreamToIndexes(t,e,s){let n=[],a=0,o=0,m=1,d=1,p=256,h=0,g=0;for(;e>0;){for(;o<8+m;)a|=t.getUByte()<<o,e--,o+=8;for(;o>=8+m;)g=a&(d<<8&65280|255),a>>=8+m,o-=8+m,h++,h==p&&(h=0,m+=1,d<<=1,d|=1,p<<=1,8+m>s&&(h=0,m=1,d=1,p=256)),n.push(g)}return n}static decode(t,e){e=e||11;let s=t,n=[];for(;s.length>0;){let a=new xr(e),o=[s[0]],m=s[0],d=a.getEntry(m),p=m,h,g=0;for(;!a.isFull()&&g++<s.length-1;){h=s[g];let f=[];h>=a.getCurPos()?(f=a.getEntry(m),f===null&&console.error(`No dictionary entry in LZW special case: oldCode=${m}; newCode=${h}; i=${g}; buffer=${d}`),f=[...f??[],p]):f=a.getEntry(s[g]),o.push.apply(o,f),p=f[0],a.addEntry(d.concat(p)),m=h,d=a.getEntry(m)}n.push.apply(n,o),s=s.slice(g+1)}return n}static RLEDecode(t){let e=[],s=0,n=!1;for(let a=0;a<t.length;a++){let o=t[a];if(n){if(o==0)s=144,e.push(144);else for(let m=0;m<o-1;m++)e.push(s);n=!1}else o==144?n=!0:(e.push(o),s=o)}return e}};l(Rn,"LZW");var $n=Rn;var Sa=l(i=>i&15,"lowerNibble"),vr=Sa;var Da=l(i=>(i&240)>>4,"upperNibble"),yr=Da;var Un=class extends fr{constructor(){super(...arguments);this.palette=[];this.palette16=[{r:255,g:255,b:255,a:0},{r:170,g:0,b:0,a:255},{r:0,g:170,b:0,a:255},{r:170,g:170,b:0,a:255},{r:0,g:0,b:170,a:255},{r:0,g:0,b:0,a:255},{r:0,g:85,b:170,a:255},{r:170,g:170,b:170,a:255},{r:85,g:85,b:85,a:255},{r:255,g:85,b:85,a:255},{r:85,g:255,b:85,a:255},{r:255,g:255,b:85,a:255},{r:85,g:85,b:255,a:255},{r:255,g:85,b:255,a:255},{r:85,g:255,b:255,a:255},{r:255,g:255,b:255,a:255}];this.imageData=null;this.imageHeight=0;this.imageWidth=0;this.byteMode=11}decode(e){let s=this.getString(2),n=this.getShort();if(s=="M0")this.getPaletteData(),s=this.getString(2),n=this.getShort();else{console.log("Creating a random color palette...");for(let a=0;a<256;a++)a<16?this.palette.push(this.palette16[a]):this.palette.push({r:Math.floor(Math.random()*256),g:Math.floor(Math.random()*256),b:Math.floor(Math.random()*256),a:255})}s=="X0"?this.getX0ImageData(n):s=="X1"?this.getX1ImageData(n):console.error('"'+s+'" is an unknown chunk type'),e&&e()}getPaletteData(){let e=this.getUByte(),s=this.getUByte(),n=s-e+1,a=!1;for(let o=0;o<n;o++){let m={r:this.getUByte()*4,g:this.getUByte()*4,b:this.getUByte()*4,a:255};this.palette.push(m),m.r===m.g&&m.g===m.b&&m.r===0&&(a||(m.a=0),a=!0)}this.palette.push({r:0,g:0,b:0,a:0})}getX0ImageData(e){this.imageWidth=this.getShort(),this.imageHeight=this.getShort(),this.byteMode=this.getUByte();let s=$n.parseByteStreamToIndexes(this,e-5,this.byteMode),n=$n.decode(s,this.byteMode);this.imageData=$n.RLEDecode(n)}getX1ImageData(e){this.getX0ImageData(e);let s=this.imageData;this.imageData=[];for(let n=0;n<s.length;n++)this.imageData.push(vr(s[n])),this.imageData.push(yr(s[n]));this.palette=this.palette16}draw(e,s=0,n=0){let a=e.getImageData(0,0,this.imageWidth,this.imageHeight),o=0;for(let m=0;m<this.imageHeight;m++)for(let d=0;d<this.imageWidth;d++){let p=this.imageData[o],h=(d+m*this.imageWidth)*4;a.data[h]=this.palette[p].r,a.data[h+1]=this.palette[p].g,a.data[h+2]=this.palette[p].b,a.data[h+3]=this.palette[p].a,o++}e.putImageData(a,s,n)}getPixel(e,s){return this.imageData?this.imageData[e+this.imageWidth*s]:0}};l(Un,"PicImage");var wr=Un;var br=l((i,t,e,s,n=a=>console.log(a))=>{let a=s(320,200),o=new wr,m=[];return o.fromString(i,()=>{o.draw(a.getContext("2d",{willReadFrequently:!0})),Object.entries(t).forEach(([d,p])=>p.forEach(h=>h.contents.forEach(g=>{let f={...e,...h,...g},v=`./assets/${d+f.name}.png`,E=s(f.width,f.height),U=E.getContext("2d",{willReadFrequently:!0});U.clearRect(0,0,f.width,f.height),U.drawImage(a,f.x,f.y,f.width,f.height,0,0,f.width,f.height);for(let W=0;W<a.width;W++)for(let ue=0;ue<a.height;ue++){let ke=U.getImageData(W,ue,1,1).data;ke[0]==f.clear.r&&ke[1]==f.clear.g&&ke[2]==f.clear.b&&U.clearRect(W,ue,1,1)}n(`Processing ${v}...`),m.push({name:v,uri:E.toDataURL("image/png")})})))}),m},"extractSprites");var ps={defaults:{height:16,width:16,clear:{r:0,g:170,b:170}},files:{"SP257.PIC":{"cursor/go":[{y:33,x:33,height:12,width:12,contents:[{name:""}]}],"city/pollution":[{y:32,x:48,contents:[{name:""}]}],"improvements/irrigation":[{y:32,x:64,contents:[{name:""}]}],"improvements/mine":[{y:32,x:80,contents:[{name:""}]}],"improvements/pollution":[{y:32,x:96,contents:[{name:""}]}],"cursor/torch":[{y:33,x:113,height:13,width:13,contents:[{name:""}]}],"city/food":[{y:33,x:129,height:7,width:7,contents:[{name:""}]}],"city/production":[{y:33,x:137,height:7,width:7,contents:[{name:""}]}],"city/trade":[{y:33,x:145,height:7,width:7,contents:[{name:""}]}],"city/gold":[{y:33,x:153,height:7,width:7,contents:[{name:""}]}],"city/bulb":[{y:41,x:129,height:7,width:7,contents:[{name:""}]}],"city/sad":[{y:41,x:137,height:7,width:7,contents:[{name:""}]}],"city/luxury":[{y:41,x:145,height:7,width:7,contents:[{name:""}]}],"terrain/":[{y:41,x:153,height:7,width:7,contents:[{name:"shield"}]}],"improvements/road":[{y:48,contents:[{name:"_n",x:0},{name:"_ne",x:16},{name:"_e",x:32},{name:"_se",x:48},{name:"_s",x:64},{name:"_sw",x:80},{name:"_w",x:96},{name:"_nw",x:112}]}],"status/science":[{y:48,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"status/pollution":[{y:56,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"terrain/land":[{y:64,contents:[{name:"",x:0}]}],"terrain/river":[{y:64,contents:[{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:224},{name:"_nesw",x:240}]}],"units/combat":[{y:97,height:15,width:15,contents:[{name:"_1",x:1},{name:"_2",x:17},{name:"_3",x:33},{name:"_4",x:49},{name:"_5",x:65},{name:"_6",x:81},{name:"_7",x:97},{name:"_8",x:113}]}],"improvements/railroad":[{y:96,contents:[{name:"_n",x:128},{name:"_ne",x:144},{name:"_e",x:160},{name:"_se",x:176},{name:"_s",x:192},{name:"_sw",x:208},{name:"_w",x:224},{name:"_nw",x:240}]}],"terrain/oasis":[{y:113,height:15,width:15,contents:[{name:"",x:1}]}],"terrain/horse":[{y:113,height:15,width:15,contents:[{name:"",x:17}]}],"terrain/doe":[{y:113,height:15,width:15,contents:[{name:"",x:49}]}],"terrain/coal":[{y:113,height:15,width:15,contents:[{name:"",x:65}]}],"terrain/gold":[{y:113,height:15,width:15,contents:[{name:"",x:81}]}],"terrain/game":[{y:113,height:15,width:15,contents:[{name:"",x:97}]}],"terrain/seal":[{y:113,height:15,width:15,contents:[{name:"",x:113}]}],"terrain/oil":[{y:113,height:15,width:15,contents:[{name:"",x:129}]}],"terrain/gems":[{y:113,height:15,width:15,contents:[{name:"",x:145}]}],"terrain/fish":[{y:113,width:15,height:15,contents:[{name:"",x:161}]}],"map/city":[{y:113,contents:[{name:"",x:193}]}],"map/fortify":[{width:15,height:15,y:113,contents:[{name:"",x:209}]}],"map/fort":[{width:15,height:15,y:113,contents:[{name:"",x:225}]}],"map/hut":[{y:113,height:15,width:15,contents:[{name:"",x:241}]}],"city/people":[{y:128,height:16,width:8,contents:[{name:"_happy_m",x:0},{name:"_happy_f",x:8},{name:"_content_m",x:16},{name:"_content_f",x:24},{name:"_unhappy_m",x:32},{name:"_unhappy_f",x:40},{name:"_tax",x:48},{name:"_science",x:56},{name:"_luxury",x:64}]}],"map/fog":[{y:128,contents:[{name:"_n",x:80},{name:"_e",x:96},{name:"_s",x:112},{name:"_w",x:128}]}],"units/":[{y:161,height:15,width:15,contents:[{name:"settlers",x:1},{name:"warrior",x:17},{name:"spearman",x:33},{name:"swordman",x:49},{name:"musketman",x:65},{name:"rifleman",x:81},{name:"horseman",x:97},{name:"knight",x:113},{name:"catapult",x:129},{name:"cannon",x:145},{name:"chariot",x:161},{name:"tank",x:177},{name:"mechanizedinfantry",x:193},{name:"artillery",x:209},{name:"fighter",x:225},{name:"bomber",x:241},{name:"trireme",x:257},{name:"sail",x:273},{name:"frigate",x:289},{name:"ironclad",x:305}]},{y:177,contents:[{name:"cruiser",x:1},{name:"battleship",x:17},{name:"submarine",x:33},{name:"carrier",x:49},{name:"transport",x:65},{name:"nuclear",x:81},{name:"diplomat",x:97},{name:"caravan",x:113}]}],"general/texture":[{y:176,contents:[{name:"_1",x:288},{name:"_2",x:304}]}]},"TER257.PIC":{"terrain/desert":[{y:0,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/plains":[{y:16,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/grassland":[{y:32,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/forest":[{y:48,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/hills":[{y:64,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/mountains":[{y:80,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/tundra":[{y:96,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/arctic":[{y:112,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/swamp":[{y:128,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/jungle":[{y:144,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/ocean":[{y:160,contents:[{name:"",x:0}]}],"terrain/coast_sprite":[{x:0,y:176,height:16,width:128,contents:[{name:""}]}],"terrain/river":[{y:160,contents:[{name:"",x:240}]},{y:176,contents:[{name:"_mouth_n",x:128},{name:"_mouth_e",x:144},{name:"_mouth_s",x:160},{name:"_mouth_w",x:176}]}]}}};var cs=w(b());var Et,B,On=class extends N{constructor(){let e=(0,cs.s)('<input type="file" multiple>'),s=(0,cs.s)('<p class="loading" hidden></p>');super("Import assets",(0,cs.s)(`<div class="import-assets"><p>Upload ${Object.keys(ps.files).join(", ")} from the original Civilization files to extract assets (these will be stored locally). This process can take at least a few minutes.</p><div class="brave" ${navigator!=null&&navigator.brave?"":" hidden"}><p>It looks like you're using Brave and due to the use of <code>HTMLCanvasElement</code>'s <code>getImageData</code> and <code>toDataURL</code> functions, please put Shields down while importing, and playing, otherwise any colour-replaced icons won't look correct. <strong>Remember to put them back up after!</strong></p><p><a href="https://brave.com/privacy-updates/4-fingerprinting-defenses-2.0/#2-fingerprinting-protections-20-farbling-for-great-good" target="_blank">Read more about "farbling".</a></p></div></div>`,(0,cs.s)("<p></p>",_(e,{change:n=>this.handleFileUpload(n)})),s));c(this,Et,void 0);c(this,B,void 0);u(this,Et,e),u(this,B,s)}async handleFileUpload(e){var d;r(this,B).removeAttribute("hidden"),r(this,B).style.color="inherit";let s=Array.from((d=e.target.files)!=null?d:[]),n=s.map(p=>p.name),a=Object.keys(ps.files);if(!a.map(p=>new RegExp(p,"i")).every(p=>n.some(h=>h.match(p)))){r(this,B).style.color="#f00",r(this,B).innerText=`Please provide all files to generate assets: ${a.join(", ")}.`;return}r(this,Et).setAttribute("disabled",""),r(this,B).innerText="Building image assets...";let m=[];if(await Promise.all(s.map(async p=>new Promise(h=>{let g=ps.files[p.name.toUpperCase()];if(!g){console.warn(`No definitions found for ${p.name}, skipping.`);return}let f=new FileReader;f.addEventListener("load",async v=>{br(v.target.result,g,ps.defaults,(E,U)=>{let W=document.createElement("canvas");return W.width=E,W.height=U,W},E=>{r(this,B).innerText=E}).forEach(E=>m.push(E)),h()}),f.readAsBinaryString(p)}))),r(this,B).innerText="Writing to database...",await Promise.all(m.map(p=>M.set(p))),!await M.hasAllAssets()){console.error("Something went wrong..."),r(this,B).style.color="#f00",r(this,B).innerText="Not all expected data was written. Might need to try again... Missing: "+(await M.missingAssets()).join(", "),r(this,Et).removeAttribute("disabled");return}r(this,B).innerText="Done! Please reload the page to utilise the fresh assets.",location.reload()}};l(On,"ImportAssetsWindow"),Et=new WeakMap,B=new WeakMap;var _r=On;var Er="0.1.0@a999e22";var Pe,zn=class extends ae.Element{constructor(e,s){super(e);c(this,Pe,void 0);u(this,Pe,s),this.build(),this.addClass("active")}async build(e=!1){let s=await M.hasAllAssets();s||(console.log("Missing assets:"),console.log(await M.missingAssets())),this.append(_((0,ae.s)("<nav></nav>",_((0,ae.s)(`<button autofocus${s?"":" hidden"}>Start a New Game</button>`),{click:()=>{new hr(r(this,Pe),()=>this.remove())}}),_((0,ae.s)(`<button${s?"":" hidden"}>Earth</button>`),{click:()=>new gr(r(this,Pe),()=>this.remove())}),_((0,ae.s)(`<button${s?"":" hidden"}>Customise World</button>`),{click:async()=>new cr(r(this,Pe),()=>this.remove())}),_((0,ae.s)("<button>Import Assets</button>"),{click:()=>new _r}),_((0,ae.s)(`<button${e?"":" hidden"}>Quit</button>`),{click:()=>{this.remove(),r(this,Pe).send("quit")}})),{keydown(n){let a=document.activeElement,o=fe(n);a===null||!a.matches("#mainmenu nav button")||(o==="ArrowDown"&&a.nextElementSibling&&a.nextElementSibling.focus(),o==="ArrowUp"&&a.previousElementSibling&&a.previousElementSibling.focus())}}),(0,ae.s)(`<footer>version: ${Er}</footer>`))}remove(){this.removeClass("active"),setTimeout(()=>super.remove(),2e3)}};l(zn,"MainMenu"),Pe=new WeakMap;var Tr=zn;var Cr=w(b());var V,J,qe,Tt,oe,Wn=class{constructor(t,e,s,...n){c(this,V,void 0);c(this,J,void 0);c(this,qe,void 0);c(this,Tt,void 0);c(this,oe,void 0);u(this,J,t),u(this,oe,e),u(this,Tt,s),u(this,qe,n),u(this,V,r(this,J).getContext("2d")),(0,Cr.on)(r(this,J),"click",a=>{let o=a.offsetX-r(this,J).offsetLeft,m=a.offsetY-r(this,J).offsetTop,d=Math.ceil(o/r(this,J).offsetWidth*r(this,oe).width()),p=Math.ceil(m/r(this,J).offsetHeight*r(this,oe).height());r(this,Tt).setCenter(d,p),this.update()})}update(){let t=r(this,qe)[0].canvas().height*(190/r(this,qe)[0].canvas().width);r(this,J).height=t,r(this,V).clearRect(0,0,190,t),r(this,qe).forEach(n=>r(this,V).drawImage(n.canvas(),0,0,190,t));let[e,s]=r(this,Tt).rawVisibleRange();r(this,V).lineWidth=1,r(this,V).strokeStyle="#fff",r(this,V).fillStyle="rgba(255, 255, 255, .2)",r(this,V).rect(Math.floor(190/r(this,oe).width()*e.x),Math.floor(t/r(this,oe).height()*e.y),Math.floor(190/r(this,oe).width()*(s.x-e.x)),Math.floor(t/r(this,oe).height()*(s.y-e.y))),r(this,V).stroke(),r(this,V).fill()}};l(Wn,"Minimap"),V=new WeakMap,J=new WeakMap,qe=new WeakMap,Tt=new WeakMap,oe=new WeakMap;var Mr=Wn;var us,Ct,jn=class{constructor(t=document.body){c(this,us,void 0);c(this,Ct,[]);u(this,us,t)}receive(t){r(this,Ct).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!r(this,Ct).length||t)return;let e=r(this,Ct).shift();this.publish(e)}publish(t){var s;new Ss((s=t.title)!=null?s:"Notification",t.message,{parent:r(this,us)}).on("close",()=>this.check())}};l(jn,"Notifications"),us=new WeakMap,Ct=new WeakMap;var Lr=jn;var Mt=w(b());var hs,Nn=class extends Mt.Element{constructor(e,s){super(e);c(this,hs,void 0);u(this,hs,s)}build(){this.empty();let{civilization:e,treasury:s,research:n,cities:a}=r(this,hs),[o,m]=a.reduce(([p,h],g)=>{let[f,v]=Nt(g.yields,"Gold","Research");return[p+f,h+v]},[0,0]),d=Math.ceil((n.cost.value-n.progress.value)/m);this.append((0,Mt.s)(`<h3>${e.leader.name} of the ${e._} empire</h3>`),(0,Mt.s)(`<p><strong>Researching</strong><br/>${n.researching?`${n.researching._} ${n.progress.value} / ${n.cost.value} (${d} turn${d===1?"":"s"})`:"Nothing"}</p>`),(0,Mt.s)(`<p><strong>Treasury</strong><br/>${s.value} (${o} / turn}</p>`))}};l(Nn,"PlayerDetails"),hs=new WeakMap;var Ir=Nn;var Pr=l(i=>i.cities.reduce((t,e)=>t.concat(e.yields),[]),"combinedYields");var hi=w(b());var Aa=l(async(i,t)=>{let e=await M.getScaled(`./assets/${it.Research}`,2).then(s=>`<img src="${s.toDataURL("image/png")}">`);return(0,hi.s)(`<div><p><strong>Researching ${i.researching?i.researching._:"Nothing"}</strong>${i.researching?` ${Kt(i,t,"Research")}`:""}</p><p>${e} ${nt(t,"Research")} / turn</p><div class="discovered">${i.complete.map(s=>`<div>${s._}</div>`).join("")}</div></div>`)},"template"),Lt,Ye,Kn=class extends N{constructor(e){super("Player research",(0,hi.s)("<div></div>"));c(this,Lt,void 0);c(this,Ye,void 0);u(this,Ye,e),this.addClass("science-report"),this.update(),u(this,Lt,new _e([e.id,e.research.id,...e.cities.map(s=>s.id)],s=>{let n=s.player;r(this,Lt).setIds([n.id,n.research.id,...n.cities.map(a=>a.id)]),u(this,Ye,n),this.update()}))}close(){return r(this,Lt).dispose(),super.close()}update(){Aa(r(this,Ye).research,Pr(r(this,Ye))).then(e=>super.update(e))}};l(Kn,"ScienceReport"),Lt=new WeakMap,Ye=new WeakMap;var Sr=Kn;var le=w(b());var D,Bn=class extends le.Element{constructor(e,s){super(e);c(this,D,void 0);u(this,D,s),this.build()}build(){var e,s;this.empty(),r(this,D)!==null&&this.append((0,le.s)(`<p>${r(this,D)._} (${r(this,D).tile.x}, ${r(this,D).tile.y})</p>`),(0,le.s)(`<p>${(s=(e=r(this,D).city)==null?void 0:e.name)!=null?s:"NONE"}</p>`),(0,le.s)(`<p>${Number.isInteger(r(this,D).moves.value)?r(this,D).moves.value:r(this,D).moves.value.toFixed(2)} / ${r(this,D).movement.value} moves</p>`),(0,le.s)(`<p>A: ${r(this,D).attack.value} / D: ${r(this,D).defence.value} / V: ${r(this,D).visibility.value}</p>`),(0,le.s)(`<p>${r(this,D).improvements.map(n=>n._).join(", ")}</p>`),(0,le.s)(`<p>${r(this,D).tile.terrain._}${r(this,D).tile.terrain.features?" "+r(this,D).tile.terrain.features.map(n=>n._).join(", "):""}${r(this,D).tile.improvements.length?" ("+r(this,D).tile.improvements.map(n=>n._).join(", ")+")":""}</p>`),(0,le.s)(`<p>${r(this,D).tile.units.filter(n=>n!==r(this,D)).map(n=>n._).join(", ")}</p>`))}};l(Bn,"UnitDetails"),D=new WeakMap;var Dr=Bn;var Se,Fn=class{constructor(t){c(this,Se,void 0);u(this,Se,t)}init(){let t=r(this,Se);M.hasAllAssets().then(s=>{!s||M.getScaled("./assets/cursor/torch.png",2).then(n=>document.body.style.cursor=`url('${n.toDataURL("image/png")}'), default`)}),(0,Ve.on)(document,"keypress",s=>{if(s.key==="F5"||["R","r"].includes(s.key)&&s.ctrlKey){s.preventDefault(),new Os("Quit","Are you sure you want to reload?",()=>window.location.reload());return}});let e={autoEndOfTurn:!0};try{let s=document.getElementById("notification"),n=document.querySelector("#mainmenu"),a=document.getElementById("actions"),o=document.getElementById("other-actions"),m=document.getElementById("game"),d=document.getElementById("map"),p=d.querySelector("canvas"),h=document.getElementById("gameDetails"),g=document.getElementById("playerDetails"),f=document.getElementById("minimap"),v=document.getElementById("unitInfo"),E=document.getElementById("preload"),U=new Lr,W=new Tr(n,r(this,Se)),ue=l((C,j,Q,He)=>{let Z=new Dr(v,C);if(X=C,Z.build(),Q.setActiveUnit(C),Q.render(),Q.setVisible(!0),He.setActiveUnit(C),He.render(),He.setVisible(!0),C===null){j.render();return}F=C,Q.update([...F!=null&&F.tile?[F.tile]:[],C.tile]),j.isVisible(C.tile.x,C.tile.y)||j.setCenter(C.tile.x,C.tile.y),j.render()},"setActiveUnit");M.getAll().then(C=>C.forEach(j=>E.append(_((0,Ve.s)(`<img src="${j.uri}" data-path="${j.name}">`),{error:()=>console.error(`There was a problem preloading '${j.name}', you may have some missing details.`)}))));let ke=[],gs,F=null,X=null;t.receive("notification",C=>{s.innerHTML=C,gs&&window.clearTimeout(gs),gs=window.setTimeout(()=>{gs=void 0,s.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([C,j])=>t.receive(C,Q=>{let{choices:He}=vs(Q);new ve(j,He.map(({_:Z})=>({label:Z,value:Z})),Z=>t.send(C,Z),j,{displayAll:!0})}));let H;t.receiveOnce("gameData",C=>{try{let j=new Intl.ListFormat;H=vs(C),new Ss("Welcome",(0,Ve.s)(`<div class="welcome">
<p>${H.player.civilization.leader.name}, you have risen to become leader of the ${H.player.civilization._}.</p>
<p>Your people have knowledge of ${j.format(["Irrigation","Mining","Roads",...H.player.research.complete.map(y=>y._)])}.</p>
</div>`)),m.classList.add("active"),p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight;let Q=[],He=2,Z=new ln(H.player.world),Rr=new dr,I=new or(Z,t,p,{playerId:H.player.id,scale:He,tileSize:16},Vt,Ys,Zs,Gs,Ns,lr,Bs,pt,ns,qt,ui,ci),$r=I.getLayer(Vt),Yn=I.getLayer(pt),It=I.getLayer(ns),Vn=I.getLayer(qt),gi=I.getLayer(ui),Xe=I.getLayer(ci),Xn=new Mr(f,Z,I,$r,Vn,Xe),fi=new pi(a,I,r(this,Se)),Ur=new pi(o,I,r(this,Se));Yn.setVisible(!1),I.on("focus-changed",()=>Xn.update()),I.on("activate-unit",y=>ue(y,I,It,Xe)),Rr.on(()=>{Xe.setVisible(!Xe.isVisible()),I.build(ke.splice(0)),I.render()}),(0,Ve.on)(window,"resize",()=>{p.width=p.parentElement.offsetWidth,p.height=p.parentElement.offsetHeight});let Qn=l(y=>{H=vs(y),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:H}})),fi.build(H.player.mandatoryActions),Ur.build(H.player.actions.filter(S=>["AdjustTradeRates","Revolution"].includes(S._))),m.append(fi.element()),Z.setTiles(H.player.world.tiles),new rr(h,H.turn,H.year).build(),new Ir(g,H.player).build(),Q=H.player.actions.filter(S=>S._==="ActiveUnit");let[k]=Q.sort(({value:S},{value:R})=>R===F?1:S===F?-1:(I.isVisible(R.tile.x,R.tile.y)?1:0)-(I.isVisible(S.tile.x,S.tile.y)?1:0));if(F!==(k==null?void 0:k.value)&&(F=null),ue(F!=null&&F.active?F:k?k.value:null,I,It,Xe),I.build(ke.splice(0)),I.render(),Xn.update(),e.autoEndOfTurn&&H.player.mandatoryActions.length===1&&H.player.mandatoryActions.every(S=>S._==="EndTurn")){t.send("action",{name:"EndTurn"});return}},"handler");Qn(C),t.receive("gameData",y=>Qn(y));let Or=l(y=>y.replace(/]/g,"").split(/[.[]/),"pathToParts"),xi=l((y,P)=>{let T=Or(P),k=T.pop();return[T.reduce((R,fs)=>!R||!(fs in R)?null:R[fs],y),k]},"getPenultimateObject"),zr=l((y,P,T)=>{let[k,S]=xi(y,P);if(!k||!S){console.warn(`unable to set ${P} of ${y} (${S})`);return}k[S]=T},"setObjectPath"),Wr=l((y,P)=>{let[T,k]=xi(y,P);if(!T||!k){console.warn(`unable to set ${P} of ${y} (${k})`);return}delete T[k]},"removeObjectPath");t.receive("gameDataPatch",y=>{y.forEach(P=>Object.entries(P).forEach(([T,{type:k,index:S,value:R}])=>{if(k==="add"||k==="update"){if(!R.hierarchy){console.error("No hierarchy"),console.error(R);return}S?zr(C.objects[T],S,R.hierarchy):C.objects[T]=R.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:R}})),Object.entries(R.objects).forEach(([fs,Jn])=>{C.objects[fs]=Jn,Jn._==="PlayerTile"&&ke.push(Jn)})}if(k==="remove"){if(S){Wr(C.objects[T],S);return}delete C.objects[T]}})),Qn(C)}),t.receive("gameNotification",y=>U.receive(y));let vi={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},yi={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},wi={F1:()=>new ir(H.player,I,t),F4:()=>new mr(H.player),F6:()=>new Sr(H.player)},bi="";(0,Ve.on)(document,"keydown",y=>{let P=fe(y);if(P in wi&&(wi[y.key](),y.preventDefault()),X){if(P in vi){let T=[...vi[P]];for(;T.length;){let k=T.shift(),[S]=X.actions.filter(R=>R._===k);if(S){t.send("action",{name:"ActiveUnit",id:X.id,unitAction:S._,target:S.to.id}),y.stopPropagation(),y.preventDefault();return}}}if(P in yi){let[T]=X.actionsForNeighbours[yi[P]];if(T){t.send("action",{name:"ActiveUnit",id:X.id,unitAction:T._,target:T.to.id}),y.stopPropagation(),y.preventDefault();return}}}if(P==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(P==="Enter"&&H.player.mandatoryActions.some(T=>T._==="EndOfTurn")){t.send("action",{name:"EndTurn"}),y.stopPropagation(),y.preventDefault();return}if(P==="Tab"){let T=a.querySelector("div.action:first-child button");if(T!==null){T.focus(),y.preventDefault(),y.stopPropagation();return}}if(P==="c"&&X){I.setCenter(X.tile.x,X.tile.y),I.render(),Xn.update();return}if(P==="w"&&X&&Q.length>1){let T=Q.map(R=>R.value),k=T.indexOf(X),S=T[k===T.length-1?0:k+1];ue(S,I,It,Xe)}if(P==="t"){It.setVisible(!It.isVisible()),Vn.setVisible(!Vn.isVisible()),gi.setVisible(!gi.isVisible()),I.render();return}if(P==="y"){Yn.setVisible(!Yn.isVisible()),I.render();return}if(bi==="%"&&P==="^"){t.send("cheat",{name:"RevealMap"});return}bi=P})}catch(j){console.error(j)}})}catch(s){console.error(s)}}};l(Fn,"Renderer"),Se=new WeakMap;var kr=Fn;var Gn=class{async request(t){return new Promise(e=>{this.send(t.channel(),...t.args()),this.receiveOnce(t.channel(),s=>e(s))})}};l(Gn,"AbstractTransport");var Hr=Gn;var De,qn=class extends Hr{constructor(e){super();c(this,De,void 0);u(this,De,e)}receive(e,s){r(this,De).addEventListener("message",({data:{channel:n,data:a}})=>{n===e&&s(a)})}receiveOnce(e,s){let n=l(({data:{channel:a,data:o}})=>{a===e&&(s(o),r(this,De).removeEventListener("message",n))},"onceHandler");r(this,De).addEventListener("message",n)}send(e,s){r(this,De).postMessage({channel:e,data:s})}};l(qn,"WorkerTransport"),De=new WeakMap;var Ar=qn;var Ra=new kr(new Ar(new Worker("dist/backend.js")));Ra.init();})();
//# sourceMappingURL=frontend.js.map
