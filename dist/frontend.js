"use strict";(()=>{var pr=Object.create;var In=Object.defineProperty;var dr=Object.getOwnPropertyDescriptor;var cr=Object.getOwnPropertyNames;var ur=Object.getPrototypeOf,hr=Object.prototype.hasOwnProperty;var l=(i,t)=>In(i,"name",{value:t,configurable:!0});var Yn=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var gr=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of cr(t))!hr.call(i,n)&&n!==e&&In(i,n,{get:()=>t[n],enumerable:!(s=dr(t,n))||s.enumerable});return i};var E=(i,t,e)=>(e=i!=null?pr(ur(i)):{},gr(t||!i||!i.__esModule?In(e,"default",{value:i,enumerable:!0}):e,i));var Xn=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var r=(i,t,e)=>(Xn(i,t,"read from private field"),e?e.call(i):t.get(i)),c=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},u=(i,t,e,s)=>(Xn(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var T=Yn(x=>{"use strict";var Yt,fr=x&&x.__classPrivateFieldSet||function(i,t,e,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?i!==t||!n:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(i,e):n?n.value=e:t.set(i,e),e},xr=x&&x.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(x,"__esModule",{value:!0}),x.Element=x.toggleClass=x.t=x.s=x.removeClass=x.once=x.onEach=x.on=x.off=x.hasClass=x.empty=x.emitCustom=x.emit=x.addClass=void 0;x.addClass=(i,...t)=>i.classList.add(...t);x.emit=(i,t)=>i.dispatchEvent(t);x.emitCustom=(i,t,...e)=>(0,x.emit)(i,new CustomEvent(t,{detail:e}));x.empty=i=>{for(var t;i.hasChildNodes();)(t=i.firstChild)===null||t===void 0||t.remove()};x.hasClass=(i,t)=>i.classList.contains(t);x.off=(i,t,e,s={})=>i.removeEventListener(t,e,s);x.on=(i,t,e,s={})=>i.addEventListener(t,e,s);x.onEach=(i,t,e,s={})=>t.forEach(n=>(0,x.on)(i,n,e,s));x.once=(i,t,e,s={})=>(0,x.on)(i,t,e,Object.assign(Object.assign({},typeof s=="boolean"?{capture:s}:s),{once:!0}));x.removeClass=(i,...t)=>i.classList.remove(...t);x.s=(i,...t)=>{let e=document.createElement("div");e.innerHTML=i;let s=e.firstElementChild;return t.forEach(n=>{n instanceof ae?s.append(n.element()):n instanceof Node?s.append(n):s.append((0,x.t)(n))}),s};x.t=i=>document.createTextNode(i);x.toggleClass=(i,...t)=>t.forEach(e=>i.classList.toggle(e));var ae=class{constructor(t){Yt.set(this,void 0),fr(this,Yt,t,"f")}static fromString(t){return new ae((0,x.s)(t))}addClass(...t){(0,x.addClass)(this.element(),...t)}append(...t){t.forEach(e=>{e instanceof ae&&(e=e.element()),this.element().append(e)})}element(){return xr(this,Yt,"f")}emit(t){return(0,x.emit)(this.element(),t)}emitCustom(t,...e){return(0,x.emitCustom)(this.element(),t,...e)}empty(){(0,x.empty)(this.element())}hasClass(t){return(0,x.hasClass)(this.element(),t)}off(t,e,s={}){(0,x.off)(this.element(),t,e,s)}on(t,e,s={}){(0,x.on)(this.element(),t,e,s)}onEach(t,e,s={}){(0,x.onEach)(this.element(),t,e,s)}once(t,e,s={}){(0,x.once)(this.element(),t,e,s)}query(t){return this.element().querySelector(t)}queryAll(t){return this.element().querySelectorAll(t)}remove(){this.element().remove()}removeClass(...t){(0,x.removeClass)(this.element(),...t)}toggleClass(...t){(0,x.toggleClass)(this.element(),...t)}};l(ae,"o");x.Element=ae,Yt=new WeakMap,x.default=ae});var vi=Yn(He=>{"use strict";var se,_e=He&&He.__classPrivateFieldGet||function(i,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?i!==t||!s:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(i):s?s.value:t.get(i)};Object.defineProperty(He,"__esModule",{value:!0}),He.EventEmitter=void 0;var Dt=class{constructor(){se.set(this,{})}on(t,e){t in _e(this,se,"f")||(_e(this,se,"f")[t]=[]),_e(this,se,"f")[t].push(e)}once(t,e){let s=l((...n)=>{e(...n),this.off(t,s)},"i");this.on(t,s)}off(t,e){if(!(t in _e(this,se,"f")))return;let s=_e(this,se,"f")[t].indexOf(e);s!==-1&&_e(this,se,"f")[t].splice(s,1)}emit(t,...e){t in _e(this,se,"f")&&_e(this,se,"f")[t].forEach(s=>s(...e))}};l(Dt,"i");He.EventEmitter=Dt,se=new WeakMap,He.default=Dt});var _=l((i,t)=>(Object.entries(t).forEach(([e,s])=>i.addEventListener(e,s)),i),"h");var Kt=l(({hierarchy:i,objects:t},e=null)=>{let s=new Map;e&&Object.keys(t).forEach(a=>e.push(a));let n=l(a=>{if(s.has(a))return s.get(a);if(Array.isArray(a)){let o=[];return s.set(a,o),a.forEach(m=>o.push(n(m))),o}if(a&&a["#ref"]){if(e&&e.splice(e.indexOf(a["#ref"]),1),!(a["#ref"]in t))throw new TypeError(`missing ${a["#ref"]}`);let o=n(t[a["#ref"]]);return s.set(a,o),o}if(a instanceof Object){let o={};return s.set(a,o),Object.entries(a).forEach(([m,p])=>{o[m]=n(p)}),o}return a},"getReferences");return n(i)},"reconstituteData");var qs=E(T());var Qt=E(T());var ut,ht,Xt=class extends Qt.Element{constructor(e,s){super((0,Qt.s)('<div class="action"></div>'));c(this,ut,void 0);c(this,ht,void 0);u(this,ut,e),u(this,ht,s),this.on("keydown",n=>{n.key!=="Escape"&&n.stopPropagation()}),this.build()}activate(){}build(){}complete(){this.emit(new CustomEvent("actioned",{bubbles:!0,detail:this}))}transport(){return r(this,ht)}value(){return r(this,ut).value}};l(Xt,"Action"),ut=new WeakMap,ht=new WeakMap;var Q=Xt;var Zt=E(T());var wr=l((i,t)=>(0,Zt.s)(`<fieldset><legend>${i}</legend><input type="range" max="100" min="0" step="1" value="${t}"><input type="number"><label><input type="checkbox">Lock</label></fieldset>`),"template"),gt,B,J,Be,ft,Jt=class extends Zt.Element{constructor(e,s){super(wr(e,s));c(this,gt,void 0);c(this,B,void 0);c(this,J,void 0);c(this,Be,void 0);c(this,ft,[]);u(this,gt,e),u(this,B,this.element().querySelector('input[type="range"]')),u(this,J,this.element().querySelector('input[type="number"]')),u(this,Be,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(r(this,B).value),r(this,B).addEventListener("input",()=>this.set(r(this,B).value)),r(this,J).addEventListener("input",()=>this.set(r(this,J).value)),r(this,Be).addEventListener("input",()=>this.lock()),this.lock()}label(){return r(this,gt)}lock(){if(this.isLocked()){r(this,B).setAttribute("disabled",""),r(this,J).setAttribute("disabled","");return}r(this,B).removeAttribute("disabled"),r(this,J).removeAttribute("disabled")}onInput(e){r(this,ft).push(e)}isLocked(){return r(this,Be).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),r(this,B).value!==e&&(r(this,B).value=e),r(this,J).value!==e&&(r(this,J).value=e),r(this,ft).forEach(s=>s())}value(){return parseInt(r(this,B).value,10)}};l(Jt,"LockedSlider"),gt=new WeakMap,B=new WeakMap,J=new WeakMap,Be=new WeakMap,ft=new WeakMap;var Qn=Jt;var he,es=class{constructor(...t){c(this,he,void 0);u(this,he,t),r(this,he).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let s=r(this,he).filter(a=>a!==e),n=s.filter(a=>!a.isLocked());if(this.total()!==100&&n.length===0){e.set((100-this.total(s)).toString());return}if(this.total()>100){let a=this.total()-100,o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()-Math.min(o,a)).toString()),a-=o}),this.total()>100&&e.set((100-this.total(s)).toString())}if(this.total()<100){let a=100-this.total(),o=Math.ceil(a/n.length);n.forEach(m=>{m.set((m.value()+Math.min(o,a)).toString()),a-=o}),this.total()<100&&e.set((100-this.total(s)).toString())}}))}sliders(){return r(this,he)}total(t=r(this,he)){return t.reduce((e,s)=>e+s.value(),0)}};l(es,"LockedSliderGroup"),he=new WeakMap;var Jn=es;var ts=E(T());var Fe,xt=class extends ts.Element{constructor(e,s=(0,ts.s)("<div></div>")){super(s);c(this,Fe,void 0);this.on("keydown",n=>{n.stopPropagation()}),this.element().setAttribute("tabindex","0"),u(this,Fe,e)}build(){}display(){this.build(),r(this,Fe).append(this.element())}parent(){return r(this,Fe)}};l(xt,"TransientElement"),Fe=new WeakMap;var j=E(T());var Zn={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},ke,wt,qe=class extends xt{constructor(e,s,n={}){var a;super((a=n.parent)!=null?a:Zn.parent,(0,j.s)('<div class="window"></div>'));c(this,ke,void 0);c(this,wt,void 0);if(this.options={...Zn,...n},u(this,ke,s),u(this,wt,e),this.options.size==="auto"&&this.addClass("size-auto"),this.options.size==="maximised"&&this.addClass("maximised"),this.options.size!=="auto"&&["height","width"].forEach(o=>{let m=this.options.size[o];if(typeof m=="number"){this.element().style[o]=m+"px";return}this.element().style[o]=m}),this.options.position==="auto"&&this.addClass("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([o,m])=>{this.element().style[m]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[o]))+"px"}),this.options.autoDisplay){this.display();return}this.build()}build(){this.empty();let e=[[this.options.canMaximise,_((0,j.s)('<button class="maximise" aria-label="Maximise">Maximise</button>'),{click:()=>this.maximise()})],[this.options.canClose,_((0,j.s)('<button class="close" aria-label="Close">Maximise</button>'),{click:()=>this.close()})]].filter(([n])=>n).map(([,n])=>n),s=!1;this.append(_((0,j.s)(`<header><h3>${r(this,wt)}</h3></header>`,...e),{dblclick:()=>this.maximise(),mousedown:n=>{if(n.target.matches("button, button img"))return;s=!0;let a=l(o=>{!s||this.move({x:o.movementX,y:o.movementY})},"moveHandler");(0,j.on)(document,"mousemove",a),(0,j.on)(document,"mouseup",()=>{(0,j.off)(document,"mousemove",a),s=!1},{once:!0})}}),(0,j.s)('<div class="body"></div>',r(this,ke)instanceof Node?r(this,ke):(0,j.s)(`<p>${r(this,ke)}</p>`))),this.on("keydown",n=>{n.key==="Escape"&&this.options.canClose&&this.close(),n.stopPropagation()})}close(){this.remove(),this.emit(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||(this.element().classList.toggle("maximised"),this.emit(new CustomEvent("resize",{bubbles:!1})))}move({x:e,y:s}){if(this.hasClass("position-auto")){e+=this.element().offsetLeft,s+=this.element().offsetTop,this.removeClass("position-auto"),this.element().style.setProperty("top",s+"px"),this.element().style.setProperty("left",e+"px");return}let n=getComputedStyle(this.element()),a=parseInt(n.getPropertyValue("top"),10),o=parseInt(n.getPropertyValue("left"),10);this.element().style.setProperty("top",a+s+"px"),this.element().style.setProperty("left",o+e+"px")}update(e){this.element().lastElementChild.remove(),this.append(e instanceof Node?e:(0,j.s)(`<p>${e}</p>`))}};l(qe,"Window"),ke=new WeakMap,wt=new WeakMap;var ge=qe;var yr=l((i,t)=>t.some(e=>i instanceof e),"instanceOfAny"),ei,ti;function vr(){return ei||(ei=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}l(vr,"getIdbProxyableTypes");function br(){return ti||(ti=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}l(br,"getCursorAdvanceMethods");var si=new WeakMap,Ln=new WeakMap,ni=new WeakMap,Sn=new WeakMap,Dn=new WeakMap;function _r(i){let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("success",a),i.removeEventListener("error",o)},"unlisten"),a=l(()=>{e(Z(i.result)),n()},"success"),o=l(()=>{s(i.error),n()},"error");i.addEventListener("success",a),i.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&si.set(e,i)}).catch(()=>{}),Dn.set(t,i),t}l(_r,"promisifyRequest");function Er(i){if(Ln.has(i))return;let t=new Promise((e,s)=>{let n=l(()=>{i.removeEventListener("complete",a),i.removeEventListener("error",o),i.removeEventListener("abort",o)},"unlisten"),a=l(()=>{e(),n()},"complete"),o=l(()=>{s(i.error||new DOMException("AbortError","AbortError")),n()},"error");i.addEventListener("complete",a),i.addEventListener("error",o),i.addEventListener("abort",o)});Ln.set(i,t)}l(Er,"cacheDonePromiseForTransaction");var Pn={get(i,t,e){if(i instanceof IDBTransaction){if(t==="done")return Ln.get(i);if(t==="objectStoreNames")return i.objectStoreNames||ni.get(i);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Z(i[t])},set(i,t,e){return i[t]=e,!0},has(i,t){return i instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in i}};function ii(i){Pn=i(Pn)}l(ii,"replaceTraps");function Tr(i){return i===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){let s=i.call(ss(this),t,...e);return ni.set(s,t.sort?t.sort():[t]),Z(s)}:br().includes(i)?function(...t){return i.apply(ss(this),t),Z(si.get(this))}:function(...t){return Z(i.apply(ss(this),t))}}l(Tr,"wrapFunction");function Cr(i){return typeof i=="function"?Tr(i):(i instanceof IDBTransaction&&Er(i),yr(i,vr())?new Proxy(i,Pn):i)}l(Cr,"transformCachableValue");function Z(i){if(i instanceof IDBRequest)return _r(i);if(Sn.has(i))return Sn.get(i);let t=Cr(i);return t!==i&&(Sn.set(i,t),Dn.set(t,i)),t}l(Z,"wrap");var ss=l(i=>Dn.get(i),"unwrap");function ai(i,t,{blocked:e,upgrade:s,blocking:n,terminated:a}={}){let o=indexedDB.open(i,t),m=Z(o);return s&&o.addEventListener("upgradeneeded",p=>{s(Z(o.result),p.oldVersion,p.newVersion,Z(o.transaction),p)}),e&&o.addEventListener("blocked",p=>e(p.oldVersion,p.newVersion,p)),m.then(p=>{a&&p.addEventListener("close",()=>a()),n&&p.addEventListener("versionchange",d=>n(d.oldVersion,d.newVersion,d))}).catch(()=>{}),m}l(ai,"openDB");var Mr=["get","getKey","getAll","getAllKeys","count"],Ir=["put","add","delete","clear"],kn=new Map;function ri(i,t){if(!(i instanceof IDBDatabase&&!(t in i)&&typeof t=="string"))return;if(kn.get(t))return kn.get(t);let e=t.replace(/FromIndex$/,""),s=t!==e,n=Ir.includes(e);if(!(e in(s?IDBIndex:IDBObjectStore).prototype)||!(n||Mr.includes(e)))return;let a=l(async function(o,...m){let p=this.transaction(o,n?"readwrite":"readonly"),d=p.store;return s&&(d=d.index(m.shift())),(await Promise.all([d[e](...m),n&&p.done]))[0]},"method");return kn.set(t,a),a}l(ri,"getMethod");ii(i=>({...i,get:(t,e,s)=>ri(t,e)||i.get(t,e,s),has:(t,e)=>!!ri(t,e)||i.has(t,e)}));var oe,ee,yt=class{constructor(t,e,s){c(this,oe,void 0);c(this,ee,void 0);u(this,ee,e),u(this,oe,ai(t,1,{upgrade:n=>n.createObjectStore(r(this,ee),s)}))}async get(t){return(await r(this,oe)).get(r(this,ee),t)}async getAll(t,e){return(await r(this,oe)).getAll(r(this,ee),t,e)}async set(t,e){return(await r(this,oe)).put(r(this,ee),t,e)}async clear(){return(await r(this,oe)).clear(r(this,ee))}async keys(){return(await r(this,oe)).getAllKeys(r(this,ee))}};l(yt,"Store"),oe=new WeakMap,ee=new WeakMap;var Sr=l((i,t,e)=>{let s=document.createElement("canvas"),n=s.getContext("2d");return s.width=i.width*t,s.height=i.height*t,e!=null&&e.smoothing||(n.imageSmoothingEnabled=!1),n.drawImage(i,0,0,s.width,s.height),s},"scaleImage"),oi=Sr;var Ge,Ve,Ke,is,ns=class extends yt{constructor(){super("civ-clone-assets","assets",{keyPath:"name"});c(this,Ge,new Map);c(this,Ve,new Map);c(this,Ke,new Map);c(this,is,["./assets/city/bulb.png","./assets/city/food.png","./assets/city/gold.png","./assets/city/luxury.png","./assets/city/people_content_f.png","./assets/city/people_content_m.png","./assets/city/people_happy_f.png","./assets/city/people_happy_m.png","./assets/city/people_luxury.png","./assets/city/people_science.png","./assets/city/people_tax.png","./assets/city/people_unhappy_f.png","./assets/city/people_unhappy_m.png","./assets/city/pollution.png","./assets/city/sad.png","./assets/city/production.png","./assets/city/trade.png","./assets/cursor/go.png","./assets/cursor/torch.png","./assets/general/texture_1.png","./assets/general/texture_2.png","./assets/improvements/irrigation.png","./assets/improvements/mine.png","./assets/improvements/pollution.png","./assets/improvements/railroad_e.png","./assets/improvements/railroad_se.png","./assets/improvements/railroad_n.png","./assets/improvements/railroad_ne.png","./assets/improvements/railroad_nw.png","./assets/improvements/railroad_s.png","./assets/improvements/railroad_sw.png","./assets/improvements/railroad_w.png","./assets/improvements/road_e.png","./assets/improvements/road_n.png","./assets/improvements/road_ne.png","./assets/improvements/road_nw.png","./assets/improvements/road_s.png","./assets/improvements/road_se.png","./assets/improvements/road_sw.png","./assets/improvements/road_w.png","./assets/map/city.png","./assets/map/fog_e.png","./assets/map/fog_n.png","./assets/map/fog_s.png","./assets/map/fog_w.png","./assets/map/fort.png","./assets/map/fortify.png","./assets/map/hut.png","./assets/status/pollution_0.png","./assets/status/pollution_25.png","./assets/status/pollution_50.png","./assets/status/pollution_75.png","./assets/status/science_0.png","./assets/status/science_25.png","./assets/status/science_50.png","./assets/status/science_75.png","./assets/terrain/arctic.png","./assets/terrain/arctic_e.png","./assets/terrain/arctic_es.png","./assets/terrain/arctic_esw.png","./assets/terrain/arctic_ew.png","./assets/terrain/arctic_n.png","./assets/terrain/arctic_ne.png","./assets/terrain/arctic_nes.png","./assets/terrain/arctic_nesw.png","./assets/terrain/arctic_new.png","./assets/terrain/arctic_ns.png","./assets/terrain/arctic_nsw.png","./assets/terrain/arctic_nw.png","./assets/terrain/arctic_s.png","./assets/terrain/arctic_sw.png","./assets/terrain/arctic_w.png","./assets/terrain/coal.png","./assets/terrain/coast_sprite.png","./assets/terrain/desert.png","./assets/terrain/desert_e.png","./assets/terrain/desert_es.png","./assets/terrain/desert_esw.png","./assets/terrain/desert_ew.png","./assets/terrain/desert_n.png","./assets/terrain/desert_ne.png","./assets/terrain/desert_nes.png","./assets/terrain/desert_nesw.png","./assets/terrain/desert_new.png","./assets/terrain/desert_ns.png","./assets/terrain/desert_nsw.png","./assets/terrain/desert_nw.png","./assets/terrain/desert_s.png","./assets/terrain/desert_sw.png","./assets/terrain/desert_w.png","./assets/terrain/doe.png","./assets/terrain/fish.png","./assets/terrain/forest.png","./assets/terrain/forest_e.png","./assets/terrain/forest_es.png","./assets/terrain/forest_esw.png","./assets/terrain/forest_ew.png","./assets/terrain/forest_n.png","./assets/terrain/forest_ne.png","./assets/terrain/forest_nes.png","./assets/terrain/forest_nesw.png","./assets/terrain/forest_new.png","./assets/terrain/forest_ns.png","./assets/terrain/forest_nsw.png","./assets/terrain/forest_nw.png","./assets/terrain/forest_s.png","./assets/terrain/forest_sw.png","./assets/terrain/forest_w.png","./assets/terrain/gems.png","./assets/terrain/gold.png","./assets/terrain/grassland.png","./assets/terrain/grassland_e.png","./assets/terrain/grassland_es.png","./assets/terrain/grassland_esw.png","./assets/terrain/grassland_ew.png","./assets/terrain/grassland_n.png","./assets/terrain/grassland_ne.png","./assets/terrain/grassland_nes.png","./assets/terrain/grassland_nesw.png","./assets/terrain/grassland_new.png","./assets/terrain/grassland_ns.png","./assets/terrain/grassland_nsw.png","./assets/terrain/grassland_nw.png","./assets/terrain/grassland_s.png","./assets/terrain/grassland_sw.png","./assets/terrain/grassland_w.png","./assets/terrain/hills.png","./assets/terrain/hills_e.png","./assets/terrain/hills_es.png","./assets/terrain/hills_esw.png","./assets/terrain/hills_ew.png","./assets/terrain/hills_n.png","./assets/terrain/hills_ne.png","./assets/terrain/hills_nes.png","./assets/terrain/hills_nesw.png","./assets/terrain/hills_new.png","./assets/terrain/hills_ns.png","./assets/terrain/hills_nsw.png","./assets/terrain/hills_nw.png","./assets/terrain/hills_s.png","./assets/terrain/hills_sw.png","./assets/terrain/hills_w.png","./assets/terrain/horse.png","./assets/terrain/jungle.png","./assets/terrain/jungle_e.png","./assets/terrain/jungle_es.png","./assets/terrain/jungle_esw.png","./assets/terrain/jungle_ew.png","./assets/terrain/jungle_n.png","./assets/terrain/jungle_ne.png","./assets/terrain/jungle_nes.png","./assets/terrain/jungle_nesw.png","./assets/terrain/jungle_new.png","./assets/terrain/jungle_ns.png","./assets/terrain/jungle_nsw.png","./assets/terrain/jungle_nw.png","./assets/terrain/jungle_s.png","./assets/terrain/jungle_sw.png","./assets/terrain/jungle_w.png","./assets/terrain/land.png","./assets/terrain/mountains.png","./assets/terrain/mountains_e.png","./assets/terrain/mountains_es.png","./assets/terrain/mountains_esw.png","./assets/terrain/mountains_ew.png","./assets/terrain/mountains_n.png","./assets/terrain/mountains_ne.png","./assets/terrain/mountains_nes.png","./assets/terrain/mountains_nesw.png","./assets/terrain/mountains_new.png","./assets/terrain/mountains_ns.png","./assets/terrain/mountains_nsw.png","./assets/terrain/mountains_nw.png","./assets/terrain/mountains_s.png","./assets/terrain/mountains_sw.png","./assets/terrain/mountains_w.png","./assets/terrain/oasis.png","./assets/terrain/ocean.png","./assets/terrain/oil.png","./assets/terrain/plains.png","./assets/terrain/plains_e.png","./assets/terrain/plains_es.png","./assets/terrain/plains_esw.png","./assets/terrain/plains_ew.png","./assets/terrain/plains_n.png","./assets/terrain/plains_ne.png","./assets/terrain/plains_nes.png","./assets/terrain/plains_nesw.png","./assets/terrain/plains_new.png","./assets/terrain/plains_ns.png","./assets/terrain/plains_nsw.png","./assets/terrain/plains_nw.png","./assets/terrain/plains_s.png","./assets/terrain/plains_sw.png","./assets/terrain/plains_w.png","./assets/terrain/river_e.png","./assets/terrain/river_es.png","./assets/terrain/river_esw.png","./assets/terrain/river_ew.png","./assets/terrain/river_mouth_e.png","./assets/terrain/river_mouth_n.png","./assets/terrain/river_mouth_s.png","./assets/terrain/river_mouth_w.png","./assets/terrain/river.png","./assets/terrain/river_n.png","./assets/terrain/river_ne.png","./assets/terrain/river_nes.png","./assets/terrain/river_nesw.png","./assets/terrain/river_new.png","./assets/terrain/river_ns.png","./assets/terrain/river_nsw.png","./assets/terrain/river_nw.png","./assets/terrain/river_s.png","./assets/terrain/river_sw.png","./assets/terrain/river_w.png","./assets/terrain/seal.png","./assets/terrain/shield.png","./assets/terrain/game.png","./assets/terrain/swamp.png","./assets/terrain/swamp_e.png","./assets/terrain/swamp_es.png","./assets/terrain/swamp_esw.png","./assets/terrain/swamp_ew.png","./assets/terrain/swamp_n.png","./assets/terrain/swamp_ne.png","./assets/terrain/swamp_nes.png","./assets/terrain/swamp_nesw.png","./assets/terrain/swamp_new.png","./assets/terrain/swamp_ns.png","./assets/terrain/swamp_nsw.png","./assets/terrain/swamp_nw.png","./assets/terrain/swamp_s.png","./assets/terrain/swamp_sw.png","./assets/terrain/swamp_w.png","./assets/terrain/tundra.png","./assets/terrain/tundra_e.png","./assets/terrain/tundra_es.png","./assets/terrain/tundra_esw.png","./assets/terrain/tundra_ew.png","./assets/terrain/tundra_n.png","./assets/terrain/tundra_ne.png","./assets/terrain/tundra_nes.png","./assets/terrain/tundra_nesw.png","./assets/terrain/tundra_new.png","./assets/terrain/tundra_ns.png","./assets/terrain/tundra_nsw.png","./assets/terrain/tundra_nw.png","./assets/terrain/tundra_s.png","./assets/terrain/tundra_sw.png","./assets/terrain/tundra_w.png","./assets/units/tank.png","./assets/units/artillery.png","./assets/units/battleship.png","./assets/units/bomber.png","./assets/units/cannon.png","./assets/units/caravan.png","./assets/units/carrier.png","./assets/units/catapult.png","./assets/units/horseman.png","./assets/units/chariot.png","./assets/units/combat_1.png","./assets/units/combat_2.png","./assets/units/combat_3.png","./assets/units/combat_4.png","./assets/units/combat_5.png","./assets/units/combat_6.png","./assets/units/combat_7.png","./assets/units/combat_8.png","./assets/units/cruiser.png","./assets/units/diplomat.png","./assets/units/fighter.png","./assets/units/frigate.png","./assets/units/ironclad.png","./assets/units/knight.png","./assets/units/swordman.png","./assets/units/mechanizedinfantry.png","./assets/units/warrior.png","./assets/units/musketman.png","./assets/units/nuclear.png","./assets/units/spearman.png","./assets/units/rifleman.png","./assets/units/sail.png","./assets/units/settlers.png","./assets/units/submarine.png","./assets/units/transport.png","./assets/units/trireme.png"])}async get(e){return r(this,Ge).has(e)||r(this,Ge).set(e,await super.get(e)),r(this,Ge).get(e)}async getImage(e){if(!r(this,Ve).has(e)){let s=await this.get(e),n=document.createElement("img");n.src=s.uri,r(this,Ve).set(e,n)}return r(this,Ve).get(e)}async getScaled(e,s){return r(this,Ke).has(e)||r(this,Ke).set(e,oi(await this.getImage(e),s)),r(this,Ke).get(e)}async hasAllAssets(){return(await this.missingAssets()).length===0}async missingAssets(){let e=await this.keys();return r(this,is).filter(s=>!e.includes(s))}};l(ns,"AssetStore"),Ge=new WeakMap,Ve=new WeakMap,Ke=new WeakMap,is=new WeakMap;var S=new ns;var An=E(T());var vt,rs=class extends Q{constructor(){super(...arguments);c(this,vt,void 0)}activate(){let e=[];new ge("Adjust trade rates",(0,An.s)("<div></div>",...this.value().all.map(n=>{let a=new Qn(n._,n.value*100);return e.push(a),a}))).on("close",()=>{let n=r(this,vt).sliders().map(a=>[a.label(),parseFloat((a.value()/100).toFixed(2))]);console.info("AdjustTradeRates: ",n),this.transport().send("action",{name:"AdjustTradeRates",id:this.value().id,value:n})}),u(this,vt,new Jn(...e))}build(){S.get("./assets/city/trade.png").then(e=>this.append((0,An.s)(`<button class="adjustTradeRates" title="Adjust trade rates" style="background-image:url('${e.uri}')"></button>`)))}value(){return super.value()}};l(rs,"AdjustTradeRates"),vt=new WeakMap;var li=rs;var Hn=[],bt,as=class extends qe{constructor(e,s,n={}){let a={queue:!0,...n};super(e,s,a);c(this,bt,{});u(this,bt,a),this.addClass("notificationWindow"),this.on("keydown",o=>{o.key==="Enter"&&(this.close(),o.stopPropagation())})}close(){if(super.close(),r(this,bt).queue&&Hn.length&&as.hasOpenWindow()){let[e,s,n]=Hn.shift();e.display(s),n()}}display(e=!0){return new Promise(s=>{if(as.hasOpenWindow()){Hn.push([this,e,s]);return}if(super.display(),!e){s(void 0);return}this.element().focus(),s(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},fe=as;l(fe,"NotificationWindow"),bt=new WeakMap;var os=fe;var te=E(T());var _t,Et,xe=class extends fe{constructor(e,s,n,a="Please choose one of the following:",o={}){var d,h;o={autoFocus:!0,displayAll:!1,...o,actions:{primary:{label:"OK",action:g=>m(g.selectionList().value),...(h=(d=o.actions)==null?void 0:d.primary)!=null?h:{}},...o.actions}};let m=l(g=>{this.emit(new CustomEvent("selection",{detail:g})),this.close(),n(g)},"chooseHandler"),p=_((0,te.s)(`<select>${s.map(g=>`<option value="${g.value}">${g.label||g.value}</option>`).join("")}</select>`),{keydown:g=>{g.key==="Enter"&&m(p.value)},dblclick:()=>m(p.value)});o.displayAll&&s.length>1&&p.setAttribute("size",s.length.toString()),o.autoFocus&&s.length>1&&p.setAttribute("autofocus","");super(e,(0,te.s)("<div></div>",...a instanceof Node?[a]:a===null?[]:[(0,te.s)(`<p>${a}</p>`)],p,(0,te.s)("<footer></footer>",...Object.entries(o.actions).map(([,{label:g,action:f}])=>_((0,te.s)(`<button>${g}</button>`),{click:()=>f(this),keydown:y=>{y.key==="Enter"&&f(this)}})))),o);c(this,_t,l(()=>this.resize(),"#resizeHandler"));c(this,Et,void 0);this.addClass("selectionWindow"),u(this,Et,p),this.resize(),(0,te.on)(window,"resize",r(this,_t))}close(){(0,te.off)(window,"resize",r(this,_t)),super.close()}display(){return super.display(!1).then(()=>{let e=this.query("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,s;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-this.element().firstElementChild.offsetHeight-((s=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?s:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2.1em)`}catch(n){console.warn(n)}}selectionList(){return r(this,Et)}};l(xe,"SelectionWindow"),_t=new WeakMap,Et=new WeakMap;var we=xe;var mi=E(T());var ls=class extends Q{activate(){let t=new we("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){S.get("./assets/city/bulb.png").then(t=>this.append((0,mi.s)(`<button class="chooseResearch" title="Choose research" style="background-image:url('${t.uri}')">`)))}value(){return super.value()}};l(ls,"ChooseResearch");var pi=ls;var ms={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLaw:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},Rn=Object.entries(ms).reduce((i,[t,e])=>(Object.prototype.hasOwnProperty.call(i,e)||(i[e]=[]),Object.prototype.hasOwnProperty.call(i,t)||(i[t]=[]),i[e].push(t),i[t].push(t),i),{}),Tt=l((i,...t)=>i.yields.reduce((e,s,n)=>(t.forEach((a,o)=>{var m;(m=Rn[a])!=null&&m.includes(s._)&&(e[o]+=s.value)}),e),t.map(()=>0)),"reduceKnownYields"),Ct=l((i,t)=>Tt(i,t)[0],"reduceKnownYield"),di={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var ci=E(T());var ui,hi=l(i=>ui=i,"setPreloadContainer"),$n=l(i=>{let t=ui.querySelector(`[data-path$="${i}.png"]`);return t===null?(console.error(`Missing image: ${i}.`),(0,ci.s)("<canvas></canvas>")):t},"getPreloadedImage"),Un=$n;var gi=E(T());var Lr=l((i,t,e)=>{let s=(0,gi.s)("<canvas></canvas>"),n=s.getContext("2d");s.width=i.width,s.height=i.height,n.drawImage(i,0,0,i.width,i.height);let a=n.getImageData(0,0,s.width,s.height),o=l(d=>{var f;let h=null,g={r:0,g:0,b:0,a:0};return typeof d=="string"?(h=d.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?g={r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16),a:1}:(h=d.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?g={r:parseInt(h[1]+h[1],16),g:parseInt(h[2]+h[2],16),b:parseInt(h[3]+h[3],16),a:1}:(h=d.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:1}:(h=d.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:parseFloat((f=h[4])!=null?f:1)}):"length"in d&&(g={r:d[0]||0,g:d[1]||0,b:d[2]||0,a:d[3]||1}),g},"getColor"),m=t.map(o),p=e.map(o);for(let d=0;d<a.data.length;d+=4)m.forEach((h,g)=>{a.data[d]===h.r&&a.data[d+1]===h.g&&a.data[d+2]===h.b&&a.data[d+3]===h.a*255&&(a.data[d]=(p[g]||p[0]).r,a.data[d+1]=(p[g]||p[0]).g,a.data[d+2]=(p[g]||p[0]).b,a.data[d+3]=Math.trunc((p[g]||p[0]).a*255))});return n.putImageData(a,0,0),s},"replaceColours"),ps=Lr;var fi=E(T());var ye,Ae,Mt,ve,It,be,F=class{constructor(t,e=2,s=16,n=(0,fi.s)("<canvas></canvas>")){c(this,ye,void 0);c(this,Ae,void 0);c(this,Mt,!0);c(this,ve,void 0);c(this,It,void 0);c(this,be,void 0);u(this,ye,n),u(this,be,t),u(this,It,s),u(this,ve,e),this.setCanvasSize(),u(this,Ae,r(this,ye).getContext("2d")),hi(document.querySelector("#preload"))}canvas(){return r(this,ye)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return r(this,Ae)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}renderTile({x:t,y:e}){let s=this.tileSize(),n=t*s,a=e*s;this.context().clearRect(n,a,s,s)}scale(){return r(this,ve)}tileSize(){return r(this,It)*r(this,ve)}update(t){t.forEach(({x:e,y:s})=>this.renderTile(this.world().get(e,s)))}world(){return r(this,be)}drawImage(t,e,s,n={}){var d,h;let a=this.tileSize(),o=e*a,m=s*a,p=this.getPreloadedImage(t);this.putImage(n.augment?n.augment(p):p,o+((d=n.offsetX)!=null?d:0),m+((h=n.offsetY)!=null?h:0))}filterNeighbours(t,e,s=["n","e","s","w"]){return s.filter(n=>e(r(this,be).getNeighbour(t,n)))}getPreloadedImage(t){return $n(t)}putImage(t,e,s){r(this,Ae).imageSmoothingEnabled=!1,r(this,Ae).drawImage(t,e,s,t.width*r(this,ve),t.height*r(this,ve))}replaceColours(t,e,s){return ps(t,e,s)}setCanvasSize(){r(this,ye).height=r(this,be).height()*this.tileSize(),r(this,ye).width=r(this,be).width()*this.tileSize()}isVisible(){return r(this,Mt)}setVisible(t){u(this,Mt,t)}};l(F,"Map"),ye=new WeakMap,Ae=new WeakMap,Mt=new WeakMap,ve=new WeakMap,It=new WeakMap,be=new WeakMap;var xi=F;var ds=class extends F{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.city){let m=t.city,p=m.player,d=p.civilization,[h]=d.attributes.filter(g=>g.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(a,o,n,n)),this.context().fillStyle=h.value[0],this.context().fillRect(a+this.scale(),o+this.scale(),n-this.scale()*2,n-this.scale()*2),this.drawImage("map/city",e,s,{augment:g=>this.replaceColours(g,["#000"],[h.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}};l(ds,"Cities");var St=ds;var Lt=E(T());var cs=class extends fe{constructor(t,e,s,n={}){var o,m;let a=_((0,Lt.s)(`<button>${(o=n.okLabel)!=null?o:"OK"}</button>`),{click:()=>{s(),this.close()},keydown:p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),p.stopPropagation(),s(),this.close())}});super(t,(0,Lt.s)(`<div class="content"><p>${e}</p></div>`,(0,Lt.s)("<footer></footer>",a,_((0,Lt.s)(`<button>${(m=n.cancelLabel)!=null?m:"Cancel"}</button>`),{click:()=>this.close(),keydown:p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),p.stopPropagation(),this.close())}}))),{...n,queue:!1}),a.focus()}};l(cs,"ConfirmationWindow");var us=cs;var Ye,Xe,hs=class{constructor(t,e){c(this,Ye,void 0);c(this,Xe,[]);this.setIds(t),u(this,Ye,s=>{let{detail:n}=s,a=n.value.objects;!a||r(this,Xe).some(o=>o in a)&&document.addEventListener("dataupdated",o=>e(o.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",r(this,Ye))}dispose(){document.removeEventListener("patchdatareceived",r(this,Ye))}setIds(t){r(this,Xe).splice(0,r(this,Xe).length,...t)}};l(hs,"DataObserver"),Ye=new WeakMap,Xe=new WeakMap;var wi=hs;var gs=class extends F{update(t){let e=[...t];return t.forEach(s=>{["n","ne","e","se","s","sw","w","nw"].forEach(n=>{let a=this.world().getNeighbour(s,n);e.includes(a)||e.push(a)})}),super.update(e)}};l(gs,"TerrainAbstract");var W=gs;var fs=class extends W{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.terrain.features.length&&t.terrain.features.forEach(n=>n._==="Shield"?this.drawImage(`terrain/${n._.toLowerCase()}`,e,s,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${n._.toLowerCase()}`,e,s))}};l(fs,"Feature");var xs=fs;var ws=class extends W{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;this.filterNeighbours(t,n=>n.terrain._==="Unknown").forEach(n=>this.drawImage(`map/fog_${n}`,e,s))}};l(ws,"Fog");var ys=ws;var vs=class extends W{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=t.improvements.reduce((a,o)=>{let m=o._;return m in a&&(a[m]=!0),a},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(a=>{n[a]&&this.drawImage(`improvements/${a.toLowerCase()}`,e,s)}),n.Road){let a=this.filterNeighbours(t,m=>m.improvements.some(p=>p._==="Road"),["n","ne","e","se","s","sw","w","nw"]),o=this.filterNeighbours(t,m=>!!m.city||m.improvements.some(p=>p._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(a.forEach(m=>{(!n.Railroad||!o.includes(m))&&this.drawImage(`improvements/road_${m}`,e,s)}),n.Railroad&&o.forEach(m=>this.drawImage(`improvements/railroad_${m}`,e,s)),a.length===0&&o.length===0){let m=this.tileSize(),p=e*m,d=s*m,h=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=n.Railroad?"#000":"#8c5828",this.context().rect(p+h,d+h,this.scale()*2,this.scale()*2),this.context().fill()}}}};l(vs,"Terrain");var bs=vs;var _s=class extends W{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;!t.improvements.some(a=>a._==="Irrigation")||this.drawImage("improvements/irrigation",e,s)}};l(_s,"Terrain");var Es=_s;var yi=E(T());var Ts=class extends W{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,s);else if(t.isWater&&(this.drawImage("terrain/ocean",e,s),t.isCoast)){let m=this.getPreloadedImage("terrain/coast_sprite"),p=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(p>0){let d=p&7,h=p>>2&7,g=p>>4&7,f=p>>6&7|(p&1)<<2,y=(0,yi.s)('<canvas height="16" width="16"></canvas>'),H=y.getContext("2d");H.drawImage(m,d<<4,0,8,8,0,0,8,8),H.drawImage(m,(h<<4)+8,0,8,8,8,0,8,8),H.drawImage(m,(g<<4)+8,8,8,8,8,8,8,8),H.drawImage(m,f<<4,8,8,8,0,8,8,8),this.putImage(y,a,o)}this.filterNeighbours(t,d=>d.terrain._==="River").forEach(d=>this.drawImage(`terrain/river_mouth_${d}`,e,s))}}}};l(Ts,"Land");var Pt=Ts;var bi=E(vi()),_i=E(T());var Pr={playerId:null,scale:2,tileSize:16},$,O,Re,$e,kt,Qe,Je,At,D,Cs=class extends bi.EventEmitter{constructor(e,s,n=(0,_i.s)("<canvas></canvas>"),a={playerId:null,scale:2},...o){let m={...Pr,...a};super();c(this,$,void 0);c(this,O,{x:0,y:0});c(this,Re,void 0);c(this,$e,[]);c(this,kt,null);c(this,Qe,void 0);c(this,Je,void 0);c(this,At,void 0);c(this,D,void 0);u(this,D,e),u(this,$,n),u(this,kt,m.playerId),u(this,Je,m.tileSize),u(this,Qe,m.scale),u(this,At,s),o.forEach(p=>r(this,$e).push(new p(r(this,D),this.scale(),r(this,Je)))),u(this,Re,n.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){r(this,$e).forEach(s=>s.update(e))}canvas(){return r(this,$)}center(){return r(this,O)}getLayer(e){var s;return(s=this.getLayers(e).shift())!=null?s:null}getLayers(e){return r(this,$e).filter(s=>s instanceof e)}isVisible(e,s){let n=Math.floor(r(this,$).width/this.tileSize()),a=Math.floor(r(this,$).height/this.tileSize());if(n>=r(this,D).width()&&a>=r(this,D).height())return!0;let[o,m,p,d]=this.visibleBounds();return(n>=r(this,D).width()||(o>m?e<m||e>o:e<m&&e>o))&&(a>=r(this,D).height()||(p>d?s<d||s>p:s<d&&s>p))}playerId(){return r(this,kt)}render(){let e=this.tileSize(),s=r(this,D).width()*e,n=r(this,O).x*e+Math.trunc(e/this.scale()),a=Math.trunc(r(this,$).width/2),o=r(this,D).height()*e,m=r(this,O).y*e+Math.trunc(e/this.scale()),p=Math.trunc(r(this,$).height/2),d=a-n,h=a+s,g=p-m,f=p+o;for(;d>0;)d-=s;for(;g>0;)g-=o;for(;h<r(this,$).width;)h+=s;for(;f<r(this,$).height;)f+=o;r(this,Re).fillStyle="#000",r(this,Re).fillRect(0,0,Math.max(r(this,D).width()*e,r(this,$).width),Math.max(r(this,D).height()*e,r(this,$).height));for(let y=d;y<h;y+=s)for(let H=g;H<f;H+=o)r(this,$e).forEach(U=>{if(!U.isVisible())return;let G=U.canvas();r(this,Re).drawImage(G,y,H,G.width,G.height)})}scale(){return r(this,Qe)}setCenter(e,s){r(this,O).x=e,r(this,O).y=s,this.render(),this.emit("focus-changed",e,s)}tileSize(){return r(this,Je)*r(this,Qe)}transport(){return r(this,At)}visibleBounds(){let[{x:e,y:s},{x:n,y:a}]=this.visibleRange();return[e,n,s,a]}visibleRange(){let e=Math.floor(Math.floor(r(this,$).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,$).height/this.tileSize())/2);return[{x:(r(this,O).x-e+r(this,D).width())%r(this,D).width(),y:(r(this,O).y-s+r(this,D).height())%r(this,D).height()},{x:(r(this,O).x+e)%r(this,D).width(),y:(r(this,O).y+s)%r(this,D).height()}]}rawVisibleRange(){let e=Math.floor(Math.floor(r(this,$).width/this.tileSize())/2),s=Math.floor(Math.floor(r(this,$).height/this.tileSize())/2);return[{x:r(this,O).x-e,y:r(this,O).y-s},{x:r(this,O).x+e,y:r(this,O).y+s}]}world(){return r(this,D)}};l(Cs,"Portal"),$=new WeakMap,O=new WeakMap,Re=new WeakMap,$e=new WeakMap,kt=new WeakMap,Qe=new WeakMap,Je=new WeakMap,At=new WeakMap,D=new WeakMap;var Ms=Cs;var Is=class extends W{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t,n=this.filterNeighbours(t,a=>t.terrain._==="River"&&a.isWater||t.terrain._===a.terrain._).join("");t.terrain._!=="Ocean"&&(n?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${n}`,e,s):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,s))}};l(Is,"Terrain");var Ss=Is;var Ds=E(T());var Dr={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},kr=l((i,t=16)=>{var m,p;let e=i.player,s=e.civilization,[n]=s.attributes.filter(d=>d.name==="colors"),a=ps(Un(`units/${i._.toLowerCase()}`),["#60E064","#2C7800"],n.value),o=a.getContext("2d");if(o.imageSmoothingEnabled=!1,(m=i.improvements)!=null&&m.some(d=>d._==="Fortified")&&o.drawImage(Un("map/fortify"),0,0),i.busy){let d=t/2,h=t*.75,g=(p=Dr[i.busy._])!=null?p:i.busy._.replace(/[a-z]+/g,"");o.font="bold 8px sans-serif",o.fillStyle="black",o.textAlign="center",o.fillText(g,d,h),o.fillStyle="white",o.fillText(g,d,h)}return a},"renderUnit"),Ls=kr;var Ht,Ps=class extends Ds.Element{constructor(e,s=2){super((0,Ds.s)('<canvas width="32" height="32"></canvas>'));c(this,Ht,2);u(this,Ht,s),this.build(e)}build(e){let s=Ls(e),n=this.element().getContext("2d");n.imageSmoothingEnabled=!1;let a=this.size(s.width),o=this.size(s.height),m=Math.floor((this.size(16)-a)/2),p=Math.floor((this.size(16)-o)/2);n.drawImage(s,m,p,a,o)}element(){return super.element()}size(e=16){return e*r(this,Ht)}};l(Ps,"Unit"),Ht=new WeakMap;var On=Ps;var ks=class extends we{constructor(t,e,s=()=>{}){super("Activate unit",t.map(n=>{var a,o;return{label:n._+" ["+((o=(a=n.city)==null?void 0:a.name)!=null?o:"NONE")+"]"+(n.busy?` (${n.busy._})`:""),value:n.id}}),n=>{let[a]=t.filter(o=>o.id===n);if(!!a){if(!a.active){e.send("action",{name:"InactiveUnit",id:n});return}s(a)}},null)}};l(ks,"UnitSelectionWindow");var As=ks;var Rs,Ze,Ee,Te,Ce,Hs=class{constructor(t){c(this,Rs,l((t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}),"#unknown"));c(this,Ze,{});c(this,Ee,void 0);c(this,Te,void 0);c(this,Ce,void 0);u(this,Te,t.height),u(this,Ce,t.width),u(this,Ee,t.tiles||[])}get(t,e){for(;t<0;)t+=r(this,Ce);for(;e<0;)e+=r(this,Te);for(;t>=r(this,Ce);)t-=r(this,Ce);for(;e>=r(this,Te);)e-=r(this,Te);let s=[t,e].toString();if(!(s in r(this,Ze))){let n=r(this,Ee).findIndex(a=>a.x===t&&a.y===e);if(n===-1)return r(this,Rs).call(this,t,e);r(this,Ze)[s]=n}return r(this,Ee)[r(this,Ze)[s]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return r(this,Te)}tiles(){return r(this,Ee)}width(){return r(this,Ce)}setTiles(t){u(this,Ee,t)}};l(Hs,"World"),Rs=new WeakMap,Ze=new WeakMap,Ee=new WeakMap,Te=new WeakMap,Ce=new WeakMap;var $s=Hs;var Us=class extends xi{renderTile(t){super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.yields.reduce((g,f)=>g+f.value,0),p=t.yields.sort((g,f)=>g._.charCodeAt(0)-f._.charCodeAt(0)),d=0;if(m<5){let g=[[a,o],[a+n/2,o],[a,o+n/2],[a+n/2,o+n/2]];p.forEach(f=>{for(let y=0;y<f.value;y++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[d++])});return}if(m<7){let g=[[a,o],[a+n/3,o],[a+n/3*2,o],[a,o+n/2],[a+n/3,o+n/2],[a+n/3*2,o+n/2]];p.forEach(f=>{for(let y=0;y<f.value;y++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),g[d][0],g[d++][1])});return}if(m<9){let g=[[a,o],[a+n/4,o],[a+n/4*2,o],[a+n/4*3,o],[a,o+n/2],[a+n/4,o+n/2],[a+n/4*2,o+n/2],[a+n/4*3,o+n/2]];p.forEach(f=>{for(let y=0;y<f.value;y++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[d++])});return}if(m<11){let g=[[a,o],[a+n/5,o],[a+n/5*2,o],[a+n/5*3,o],[a+n/5*4,o],[a,o+n/2],[a+n/5,o+n/2],[a+n/5*2,o+n/2],[a+n/5*3,o+n/2],[a+n/5*4,o+n/2]];p.forEach(f=>{for(let y=0;y<f.value;y++)this.putImage(this.getPreloadedImage(`city/${f._.toLowerCase()}`),...g[d++])});return}let h=[[a,o],[a+n/6,o],[a+n/6*2,o],[a+n/6*3,o],[a+n/6*4,o],[a+n/6*5,o],[a,o+n/2],[a+n/6,o+n/2],[a+n/6*2,o+n/2],[a+n/6*3,o+n/2],[a+n/6*4,o+n/2],[a+n/6*5,o+n/2]];p.forEach(g=>{for(let f=0;f<g.value;f++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),...h[d++])})}};l(Us,"Yields");var et=Us;var b=E(T());var Ar=l(i=>Math.max(1,Math.ceil((i.build.cost.value-i.build.progress.value)/Ct(i,"Production"))),"buildTurns"),Hr=l(i=>Math.max(1,Math.ceil((i.growth.cost.value-i.growth.progress.value)/Ct(i,"Food"))),"growthTurns"),Rr=l(i=>{let t=i.growth,e=parseInt(i.name.replace(/[^a-z]/gi,""),36).toString(2),s=new Array(t.size).fill(1),n=(0,b.s)('<div class="population"></div>'),[a,o]=Tt(i,"Happiness","Unhappiness"),m=s.length-1;for(;o>0&&m>-1;)s[m--]=0,o--;for(m=0;a>0&&m<s.length;)s[m]===0&&(s[m]++,a--),s[m]===1&&(s[m++]++,a--),s[m]===2&&m++;return s.forEach((p,d)=>S.getScaled(`./assets/city/people_${["unhappy","content","happy"][p]}_${["f","m"][parseInt(e[d%e.length],10)]}.png`,2).then(h=>n.append((0,b.s)('<span class="citizen"></span>',(0,b.s)(`<img src="${h.toDataURL("image/png")}">`))))),n},"renderPopulation"),$r=l((i,t)=>t.filter(e=>Rn[i].includes(e._)).reduce(([e,s],n)=>[e+(n.value<0?-n.value:0),s+n.value],[0,0]),"reduceYield"),Ur=l(i=>(0,b.s)('<div class="yields-detail"></div>',...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>(0,b.s)(`<div class="yields" data-yields="${t.join(" ")}"></div>`,...t.map(e=>(0,b.s)(`<span class="yield" data-yield="${e}"></span>`,...$r(e,i.yields).map((s,n)=>(0,b.s)(`<span class="${["used","free"][n]}"></span>`,...Wn({id:"",_:e,value:s,values:[]}))))))),...Object.entries(i.yields.filter(t=>!Object.keys(ms).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>(0,b.s)(`<div><div>${t}</div><div>${e}</div></div>`))),"renderYields"),zn=l(i=>{let t=i.querySelectorAll(".yields-detail .yield");Array.from(t).forEach(e=>{let[s,n]=Array.from(e.children);for(;s.scrollWidth+n.scrollWidth>e.clientWidth;){let a=parseInt(e.getAttribute("data-max-width")||"14",10);if(a===0)break;e.setAttribute("data-max-width",(a-1).toString())}})},"resizeYields"),Or=l((i,t,e)=>{let s=(0,b.s)("<canvas></canvas>"),n=new Ms(new $s(t.player.world),e,s,{playerId:t.player.id,scale:i.scale(),tileSize:i.tileSize()/i.scale()},Pt,Es,Ss,bs,xs,ys,St,et);return s.height=i.tileSize()*5,s.width=i.tileSize()*5,n.setCenter(t.tile.x,t.tile.y),n.build(t.tiles),n.getLayer(et).render(t.tilesWorked),n.render(),_((0,b.s)('<div class="city-map"></div>',s),{click:()=>e.send("action",{name:"ReassignWorkers",city:t.id})})},"renderMap"),Wn=l(i=>new Array(Math.abs(i.value)).fill(0).map(()=>{let t=(0,b.s)('<span class="yield-icon"></span>');return S.getScaled(`./assets/${di[ms[i._]]}`,2).then(e=>t.append((0,b.s)(`<img src="${e.toDataURL("image/png")}">`))),t}),"yieldImages"),zr=l((i,t,e)=>{let s=Ar(i);return(0,b.s)(`<div class="build"><header>Building ${i.build.building?i.build.building.item._:"nothing"}</header></div>`,_((0,b.s)(`<button>${i.build.building?"Change":"Choose"}</button>`),{click(){t()}}),_((0,b.s)("<button>Buy</button>"),{click(){e()}}),i.build.building?(0,b.s)(`<p>Progress ${i.build.progress.value} / ${i.build.cost.value} (${s} turn${s===1?"":"s"})</p>`):"")},"renderBuildDetails"),Wr=l(i=>{let t=i.growth,e=Hr(i);return(0,b.s)(`<div class="growth"><header>Growth</header><p>Size ${t.size.toString()}</p><p>Progress ${i.growth.progress.value} / ${i.growth.cost.value} (${e} turn${e===1?"":"s"})</p></div>`)},"renderGrowth"),Nr=l(i=>(0,b.s)('<div class="improvements"></div>',(0,b.s)("<div></div>",...i.improvements.map(t=>(0,b.s)(`<div>${t._}</div>`,...i.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>Wn(e)))))),"renderImprovements"),jr=l((i,t)=>_((0,b.s)('<div class="garrisoned-units"><header>Garrisoned Units</header></div>',(0,b.s)('<div class="units"></div>',...i.tile.units.map(e=>new On(e).element()))),{click(){let e=i.tile.units.filter(s=>s.player.id===i.player.id);e.length!==0&&new As(e,t)}}),"renderGarrisonedUnits"),Br=l(i=>(0,b.s)('<div class="supported-units"><header>Supported Units</header></div>',(0,b.s)('<div class="units"></div>',...i.units.map(t=>(0,b.s)('<span class="unit"></span>',new On(t),...i.yields.filter(e=>["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"].includes(e._)).filter(e=>e.unit.id===t.id).flatMap(e=>Wn(e)))))),"renderSupportedUnits"),Ei=l((i,t,e,s,n)=>(0,b.s)('<div class="city-screen"></div>',(0,b.s)('<div class="top-row"></div>',(0,b.s)('<div class="yield-details"></div>',Rr(i),Ur(i),Br(i)),Or(t,i,e),Nr(i)),(0,b.s)('<div class="bottom-row"></div>',Wr(i),(0,b.s)('<div class="tabbed-details"></div>',(0,b.s)('<div class="info"></div>',jr(i,e))),zr(i,s,n))),"buildDetails"),le,tt,Rt,st,Os=class extends ge{constructor(e,s,n){super(e.name,Ei(e,s,n,()=>this.changeProduction(),()=>this.completeProduction()),{canResize:!0,canMaximise:!0,size:"maximised"});c(this,le,void 0);c(this,tt,void 0);c(this,Rt,void 0);c(this,st,void 0);setTimeout(()=>zn(this.element()),200),this.addClass("city-screen-window"),u(this,le,e),u(this,Rt,s),u(this,st,n),u(this,tt,new wi([e.id,e.build.id,e.growth.id,...e.units.map(o=>o.id)],o=>{var p,d;let[m]=((d=(p=o.player)==null?void 0:p.cities)!=null?d:[]).filter(h=>e.id===h.id);if(!m){this.close();return}u(this,le,m),r(this,tt).setIds([m.id,m.build.id,m.growth.id,...m.units.map(h=>h.id)]),this.update(Ei(m,r(this,Rt),n,()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus(),setTimeout(()=>zn(this.element()),200)})),this.on("keydown",o=>{["c","C"].includes(o.key)&&(this.changeProduction(),o.preventDefault(),o.stopPropagation()),["b","B"].includes(o.key)&&(this.completeProduction(),o.preventDefault(),o.stopPropagation()),["Enter","x","X"].includes(o.key)&&this.close()});let a=l(()=>setTimeout(()=>zn(this.element()),200),"resizeHandler");this.on("close",()=>window.removeEventListener("resize",a)),window.addEventListener("resize",a),this.on("close",()=>this.off("resize",a)),this.on("resize",a)}changeProduction(){new nt(r(this,le).build,r(this,st),()=>this.element().focus())}close(){r(this,tt).dispose(),super.close()}completeProduction(){!r(this,le).build.building||new us("Are you sure?",`Do you want to rush building of ${r(this,le).build.building.item._}`,()=>r(this,st).send("action",{name:"CompleteProduction",id:r(this,le).id}))}};l(Os,"City"),le=new WeakMap,tt=new WeakMap,Rt=new WeakMap,st=new WeakMap;var zs=Os;var $t,Ws,it=class extends xe{constructor(e,s,n=()=>{},a={}){let o=l(m=>Math.max(1,Math.ceil((m.cost.value-e.progress.value)/Ct(e.city,"Production"))),"turns");super(`What would you like to build in ${e.city.name}?`,e.available.map(m=>({label:`${m.item._} (Cost: ${m.cost.value} / ${o(m)} turn${o(m)===1?"":"s"})`,value:m.item._})),m=>{!m||(s.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:m||"@"}),this.close(!0))},null,{actions:a,displayAll:!0});c(this,$t,void 0);c(this,Ws,void 0);u(this,$t,n),u(this,Ws,s)}close(e=!1){super.close(),e&&r(this,$t).call(this,e)}};l(it,"CityBuildSelectionWindow"),$t=new WeakMap,Ws=new WeakMap,it.showCityAction=l((e,s,n)=>({label:"View city",action(a){a.close(),new zs(e,s,n)}}),"showCityAction"),it.showCityOnMapAction=l((e,s)=>({label:"Show on map",action(n){n.close(),s.setCenter(e.tile.x,e.tile.y)}}),"showCityOnMapAction");var nt=it;var Ti=E(T());var rt,Ns=class extends Q{constructor(e,s,n){super(e,n);c(this,rt,void 0);u(this,rt,s)}activate(){new nt(this.value(),this.transport(),()=>this.complete(),{showCity:nt.showCityAction(this.value().city,r(this,rt),this.transport()),showCityOnMap:nt.showCityOnMapAction(this.value().city,r(this,rt))})}build(){let e=this.value();S.get("./assets/city/production.png").then(s=>this.append((0,Ti.s)(`<button class="cityBuild" title="What would you like to build in ${e.city.name}?" style="background-image:url('${s.uri}')">`)))}value(){return super.value()}};l(Ns,"CityBuild"),rt=new WeakMap;var Ci=Ns;var Mi=E(T());var js=class extends Q{activate(){this.transport().send("action",{name:"EndTurn"})}build(){this.append((0,Mi.s)('<button class="endTurn" title="End turn"></button>'))}};l(js,"EndTurn");var Ii=js;var Si=E(T());var Bs=class extends Q{activate(){let t=new we("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(this.transport().send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){S.get("./assets/city/sad.png").then(t=>this.append((0,Si.s)(`<button class="chooseGovernment" title="Choose government" style="background-image:url('${t.uri}')"></button>`)))}value(){return super.value()}};l(Bs,"Revolution");var Li=Bs;var Ut,me,Fs=class extends qs.Element{constructor(e=(0,qs.s)('<div class="actions"></div>'),s,n){super(e);c(this,Ut,void 0);c(this,me,void 0);u(this,Ut,s),u(this,me,n),this.on("actioned",a=>a.detail.remove()),this.on("keydown",a=>{var g;let o=document.activeElement;if(!this.element().contains(o))return;let{key:m}=a,p=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(m)||p.length===0)return;a.preventDefault(),a.stopPropagation();let d=o===this.element()?["ArrowLeft","ArrowUp"].includes(m)?o.firstElementChild:o.lastElementChild:o;for(;d.parentElement!==this.element();)d=d.parentElement;let h=p.indexOf(d);if(["ArrowUp","ArrowLeft"].includes(m)){if(h>0){(g=p[h-1].querySelector("button"))==null||g.focus();return}p.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(m)){if(h<p.length-1){p[h+1].querySelector("button").focus();return}p.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(s=>{let n;switch(s._){case"ActiveUnit":return;case"AdjustTradeRates":n=new li(s,r(this,me));break;case"ChooseResearch":n=new pi(s,r(this,me));break;case"CityBuild":n=new Ci(s,r(this,Ut),r(this,me));break;case"EndTurn":n=new Ii(s,r(this,me));break;case"Revolution":n=new Li(s,r(this,me));break;default:console.log("need to handle "+s._);return}this.element().prepend(_(n.element(),{click:()=>n.activate(),keydown:({key:a})=>{(a===" "||a==="Enter")&&n.activate()}}))})}};l(Fs,"Actions"),Ut=new WeakMap,me=new WeakMap;var Nn=Fs;var Ue,Gs=class extends F{constructor(){super(...arguments);c(this,Ue,null)}renderTile(e){super.renderTile(e);let{x:s,y:n}=e,a=this.tileSize(),o=s*a,m=n*a;if(e.units.length>0&&(r(this,Ue)!==null?r(this,Ue).tile.id!==e.id:!0)){let[p]=e.units.sort((h,g)=>{var f,y;return((f=g.defence)==null?void 0:f.value)-((y=h.defence)==null?void 0:y.value)}),d=this.renderUnit(p);e.units.length>1&&this.putImage(d,o-this.scale(),m-this.scale()),this.putImage(d,o,m)}}renderUnit(e){return Ls(e)}setActiveUnit(e){u(this,Ue,e)}activeUnit(){return r(this,Ue)}};l(Gs,"Units"),Ue=new WeakMap;var Ot=Gs;var Vs=class extends Ot{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:s}=t.tile,n=this.world().get(e,s),a=this.tileSize(),o=e*a,m=s*a,p=this.renderUnit(t);n.units.length>1&&this.putImage(p,o-this.scale(),m-this.scale()),this.putImage(p,o,m)}update(){this.render()}};l(Vs,"ActiveUnit");var jn=Vs;var Ks=class extends F{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:s}=t,n=this.tileSize(),a=e*n,o=s*n,m=t.city,p=this.tileSize()/2,d=this.tileSize()*.75,h=this.tileSize()/2,g=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(m.growth.size.toString(),a+p+this.scale(),o+d),this.context().fillText(m.name,a+h+this.scale(),o+g),this.context().fillStyle="white",this.context().fillText(m.growth.size.toString(),a+p,o+d-this.scale()),this.context().fillText(m.name,a+h,o+g-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}};l(Ks,"CityNames");var Bn=Ks;var Xs=E(T());var zt,Wt,Ys=class extends Xs.Element{constructor(e,s,n){super(e);c(this,zt,void 0);c(this,Wt,void 0);u(this,zt,s),u(this,Wt,n)}build(){this.empty(),this.append((0,Xs.s)(`<h3><span class="year">${this.year()}</span><span class="turn">${r(this,zt).value.toString()}</span></h3>`))}year(e=r(this,Wt).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};l(Ys,"GameDetails"),zt=new WeakMap,Wt=new WeakMap;var Pi=Ys;var Di=E(T());var Qs=class extends Ms{bindEvents(){(0,Di.on)(this.canvas(),"click",t=>{let e=this.center(),s={x:Math.floor(this.canvas().width/2-this.tileSize()/2),y:Math.floor(this.canvas().height/2-this.tileSize()/2)},n=e.x+Math.trunc(((t.offsetX-s.x)/this.tileSize()+this.world().width())%this.world().width()),a=e.y+Math.trunc(((t.offsetY-s.y)/this.tileSize()+this.world().height())%this.world().height()),o=this.world().get(n,a),m=o.units.filter(p=>p.player.id===this.playerId());if(o.city&&o.city.player.id===this.playerId())new zs(o.city,this,this.transport());else if(m.length){new As(m,this.transport(),p=>this.emit("activate-unit",p));return}this.setCenter(o.x,o.y)})}};l(Qs,"GamePortal");var ki=Qs;var Js=class extends W{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:s}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,s)}};l(Js,"Terrain");var Ai=Js;var Oe,Me,Zs=class{constructor(t=500){c(this,Oe,!1);c(this,Me,[]);setInterval(()=>this.check(),t)}check(){r(this,Oe)||r(this,Me).forEach(t=>t())}clear(){u(this,Me,[])}off(t){u(this,Me,r(this,Me).filter(e=>e!==t))}on(t){r(this,Me).push(t)}pause(){u(this,Oe,!0)}isPaused(){return r(this,Oe)}resume(){u(this,Oe,!1)}};l(Zs,"IntervalHandler"),Oe=new WeakMap,Me=new WeakMap;var Hi=Zs;var ne=E(T());var Nt,jt,en=class{constructor(t,...e){c(this,Nt,void 0);c(this,jt,void 0);u(this,Nt,e),u(this,jt,t)}args(){return r(this,Nt)}channel(){return r(this,jt)}};l(en,"Request"),Nt=new WeakMap,jt=new WeakMap;var Ie=en;var tn=class extends Ie{constructor(t){super("getOptions",t)}};l(tn,"Options");var Ri=tn;var z=E(T());var at,ze,sn=class extends ge{constructor(e,s){super("Customise world",(0,z.s)('<div class="customise-world"></div>'));c(this,at,void 0);c(this,ze,void 0);u(this,at,s),u(this,ze,e),this.init()}build(){super.build(),this.init()}async init(){var h,g,f,y,H,U;let e=await r(this,ze).request(new Ri(["players","height","width","landCoverage","landSize","maxIterations"])),s=(0,z.s)(`<input name="players" type="number" value="${(h=e.players)!=null?h:7}" step="1" min="1" max="20">`),n=(0,z.s)(`<input name="height" type="number" value="${(g=e.height)!=null?g:60}" step="1" min="1">`),a=(0,z.s)(`<input name="width" type="number" value="${(f=e.width)!=null?f:80}" step="1" min="1">`),o=(0,z.s)(`<input name="landCoverage" type="number" value="${(y=e.landCoverage)!=null?y:.4}" step="0.01" min="0">`),m=(0,z.s)(`<input name="landSize" type="number" value="${(H=e.landSize)!=null?H:.2}" step="0.01" min="0">`),p=(0,z.s)(`<input name="maxIterations" type="number" value="${(U=e.maxIterations)!=null?U:20}" step="1" min="1">`),d=l(async()=>{this.close(),await r(this,ze).request(new Ie("setOptions",{players:s.value,height:n.value,width:a.value,landCoverage:o.value,landSize:m.value,maxIterations:p.value})),r(this,ze).send("start"),r(this,at)&&r(this,at).call(this)},"submit");this.update((0,z.s)('<div class="customise-world"></div>',(0,z.s)('<div class="option"><label>Players</label></div>',s),(0,z.s)('<div class="option"><label>Height</label></div>',n),(0,z.s)('<div class="option"><label>Width</label></div>',a),(0,z.s)('<div class="option"><label>Land coverage</label></div>',o),(0,z.s)('<div class="option"><label>Land size</label></div>',m),(0,z.s)('<div class="option"><label>Max iterations</label></div>',p),_((0,z.s)("<button>Build</button>"),{click:()=>d()}))),this.on("keydown",G=>{G.key==="Enter"&&d()})}};l(sn,"CustomiseWorldWindow"),at=new WeakMap,ze=new WeakMap;var $i=sn;var nn=class extends xe{constructor(t,e,s,n="Please choose one of the following:",a={canClose:!1,displayAll:!1}){super(t,e,s,n,{...a,displayAll:!0})}display(){return new Promise(t=>{this.on("selection",({detail:e})=>t(e)),super.display()})}};l(nn,"MandatorySelection");var Ui=nn;var ot=class extends Ui{constructor(t,e){super("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],async s=>{this.close(),await t.request(new Ie("setOptions",{width:80,height:60,players:parseInt(s,10)})),e&&await e(),t.send("start")})}};l(ot,"NewGameWindow");var Oi=ot;var rn=class extends ot{constructor(t,e){super(t,async()=>{e&&await e(),await t.request(new Ie("setOptions",{width:80,height:50,earth:!0}))})}};l(rn,"EarthWindow");var zi=rn;var an=class{constructor(){this.blob=null;this.ptr=-1}fromString(t,e){this.blob=t,this.ptr=0,this.decode(e)}getUByte(){return this.blob.charCodeAt(this.ptr++)}getUShort(){let t=this.getUByte();return(this.getUByte()<<8)+t}getShort(){return(this.getUShort()+32768)%65536-32768}getString(t){let e=this.ptr;return this.ptr+=t,this.blob.substr(e,t)}decode(t){if(this.blob===null){console.warn("file has not been loaded!");return}console.warn("The decode function should be overwritten"),t&&t()}};l(an,"BinFile");var Wi=an;var on=class{constructor(t){this.dicTable=[];this.dicTable=[],this.dicSize=1<<t;for(let e=0;e<this.dicSize;e++)e<256?this.dicTable[e]=[e]:this.dicTable[e]=null;this.curPos=257}getEntry(t){return t<this.curPos?this.dicTable[t]:null}isFull(){return this.curPos===this.dicTable.length}getCurPos(){return this.curPos}addEntry(t){return this.curPos<this.dicTable.length&&(this.dicTable[this.curPos]=t,this.curPos++),this.curPos-1}};l(on,"LZWDictionary");var Ni=on;var ln=class{static parseByteStreamToIndexes(t,e,s){let n=[],a=0,o=0,m=1,p=1,d=256,h=0,g=0;for(;e>0;){for(;o<8+m;)a|=t.getUByte()<<o,e--,o+=8;for(;o>=8+m;)g=a&(p<<8&65280|255),a>>=8+m,o-=8+m,h++,h==d&&(h=0,m+=1,p<<=1,p|=1,d<<=1,8+m>s&&(h=0,m=1,p=1,d=256)),n.push(g)}return n}static decode(t,e){e=e||11;let s=t,n=[];for(;s.length>0;){let a=new Ni(e),o=[s[0]],m=s[0],p=a.getEntry(m),d=m,h,g=0;for(;!a.isFull()&&g++<s.length-1;){h=s[g];let f=[];h>=a.getCurPos()?(f=a.getEntry(m),f===null&&console.error(`No dictionary entry in LZW special case: oldCode=${m}; newCode=${h}; i=${g}; buffer=${p}`),f=[...f??[],d]):f=a.getEntry(s[g]),o.push.apply(o,f),d=f[0],a.addEntry(p.concat(d)),m=h,p=a.getEntry(m)}n.push.apply(n,o),s=s.slice(g+1)}return n}static RLEDecode(t){let e=[],s=0,n=!1;for(let a=0;a<t.length;a++){let o=t[a];if(n){if(o==0)s=144,e.push(144);else for(let m=0;m<o-1;m++)e.push(s);n=!1}else o==144?n=!0:(e.push(o),s=o)}return e}};l(ln,"LZW");var mn=ln;var Fr=l(i=>i&15,"lowerNibble"),ji=Fr;var qr=l(i=>(i&240)>>4,"upperNibble"),Bi=qr;var pn=class extends Wi{constructor(){super(...arguments);this.palette=[];this.palette16=[{r:255,g:255,b:255,a:0},{r:170,g:0,b:0,a:255},{r:0,g:170,b:0,a:255},{r:170,g:170,b:0,a:255},{r:0,g:0,b:170,a:255},{r:0,g:0,b:0,a:255},{r:0,g:85,b:170,a:255},{r:170,g:170,b:170,a:255},{r:85,g:85,b:85,a:255},{r:255,g:85,b:85,a:255},{r:85,g:255,b:85,a:255},{r:255,g:255,b:85,a:255},{r:85,g:85,b:255,a:255},{r:255,g:85,b:255,a:255},{r:85,g:255,b:255,a:255},{r:255,g:255,b:255,a:255}];this.imageData=null;this.imageHeight=0;this.imageWidth=0;this.byteMode=11}decode(e){let s=this.getString(2),n=this.getShort();if(s=="M0")this.getPaletteData(),s=this.getString(2),n=this.getShort();else{console.log("Creating a random color palette...");for(let a=0;a<256;a++)a<16?this.palette.push(this.palette16[a]):this.palette.push({r:Math.floor(Math.random()*256),g:Math.floor(Math.random()*256),b:Math.floor(Math.random()*256),a:255})}s=="X0"?this.getX0ImageData(n):s=="X1"?this.getX1ImageData(n):console.error('"'+s+'" is an unknown chunk type'),e&&e()}getPaletteData(){let e=this.getUByte(),s=this.getUByte(),n=s-e+1,a=!1;for(let o=0;o<n;o++){let m={r:this.getUByte()*4,g:this.getUByte()*4,b:this.getUByte()*4,a:255};this.palette.push(m),m.r===m.g&&m.g===m.b&&m.r===0&&(a||(m.a=0),a=!0)}this.palette.push({r:0,g:0,b:0,a:0})}getX0ImageData(e){this.imageWidth=this.getShort(),this.imageHeight=this.getShort(),this.byteMode=this.getUByte();let s=mn.parseByteStreamToIndexes(this,e-5,this.byteMode),n=mn.decode(s,this.byteMode);this.imageData=mn.RLEDecode(n)}getX1ImageData(e){this.getX0ImageData(e);let s=this.imageData;this.imageData=[];for(let n=0;n<s.length;n++)this.imageData.push(ji(s[n])),this.imageData.push(Bi(s[n]));this.palette=this.palette16}draw(e,s=0,n=0){let a=e.getImageData(0,0,this.imageWidth,this.imageHeight),o=0;for(let m=0;m<this.imageHeight;m++)for(let p=0;p<this.imageWidth;p++){let d=this.imageData[o],h=(p+m*this.imageWidth)*4;a.data[h]=this.palette[d].r,a.data[h+1]=this.palette[d].g,a.data[h+2]=this.palette[d].b,a.data[h+3]=this.palette[d].a,o++}e.putImageData(a,s,n)}getPixel(e,s){return this.imageData?this.imageData[e+this.imageWidth*s]:0}};l(pn,"PicImage");var Fi=pn;var qi=l((i,t,e,s,n=a=>console.log(a))=>{let a=s(320,200),o=new Fi,m=[];return o.fromString(i,()=>{o.draw(a.getContext("2d",{willReadFrequently:!0})),Object.entries(t).forEach(([p,d])=>d.forEach(h=>h.contents.forEach(g=>{let f={...e,...h,...g},y=`./assets/${p+f.name}.png`,H=s(f.width,f.height),U=H.getContext("2d",{willReadFrequently:!0});U.clearRect(0,0,f.width,f.height),U.drawImage(a,f.x,f.y,f.width,f.height,0,0,f.width,f.height);for(let G=0;G<a.width;G++)for(let pe=0;pe<a.height;pe++){let De=U.getImageData(G,pe,1,1).data;De[0]==f.clear.r&&De[1]==f.clear.g&&De[2]==f.clear.b&&U.clearRect(G,pe,1,1)}n(`Processing ${y}...`),m.push({name:y,uri:H.toDataURL("image/png")})})))}),m},"extractSprites");var Bt={defaults:{height:16,width:16,clear:{r:0,g:170,b:170}},files:{"SP257.PIC":{"cursor/go":[{y:33,x:33,height:12,width:12,contents:[{name:""}]}],"city/pollution":[{y:32,x:48,contents:[{name:""}]}],"improvements/irrigation":[{y:32,x:64,contents:[{name:""}]}],"improvements/mine":[{y:32,x:80,contents:[{name:""}]}],"improvements/pollution":[{y:32,x:96,contents:[{name:""}]}],"cursor/torch":[{y:33,x:113,height:13,width:13,contents:[{name:""}]}],"city/food":[{y:33,x:129,height:7,width:7,contents:[{name:""}]}],"city/production":[{y:33,x:137,height:7,width:7,contents:[{name:""}]}],"city/trade":[{y:33,x:145,height:7,width:7,contents:[{name:""}]}],"city/gold":[{y:33,x:153,height:7,width:7,contents:[{name:""}]}],"city/bulb":[{y:41,x:129,height:7,width:7,contents:[{name:""}]}],"city/sad":[{y:41,x:137,height:7,width:7,contents:[{name:""}]}],"city/luxury":[{y:41,x:145,height:7,width:7,contents:[{name:""}]}],"terrain/":[{y:41,x:153,height:7,width:7,contents:[{name:"shield"}]}],"improvements/road":[{y:48,contents:[{name:"_n",x:0},{name:"_ne",x:16},{name:"_e",x:32},{name:"_se",x:48},{name:"_s",x:64},{name:"_sw",x:80},{name:"_w",x:96},{name:"_nw",x:112}]}],"status/science":[{y:48,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"status/pollution":[{y:56,height:8,width:8,contents:[{name:"_0",x:128},{name:"_25",x:136},{name:"_50",x:144},{name:"_75",x:152}]}],"terrain/land":[{y:64,contents:[{name:"",x:0}]}],"terrain/river":[{y:64,contents:[{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:224},{name:"_nesw",x:240}]}],"units/combat":[{y:97,height:15,width:15,contents:[{name:"_1",x:1},{name:"_2",x:17},{name:"_3",x:33},{name:"_4",x:49},{name:"_5",x:65},{name:"_6",x:81},{name:"_7",x:97},{name:"_8",x:113}]}],"improvements/railroad":[{y:96,contents:[{name:"_n",x:128},{name:"_ne",x:144},{name:"_e",x:160},{name:"_se",x:176},{name:"_s",x:192},{name:"_sw",x:208},{name:"_w",x:224},{name:"_nw",x:240}]}],"terrain/oasis":[{y:113,height:15,width:15,contents:[{name:"",x:1}]}],"terrain/horse":[{y:113,height:15,width:15,contents:[{name:"",x:17}]}],"terrain/doe":[{y:113,height:15,width:15,contents:[{name:"",x:49}]}],"terrain/coal":[{y:113,height:15,width:15,contents:[{name:"",x:65}]}],"terrain/gold":[{y:113,height:15,width:15,contents:[{name:"",x:81}]}],"terrain/game":[{y:113,height:15,width:15,contents:[{name:"",x:97}]}],"terrain/seal":[{y:113,height:15,width:15,contents:[{name:"",x:113}]}],"terrain/oil":[{y:113,height:15,width:15,contents:[{name:"",x:129}]}],"terrain/gems":[{y:113,height:15,width:15,contents:[{name:"",x:145}]}],"terrain/fish":[{y:113,width:15,height:15,contents:[{name:"",x:161}]}],"map/city":[{y:113,contents:[{name:"",x:193}]}],"map/fortify":[{width:15,height:15,y:113,contents:[{name:"",x:209}]}],"map/fort":[{width:15,height:15,y:113,contents:[{name:"",x:225}]}],"map/hut":[{y:113,height:15,width:15,contents:[{name:"",x:241}]}],"city/people":[{y:128,height:16,width:8,contents:[{name:"_happy_m",x:0},{name:"_happy_f",x:8},{name:"_content_m",x:16},{name:"_content_f",x:24},{name:"_unhappy_m",x:32},{name:"_unhappy_f",x:40},{name:"_tax",x:48},{name:"_science",x:56},{name:"_luxury",x:64}]}],"map/fog":[{y:128,contents:[{name:"_n",x:80},{name:"_e",x:96},{name:"_s",x:112},{name:"_w",x:128}]}],"units/":[{y:161,height:15,width:15,contents:[{name:"settlers",x:1},{name:"warrior",x:17},{name:"spearman",x:33},{name:"swordman",x:49},{name:"musketman",x:65},{name:"rifleman",x:81},{name:"horseman",x:97},{name:"knight",x:113},{name:"catapult",x:129},{name:"cannon",x:145},{name:"chariot",x:161},{name:"tank",x:177},{name:"mechanizedinfantry",x:193},{name:"artillery",x:209},{name:"fighter",x:225},{name:"bomber",x:241},{name:"trireme",x:257},{name:"sail",x:273},{name:"frigate",x:289},{name:"ironclad",x:305}]},{y:177,contents:[{name:"cruiser",x:1},{name:"battleship",x:17},{name:"submarine",x:33},{name:"carrier",x:49},{name:"transport",x:65},{name:"nuclear",x:81},{name:"diplomat",x:97},{name:"caravan",x:113}]}],"general/texture":[{y:176,contents:[{name:"_1",x:288},{name:"_2",x:304}]}]},"TER257.PIC":{"terrain/desert":[{y:0,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/plains":[{y:16,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/grassland":[{y:32,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/forest":[{y:48,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/hills":[{y:64,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/mountains":[{y:80,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/tundra":[{y:96,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/arctic":[{y:112,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/swamp":[{y:128,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/jungle":[{y:144,contents:[{name:"",x:0},{name:"_n",x:16},{name:"_e",x:32},{name:"_ne",x:48},{name:"_s",x:64},{name:"_ns",x:80},{name:"_es",x:96},{name:"_nes",x:112},{name:"_w",x:128},{name:"_nw",x:144},{name:"_ew",x:160},{name:"_new",x:176},{name:"_sw",x:192},{name:"_nsw",x:208},{name:"_esw",x:222},{name:"_nesw",x:228}]}],"terrain/ocean":[{y:160,contents:[{name:"",x:0}]}],"terrain/coast_sprite":[{x:0,y:176,height:16,width:128,contents:[{name:""}]}],"terrain/river":[{y:160,contents:[{name:"",x:240}]},{y:176,contents:[{name:"_mouth_n",x:128},{name:"_mouth_e",x:144},{name:"_mouth_s",x:160},{name:"_mouth_w",x:176}]}]}}};var Ft=E(T());var lt,K,dn=class extends ge{constructor(){let e=(0,Ft.s)('<input type="file" multiple>'),s=(0,Ft.s)('<p class="loading" hidden></p>');super("Import assets",(0,Ft.s)(`<div class="import-assets"><p>Upload ${Object.keys(Bt.files).join(", ")} from the original Civilization files to extract assets (these will be stored locally). This process can take at least a few minutes.</p><div class="brave" ${navigator!=null&&navigator.brave?"":" hidden"}><p>It looks like you're using Brave and due to the use of <code>HTMLCanvasElement</code>'s <code>getImageData</code> and <code>toDataURL</code> functions, please put Shields down while importing, and playing, otherwise any colour-replaced icons won't look correct. <strong>Remember to put them back up after!</strong></p><p><a href="https://brave.com/privacy-updates/4-fingerprinting-defenses-2.0/#2-fingerprinting-protections-20-farbling-for-great-good" target="_blank">Read more about "farbling".</a></p></div></div>`,(0,Ft.s)("<p></p>",_(e,{change:n=>this.handleFileUpload(n)})),s));c(this,lt,void 0);c(this,K,void 0);u(this,lt,e),u(this,K,s)}async handleFileUpload(e){var m;r(this,lt).setAttribute("disabled",""),r(this,K).removeAttribute("hidden"),r(this,K).innerText="Building image assets...";let s=Array.from((m=e.target.files)!=null?m:[]),n=s.map(p=>p.name);if(!Object.keys(Bt.files).map(p=>new RegExp(p,"i")).every(p=>n.some(d=>d.match(p)))){console.error(`Please provide ${n.join(", ")} to process the assets.`);return}let o=[];if(await Promise.all(s.map(async p=>new Promise(d=>{let h=Bt.files[p.name.toUpperCase()];if(!h){console.warn(`No definitions found for ${p.name}, skipping.`);return}let g=new FileReader;g.addEventListener("load",async f=>{qi(f.target.result,h,Bt.defaults,(y,H)=>{let U=document.createElement("canvas");return U.width=y,U.height=H,U},y=>{r(this,K).innerText=y}).forEach(y=>o.push(y)),d()}),g.readAsBinaryString(p)}))),r(this,K).innerText="Writing to database...",await Promise.all(o.map(p=>S.set(p))),!await S.hasAllAssets()){console.error("Something went wrong..."),r(this,K).style.color="#f00",r(this,K).innerText="Not all expected data was written. Might need to try again... Missing: "+(await S.missingAssets()).join(", "),r(this,lt).removeAttribute("disabled");return}r(this,K).innerText="Done! Please reload the page to utilise the fresh assets.",location.reload()}};l(dn,"ImportAssetsWindow"),lt=new WeakMap,K=new WeakMap;var Gi=dn;var Vi="0.1.0@4cb5589";var Se,cn=class extends ne.Element{constructor(e,s){super(e);c(this,Se,void 0);u(this,Se,s),this.build(),this.addClass("active")}async build(e=!1){let s=await S.hasAllAssets();s||(console.log("Missing assets:"),console.log(await S.missingAssets())),this.append(_((0,ne.s)("<nav></nav>",_((0,ne.s)(`<button autofocus${s?"":" hidden"}>Start a New Game</button>`),{click:()=>{new Oi(r(this,Se),()=>this.remove())}}),_((0,ne.s)(`<button${s?"":" hidden"}>Earth</button>`),{click:()=>new zi(r(this,Se),()=>this.remove())}),_((0,ne.s)(`<button${s?"":" hidden"}>Customise World</button>`),{click:async()=>new $i(r(this,Se),()=>this.remove())}),_((0,ne.s)(`<button${s?"":" hidden"}>Import Assets</button>`),{click:()=>new Gi}),_((0,ne.s)(`<button${e?"":" hidden"}>Quit</button>`),{click:()=>{this.remove(),r(this,Se).send("quit")}})),{keydown(n){let a=document.activeElement;a===null||!a.matches("#mainmenu nav button")||(n.key==="ArrowDown"&&a.nextElementSibling&&a.nextElementSibling.focus(),n.key==="ArrowUp"&&a.previousElementSibling&&a.previousElementSibling.focus())}}),(0,ne.s)(`<footer>version: ${Vi}</footer>`))}remove(){this.removeClass("active"),setTimeout(()=>super.remove(),2e3)}};l(cn,"MainMenu"),Se=new WeakMap;var Ki=cn;var Yi=E(T());var q,Y,We,mt,ie,un=class{constructor(t,e,s,...n){c(this,q,void 0);c(this,Y,void 0);c(this,We,void 0);c(this,mt,void 0);c(this,ie,void 0);u(this,Y,t),u(this,ie,e),u(this,mt,s),u(this,We,n),u(this,q,r(this,Y).getContext("2d")),(0,Yi.on)(r(this,Y),"click",a=>{let o=a.offsetX-r(this,Y).offsetLeft,m=a.offsetY-r(this,Y).offsetTop,p=Math.ceil(o/r(this,Y).offsetWidth*r(this,ie).width()),d=Math.ceil(m/r(this,Y).offsetHeight*r(this,ie).height());r(this,mt).setCenter(p,d),this.update()})}update(){let t=r(this,We)[0].canvas().height*(190/r(this,We)[0].canvas().width);r(this,Y).height=t,r(this,q).clearRect(0,0,190,t),r(this,We).forEach(n=>r(this,q).drawImage(n.canvas(),0,0,190,t));let[e,s]=r(this,mt).rawVisibleRange();r(this,q).lineWidth=1,r(this,q).strokeStyle="#fff",r(this,q).fillStyle="rgba(255, 255, 255, .2)",r(this,q).rect(Math.floor(190/r(this,ie).width()*e.x),Math.floor(t/r(this,ie).height()*e.y),Math.floor(190/r(this,ie).width()*(s.x-e.x)),Math.floor(t/r(this,ie).height()*(s.y-e.y))),r(this,q).stroke(),r(this,q).fill()}};l(un,"Minimap"),q=new WeakMap,Y=new WeakMap,We=new WeakMap,mt=new WeakMap,ie=new WeakMap;var Xi=un;var qt,pt,hn=class{constructor(t=document.body){c(this,qt,void 0);c(this,pt,[]);u(this,qt,t)}receive(t){r(this,pt).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!r(this,pt).length||t)return;let e=r(this,pt).shift();this.publish(e)}publish(t){var s;new os((s=t.title)!=null?s:"Notification",t.message,{parent:r(this,qt)}).on("close",()=>this.check())}};l(hn,"Notifications"),qt=new WeakMap,pt=new WeakMap;var Qi=hn;var dt=E(T());var Gt,gn=class extends dt.Element{constructor(e,s){super(e);c(this,Gt,void 0);u(this,Gt,s)}build(){this.empty();let{civilization:e,treasury:s,research:n,cities:a}=r(this,Gt),[o,m]=a.reduce(([d,h],g)=>{let[f,y]=Tt(g,"Gold","Research");return[d+f,h+y]},[0,0]),p=Math.ceil((n.cost.value-n.progress.value)/m);this.append((0,dt.s)(`<h3>${e.leader.name} of the ${e._} empire</h3>`),(0,dt.s)(`<p><strong>Researching</strong><br/>${n.researching?`${n.researching._} ${n.progress.value} / ${n.cost.value} (${p} turn${p===1?"":"s"})`:"Nothing"}</p>`),(0,dt.s)(`<p><strong>Treasury</strong><br/>${s.value} (${o} / turn}</p>`))}};l(gn,"PlayerDetails"),Gt=new WeakMap;var Ji=gn;var re=E(T());var I,fn=class extends re.Element{constructor(e,s){super(e);c(this,I,void 0);u(this,I,s),this.build()}build(){var e,s;this.empty(),r(this,I)!==null&&this.append((0,re.s)(`<p>${r(this,I)._} (${r(this,I).tile.x}, ${r(this,I).tile.y})</p>`),(0,re.s)(`<p>${(s=(e=r(this,I).city)==null?void 0:e.name)!=null?s:"NONE"}</p>`),(0,re.s)(`<p>${Number.isInteger(r(this,I).moves.value)?r(this,I).moves.value:r(this,I).moves.value.toFixed(2)} / ${r(this,I).movement.value} moves</p>`),(0,re.s)(`<p>A: ${r(this,I).attack.value} / D: ${r(this,I).defence.value} / V: ${r(this,I).visibility.value}</p>`),(0,re.s)(`<p>${r(this,I).improvements.map(n=>n._).join(", ")}</p>`),(0,re.s)(`<p>${r(this,I).tile.terrain._}${r(this,I).tile.terrain.features?" "+r(this,I).tile.terrain.features.map(n=>n._).join(", "):""}${r(this,I).tile.improvements.length?" ("+r(this,I).tile.improvements.map(n=>n._).join(", ")+")":""}</p>`),(0,re.s)(`<p>${r(this,I).tile.units.filter(n=>n!==r(this,I)).map(n=>n._).join(", ")}</p>`))}};l(fn,"UnitDetails"),I=new WeakMap;var Zi=fn;var Ne=E(T());var Le,xn=class{constructor(t){c(this,Le,void 0);u(this,Le,t)}init(){let t=r(this,Le);S.hasAllAssets().then(s=>{!s||S.getScaled("./assets/cursor/torch.png",2).then(n=>document.body.style.cursor=`url('${n.toDataURL("image/png")}'), default`)}),(0,Ne.on)(document,"keypress",s=>{if(s.key==="F5"||["R","r"].includes(s.key)&&s.ctrlKey){s.preventDefault(),new us("Quit","Are you sure you want to reload?",()=>window.location.reload());return}});let e={autoEndOfTurn:!0};try{let s=document.getElementById("notification"),n=document.querySelector("#mainmenu"),a=document.getElementById("actions"),o=document.getElementById("other-actions"),m=document.getElementById("game"),p=document.getElementById("map"),d=p.querySelector("canvas"),h=document.getElementById("gameDetails"),g=document.getElementById("playerDetails"),f=document.getElementById("minimap"),y=document.getElementById("unitInfo"),H=document.getElementById("preload"),U=new Qi,G=new Ki(n,r(this,Le)),pe=l((C,L,de,X)=>{let ce=new Zi(y,C);if(V=C,ce.build(),de.setActiveUnit(C),de.render(),de.setVisible(!0),X.setActiveUnit(C),X.render(),X.setVisible(!0),C===null){L.render();return}N=C,de.update([...N!=null&&N.tile?[N.tile]:[],C.tile]),L.isVisible(C.tile.x,C.tile.y)||L.setCenter(C.tile.x,C.tile.y),L.render()},"setActiveUnit");S.getAll().then(C=>C.forEach(L=>H.append(_((0,Ne.s)(`<img src="${L.uri}" data-path="${L.name}">`),{error:()=>console.error(`There was a problem preloading '${L.name}', you may have some missing details.`)}))));let De=[],Vt,N=null,V=null;t.receive("notification",C=>{s.innerHTML=C,Vt&&window.clearTimeout(Vt),Vt=window.setTimeout(()=>{Vt=void 0,s.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([C,L])=>t.receive(C,de=>{let{choices:X}=Kt(de);new we(L,X.map(({_:ce})=>({label:ce,value:ce})),ce=>t.send(C,ce),L,{displayAll:!0})})),t.receiveOnce("gameData",C=>{try{let L=Kt(C),de=new Intl.ListFormat;new os("Welcome",(0,Ne.s)(`<div class="welcome">
<p>${L.player.civilization.leader.name}, you have risen to become leader of the ${L.player.civilization._}.</p>
<p>Your people have knowledge of ${de.format(["Irrigation","Mining","Roads",...L.player.research.complete.map(w=>w._)])}.</p>
</div>`)),m.classList.add("active"),d.width=d.parentElement.offsetWidth,d.height=d.parentElement.offsetHeight;let X=[],ce=2,vn=new $s(L.player.world),nr=new Hi,M=new ki(vn,t,d,{playerId:L.player.id,scale:ce,tileSize:16},Pt,Es,Ss,bs,xs,Ai,ys,et,Ot,St,Bn,jn),ir=M.getLayer(Pt),bn=M.getLayer(et),ct=M.getLayer(Ot),_n=M.getLayer(St),Fn=M.getLayer(Bn),je=M.getLayer(jn),En=new Xi(f,vn,M,ir,_n,je),qn=new Nn(a,M,r(this,Le)),rr=new Nn(o,M,r(this,Le));bn.setVisible(!1),M.on("focus-changed",()=>En.update()),M.on("activate-unit",w=>pe(w,M,ct,je)),nr.on(()=>{je.setVisible(!je.isVisible()),M.build(De.splice(0)),M.render()}),(0,Ne.on)(window,"resize",()=>{d.width=d.parentElement.offsetWidth,d.height=d.parentElement.offsetHeight});let Tn=l(w=>{let v=Kt(w);document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:v}})),qn.build(v.player.mandatoryActions),rr.build(v.player.actions.filter(P=>["AdjustTradeRates","Revolution"].includes(P._))),m.append(qn.element()),vn.setTiles(v.player.world.tiles),new Pi(h,v.turn,v.year).build(),new Ji(g,v.player).build(),X=v.player.actions.filter(P=>P._==="ActiveUnit");let[A]=X.sort(({value:P},{value:ue})=>ue===N?1:P===N?-1:(M.isVisible(ue.tile.x,ue.tile.y)?1:0)-(M.isVisible(P.tile.x,P.tile.y)?1:0));if(N!==(A==null?void 0:A.value)&&(N=null),pe(N!=null&&N.active?N:A?A.value:null,M,ct,je),M.build(De.splice(0)),M.render(),En.update(),e.autoEndOfTurn&&v.player.mandatoryActions.length===1&&v.player.mandatoryActions.every(P=>P._==="EndTurn")){t.send("action",{name:"EndTurn"});return}},"handler");Tn(C),t.receive("gameData",w=>Tn(w));let ar=l(w=>w.replace(/]/g,"").split(/[.[]/),"pathToParts"),Gn=l((w,v)=>{let R=ar(v),k=R.pop();return[R.reduce((P,ue)=>!P||!(ue in P)?null:P[ue],w),k]},"getPenultimateObject"),or=l((w,v,R)=>{let[k,A]=Gn(w,v);if(!k||!A){console.warn(`unable to set ${v} of ${w} (${A})`);return}k[A]=R},"setObjectPath"),lr=l((w,v)=>{let[R,k]=Gn(w,v);if(!R||!k){console.warn(`unable to set ${v} of ${w} (${k})`);return}delete R[k]},"removeObjectPath");t.receive("gameDataPatch",w=>{w.forEach(v=>Object.entries(v).forEach(([R,{type:k,index:A,value:P}])=>{if(k==="add"||k==="update"){if(!P.hierarchy){console.error("No hierarchy"),console.error(P);return}A?or(C.objects[R],A,P.hierarchy):C.objects[R]=P.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:P}})),Object.entries(P.objects).forEach(([ue,Mn])=>{C.objects[ue]=Mn,Mn._==="PlayerTile"&&De.push(Mn)})}if(k==="remove"){if(A){lr(C.objects[R],A);return}delete C.objects[R]}})),Tn(C)}),t.receive("gameNotification",w=>U.receive(w));let Vn={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},Cn={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},mr={8:"n",9:"ne",6:"e",3:"se",2:"s",1:"sw",4:"w",7:"nw"},Yr={[KeyboardEvent.DOM_KEY_LOCATION_STANDARD]:Cn,[KeyboardEvent.DOM_KEY_LOCATION_NUMPAD]:mr},Kn="";(0,Ne.on)(document,"keydown",w=>{if(V){if(w.key in Vn){let v=[...Vn[w.key]];for(;v.length;){let R=v.shift(),[k]=V.actions.filter(A=>A._===R);if(k){t.send("action",{name:"ActiveUnit",id:V.id,unitAction:k._,target:k.to.id}),w.stopPropagation(),w.preventDefault();return}}}if(w.key in Cn){let[v]=V.actionsForNeighbours[Cn[w.key]];if(v){t.send("action",{name:"ActiveUnit",id:V.id,unitAction:v._,target:v.to.id}),w.stopPropagation(),w.preventDefault();return}}}if(w.key==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(w.key==="Enter"&&L.player.mandatoryActions.some(v=>v._==="EndOfTurn")){t.send("action",{name:"EndTurn"}),w.stopPropagation(),w.preventDefault();return}if(w.key==="Tab"){let v=a.querySelector("div.action:first-child button");if(v!==null){v.focus(),w.preventDefault(),w.stopPropagation();return}}if(w.key==="c"&&V){M.setCenter(V.tile.x,V.tile.y),M.render(),En.update();return}if(w.key==="w"&&V&&X.length>1){let v=X.map(A=>A.value),R=v.indexOf(V),k=v[R===v.length-1?0:R+1];pe(k,M,ct,je)}if(w.key==="t"){ct.setVisible(!ct.isVisible()),_n.setVisible(!_n.isVisible()),Fn.setVisible(!Fn.isVisible()),M.render();return}if(w.key==="y"){bn.setVisible(!bn.isVisible()),M.render();return}if(Kn==="%"&&w.key==="^"){t.send("cheat",{name:"RevealMap"});return}Kn=w.key})}catch(L){console.error(L)}})}catch(s){console.error(s)}}};l(xn,"Renderer"),Le=new WeakMap;var er=xn;var wn=class{async request(t){return new Promise(e=>{this.send(t.channel(),...t.args()),this.receiveOnce(t.channel(),s=>e(s))})}};l(wn,"AbstractTransport");var tr=wn;var Pe,yn=class extends tr{constructor(e){super();c(this,Pe,void 0);u(this,Pe,e)}receive(e,s){r(this,Pe).addEventListener("message",({data:{channel:n,data:a}})=>{n===e&&s(a)})}receiveOnce(e,s){let n=l(({data:{channel:a,data:o}})=>{a===e&&(s(o),r(this,Pe).removeEventListener("message",n))},"onceHandler");r(this,Pe).addEventListener("message",n)}send(e,s){r(this,Pe).postMessage({channel:e,data:s})}};l(yn,"WorkerTransport"),Pe=new WeakMap;var sr=yn;var Kr=new er(new sr(new Worker("dist/backend.js")));Kr.init();})();
//# sourceMappingURL=frontend.js.map
